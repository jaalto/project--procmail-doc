<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<title>
Procmail Tips
</title>




  <meta http-equiv="keywords"
	CONTENT="procmail, sendmail, formail, mail, UBE, UCE, spam, filter">

  <meta http-equiv="description"
	content="">

<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Expires" content="Sat,  1 Dec 2007 15:13:04 GMT">







<link rel="stylesheet" type="text/css" href="pm-tips.css">
</head>

<body >




<div class="toc" id="toc">
<A name="toc" id="toc" class="name"></A>
<h1>
    Table of Contents

</h1>

<a href="#document_id" class="toc">
               1.0 Document id
           </a>
           <br>

<ul>
<li>
           <a href="#general" class="toc">
               1.1 General
           </a>
           <br>
<li>
           <a href="#what_is_procmail" class="toc">
               1.2 What is Procmail?
           </a>
           <br>
<li>
           <a href="#abbreviations_and_thanks" class="toc">
               1.3 Abbreviations and thanks
           </a>
           <br>
<li>
           <a href="#version_information" class="toc">
               1.4 Version information
           </a>
           <br>
<li>
           <a href="#document_layout_and_maintenance" class="toc">
               1.5 Document layout and maintenance
           </a>
           <br>
<li>
           <a href="#about_presented_recipes" class="toc">
               1.6 About presented recipes
           </a>
           <br>
<li>
           <a href="#variables_used_in_recipes" class="toc">
               1.7 Variables used in recipes
           </a>
           <br>
<li>
           <a href="#about_useless_use_of_cat_award" class="toc">
               1.8 About &quot;useless use of cat award&quot;
           </a>
           <br>
</ul>
<a href="#procmail_pointers" class="toc">
               2.0 Procmail pointers
           </a>
           <br>

<ul>
<li>
           <a href="#where_is_procmail_developed" class="toc">
               2.1 Where is procmail developed
           </a>
           <br>
<li>
           <a href="#procmail_resources" class="toc">
               2.2 Procmail resources
           </a>
           <br>
<li>
           <a href="#procmail_mode_for_emacs" class="toc">
               2.3 Procmail mode for Emacs
           </a>
           <br>
<li>
           <a href="#procmail_module_library_project" class="toc">
               2.4 Procmail module library project
           </a>
           <br>
<li>
           <a href="#procmail_code_to_filter_ube" class="toc">
               2.5 Procmail code to filter UBE
           </a>
           <br>
</ul>
<a href="#dry_run_testing" class="toc">
               3.0 Dry run testing
           </a>
           <br>

<ul>
<li>
           <a href="#what_is_dry_run_testing" class="toc">
               3.1 What is dry run testing?
           </a>
           <br>
<li>
           <a href="#why_the_from_field_is_not_okay_after_dry" class="toc">
               3.2 Why the From field is not okay after dry run?
           </a>
           <br>
<li>
           <a href="#getting_default_value_of_a_procmail_variable" class="toc">
               3.3 Getting default value of a procmail variable
           </a>
           <br>
</ul>
<a href="#things_to_remember" class="toc">
               4.0 Things to remember
           </a>
           <br>

<ul>
<li>
           <a href="#get_the_newest_procmail" class="toc">
               4.1 Get the newest procmail
           </a>
           <br>
<li>
           <a href="#cshs_tilde_is_not_supported" class="toc">
               4.2 Csh's tilde is not supported
           </a>
           <br>
<li>
           <a href="#be_sure_to_write_the_recipe_starting_right" class="toc">
               4.3 Be sure to write the recipe starting right
           </a>
           <br>
<li>
           <a href="#always_set_shell" class="toc">
               4.4 Always set SHELL
           </a>
           <br>
<li>
           <a href="#check_and_set_path" class="toc">
               4.5 Check and set PATH
           </a>
           <br>
<li>
           <a href="#keep_the_log_on_all_the_time" class="toc">
               4.6 Keep the log on all the time
           </a>
           <br>
<li>
           <a href="#never_add_a_trailing_slash_for_directories" class="toc">
               4.7 Never add a trailing slash for directories
           </a>
           <br>
<li>
           <a href="#remember_what_term_delivered_means" class="toc">
               4.8 Remember what term DELIVERED means
           </a>
           <br>
<li>
           <a href="#beware_putting_comment_in_wrong_places" class="toc">
               4.9 Beware putting comment in wrong places
           </a>
           <br>
<li>
           <a href="#brace_placement" class="toc">
               4.10 Brace placement
           </a>
           <br>
<li>
           <a href="#local_lockfile_usage" class="toc">
               4.11 Local lockfile usage
           </a>
           <br>
<li>
           <a href="#global_lockfile" class="toc">
               4.12 Global lockfile
           </a>
           <br>
<li>
           <a href="#gee_where_do_i_put_all_those" class="toc">
               4.13 Gee, where do I put all those ! * $ ??
           </a>
           <br>
<li>
           <a href="#if_you_send_an_automatic_reply_use_xloop_header" class="toc">
               4.14 If you Send an automatic reply, use X-loop header
           </a>
           <br>
<li>
           <a href="#avoid_extra_shell_layer_and_check_command_for_shellmetas" class="toc">
               4.15 Avoid extra shell layer and check command for SHELLMETAS
           </a>
           <br>
<li>
           <a href="#think_what_shell_commands_you_use" class="toc">
               4.16 Think what shell commands you use
           </a>
           <br>
<li>
           <a href="#using_absolute_paths_when_calling_a_shell_program" class="toc">
               4.17 Using absolute paths when calling a shell program
           </a>
           <br>
<li>
           <a href="#disabling_a_recipe_temporarily" class="toc">
               4.18 Disabling a recipe temporarily
           </a>
           <br>
<li>
           <a href="#keep_message_backup_no_matter_what" class="toc">
               4.19 Keep message backup, no matter what
           </a>
           <br>
<li>
           <a href="#order_of_the_procmail_recipes" class="toc">
               4.20 Order of the procmail recipes
           </a>
           <br>
</ul>
<a href="#procmail_flags" class="toc">
               5.0 Procmail flags
           </a>
           <br>

<ul>
<li>
           <a href="#the_order_of_the_flags" class="toc">
               5.1 The order of the flags
           </a>
           <br>
<li>
           <a href="#flags_hb_at_top_of_recipe_warning" class="toc">
               5.2 Flags HB at top of recipe (warning)
           </a>
           <br>
<li>
           <a href="#flag_w_and_recipe_with" class="toc">
               5.3 Flag w and recipe with |
           </a>
           <br>
<li>
           <a href="#flag_w_lock_file_and_recipe_with" class="toc">
               5.4 Flag w, lock file and recipe with |
           </a>
           <br>
<li>
           <a href="#flag_f_and_w_together" class="toc">
               5.5 Flag f and w together
           </a>
           <br>
<li>
           <a href="#flags_h_and_b" class="toc">
               5.6 Flags h and b
           </a>
           <br>
<li>
           <a href="#flag_h_and_sinking_to_devnull" class="toc">
               5.7 Flag h and sinking to /dev/null
           </a>
           <br>
<li>
           <a href="#flag_i_and_pipe_flag_f" class="toc">
               5.8 Flag i and pipe flag f
           </a>
           <br>
<li>
           <a href="#flag_r" class="toc">
               5.9 Flag r
           </a>
           <br>
<li>
           <a href="#flag_cs_background" class="toc">
               5.10 Flag c's background
           </a>
           <br>
<li>
           <a href="#flag_c_before_nested_block_forks_a_child" class="toc">
               5.11 Flag c before nested block forks a child
           </a>
           <br>
<li>
           <a href="#flag_c_and_understanding_possible_forking_penalty" class="toc">
               5.12 Flag c and understanding possible forking penalty
           </a>
           <br>
<li>
           <a href="#flags_before_nested_block" class="toc">
               5.13 Flags before nested block
           </a>
           <br>
<li>
           <a href="#flags_aaee_tutorial" class="toc">
               5.14 Flags aAeE tutorial
           </a>
           <br>
</ul>
<a href="#matching_and_regexps_regular_expressions" class="toc">
               6.0 Matching and regexps (regular expressions)
           </a>
           <br>

<ul>
<li>
           <a href="#philosophy_of_abstraction_in_regexps" class="toc">
               6.1 Philosophy of abstraction in regexps
           </a>
           <br>
<li>
           <a href="#matches_are_not_casesensitive" class="toc">
               6.2 Matches are not case-sensitive
           </a>
           <br>
<li>
           <a href="#procmail_uses_multi_line_matches" class="toc">
               6.3 Procmail uses multi line matches
           </a>
           <br>
<li>
           <a href="#headers_are_unfolded_before_matching" class="toc">
               6.4 Headers are unfolded before matching
           </a>
           <br>
<li>
           <a href="#improving_spacetab_syndrome" class="toc">
               6.5 Improving Space-Tab syndrome
           </a>
           <br>
<li>
           <a href="#handling_exclamation_character" class="toc">
               6.6 Handling exclamation character
           </a>
           <br>
<li>
           <a href="#rules_for_generating_a_character_class" class="toc">
               6.7 Rules for generating a character class
           </a>
           <br>
<li>
           <a href="#matching_space_at_the_end_of_condition" class="toc">
               6.8 Matching space at the end of condition
           </a>
           <br>
<li>
           <a href="#beware_leading_backslash" class="toc">
               6.9 Beware leading backslash
           </a>
           <br>
<li>
           <a href="#correct_use_of_to_macro" class="toc">
               6.10 Correct use of TO Macro
           </a>
           <br>
<li>
           <a href="#procmails_regexp_engine" class="toc">
               6.11 Procmail's regexp engine
           </a>
           <br>
<li>
           <a href="#procmail_and_egrep_differences" class="toc">
               6.12 Procmail and egrep differences
           </a>
           <br>
<li>
           <a href="#understanding_procmails_minimal_matching_stingy_vs_greedy" class="toc">
               6.13 Understanding procmail's minimal matching (stingy vs. greedy)
           </a>
           <br>
<li>
           <a href="#explaining_and" class="toc">
               6.14 Explaining \/ and ()\/
           </a>
           <br>
<li>
           <a href="#explaining__and" class="toc">
               6.15 Explaining  ^^ and ^
           </a>
           <br>
<li>
           <a href="#anding_traditionally" class="toc">
               6.16 ANDing traditionally
           </a>
           <br>
<li>
           <a href="#oring_traditionally" class="toc">
               6.17 ORing traditionally
           </a>
           <br>
<li>
           <a href="#oring_and_score_recipe" class="toc">
               6.18 ORing and score recipe
           </a>
           <br>
<li>
           <a href="#oring_by_using_de_morgan_rules" class="toc">
               6.19 ORing by using De Morgan rules
           </a>
           <br>
</ul>
<a href="#variables" class="toc">
               7.0 Variables
           </a>
           <br>

<ul>
<li>
           <a href="#setting_and_unsetting_variables" class="toc">
               7.1 Setting and unsetting variables
           </a>
           <br>
<li>
           <a href="#variable_initialization_and_sh_syntax" class="toc">
               7.2 Variable initialization and sh syntax
           </a>
           <br>
<li>
           <a href="#testing_variables" class="toc">
               7.3 Testing variables
           </a>
           <br>
<li>
           <a href="#what_does" class="toc">
               7.4 What does $\VAR mean?
           </a>
           <br>
<li>
           <a href="#common_pitfalls_when_using_variables" class="toc">
               7.5 Common pitfalls when using variables
           </a>
           <br>
<li>
           <a href="#quoting_using_single_or_double_quotes" class="toc">
               7.6 Quoting: Using single or double quotes
           </a>
           <br>
<li>
           <a href="#quoting_passing_values_to_an_external_program" class="toc">
               7.7 Quoting: Passing values to an external program
           </a>
           <br>
<li>
           <a href="#passing_values_from_an_external_program" class="toc">
               7.8 Passing values from an external program
           </a>
           <br>
<li>
           <a href="#incrementing_a_variable_by_a_value_n" class="toc">
               7.9 Incrementing a variable by a value N
           </a>
           <br>
<li>
           <a href="#comparing_values" class="toc">
               7.10 Comparing values
           </a>
           <br>
<li>
           <a href="#strings_how_many_characters_are_there_in_a_given" class="toc">
               7.11 Strings: How many characters are there in a given string?
           </a>
           <br>
<li>
           <a href="#strings_how_to_strip_trailing_newline" class="toc">
               7.12 Strings: How to strip trailing newline.
           </a>
           <br>
<li>
           <a href="#strings_deriving_the_last_n_characters_of_a_string" class="toc">
               7.13 Strings: deriving the last N characters of a string.
           </a>
           <br>
<li>
           <a href="#strings_getting_partial_matches_from_a_string" class="toc">
               7.14 Strings: Getting partial matches from a string.
           </a>
           <br>
<li>
           <a href="#strings_procmail_string_manipulation_example" class="toc">
               7.15 Strings: Procmail string manipulation example
           </a>
           <br>
<li>
           <a href="#how_to_raise_a_flag_if_the_message_was" class="toc">
               7.16 How to raise a flag if the message was filed
           </a>
           <br>
<li>
           <a href="#dollar_sign_in_condition_lines" class="toc">
               7.17 Dollar sign in condition lines.
           </a>
           <br>
<li>
           <a href="#finding_mysterious_foo_variable" class="toc">
               7.18 Finding mysterious foo variable
           </a>
           <br>
<li>
           <a href="#storing_code_to_variable" class="toc">
               7.19 Storing code to variable
           </a>
           <br>
<li>
           <a href="#getting_headers_into_a_variable" class="toc">
               7.20 Getting headers into a variable
           </a>
           <br>
<li>
           <a href="#converting_value_to_lowercase" class="toc">
               7.21 Converting value to lowercase
           </a>
           <br>
</ul>
<a href="#suggestions_and_miscellaneous" class="toc">
               8.0 Suggestions and miscellaneous
           </a>
           <br>

<ul>
<li>
           <a href="#speeding_up_procmail" class="toc">
               8.1 Speeding up procmail
           </a>
           <br>
<li>
           <a href="#see_the_procmail_installations_examples" class="toc">
               8.2 See the procmail installation's examples
           </a>
           <br>
<li>
           <a href="#printing_statistics_of_your_incoming_mail" class="toc">
               8.3 Printing statistics of your incoming mail
           </a>
           <br>
<li>
           <a href="#storing_ube_mailboxes_outside_of_quota" class="toc">
               8.4 Storing UBE mailboxes outside of quota
           </a>
           <br>
<li>
           <a href="#using_first_530_lines_from_the_message" class="toc">
               8.5 Using first 5-30 lines from the message
           </a>
           <br>
<li>
           <a href="#using_cat_or_echo_in_scripts" class="toc">
               8.6 Using cat or echo in scripts?
           </a>
           <br>
<li>
           <a href="#how_to_run_an_extra_shell_command_as_a" class="toc">
               8.7 How to run an extra shell command as a side effect?
           </a>
           <br>
<li>
           <a href="#forcing_ok_return_status_from_shell_script" class="toc">
               8.8 Forcing &quot;ok&quot; return status from shell script
           </a>
           <br>
<li>
           <a href="#using_grep_with_file_lists_to_mach_messages" class="toc">
               8.9 Using grep with file lists to mach messages
           </a>
           <br>
<li>
           <a href="#make_your_own_procmailrc_available_to_others" class="toc">
               8.10 Make your own .procmailrc available to others
           </a>
           <br>
<li>
           <a href="#using_dates_efficiently" class="toc">
               8.11 Using dates efficiently
           </a>
           <br>
<li>
           <a href="#keep_simple_header_log" class="toc">
               8.12 Keep simple header log
           </a>
           <br>
<li>
           <a href="#gzipping_messages" class="toc">
               8.13 Gzipping messages
           </a>
           <br>
<li>
           <a href="#emergency_stop_for_your_procmailrc" class="toc">
               8.14 Emergency stop for your .procmailrc
           </a>
           <br>
</ul>
<a href="#scoring" class="toc">
               9.0 Scoring
           </a>
           <br>

<ul>
<li>
           <a href="#using_scores_by_an_example" class="toc">
               9.1 Using scores by an example
           </a>
           <br>
<li>
           <a href="#brief_score_tutorial" class="toc">
               9.2 Brief Score tutorial
           </a>
           <br>
<li>
           <a href="#scores_scope" class="toc">
               9.3 Score's scope
           </a>
           <br>
<li>
           <a href="#counting_length_of_a_string" class="toc">
               9.4 Counting length of a string
           </a>
           <br>
<li>
           <a href="#counting_lines_in_a_message_adding_lines_header" class="toc">
               9.5 Counting lines in a message (Adding Lines: header)
           </a>
           <br>
<li>
           <a href="#determining_if_body_is_longer_than_header" class="toc">
               9.6 Determining if body is longer than header
           </a>
           <br>
<li>
           <a href="#matching_last_received_header" class="toc">
               9.7 Matching last Received header
           </a>
           <br>
<li>
           <a href="#testing_value_range_with_scoring_bogofilter" class="toc">
               9.8 Testing value range with scoring (bogofilter)
           </a>
           <br>
<li>
           <a href="#how_to_add_contentlength_header" class="toc">
               9.9 How to add Content-Length header
           </a>
           <br>
<li>
           <a href="#testing_message_size_or_number_of_lines" class="toc">
               9.10 Testing message size or number of lines
           </a>
           <br>
<li>
           <a href="#counting_commas_with_recursive_includerc" class="toc">
               9.11 Counting commas with recursive includerc
           </a>
           <br>
</ul>
<a href="#formail_usage" class="toc">
               10.0 Formail usage
           </a>
           <br>

<ul>
<li>
           <a href="#fetching_fields_with_formail_x" class="toc">
               10.1 Fetching fields with formail -x
           </a>
           <br>
<li>
           <a href="#always_use_formails_rt_switch" class="toc">
               10.2 Always use formail's -rt switch
           </a>
           <br>
<li>
           <a href="#using_rt_and_rewriting_the_from_address" class="toc">
               10.3 Using -rt and rewriting the From address
           </a>
           <br>
<li>
           <a href="#formail_rt_and_resentfrom_header" class="toc">
               10.4 Formail -rt and Resent-From header
           </a>
           <br>
<li>
           <a href="#quoting_the_message" class="toc">
               10.5 Quoting the message
           </a>
           <br>
<li>
           <a href="#without_quoting_the_message" class="toc">
               10.6 Without quoting the message
           </a>
           <br>
<li>
           <a href="#how_to_include_headers_and_body_to_the_reply" class="toc">
               10.7 How to include headers and body to the reply message
           </a>
           <br>
<li>
           <a href="#adding_text_to_the_beginning_of_message" class="toc">
               10.8 Adding text to the beginning of message
           </a>
           <br>
<li>
           <a href="#adding_text_to_the_end_of_message" class="toc">
               10.9 Adding text to the end of message
           </a>
           <br>
<li>
           <a href="#adding_text_before_quoted_message" class="toc">
               10.10 Adding text before quoted message
           </a>
           <br>
<li>
           <a href="#adding_extra_headers_from_file" class="toc">
               10.11 Adding extra headers from file
           </a>
           <br>
<li>
           <a href="#splitting_digest" class="toc">
               10.12 Splitting digest
           </a>
           <br>
<li>
           <a href="#mailbox_splitting_to_individual_files" class="toc">
               10.13 Mailbox: Splitting to individual files
           </a>
           <br>
<li>
           <a href="#mailbox_extracting_all_from_addresses_from_mailbox" class="toc">
               10.14 Mailbox: Extracting all From addresses from mailbox
           </a>
           <br>
<li>
           <a href="#mailbox_applying_procmail_recipe_on_whole_mailbox" class="toc">
               10.15 Mailbox: Applying procmail recipe on whole mailbox
           </a>
           <br>
<li>
           <a href="#mailbox_run_series_of_commands_for_each_mail_split" class="toc">
               10.16 Mailbox: run series of commands for each mail (split mailbox)
           </a>
           <br>
<li>
           <a href="#option_d_and_cache" class="toc">
               10.17 Option -D and cache
           </a>
           <br>
<li>
           <a href="#option_d_and_messageid_in_the_body" class="toc">
               10.18 Option -D and message-id in the body
           </a>
           <br>
<li>
           <a href="#reducing_formail_calls_conditionally_adding_fields" class="toc">
               10.19 Reducing formail calls (conditionally adding fields)
           </a>
           <br>
<li>
           <a href="#formail_a_a_options" class="toc">
               10.20 Formail -A -a options
           </a>
           <br>
<li>
           <a href="#formail_e_s_options" class="toc">
               10.21 Formail -e -s options
           </a>
           <br>
</ul>
<a href="#saving_mailing_list_messages" class="toc">
               11.0 Saving mailing list messages
           </a>
           <br>

<ul>
<li>
           <a href="#using_subroutine_pmjalist_rc_to_detect_mailing_lists" class="toc">
               11.1 Using subroutine pm-jalist.rc to detect mailing lists
           </a>
           <br>
<li>
           <a href="#using_plus_addressing_foobar" class="toc">
               11.2 Using plus addressing foo+bar@address.com
           </a>
           <br>
<li>
           <a href="#using_rfc_comment_trick_for_additional_information" class="toc">
               11.3 Using RFC comment trick for additional information
           </a>
           <br>
<li>
           <a href="#simple_mailing_list_handling" class="toc">
               11.4 Simple mailing list handling
           </a>
           <br>
<li>
           <a href="#archiving_according_to_to" class="toc">
               11.5 Archiving according to TO
           </a>
           <br>
<li>
           <a href="#using_returnpath_to_detect_mailing_lists" class="toc">
               11.6 Using Return-Path to detect mailing lists
           </a>
           <br>
</ul>
<a href="#procmail_mime_and_html" class="toc">
               12.0 Procmail, MIME and HTML
           </a>
           <br>

<ul>
<li>
           <a href="#mime_bibliography" class="toc">
               12.1 Mime Bibliography
           </a>
           <br>
<li>
           <a href="#mime_content_type_applicationmstnef" class="toc">
               12.2 Mime content type application/ms-tnef
           </a>
           <br>
<li>
           <a href="#trapping_html_mime_messages" class="toc">
               12.3 Trapping HTML mime messages
           </a>
           <br>
<li>
           <a href="#complaining_about_html_messages" class="toc">
               12.4 Complaining about HTML messages
           </a>
           <br>
<li>
           <a href="#converting_html_body_to_plain_text" class="toc">
               12.5 Converting HTML body to plain text
           </a>
           <br>
<li>
           <a href="#getting_rid_of_unwanted_mime_attachments_html_vcard" class="toc">
               12.6 Getting rid of unwanted mime attachments (HTML, vcard)
           </a>
           <br>
<li>
           <a href="#sending_contents_of_a_html_page_in_plain_text" class="toc">
               12.7 Sending contents of a HTML page in plain text to someone
           </a>
           <br>
</ul>
<a href="#simple_recipe_examples" class="toc">
               13.0 Simple recipe examples
           </a>
           <br>

<ul>
<li>
           <a href="#saving_mh_folders_numbered_messages" class="toc">
               13.1 Saving: MH folders -- numbered messages
           </a>
           <br>
<li>
           <a href="#saving_to_monthly_folders" class="toc">
               13.2 Saving: to monthly folders
           </a>
           <br>
<li>
           <a href="#modifying_filtering_basics" class="toc">
               13.3 Modifying: Filtering basics
           </a>
           <br>
<li>
           <a href="#modifying_squeezing_empty_lines_around_message_body" class="toc">
               13.4 Modifying: Squeezing empty lines around message body
           </a>
           <br>
<li>
           <a href="#modifying_shuffling_headers_always_to_same_order" class="toc">
               13.5 Modifying: shuffling headers always to same order
           </a>
           <br>
<li>
           <a href="#service_auto_answerer_to_empty_messages" class="toc">
               13.6 Service: Auto answerer to empty messages
           </a>
           <br>
<li>
           <a href="#service_ping_responder" class="toc">
               13.7 Service: Ping responder
           </a>
           <br>
<li>
           <a href="#service_simple_vacation_with_procmail" class="toc">
               13.8 Service: simple vacation with procmail
           </a>
           <br>
<li>
           <a href="#service_vacation_code_example" class="toc">
               13.9 Service: vacation code example
           </a>
           <br>
<li>
           <a href="#service_autoforwarding" class="toc">
               13.10 Service: Auto-forwarding
           </a>
           <br>
<li>
           <a href="#service_forward_only_specific_messages" class="toc">
               13.11 Service: forward only specific messages
           </a>
           <br>
<li>
           <a href="#service_making_digests" class="toc">
               13.12 Service: Making digests
           </a>
           <br>
<li>
           <a href="#kill_killing_advertisement_headers_and_footers" class="toc">
               13.13 Kill: killing advertisement headers and footers
           </a>
           <br>
<li>
           <a href="#kill_simple_kill_file_recipe_with_procmail" class="toc">
               13.14 Kill: simple kill file recipe with procmail
           </a>
           <br>
<li>
           <a href="#kill_duplicate_messages" class="toc">
               13.15 Kill: duplicate messages
           </a>
           <br>
<li>
           <a href="#kill_spam_filter_with_simple_recipes" class="toc">
               13.16 Kill: spam filter with simple recipes
           </a>
           <br>
<li>
           <a href="#kill_unsubscribe_messages" class="toc">
               13.17 Kill: (un)subscribe messages
           </a>
           <br>
<li>
           <a href="#time_once_a_day_cronlike_job" class="toc">
               13.18 Time: Once a day cron-like job
           </a>
           <br>
<li>
           <a href="#time_running_a_recipe_at_a_given_time" class="toc">
               13.19 Time: Running a recipe at a given time
           </a>
           <br>
<li>
           <a href="#time_triggering_mail_and_using_cron" class="toc">
               13.20 Time: Triggering mail and using cron
           </a>
           <br>
<li>
           <a href="#decoding_uudecode" class="toc">
               13.21 Decoding: Uudecode
           </a>
           <br>
<li>
           <a href="#decoding_mime" class="toc">
               13.22 Decoding: MIME
           </a>
           <br>
<li>
           <a href="#how_to_send_commands_in_the_messages_body" class="toc">
               13.23 How to send commands in the message's body
           </a>
           <br>
<li>
           <a href="#matching_two_words_on_a_line_but_not_one" class="toc">
               13.24 Matching two words on a line, but not one
           </a>
           <br>
<li>
           <a href="#how_to_define_personal_xx_macros" class="toc">
               13.25 How to define personal XX macros?
           </a>
           <br>
<li>
           <a href="#how_to_change_subject_by_body_match" class="toc">
               13.26 How to change subject by body match
           </a>
           <br>
<li>
           <a href="#how_to_change_subject_according_to_some_other_header" class="toc">
               13.27 How to change Subject according to some other header
           </a>
           <br>
<li>
           <a href="#how_to_call_program_with_parameters" class="toc">
               13.28 How to call program with parameters
           </a>
           <br>
</ul>
<a href="#miscellaneous_recipes" class="toc">
               14.0 Miscellaneous recipes
           </a>
           <br>

<ul>
<li>
           <a href="#matching_valid_messageid_header" class="toc">
               14.1 Matching valid Message-Id header
           </a>
           <br>
<li>
           <a href="#sending_two_files_in_a_message" class="toc">
               14.2 Sending two files in a message
           </a>
           <br>
<li>
           <a href="#excessive_quoting_of_message" class="toc">
               14.3 Excessive quoting of message
           </a>
           <br>
<li>
           <a href="#sending_message_to_pager_in_chunks" class="toc">
               14.4 Sending message to pager in chunks
           </a>
           <br>
<li>
           <a href="#playing_particular_sound_when_message_arrives" class="toc">
               14.5 Playing particular sound when message arrives
           </a>
           <br>
<li>
           <a href="#combining_multiple_originalcc_and_originalto_headers" class="toc">
               14.6 Combining multiple Original-Cc and Original-To headers
           </a>
           <br>
<li>
           <a href="#forwarding_sensitive_messages_in_encrypted_format" class="toc">
               14.7 Forwarding sensitive messages in encrypted format
           </a>
           <br>
</ul>
<a href="#procmail_and_pgp" class="toc">
               15.0 Procmail and PGP
           </a>
           <br>

<ul>
<li>
           <a href="#decrypt_pgp_messages_automatically" class="toc">
               15.1 Decrypt pgp messages automatically
           </a>
           <br>
<li>
           <a href="#getkeys_from_key_server" class="toc">
               15.2 Getkeys from key server
           </a>
           <br>
<li>
           <a href="#auto_grab_incoming_pgp_keys" class="toc">
               15.3 Auto grab incoming pgp keys
           </a>
           <br>
</ul>
<a href="#includerc_usage" class="toc">
               16.0 Includerc usage
           </a>
           <br>

<ul>
<li>
           <a href="#using_multiple_rc_files" class="toc">
               16.1 Using: multiple rc files
           </a>
           <br>
<li>
           <a href="#using_call_rc_file_conditionally" class="toc">
               16.2 Using: call rc file conditionally
           </a>
           <br>
<li>
           <a href="#using_autoloading_an_rc_file" class="toc">
               16.3 Using: autoloading an rc file
           </a>
           <br>
<li>
           <a href="#making_naming_of_the_rc_file" class="toc">
               16.4 Making: naming of the rc file
           </a>
           <br>
<li>
           <a href="#making_using_name_space_when_saving_procmail_variables" class="toc">
               16.5 Making: Using name space when saving procmail variables
           </a>
           <br>
<li>
           <a href="#making_public_and_private_variables_in_rc_file" class="toc">
               16.6 Making: Public and private variables in rc file
           </a>
           <br>
<li>
           <a href="#the_rules_of_thumb_for_constructing_general_purpose_rc" class="toc">
               16.7 The rules of thumb for constructing general purpose rc file
           </a>
           <br>
<li>
           <a href="#an_includerc_skeleton" class="toc">
               16.8 An includerc skeleton
           </a>
           <br>
</ul>
<a href="#mailing_list_server" class="toc">
               17.0 Mailing list server
           </a>
           <br>
<a href="#common_troubles" class="toc">
               18.0 Common troubles
           </a>
           <br>

<ul>
<li>
           <a href="#procmail_modes_normal_delivery_and_mail_filter" class="toc">
               18.1 Procmail modes: normal, delivery, and mail filter.
           </a>
           <br>
<li>
           <a href="#procmail_as_sendmail_mlocal_mail_filtering_device" class="toc">
               18.2 Procmail as sendmail Mlocal mail filtering device
           </a>
           <br>
<li>
           <a href="#procmail_doesnt_pass_8bit_characters" class="toc">
               18.3 Procmail doesn't pass 8bit characters
           </a>
           <br>
<li>
           <a href="#my_isp_isnt_very_interested_in_installing_procmail" class="toc">
               18.4 My ISP isn't very interested in installing procmail
           </a>
           <br>
<li>
           <a href="#my_isp_has_systemwide_procmailrc_is_this_a_good" class="toc">
               18.5 My ISP has systemwide procmailrc; is this a good idea?
           </a>
           <br>
<li>
           <a href="#procmail_changes_mailbox_and_directory_permissions" class="toc">
               18.6 Procmail changes mailbox and directory permissions
           </a>
           <br>
<li>
           <a href="#changing_mbox_permission_during_compilation_to_660" class="toc">
               18.7 Changing mbox permission during compilation to 660
           </a>
           <br>
<li>
           <a href="#the_forward_file_must_be_real_file" class="toc">
               18.8 The .forward file must be real file
           </a>
           <br>
<li>
           <a href="#using_forward_if_procmail_already_is_lda" class="toc">
               18.9 Using .forward if procmail already is LDA
           </a>
           <br>
<li>
           <a href="#mail_should_be_put_in_the_mailqueue_if_write" class="toc">
               18.10 Mail should be put in the mailqueue if write fails
           </a>
           <br>
<li>
           <a href="#qmail_how_to_make_it_work_with_procmail" class="toc">
               18.11 Qmail: how to make it work with procmail
           </a>
           <br>
<li>
           <a href="#qmail_procmail_looks_file_from_varspoolmail_only" class="toc">
               18.12 Qmail: Procmail looks file from /var/spool/mail only
           </a>
           <br>
<li>
           <a href="#qmail_patch_to_procmail_3_11pre7_to_work_with" class="toc">
               18.13 Qmail: patch to procmail 3.11pre7 to work with Maildirs
           </a>
           <br>
<li>
           <a href="#afs_how_to_use_procmail_when_home_is_in" class="toc">
               18.14 AFS: How to use Procmail when HOME is in AFS cell
           </a>
           <br>
<li>
           <a href="#help_some_idiot_sent_my_address_to_30_mailing" class="toc">
               18.15 Help, some idiot sent my address to 30 mailing lists
           </a>
           <br>
<li>
           <a href="#help_procmail_beeps_and_prints_to_my_console" class="toc">
               18.16 Help, Procmail beeps and prints to my console
           </a>
           <br>
<li>
           <a href="#help_procmail_dumps_mail_to_console" class="toc">
               18.17 Help, procmail dumps mail to console
           </a>
           <br>
<li>
           <a href="#help_corrupted_from_line_in_mailbox" class="toc">
               18.18 Help, corrupted From_ line in mailbox
           </a>
           <br>
<li>
           <a href="#directing_users_mail_to_home_instead_of_varspool" class="toc">
               18.19 Directing user's mail to HOME instead of /var/spool/
           </a>
           <br>
<li>
           <a href="#nfs_mounting_varmail_is_a_good_way_to_get" class="toc">
               18.20 NFS mounting /var/mail is a good way to get bad performance
           </a>
           <br>
<li>
           <a href="#i_cant_see_the_sendmails_response_in_logfile" class="toc">
               18.21 I can't see the sendmail's response in LOGFILE
           </a>
           <br>
<li>
           <a href="#compiling_procmail_and_choosing_locking_scheme" class="toc">
               18.22 Compiling procmail and choosing locking scheme
           </a>
           <br>
<li>
           <a href="#forwarding_lot_of_mail_causes_heavy_load" class="toc">
               18.23 Forwarding lot of mail causes heavy load
           </a>
           <br>
<li>
           <a href="#what_happens_to_mail_if_mda_procmail_fails" class="toc">
               18.24 What happens to mail if MDA Procmail fails
           </a>
           <br>
<li>
           <a href="#procmail_reads_entire_90mb_message_into_memory" class="toc">
               18.25 Procmail reads entire 90Mb message into memory
           </a>
           <br>
<li>
           <a href="#procmail_signaled_out_of_memory_in_my_verbose_log" class="toc">
               18.26 Procmail signaled out of memory in my verbose log
           </a>
           <br>
<li>
           <a href="#variables_default_and_orgmail" class="toc">
               18.27 Variables DEFAULT and ORGMAIL
           </a>
           <br>
<li>
           <a href="#when_default_cannot_be_mailed_to" class="toc">
               18.28 When DEFAULT cannot be mailed to
           </a>
           <br>
<li>
           <a href="#variable_dropprivs" class="toc">
               18.29 Variable DROPPRIVS
           </a>
           <br>
<li>
           <a href="#variable_home" class="toc">
               18.30 Variable HOME
           </a>
           <br>
<li>
           <a href="#variable_host" class="toc">
               18.31 Variable HOST
           </a>
           <br>
<li>
           <a href="#variable_linebuf" class="toc">
               18.32 Variable LINEBUF
           </a>
           <br>
<li>
           <a href="#variable_log_and_logfile" class="toc">
               18.33 Variable LOG and LOGFILE
           </a>
           <br>
<li>
           <a href="#variable_trap" class="toc">
               18.34 Variable TRAP
           </a>
           <br>
<li>
           <a href="#variable_umask" class="toc">
               18.35 Variable UMASK
           </a>
           <br>
<li>
           <a href="#umask_and_permissions" class="toc">
               18.36 UMASK and permissions
           </a>
           <br>
<li>
           <a href="#performance_difference_between_back_tick_and_recipe" class="toc">
               18.37 Performance difference between back tick and &quot;|&quot; recipe
           </a>
           <br>
<li>
           <a href="#procmails_temporary_file_names_while_writing_file_out" class="toc">
               18.38 Procmail's temporary file names while writing file out
           </a>
           <br>
<li>
           <a href="#parameter" class="toc">
               18.39 Parameter $@
           </a>
           <br>
<li>
           <a href="#procmail_variables_are_null_terminated_detecting_null_string" class="toc">
               18.40 Procmail variables are null terminated (detecting null string)
           </a>
           <br>
<li>
           <a href="#from_daemon_to_and_to_and_casesensitiveness" class="toc">
               18.41 FROM_DAEMON TO and TO_ and case-sensitiveness
           </a>
           <br>
<li>
           <a href="#to_macro_deciphered" class="toc">
               18.42 TO_ macro deciphered
           </a>
           <br>
<li>
           <a href="#to_macro_and_rfc_822" class="toc">
               18.43 TO_ macro and RFC 822
           </a>
           <br>
<li>
           <a href="#from_daemon_deciphered" class="toc">
               18.44 FROM_DAEMON deciphered
           </a>
           <br>
</ul>
<a href="#technical_matters" class="toc">
               19.0 Technical matters
           </a>
           <br>

<ul>
<li>
           <a href="#list_of_exit_codes" class="toc">
               19.1 List of exit codes
           </a>
           <br>
<li>
           <a href="#list_of_precedence_codes" class="toc">
               19.2 List of precedence codes
           </a>
           <br>
<li>
           <a href="#sendmail_and_t" class="toc">
               19.3 Sendmail and -t
           </a>
           <br>
<li>
           <a href="#rfc822_replyto_and_formail_problem_with_multiple_recipients" class="toc">
               19.4 RFC822 Reply-To and formail problem with multiple recipients
           </a>
           <br>
<li>
           <a href="#procmail_and_imap_server" class="toc">
               19.5 Procmail and IMAP server
           </a>
           <br>
<li>
           <a href="#machine_which_processes_mail" class="toc">
               19.6 Machine which processes mail
           </a>
           <br>
<li>
           <a href="#compiling_procmail_and_mailspoolhome" class="toc">
               19.7 Compiling procmail and MAILSPOOLHOME
           </a>
           <br>
</ul>
<a href="#procmail_software_for_emacs" class="toc">
               20.0 Procmail software for Emacs
           </a>
           <br>

<ul>
<li>
           <a href="#what_is_emacs" class="toc">
               20.1 What is Emacs
           </a>
           <br>
<li>
           <a href="#emacs_procmailmode_and_procmail_code_checking_lint" class="toc">
               20.2 Emacs procmail-mode and Procmail code checking (Lint)
           </a>
           <br>
<li>
           <a href="#why_use_procmail_with_gnus" class="toc">
               20.3 Why use procmail with Gnus
           </a>
           <br>
<li>
           <a href="#setting_up_gnus_for_procmail_basics" class="toc">
               20.4 Setting up Gnus for procmail - Basics
           </a>
           <br>
<li>
           <a href="#gnus_for_procmail_more_about_it" class="toc">
               20.5 Gnus for procmail - More about it
           </a>
           <br>
<li>
           <a href="#emacs_and_gnus_fiddling_with_spool_files" class="toc">
               20.6 Emacs and Gnus -- Fiddling with spool files
           </a>
           <br>
<li>
           <a href="#gnus_article_snippets" class="toc">
               20.7 Gnus article snippets
           </a>
           <br>
</ul>
<a href="#rfc_request_for_comments" class="toc">
               21.0 RFC, Request for comments
           </a>
           <br>

<ul>
<li>
           <a href="#rfcs_and_their_jurisdiction_munged_addresses" class="toc">
               21.1 RFCs and their jurisdiction (munged Addresses)
           </a>
           <br>
<li>
           <a href="#comments_about_addresses_munging" class="toc">
               21.2 Comments about addresses munging
           </a>
           <br>
<li>
           <a href="#rfc_and_valid_mail_address_characters" class="toc">
               21.3 RFC and valid mail address characters
           </a>
           <br>
<li>
           <a href="#rfc_and_loginname" class="toc">
               21.4 RFC and login-name@fdqn
           </a>
           <br>
<li>
           <a href="#rfcs_and_messages_signature" class="toc">
               21.5 RFCs and messages signature
           </a>
           <br>
<li>
           <a href="#rfc_and_using_mime_in_usenet_newsgroups" class="toc">
               21.6 RFC and using MIME in Usenet newsgroups
           </a>
           <br>
<li>
           <a href="#some_rfc_pointers" class="toc">
               21.7 Some RFC Pointers
           </a>
           <br>
</ul>
<a href="#introduction_to_email_headers" class="toc">
               22.0 Introduction to E-mail Headers
           </a>
           <br>

<ul>
<li>
           <a href="#to_find_out_more_about_mail" class="toc">
               22.1 To find out more about mail
           </a>
           <br>
<li>
           <a href="#lecture_by_alan_stebbens" class="toc">
               22.2 Lecture by Alan Stebbens
           </a>
           <br>
<li>
           <a href="#applied_to_received_messages" class="toc">
               22.3 Applied to received messages
           </a>
           <br>
<li>
           <a href="#bcc_lecture_by_alan_stebbens" class="toc">
               22.4 Bcc lecture by Alan Stebbens
           </a>
           <br>
<li>
           <a href="#bcc_lecture_by_philip_guenther" class="toc">
               22.5 Bcc lecture by Philip Guenther
           </a>
           <br>
</ul>
<a href="#message_headers" class="toc">
               23.0 Message headers
           </a>
           <br>

<ul>
<li>
           <a href="#what_is_correct_from_address_syntax" class="toc">
               23.1 What is correct From address syntax
           </a>
           <br>
<li>
           <a href="#whats_that_xuidl_header" class="toc">
               23.2 What's that X-UIDL header?
           </a>
           <br>
<li>
           <a href="#what_is_that_first_from_header" class="toc">
               23.3 What is that first From_ header?
           </a>
           <br>
<li>
           <a href="#messageid_header" class="toc">
               23.4 Message-Id header
           </a>
           <br>
<li>
           <a href="#received_header" class="toc">
               23.5 Received header
           </a>
           <br>
<li>
           <a href="#returnpath" class="toc">
               23.6 Return-Path
           </a>
           <br>
<li>
           <a href="#errorsto" class="toc">
               23.7 Errors-To
           </a>
           <br>
<li>
           <a href="#xsubscriptioninfo" class="toc">
               23.8 X-Subscription-Info
           </a>
           <br>
<li>
           <a href="#replyto_header" class="toc">
               23.9 Reply-To header
           </a>
           <br>
<li>
           <a href="#mailcopiesto_header" class="toc">
               23.10 Mail-Copies-To header
           </a>
           <br>
<li>
           <a href="#mailfollowupto_and_replytopersonal_headers" class="toc">
               23.11 Mail-Followup-To and Reply-To-Personal headers
           </a>
           <br>
<li>
           <a href="#contentlength_header_and_from_specification" class="toc">
               23.12 Content-Length header and From_ specification
           </a>
           <br>
<li>
           <a href="#moral_about_cc_copies_in_usenet" class="toc">
               23.13 Moral about CC copies in Usenet
           </a>
           <br>
</ul>

</div>



<hr>
               <A name="document_id"  id="document_id"></A>
               <h1>
               1.0 Document id

               </h1>



  <a name="general" id="general"></a>
  <h2>
      1.1 General

  </h2>





<p>
<p class="column8">
        <EM><STRONG>$Id: pm-tips.html,v 1.13 2007/10/02 15:09:43 jaalto Exp $</STRONG></EM><br>
        Homepage <a href="http://pm-doc.sourceforge.net/" >http://pm-doc.sourceforge.net/</A><br>
        URLs last checked: 2007-10-02<br>


<p class="column8">
        Procmail is powerful mail handling tool and a lot of space
        here has been devoted to discuss about UBE (aka Spam) and its
        essence.


<p class="column8">
        This is a Procmail Tips page: a collection of procmail
        recipes, instructions, howtos. You will also find many other
        interesting subjects that discuss about Internet mail in
        general: mail headers, MIME and RFCs. Another part of this
        document is dedicated to Emacs and its maili handlling
        capabilities. Emacs is powerful tool that can be used for both
        mail and news reading; available in Windows platform as well.
        The tips have been compiled from the procmail discussion list,
        from comp.mail.misc and from the author's own experiences with
        procmail.


<p class="column8">
        This document does not intend to teach the basics of procmail,
        instead you should be familiar with the procmail manual pages
        already. If you're using Windows operating system, procmail is
        available in Cygwin &lt;<a href="http://www.cygwin.com/" >http://www.cygwin.com/</A>&gt; distribution.


<p class="column8">
        You may want to read <em class="word">Nancy's</em> and <em class="word">Era's</em> procmail FAQ pages
        before this page.


<p class="column8">
        If you find errors or things to improve in this document,
        please send mail to this document's maintainer (see project
        page). If some URL is not alive any more, you may still be
        able to find it by using a WWW search such as Google.



  <a name="what_is_procmail" id="what_is_procmail"></a>
  <h2>
      1.2 What is Procmail?

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[FAQ]</span> Procmail is a mail processing utility, which can help you
        filter your mail, sort incoming mail according to sender, Subject
        line, length of message, keywords in the message, etc, implement an
        ftp-by-mail server, and much more. Procmail is also a complete
        drop-in replacement for your MDA. (If this doesn't mean anything to
        you, you may not want to know.) Procmail runs under Unix. See
        Infinite Ink's Mail Filtering and Robots page for information about
        related utilities for various other platforms, and competing Unix
        programs, too (there aren't that many of either).



  <a name="abbreviations_and_thanks" id="abbreviations_and_thanks"></a>
  <h2>
      1.3 Abbreviations and thanks

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[stephen]</span> Stephen R. van den Berg, Author of Procmail Last heard
        from stephen 1997-08 in procmail mailing list by using address
        &lt;srb A T cuci nl&gt;. Later 1998 due to his regular work activities and
        lack of time he nominated Philip Guenther to the head of Procmail
        development.


<p class="column8">
        <span class="word-ref">[aaron]</span>      Aaron Schrab        aaron+procmail A T schrab com<br>
        <span class="word-ref">[alan]</span>       Alan K. Stebbens    alan.stebbens A T openwave com<br>
        <span class="word-ref">[dan]</span>        Daniel Smith        J.Daniel.Smith A T WriteMe dt com<br>
        <span class="word-ref">[david]</span>      David W. Tamkin     dattier A T panix com<br>
        <text> Text has been rephrased or modified that does not exist in the original source.<br>
        <span class="word-ref">[ed]</span>         Edward J. Sabol     sabol A T alderaan gsfc nasa gov<br>
        <span class="word-ref">[elijah]</span>     Eli the Bearded     process A T qz little-neck ny us<br>
        <span class="word-ref">[hal]</span>        Hal Wine            hal A T dtor com<br>
        <span class="word-ref">[jari]</span>       Jari Aalto          jari aalto A T poboxes dt com<br>
        <span class="word-ref">[philip]</span>     Philip Guenther     guenther A T gac edu<br>
        <span class="word-ref">[richard]</span>    Richard Kabel       rkabel A T sequent com<br>
        <span class="word-ref">[sean]</span>       Sean B. Straw       PSE-L A T mail professional org<br>
        <span class="word-ref">[timothy]</span>    Timothy J Luoma     luomat+procmail A T luomat peak org<br>
        <span class="word-ref">[walter]</span>     Walter Dnes         waltdnes A T interlog com<br>


<p class="column8">
        <span class="word-ref">[FAQ]</span>        Procmail FAQ        era A T iki.fi<br>
        <span class="word-ref">[manual]</span>     Quote from some procmail manual page<br>
        <span class="word-ref">[maintainer]</span> As of 2000-09 the maintainer is <span class="word-ref">[jari]</span><br>


<p class="column8">
        A big thanks goes to all these people:

<ul>
	<li>1999-06-16 Mark Seiden &lt;mis A T seiden.com&gt; Did an enormous
            work to proofread the v1.74. He sent a massive 105k patch
            with many editorial corrections.
<li>1999-01-08 Steven Alexander &lt;stevena A T teleport.com&gt;
            thought that a small perl script would help me to fix
            spelling mistakes more easily. The script has been much
            better correction program than anything else.
	</li>
<li>1999 &lt;Guido.Van.Hoecke A T se.bel.alcatel.be&gt; took v1.48
            and sent a huge 55k patch to correct many grammar
            typos.
	</li>
<li>1998-10-28 Richard Kabel &lt;rkabel A T sequent.com&gt; sent
            massive patch to correct language and provided excellent
            improvement comments.
	</li>
<li>1998 Era Eriksson proof read the v1.12 and sent numerous
            corrections.
	</li>
<li>Karl E. Vogel &lt;vogelke A T c17mis.region2.wpafb.af.mil&gt;
            sent numerous new anti-spam links to be added to the
            document.
	</li>
<li>1998 John Gianni &lt;jjg A T cadence.com&gt; sent nice
            recipes: one is now in the procmail module list and the
            other ideas I have added to this tips file.
	</li>
<li>1998 Tim Potter &lt;tpot A T zip.com.au&gt; had a spare moment
	            with v1.27 and sent a patch to correct spelling mistakes.</li>
</ul>





  <a name="version_information" id="version_information"></a>
  <h2>
      1.4 Version information

  </h2>




<p>
<p class="column8">
        Here is version and file size log of the text file, which gives you
        some estimate how the document has evolved.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      v2.31   2007-07-31  519  New HTML/CSS layout
      v2.30   2006-02-15  519  Sanitized all email addresses
      v2.27   2004-10-10  516  Spam related things removed.
      v2.16   2002-08-31  596  Removed old UBE pointers.
      v2.13   2002-08-13  596  Removed old UBE pointers.
      v2.5    2002-02-01  608  Spelling checked with Emacs ispell
      v2.2    2002-01-28  608  URL links checked and updated
      v2.0    2001-08-09  608  <a href="http://pm-doc.sourceforge.net" >http://pm-doc.sourceforge.net</a> opened.
      v1.77   1999-12-27  603  Netscape spam filters added
      v1.76   1999-10-01  602  Mark Seiden's patch applied. Now under CVS.
      v1.74   1999-04-26  599  document moved to www.procmail.org
      v1.72   1999-04-21  597  Links corrected
      v1.71   1999-03-29  597  Ricochet -- Perl script to fight UBE
      v1.70   1999-02-26  592  procmail's Y2K compliance
      v1.69   1999-02-23  590  RFC and using MIME in Usenet postings
      v1.68   1998-01-29  587  Added &quot;Lua&quot; language pointer
      v1.67   1998-01-07  579  Eli's procmail recipes in module section
      v1.66   1998-12-14  578  Philip took care of bugs/patches listing
      v1.64   1998-11-26  602  More Richard's comments integrated
      v1.63   1998-10-30  595  Richard's english correction patch
      v1.60   1998-10-21  591  UMASK, .forward if procmail already is LDA
      v1.58   1998-10-12  583  SmartList and other MLM software discussed
      v1.57   1998-10-06  575  PLUS addr. Convert HTML body to text
      v1.55   1998-08-29  565  Fetching fields with formail -x
      v1.53   1998-08-24  554  Procmail doesn't pass 8bit characters
      v1.52   1998-08-24  553  Flag c forking study, procmail wish list
      v1.51   1998-08-18  541  Small changes. MIME notes
      v1.49   1998-08-10  529  Guido.Van.Hoeck's 55k patch applied
      v1.46   1998-06-24  526  Added live urls to procmail archive
      v1.45   1998-06-23  521  All recipes checked by eye. Many fixes.
      v1.44   1998-06-19  516  Detecting mailing lists with pm-jalist.rc
      v1.41   1998-06-17  510  How to disable recipe quickly with
      v1.36   1998-04-03  493  Includerc rewritten, plus addressing
      v1.34   1998-04-02  488  ORing and supreme scoring added
      v1.32   1998-03-23  471  All recipes checked (by eye)
      v1.31   1998-03-10  469  Better ordering: ORing rules discussed
      v1.29   1998-01-30  429  &quot;regexp&quot; section rewrite.
      v1.24   1997-12-30  415  up till 1996-12 is now included
      v1.17   1997-12-09  343  up till archive 1996-07 now included
      v1.14   1997-11-25  260
      v1.13   1997-11-08  218  Era's correction suggestions.
      v1.10   1997-10-13  181  archive file 1995-10's tips included
      v1.9    1997-10-11  142
      v1.8    1997-10-01  127
      v1.6    1997-09-18  94
      v1.5    1997-09-16  76
      v1.05   1997-09-14  53
      v1.01   1997-09-13  46 (k)    </PRE></TD>
    </TR>
</TABLE>



  <a name="document_layout_and_maintenance" id="document_layout_and_maintenance"></a>
  <h2>
      1.5 Document layout and maintenance

  </h2>




<p>
<p class="column8">
        In order to be able to maintain this documentation in every
        possible platform, the base version of this document is kept
        in text format, which is easily accessible and requires no
        special editors or learning a markup language like LaTex,
        Texinfo, or Linux DocBook SGML. Granted, that some other base
        format may be more suitable for multiple presentation output
        formats (like postscript, Emacs info), but in simple TEXT and
        generated HTML hopefully suffices to all needs. Also Perl and
        Emacs are cross-platform tools and easily installed, so
        getting work is hopefully no obstacle. The tools to help
        maintaining this document include (not required!):

<ul>
	<li>Emacs Editor and plug-in: Technical Text formatting package
            <em class="word">tinytf.el</em> (automatic TOC, indentation control, fontifying)
            <a href="http://tiny-tools.sourceforge.net/" >http://tiny-tools.sourceforge.net/</A>
<li>Perl  text-to-HTML conversion program
</ul>




<p class="column8">
        Text version of this file was converted into HTML with
        following command. The <samp class="word">--Out</samp> option generates file
        pm-tips.html in current directory. Some $$ tags at the top of
        file are designed to be printed by GNU RCS ident(1).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
        --html-frame                                                  \
        --title   &quot;Procmail tips page&quot;                                \
        --author  &quot;Jari Aalto&quot;                                        \
        --meta-keywords &quot;procmail, sendmail, mail, filter, FAQ, ube&quot;  \
        --meta-description &quot;Procmail tips page&quot;                       \
        --base      <a href="http://pm-doc.sourceforge.net" >http://pm-doc.sourceforge.net</a>                     \
        --document  <a href="http://pm-doc.sourceforge.net" >http://pm-doc.sourceforge.net</a>                     \
        --url       <a href="http://pm-doc.sourceforge.net" >http://pm-doc.sourceforge.net</a>                     \
        --html-body &quot;LANG=en&quot;                                         \
        --Out                                                         \
        pm-tips.txt    </PRE></TD>
    </TR>
</TABLE>


<p class="column7"><em><strong>
       1.5.1 Sending improvements</strong></em>



<p class="column8">
        If you have any spare moment, a glimpse to find some spelling
        mistakes or misuse of the verbs, please go ahead and send a
        patch to maintainer of this page. The preferred way to send
        corrections to this document is as <samp class="word">diff(1)</samp> output. Here's
        how to make corrections send them forward. Please try to use
        unified GNU diff <samp class="word">-u</samp> options and only if it's not available,
        use regular context diff option <samp class="word">-c</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      %   cp pm-tips.txt pm-tips.txt.orig

      ... load the pm-tips.txt to a text editor
      ... edit the file and save
      ... Generate the difference (a patch(1) compatible file)

      %   diff -bwu pm-tips.txt.orig pm-tips.txt &gt; pm-tips.txt.patch

      ...Send content of pm-tips.txt.diff by mail to document maintainer.    </PRE></TD>
    </TR>
</TABLE>



  <a name="about_presented_recipes" id="about_presented_recipes"></a>
  <h2>
      1.6 About presented recipes

  </h2>




<p>
<p class="column8">
        The recipes have been kept as original as possible, but a
        generalization of the ideas have been done when necessary. If
        some recipe doesn't work as announced, please a) send note to
        <span class="word-ref">[maintainer]</span> b) send mail to procmail mailing list and ask how
        to correct it. Sometimes a simple dot(.) has been used in
        regular expressions, where the right, pedantic way would have
        been to use an escaped dot. If you want to be very strict, you
        should use the escaped dot where applicable.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # free hand version     # pedantic version
      :0                      :0
      * match.this.site       * match\.this\.site    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail also accepts assignments without quotes, like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      var = value
      num = 1
      dir = /var/mail    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But in this document a strict style has been adopted, where literal
        strings are assigned with double quotes:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      var = &quot;value&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That's because the procmail code checker (Emacs package
        <em class="word">tinyprocmail.el</em>) then won't warn about missing dollar-sign, which
        might have very well been forgotten. Emacs package <em class="word">font-lock.el</em>,
        a syntax highlighting assistant, also displays double quoted string
        in color.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   If you do this...

      var = value

      #   then you might have made a typo. It is in fact not clear
      #   what was intended:

      var = &quot;value&quot;   # Did you mean:  literal assignment?
      var = $value    # Did you mean: variable assignment?    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Recipe flags are also <strong class="word">not</strong> stuck together, because the visual
        distinction of <samp class="word">:0</samp> and <samp class="word">flags</samp> is a valuable one. Reasoning for
        which flags are kept together and in which order is explained later
        in details.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Erm, all stuck]      # This may be visually more clear
      :0ABDc:                :0 A BD c:    </PRE></TD>
    </TR>
</TABLE>



  <a name="variables_used_in_recipes" id="variables_used_in_recipes"></a>
  <h2>
      1.7 Variables used in recipes

  </h2>




<p>
<p class="column8">
        These are part of the procmail module <em class="word">pm-javar.rc</em> and are used in
        recipes.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Pure newline; typical usage if you want to write
      #   Something directly to procmail's active logfile:
      #
      #       LOG = &quot;$NL message $NL&quot;

      NL = &quot;
      &quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Refer to &quot;improving Space-Tab syndrome&quot; section for more details

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      WSPC    = &quot;     &quot;               # whitespace: space + tab

      SPC     = &quot;[$WSPC]&quot;             # Regexp: space + tab
      SPCL    = &quot;($SPC|$)&quot;            # whitespace + linefeed: spc/tab/nl
      NSPC    = &quot;[^$WSPC]&quot;            # negation

      s       = $SPC                  # shortname: like perl -- \s
      d       = &quot;[0-9]&quot;               # A digit -- Perl \d
      w       = &quot;[0-9a-z_A-Z]&quot;        # A word  -- Perl \w
      W       = &quot;[^0-9a-z_A-Z]&quot;       # A word  -- Perl \W
      a       = &quot;[a-zA-Z]&quot;            # A word, only alphabetic chars    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Writing recipes is now a little easier and may look more clear at
        least to people that have accustomed reading Perl regular expression
        short names:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ Header-Name:$s+$d+$s+$d      # Matches &quot;Header: 11 12&quot;
      {
          # Matched &quot;whitespace&quot; + &quot;digit&quot; + &quot;whitespace&quot; + &quot;digit&quot;
          # Do  something
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">SUPREME</strong> = 9876543210, is the highest score value that causes
        procmail to bail out. <span class="word-ref">[david]</span> Actually the maximum is 2147483647,
        but 9876543210 is easier to remember/type and will function just as
        well.


<p class="column8">
        <strong class="word">PMSRC</strong> = Procmail module source code directory. Location where <samp class="word">*.rc</samp>
        files reside. Anywhere you want it to be. Usually $HOME/pm or
        $HOME/procmail/lib. Here you can keep the procmail files, log files and
        includerc scripts. Another common used synonym is <strong class="word">PMDIR</strong>.


<p class="column8">
        <strong class="word">SPOOL</strong> = Directory where your procmail delivers the categorized
        messages. Like mailing lists:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      list.procmail, list.lynx-users, list.emacs, list.elm    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and work mail:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      work.announcements, work.lab, work.doc, work.customer    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and your private message:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      mail.usenet, mail.private, mail.default, mail.perl    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and unimportant messages

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      junk.daemon, junk.cron, junk.ube    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you read the procmail-delivered files directly, this directory
        is usually $HOME/Mail or $HOME/mail. If you use some other software
        that reads these files as mail spool files (like Emacs Gnus), then
        this directory is typically $HOME/Mail/spool or similar.


<p class="column8">
        <strong class="word">MYXLOOP</strong> = Used to prevent re-sending messages that have already
        been handled. Typically <samp class="word">$LOGNAME@$HOST</samp>, but this can be any user
        chosen string. Make it it unique to your address. In this document
        the definition is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      MYXLOOP = &quot;X-Loop: $LOGNAME@$HOST&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">SENDMAIL</strong> = Program to deliver composed mail. Usually standard
        Unix <samp class="word">sendmail(1)</samp>, but it must have some switches with it. See man
        page for more. We use following definition in scripts:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SENDMAIL = &quot;sendmail -oi -t&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">NICE</strong> = In a Unix environment you can lower the scheduling
        priority with <samp class="word">nice(1)</samp>. If you are conscious of how many external
        processes you launch for each piece of mail it would be polite to
        lower the priority of such processes. You may see in this document
        that external processes are called with <samp class="word">NICE</samp> enabled:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 w                # Same as &quot;nice -10 script.pl&quot;
      | $NICE script.pl    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">IS</strong> functions; Functions to test file or directory attributes.
        E.g. IS_EXIST is defined as &quot;test -e&quot; and so on. The definitions of
        <strong class="word">IS</strong> functions are system-dependent. E.g. On Irix the &quot;-e&quot; option
        is not recognized and the nearest equivalent is &quot;test -r&quot;. All <strong class="word">IS</strong>
        functions are defined in the <samp class="word">pm-javar.rc</samp> module.



  <a name="about_useless_use_of_cat_award" id="about_useless_use_of_cat_award"></a>
  <h2>
      1.8 About &quot;useless use of cat award&quot;

  </h2>




<p>
<p class="column8">
        FIXME: Replace wc -l and use other example.


<p class="column8">
        Randal Schwartz, a well-known Perl programmer and Perl book writer,
        started giving rewards for the &quot;useless use of cat command&quot;
        whenever someone wrote examples without token &quot;&lt;&quot;. Like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % cat file.name.this | wc -l    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Instead he writes that the call should have been written like this,
        which saves the pipe (never mind that <samp class="word">wc</samp> can read the file
        directly; this is an example).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % wc -l &lt; file.name.this    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Paul David Fardy &lt;pdf A T morgan.ucs.mun.ca&gt;]</span> There is weight
        in the pipeline, but the true cost is in process startup. Try
        running wc 100 times on /etc/motd or on this message. My tests show
        the useless use of cat doubles the real and processing time (real,
        user, and system time are each roughly doubled):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $ cat &gt; /tmp/randall &lt;'EOF'
      [[ -n $COUNT ]] || COUNT0
      typeset -i i=1
      while (( i &lt; $COUNT )); do
              &lt; /etc/motd wc;
              (( i = i + 1 ))
      done &gt; /dev/null
      EOF

      $ cat &gt; /tmp/useless &lt;'EOF'
      [[ -n $COUNT ]] || COUNT=100
      typeset -i i=1
      while (( i &lt; $COUNT )); do
              cat /etc/motd | wc;
              (( i = i + 1 ))
      done &gt; /dev/null
      EOF

      $ set -x
      $ export COUNT0
      $ time ksh /tmp/randall
      $ time ksh /tmp/useless    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This becomes important, for example, when you decide to filter all
        your mail with procmail &ndash; looking for virus signatures for example.
        I might well decide to look only at the first 3 or 4 kilobytes.
        It's not the size of messages--most are small anyway &ndash; but the
        number of messages that cause a problem. Do you want to double the
        processing cost of all our mail? I'm looking at a system-wide
        filter for all my users' mail. I'm considering Sendmail's mail
        filter versus procmail filtering. I'll likely be using a bit of
        both. And given that all of the filtering really just getting in
        the way of legitimate traffic, it'd really piss me off if I naively
        doubled the cost.

<hr>
               <A name="procmail_pointers"  id="procmail_pointers"></A>
               <h1>
               2.0 Procmail pointers

               </h1>



  <a name="where_is_procmail_developed" id="where_is_procmail_developed"></a>
  <h2>
      2.1 Where is procmail developed

  </h2>




<p>
<p class="column8">
        Philip Guenther &lt;guenther A T gac.edu&gt; is currently taking care of and
        coordinating procmail bug fixes. Please send any procmail bugs to
        the mailing list or to <EM><a href="mailto:bug@procmail.org" >bug@procmail.org</A></EM>. The development mailing
        list is running SmarList at <EM><a href="mailto:procmail-dev@procmail.org" >procmail-dev@procmail.org</A></EM>.
        Newest Procmail code it at &lt;<a href="http://www.procmail.org/" >http://www.procmail.org/</A>&gt; and
        &lt;<a href="ftp://ftp.procmail.org/" >ftp://ftp.procmail.org/</A>&gt;.



  <a name="procmail_resources" id="procmail_resources"></a>
  <h2>
      2.2 Procmail resources

  </h2>




<p>
<p class="column8">
        Procmail is discussed in Usenet newsgroup <em class="word">comp.mail.misc</em>.


<p class="column8">
<span class="quote7">Nancy McGough &lt;nm A T noadsplease.ii.com&gt; - Prcmail Quick start</span><BR>
        <a href="http://www.ii.com/internet/robots/procmail/qs/" >http://www.ii.com/internet/robots/procmail/qs/</A><br>


<p class="column8">
<span class="quote7">Era Eriksson's Procmail FAQ and link collection</span><BR>
        <a href="http://www.iki.fi/~era/procmail" >http://www.iki.fi/~era/procmail</A>


<p class="column8">
<span class="quote7">Professor Timo Salmis's Procmail page</span><BR>
        <a href="http://www.uwasa.fi/~ts/info/proctips.html" >http://www.uwasa.fi/~ts/info/proctips.html</A>
        See Timo's &quot;Foiling Spam with an Email Password System&quot; at
        <a href="http://www.uwasa.fi/~ts/info/spamfoil.html" >http://www.uwasa.fi/~ts/info/spamfoil.html</A>


<p class="column8">
<span class="quote7">Joe Gross's short Procmail tutorial</span><BR>
        <a href="http://www.procmail.net/" >http://www.procmail.net/</A> &lt;jgross A T stimpy.net&gt;
        ...Using procmail and a
        feature of ph you can set up your own mailing list without
        needing root on your own machine.


<p class="column8">
<span class="quote7">Google's procmail pointers</span><BR>
        <a href="http://directory.google.com/Top/Computers/Software/Internet/Clients/Mail/Unix/Procmail/" >http://directory.google.com/Top/Computers/Software/Internet/Clients/Mail/Unix/Procmail/</A>


<p class="column8">
<span class="quote7">Eli on Procmail</span><BR>
        See Eli the Bearded's addressing tips at
        <a href="http://www.faqs.org/faqs/mail/addressing/" >http://www.faqs.org/faqs/mail/addressing/</A>


<p class="column8">
<span class="quote7">Concordia University's procmail page</span><BR>
        <a href="http://alcor.concordia.ca/topics/email/auto/procmail/" >http://alcor.concordia.ca/topics/email/auto/procmail/</A>
        ...People often ask how to avoid receiving &quot;spam&quot; mail, or how
        to bounce mail from someone who is annoying them. These pages
        tell you how to install procmail; you can then tailor it to do
        all those things, or whatever else you want.
        &lt;webdoc A T alcor.concordia.ca&gt;



  <a name="procmail_mode_for_emacs" id="procmail_mode_for_emacs"></a>
  <h2>
      2.3 Procmail mode for Emacs

  </h2>




<p>
<p class="column8">
        If you use Emacs, See Procmail programming mode <em class="word">tinypm.el</em>
        at &lt;<a href="http://tiny-tools.sourceforge.net/" >http://tiny-tools.sourceforge.net/</A>&gt; and it can be used
        to syntax check procmail recipes. Here is an example of its output:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *** 1997-11-24 22:13 (pm.lint) 3.11pre7 tinypm.el 1.80
      cd /users/jaalto/junk/
      pm.lint:010: Warning, no right hand variable found. ([$`']
      pm.lint:055: Pedantic, flag orer style is not standard `hW:'
      pm.lint:060: Warning, message dropped to folder, you need lock.
      pm.lint:062: Warning, recipe with &quot;|&quot; may need `w' flag.
      pm.lint:073: Warning, Formail used but no `f' flag found.    </PRE></TD>
    </TR>
</TABLE>



  <a name="procmail_module_library_project" id="procmail_module_library_project"></a>
  <h2>
      2.4 Procmail module library project

  </h2>




<p>
<p class="column7"><em><strong>
       2.4.1 Where to get various modules</strong></em>



<p class="column8">
<span class="quote7">Procmail module library</span><BR>


<p class="column8">
        Hosted at sourceforge CVS server and open for anyone to
        participate. Visit
        &lt;<a href="http://freshmeat.net/projects/procmail-lib" >http://freshmeat.net/projects/procmail-lib</A>&gt;. The idea was
        originally invented by Alan Stebbens (&lt;alan.stebbens A T
        software.com&gt;, &lt;alan.stebbens A T openwave.com&gt;).


<p class="column7"><em><strong>
       2.4.2 Terminology</strong></em>



<p class="column8">
        <em class="word">subroutine</em> = A piece of code that gets something in <samp class="word">INPUT</samp> and
        responds with <samp class="word">OUTPUT</samp>. Subroutine is not message specific.


<p class="column8">
        <em class="word">recipe</em> = A piece of code that is somewhat self contained:
        It reads something from the message or does something
        according to matches in message. Recipe may be message-specific.


<p class="column7"><em><strong>
       2.4.3 Foreword to using modules</strong></em>



<p class="column8">
        In the module listing, some of the modules are recipes and some can
        be considered subroutines. Let's take the address exploder module
        that was discussed a while ago. First, visualise following familiar
        programming language pseudo code:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (ret-val1, ret-val2 ...) = Function(arg1, arg2, arg3 ...)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <em class="word">Function</em> may return multiple arguments and multiple arguments can
        be passed to it. Clear so far. Let's show how this applies to
        procmail modules:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      RC_FUNCTION  = $PMSRC/pm-xxx.rc # name the subroutine/module
      RC_FUNCTION2 = ...

      INPUT       = &quot;value&quot;           # Set the arg1 for module
      INCLUDERC   = $RC_FUNCTION      # Call Function( $arg1 )

      :0                              # Examine function's return value
      * ERROR ?? yes
      ...    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This should be pretty clear too. You just have to look into the
        subroutine/module which you intend to use, to find out what
        arguments it wants which you <strong class="word">need</strong> <strong class="word">to</strong> set (INPUT) before calling
        it. The documentation also tells you what values are returned, e.g.
        one of them was ERROR.


<p class="column8">
        If it were recipe/module, the call would be almost the same, but
        instead of returning values, the recipe/module most likely does
        something to your message or writes something to the data files
        etc. A <em class="word">Recipe/module</em> is much higher level, because it may
        call multiple subroutine/modules. The distinction between
        subroutine and recipe module type is not crystal clear, but I hope
        the above will clarify a bit the Procmail module/subroutine/recipe
        concept.


<p class="column7"><em><strong>
       2.4.4 Header file modules</strong></em>



<p class="column8">
        These are like #include .h files in C, they define common
        variables, but do not contain actual code.

<ul>
	<li><em class="word">pm-javar.rc</em> &ndash; Defines standard variables: SPC WSPC NSPC SPCL and
            perl styled \s \d \D \w \W and \a \A (alphabetic characters only)
<li><em class="word">headers.rc</em> &ndash; From Alan's procmail-lib. Define standard regexp
	            and macros: address, from, to, cc, list_precedence</li>
</ul>




<p class="column7"><em><strong>
       2.4.5 General modules</strong></em>


<ul>
	<li><em class="word">pm-jafrom.rc</em> &ndash; Derive FROM field without calling <samp class="word">formail</samp>
            unnecessarily. If all else fails, use formail.
<li><em class="word">get-from.rc</em> &ndash; From Alan's procmail-lib. get the &quot;best&quot; From
            address. Sets FROM and FRIENDLY, the latter being the &quot;friendly&quot;
            user name sans address.
	</li>
<li><em class="word">pm-jaaddr.rc</em> &ndash; Subroutine to extract various mail components
            from INPUT. Like address=foo@example.com, net=com, account=foo...
	</li>
<li><em class="word">pm-jastore.rc</em> &ndash; Subroutine for general mailbox delivery.
            Define MBOX as the folder where to drop
            message and this subroutine will store it appropriately.
            Supports single mboxes, &quot;.gz&quot; mbox files, directory files and
	            MH folders with rcvstore.</li>
</ul>




<p class="column7"><em><strong>
       2.4.6 Spam modules</strong></em>



<p class="column8">
        Read &quot;Thoughts about increasing spam annoyance&quot; at
        &lt;<a href="http://pm-doc.sourceforge.net/README.html" >http://pm-doc.sourceforge.net/README.html</A>&gt; which
        explains these modules better in context &quot;2.0 A lightweight
        UBE block system with pure procmail&quot;.

<ul>
	<li><em class="word">pm-jaube.rc</em> &ndash; Subroutine to investigate the message
            for know spam pattern like numeric address, invalid address,
            Pegasus bulk mail, advertising slogans etc. This is the
            generic Spam detection module. Needs only one external
            program: nslokup1(1) to verify the sender's domain. The
            results of classification appears in returned variables
            that the caller can use for deciding what to do. Optional
            headers can be added to the message to announce the
            results.
<li><em class="word">pm-jaube-keywords.rc</em> &ndash; Subroutine to scrutinize the
            message against known spam keywords. This is the &quot;bare
            bones&quot; and very simplistic (but fast) way to check if
            message is Spam. The results of classification appears in
            returned variables that the caller can use for deciding
            what to do.
	</li>
<li><em class="word">pm-jaube-prg-runall.rc</em> &ndash; An Interface module to call
            external statistical bayesian spam classifier programs.
            This subroutine will call other modules, like
            pm-jaube-prg-bogofilter.rc (for bogofilter),
            pm-jaube-prg-bsfilter.rc (for bsfilter) and many many more
            that help fighting spam. It is possible to activate
	            specific bayesian programs available in current host.</li>
</ul>




<p class="column7"><em><strong>
       2.4.7 Mime modules</strong></em>


<ul>
	<li><em class="word">pm-jamime.rc</em> &ndash; Subroutine to read MIME headers and put the
            mime version, boundary string, content-type information to
            variables.
<li><em class="word">pm-jamime-decode.rc</em> &ndash; recipe to decode quoted-printable
            or base64 encoding in the body.
	</li>
<li><em class="word">pm-jamime-kill.rc</em> &ndash; Recipe for attachment killing: wipes out the
            extra mime cruft leaving only the plain text. Applications for
            killing: ms-tnef attachment (MS Explorer 7k),
            HTML attachments (Netscape, MS Express) vcard (Netscape),
            PCX attachment (Lotus Notes).
	</li>
<li><em class="word">pm-jamime-save.rc</em> &ndash; Recipe for saving simple file attachment.
            When you receive <strong class="word">ONE</strong> file attachment in a message, this
            recipe can save it in a separate directory. The content is
	            also decoded (base64,qp) while saving.</li>
</ul>




<p class="column7"><em><strong>
       2.4.8 Filtering message body or headers</strong></em>


<ul>
	<li><em class="word">pm-jadaemon.rc</em> &ndash; Handle DAEMON messages by changing subject to
            reflect a) the error reason b) to whom the message was originally
            sent c) original subject sent and what was the subject. Store the
            DAEMON messages to separate folder.
<li><em class="word">pm-jasubject.rc</em> &ndash; Standardize Subject &quot;Re<span class="super">32</span>: FW: Sv: message&quot;
            or any other derivate to de facto &quot;Re: message&quot;
	</li>
<li><em class="word">pm-janetmind.rc</em> &ndash; <span class="word-ref">[obsolete]</span>
            Reformat minder.netmind.com messages (no longer exists 2005).
	            The default 4k message is shortened to a few important lines.</li>
</ul>




<p class="column7"><em><strong>
       2.4.9 Mailing list modules</strong></em>


<ul>
	<li><em class="word">pm-jalist.rc</em> &ndash; Subroutine to extract mailing list name from
            message. Do you need to add a new recipe to your .procmailrc
            every time you subscribe to new mailing list? If you do,
            take a look at this module, which examines the message and
            defines variable <samp class="word">LIST</samp> to hold the mailing list name. You
            can use it directly to save the messages adaptively to
            correct folders. No more hand work and manual storing
	            of mailing list messages.</li>
</ul>




<p class="column7"><em><strong>
       2.4.10 Miscellaneous modules</strong></em>


<ul>
	<li><em class="word">pm-jaempty.rc</em> &ndash; check if message body is empty (nothing
            relevant). Define variable BODY_EMPTY to &quot;yes&quot; or &quot;no&quot; if
            message is empty.
<li><em class="word">pm-janslookup.rc</em> &ndash; Run nslookup on given address. If you
            compose return address with &quot;formail -rt -x To:&quot; you can
            verify if domain is registered before sending reply. Uses cache
            for already looked up domains. This module is alos used
            by the <em class="word">pm-jaube.rc</em> to verify the sender's domain.
	</li>
<li><em class="word">guess-mua.rc</em> &ndash; Guess the Mail User Agent and set MUA:
	            MH,PINE,MAIL</li>
</ul>




<p class="column7"><em><strong>
       2.4.11 Low-level Date and time handling</strong></em>



<p class="column8">
        For these, you get the date string from somewhere, then feed
        it to some of these subroutines:

<ul>
	<li><em class="word">pm-jatime.rc</em> &ndash; a low-level subroutine. Parse time &quot;hh:mm:ss&quot;
            from variable INPUT
<li><em class="word">pm-jadate1.rc</em> &ndash; a low-level subroutine. Parse date
            &quot;Tue, 31 Dec 1997 19:32:57&quot; from variable INPUT
	</li>
<li><em class="word">pm-jadate2.rc</em> &ndash; a low-level subroutine. Parse ISO standard date
            &quot;1997-11-01 19:32:57&quot; from variable INPUT
	</li>
<li><em class="word">pm-jadate3.rc</em> &ndash; a low-level subroutine. Parse date
            Tue Nov 25 19:32:57 from variable INPUT
	</li>
<li><em class="word">pm-jadate4.rc</em> &ndash; Call shell command &quot;date&quot; once to construct RFC
            &quot;Tue, 31 Dec 1997 19:32:57&quot; and parse the YY MM HH and other
            values. You usually use this subroutine if you can't get the date
	            anywhere else.</li>
</ul>




<p class="column7"><em><strong>
       2.4.12 Higher-level Date and time handling</strong></em>



<p class="column8">
        You use these recipes to get the date directly from the message:

<ul>
	<li><em class="word">pm-jadate.rc</em> &ndash; higher-level recipe. Read date from message's
            headers: From_ Received, or call shell <samp class="word">date</samp> if none succeeds.
<li><em class="word">date.rc</em> &ndash; higher-level recipe.
            From Alan's procmail-lib: parse date or from headers
	            Resent-Date:, Date, and From</li>
</ul>




<p class="column7"><em><strong>
       2.4.13 Forwarding and account modules</strong></em>


<ul>
	<li><em class="word">pm-japop3.rc</em> &ndash; Pop3 movemail implemented with procmail. You can
            send a &quot;pop3&quot; request to move your messages from account X to
            account Y. Each message is send separately. This recipe listens
            to &quot;pop3&quot; requests.
<li><em class="word">pm-jafwd.rc</em> &ndash; control forwarding remotely. You can change the
            forward address with a &quot;control message&quot; or turn
            forwarding on/off with a &quot;control message&quot;
	</li>
<li><em class="word">pm-japing.rc</em> &ndash; Send short reply when subject contains the word
            &quot;ping&quot; to show that the account is up and mail address is
            valid.
	</li>
<li><em class="word">correct-addr.rc</em> &ndash; From alan's procmail lib. To help forward mail
            from an OLD address to a NEW address, and do some mailing list
            mail management. This recipe file is intended to make it easy
            for users to forward their mail from their old address to a new
            address, and, at the same time, educate their correspondents
	            about it by CC'ing them with the mail.</li>
</ul>




<p class="column7"><em><strong>
       2.4.14 Vacation modules</strong></em>


<ul>
	<li><em class="word">pm-javac.rc</em> &ndash; A framework for your vacation replies. This
            recipe will handle the vacation cache and compose an initial
            reply; which you only need to fill in. (Like putting vacation
            message to the body)
<li><em class="word">ackmail.rc</em> &ndash; From Alan's procmail lib. procmail rc to
            acknowledge mail (with either a  vacation message, or an
	            acknowledgment)</li>
</ul>




<p class="column7"><em><strong>
       2.4.15 Message-id based modules</strong></em>


<ul>
	<li><em class="word">pm-jadup.rc</em> &ndash; Handle duplicate messages by Message-Id.
            Store duplicate message in separate folder.
<li><em class="word">dupcheck.rc</em> &ndash; From Alan's procmail-lib. If the current mail has
            a &quot;Message-Id:&quot; header, run the mail through &quot;formail -D&quot;,
            causing duplicate messages to be dropped. Can use MD5 hash in
	            cache.</li>
</ul>




<p class="column7"><em><strong>
       2.4.16 Cron modules</strong></em>


<ul>
	<li><em class="word">pm-jacron.rc</em> &ndash; A framework for your daily cron tasks. This
            recipe contains all the needed checks to ensure that your
            includerc is called whenever a day changes. (Day change is
            subject to messages you receive). Your own cron includerc is
	            run once a day.</li>
</ul>




<p class="column7"><em><strong>
       2.4.17 Backup modules</strong></em>


<ul>
	<li><em class="word">pm-jabup.rc</em> &ndash; Save messages to backup directory and keep only N
            messages per day. Idea by John Gianni. Note:
            The implementation will always call shell for each message you
            receive; so using this module is not recommended if you get
            many messages per day. Instead, use the cron module to clean
            the messages' backup directory only once a day, and not every time
	            a message arrives.</li>
</ul>




<p class="column7"><em><strong>
       2.4.18 Confirmation modules</strong></em>


<ul>
	<li><em class="word">pm-jacookie.rc</em> &ndash; Handle cookie (unique id) confirmations.
            Also known as Procmail authentication service (PAS). This
            simple procmail module will accept messages only from
            users who have returned a &quot;cookie&quot; key. You can use this
            to to protect some services before access. Uses subroutine
            pm-jacookie1.rc, which generates the unique cookie; CRC 32
            by default. <strong class="word">NOTE:</strong> Please read page
            &lt;<a href="http://pm-lib.sf.net/README.html" >http://pm-lib.sf.net/README.html</A>&gt; before you may start
            thinking to use this module as a generic Challenge-Response
	            module to reduce spam.</li>
</ul>






  <a name="procmail_code_to_filter_ube" id="procmail_code_to_filter_ube"></a>
  <h2>
      2.5 Procmail code to filter UBE

  </h2>




<p>
<p class="column10"><em class="quote10">
          <strong class="word">Sysadms</strong> <strong class="word">remember</strong> : Spam filtering is much more
          efficiently done in the MTA, especially if you are just
          looking at From and To lines. For example, you can setup in
          Exim a rule that blocks \d.*@aol\.com (that is any aol.com
          local part that begins with a digit). AOL guarantees that
          <strong class="word">none</strong> of their addresses begin with a digit. Exim rejects
          such bogus addresses at the SMTP level before the message is
          received.</em>



<p class="column8">
<span class="quote7">pm-jaube.rc - Procmail module library's UBE filter</span><BR>
        After Daniel Smith posted his spam recipes to procmail mailing
        list, the code was adopted and more generalized to handle lot
        more UBE. Module needs no special setup and can be installed
        via simple INCLUDERC. All UBE detection happens using procmail
        rules with no external files needed. The module is available
        in Procmail module library at
        &lt;<a href="http://freshmeat.net/projects/procmail-lib" >http://freshmeat.net/projects/procmail-lib</A>&gt;.


<p class="column8">
<span class="quote7">Catherine A. Hampton's Spambouncer</span><BR>
        <a href="http://www.spambouncer.org/" >http://www.spambouncer.org/</A>
        ...The attached set of procmail recipes/filters, which I call
        The Spam Bouncer, are for users who are sick of spam (unsolicited
        junk mail) and want to filter it out of their mail as easily
        as possible. These recipes can be used as shared recipes for a
        whole system, or by an individual for their own mailbox only.


<p class="column8">
<span class="quote7">Junkfilter</span><BR>
        <a href="http://www.pobox.com/~gsutter/junkfilter/" >http://www.pobox.com/~gsutter/junkfilter/</A> and
        <a href="http://sourceforge.net/projects/junkfilter" >http://sourceforge.net/projects/junkfilter</A>
        ...Junkfilter is a user-configurable procmail-based filter system
        for electronic mail. Recipes include checks for forged headers,
        key words, common spam domains, relay servers and many others.


<p class="column8">
<span class="quote7">Nonplussed Spambouncer</span><BR>
        <a href="http://www.cs.mu.OZ.AU/~amb/" >http://www.cs.mu.OZ.AU/~amb/</A>
        ...Procmail include file for bouncing spam. Requires sendmail with
        plussed users.

<hr>
               <A name="dry_run_testing"  id="dry_run_testing"></A>
               <h1>
               3.0 Dry run testing

               </h1>



  <a name="what_is_dry_run_testing" id="what_is_dry_run_testing"></a>
  <h2>
      3.1 What is dry run testing?

  </h2>




<p>
<p class="column8">
        It means that you call your procmail test script directly with sample
        test mail

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % procmail $HOME/pm/pm-test.rc &lt; $HOME/tmp/test-mail.txt    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The script pm-test.rc has the procmail recipe you're testing
        or improving. The test-mail.txt is any valid mail message
        containing the headers and body. You can make one with any
        text editor, e.g. <samp class="word">vi</samp>, <samp class="word">pico</samp>, <samp class="word">nano</samp>, <samp class="word">emacs</samp> or <samp class="word">xemacs</samp>.
        Here's a simple test mail skeleton. Copy verbatim:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From: me@example.com
      To: me@example.com (self test)
      X-info: I'm just testing

      BODY OF MESSAGE SEPARATED BY EMPTY LINE
      txt txt txt txt txt txt txt txt txt txt    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Remember that you can define environment variables as well in
        the dry run call. Here's an example where procmail just executes
        the script and does nothing fancy.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % procmail VERBOSE=on DEFAULT=/dev/null \
          ~/pm/pm-test.rc &lt; ~/txt/test-mail.txt    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Suppose the script prints something to log files, but you'd instead
        like to get it all dumped to screen. No problem, first find out
        your tty value by calling <samp class="word">tty</samp> at shell prompt and pass
        that on the command line. Here the default LOGFILE is directed
        to take care of redirecting &quot;LOG=&quot; commands and statement:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  `tty' tells what to fill in /dev/..

      % procmail VERBOSE=on DEFAULT=/dev/null   \
          LOGFILE=/dev/pts/0                    \
          ~/pm/pm-test.rc &lt; ~/txt/test-mail.txt    </PRE></TD>
    </TR>
</TABLE>



  <a name="why_the_from_field_is_not_okay_after_dry" id="why_the_from_field_is_not_okay_after_dry"></a>
  <h2>
      3.2 Why the From field is not okay after dry run?

  </h2>




<p>
<p class="column10"><em class="quote10">
          Why it now says &quot;From foo@bar Mon Sep 8 14:38:06 1997&quot;?</em>



<p class="column8">
        Don't worry about this. It's a side-effect of running the
        message through formail after having generated any auto-reply
        &ndash; the auto-reply generated by &quot;formail -rt&quot; doesn't have a
        &quot;From &quot; header (it's pointless for outgoing messages), so the
        second formail adds one, not knowing that it'll just be
        ignored by sendmail later (well, sendmail will extract the
        date from it, but that's ignorable). You only see it because
        you're saving to a folder instead of the mailing it.



  <a name="getting_default_value_of_a_procmail_variable" id="getting_default_value_of_a_procmail_variable"></a>
  <h2>
      3.3 Getting default value of a procmail variable

  </h2>




<p>
<p class="column8">
        There's always this way to learn a variable's initial value
        (note the strong quotes), which Stephen uses to get procmail's
        value for $SENDMAIL in the scripts that build SmartList:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      procmail LOG='$PATH' DEFAULT=/dev/null /dev/null &lt; /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Since LOGFILE hasn't been defined, $PATH will be printed to the
        screen. One caution: if there are any variables in the definition
        of $PATH (such as $HOME), they'll be expanded in the output.

<hr>
               <A name="things_to_remember"  id="things_to_remember"></A>
               <h1>
               4.0 Things to remember

               </h1>



  <a name="get_the_newest_procmail" id="get_the_newest_procmail"></a>
  <h2>
      4.1 Get the newest procmail

  </h2>




<p>
<p class="column8">
        Lot of troubles surface only because you have an old
        procmail version. Be sure to have the latest. Knock your sysadm or
        ISP until he installs this version and don't give up, if you're
        serious about using procmail. Here is a command to check your
        procmail version number:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % procmail -v    </PRE></TD>
    </TR>
</TABLE>



  <a name="cshs_tilde_is_not_supported" id="cshs_tilde_is_not_supported"></a>
  <h2>
      4.2 Csh's tilde is not supported

  </h2>




<p>
<p class="column8">
        Real csh or Emacs freaks have grown accustomed to using tilde (~)
        everywhere, but must drop that habit now. Procmail doesn't support it;
        just use <samp class="word">$HOME</samp>. When you write procmail recipes, think <em class="word">sh</em> not
        <em class="word">csh</em>. This mind set will automatically get your brain tuned to the
        right programming habits.



  <a name="be_sure_to_write_the_recipe_starting_right" id="be_sure_to_write_the_recipe_starting_right"></a>
  <h2>
      4.3 Be sure to write the recipe starting right

  </h2>




<p>
<p class="column8">
        The recipe starts with <samp class="word">:0</samp> or just with <samp class="word">:</samp> but the latter
        one is somewhat dangerous and easy to miss. Beware writing it
        <samp class="word">0:</samp> as it happens easily. Always put a zero after the colon
        that begins the recipe. In the first versions of procmail, you
        would put the number of conditions, with a default of 1. That
        was annoying, and the computer can do the counting easier, so
        Stephen made it so that a count of 0 indicates that the
        conditions are all the lines beginning with a <samp class="word">*</samp>. The default
        is one, unless the <samp class="word">a</samp>, <samp class="word">A</samp> , <samp class="word">e</samp>, or <samp class="word">E</samp> flags is given, in
        which case the default is zero. <em class="word">ALWAYS</em> <em class="word">START</em> a <em class="word">RECIPE</em>
        <em class="word">WITH</em> <samp class="word">:0</samp>.



  <a name="always_set_shell" id="always_set_shell"></a>
  <h2>
      4.4 Always set SHELL

  </h2>




<p>
<p class="column8">
        If your login shell is a C shell (csh or tcsh), avoid havoc:
        as a precaution, always put following at the top of your
        <samp class="word">$HOME/.procmailrc.</samp>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SHELL = /bin/sh    </PRE></TD>
    </TR>
</TABLE>


<p class="column7"><em><strong>
       4.4.1 If system has no /bin/sh and you're forced to use csh/tcsh</strong></em>



<p class="column8">
        <span class="word-ref">[&lt;kuhlmav A T elec.canterbury.ac.nz&gt;]</span> Csh and tcsh execute the
        cshrc first, THEN if, and only if it is the login shell (not<br>
        a sub shell) it executes the .login, which should contain
        basic important system setting like <samp class="word">stty</samp> commands. Likewise,
        bash and ksh users are taught to define and export PATH in
        profile, so our per-shell startup files would not have<br>
        clobbered the PATH set in .procmailrc the way your .cshrc did.


<p class="column8">
        <span class="word-ref">[philip]</span> ...I have been told by other sysadmins that there are
        systems on which csh was hacked to source the .login before the
        cshrc. For various reasons I suspect these to be systems based on<br>
        older versions of BSD (say, 2.3 BSD).


<p class="column8">
        As for tcsh, the order in which the .login and .cshrc is sourced is
        a compile-time option which defaults to the .cshrc (or .tcshrc)
        before the .login. There may be some wackos out there who change
        the default in memory of the system(s) that they were raised on. I
        suggest electroshock as the proper treatment.


<p class="column10"><em class="quote10">
          ...done sys admin on Crays, Convexes, Suns, SGIs, Decs, PC
          running BSDI, Linux and Free BSD, and I have never run into a
          system where the .cshrc is sourced AFTER the .login. If someone
          goes to the trouble to change the order, I would love to know a
          valid reason for it.</em>



<p class="column7"><em><strong>
       4.4.2 Procmail won't work well with SHELL set to csh derivate</strong></em>



<p class="column8">
        <span class="word-ref">[1998-08-17 PM-L &lt;kuhlmav A T elec.canterbury.ac.nz&gt; Volker Kuhlmann]</span>
        ...The blame lies with procmail and its documentation. Obviously,
        procmail is programmed with the assumption that the login shell is
        a sh derivative. This assumption is a) not very nice, and b) not
        stated in the otherwise very good documentation. Of course a user
        can set SHELL to tcsh. If then procmail is too stupid to hack it,
        it ought to say so clearly, and the above-mentioned questions of
        people using tcsh will disappear from this list. One could also be
        nice and point out pitfall (3) mentioned above in the procmail
        docs. It is customary to have terminal configuration in .login. If
        it is shifted to .cshrc it should be properly surrounded by if ..
        endif. Perhaps it is not customary to configure the terminal in
        bashrc (where else then? - only a rhetorical question), but that<br>
        is no reason to blame it on tcsh.


<p class="column8">
        My .cshrc only setenvs the environment when it is a login shell
        (shell level 1). Obviously procmail runs a login shell. As I said
        earlier, there are good reasons for setting a full PATH
        independently whether the shell is interactive or not. So, when
        procmail executes programs with SHELL=tcsh, PATH is set to the tcsh
        defaults. That may or may not be desirable, depending on the
        individual case. No problem with that and avoidable (run tcsh with
        -f). Nice if it was in the procmail docs.


<p class="column8">
        But then, the PATH getting clobbered is not the point here (just a
        side-effect I didn't realize until 2 people pointed it out).



  <a name="check_and_set_path" id="check_and_set_path"></a>
  <h2>
      4.5 Check and set PATH

  </h2>




<p>
<p class="column8">
        It is very likely that the default PATH environment variable
        that your <samp class="word">$HOME/.procmailrc</samp> sees it not enough. To play
        safe, so that all the needed binaries can be found when
        escaping to shell in .procmailrc, set the <samp class="word">PATH</samp> variable as a
        very first statement. Adding paths that don't exist in another
        system but does exists in the other makes it possible to use
        the same <samp class="word">$HOME/.procmail</samp> on multiple servers (Like HP, SUN,
        IBM, Linux)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      PATH = $HOME/bin:\
      /usr/contrib/bin:\
      /bin:/usr/bin:/usr/lib:/usr/ucb:/usr/sbin:\
      /usr/local/bin:/opt/local/bin:\
      /vol/bin:/vol/lib:/vol/local/bin:${PATH}    </PRE></TD>
    </TR>
</TABLE>



  <a name="keep_the_log_on_all_the_time" id="keep_the_log_on_all_the_time"></a>
  <h2>
      4.6 Keep the log on all the time

  </h2>




<p>
<p class="column8">
        It's best that you put these variables at the very start of
        your .procmailrc. When you start using procmail, you also want to know
        all the time what's happening there and why your recipes
        didn't work as expected. The answer to almost all your questions can
        be found in the log file. As the log file will grow to be quite big,
        remember to set up a cron job to keep it moderate size.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LOGFILE     = $PMSRC/pm.log
      LOGABSTRACT = &quot;all&quot;
      VERBOSE     = &quot;on&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="never_add_a_trailing_slash_for_directories" id="never_add_a_trailing_slash_for_directories"></a>
  <h2>
      4.7 Never add a trailing slash for directories

  </h2>




<p>
<p class="column8">
        Drop the trailing slash: it'll choke if you ever end up on
        Apollo's DomainOS where double slashes are network references.
        If the directory has a trailing slash, it will choke on most
        OSes (they treat it like &quot;/.&quot;).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      DIR         = /full/path/to/www/directory/    # Wait...
      FILE        = $ARCHIVEDIR/file                # Ouch !    </PRE></TD>
    </TR>
</TABLE>



  <a name="remember_what_term_delivered_means" id="remember_what_term_delivered_means"></a>
  <h2>
      4.8 Remember what term DELIVERED means

  </h2>




<p>
<p class="column8">
        When procmail delivers a piece of mail, whether to a file or a
        pipe-command, if the write succeeds, then the mail is
        considered to have been delivered, and processing stops with
        that recipe file. Here is the relevant text from man page:


<p class="column10"><em class="quote10">
          ...There are two kinds of recipes: delivering and non-delivering
          recipes. If a delivering recipe is found to match, procmail
          considers the mail (you guessed it) delivered and will cease
          processing the rcfile after having successfully executed the
          action line of the recipe. If a non-delivering recipe is found to
          match, processing of the rcfile will continue after the action
          line of this recipe has been executed.</em>




  <a name="beware_putting_comment_in_wrong_places" id="beware_putting_comment_in_wrong_places"></a>
  <h2>
      4.9 Beware putting comment in wrong places

  </h2>




<p>
<p class="column8">
        You like commenting a lot, sticking them everywhere possible?
        Yes, I do that too, and got into trouble because one is not that
        free to comment code in procmail. Pay attention to the following
        example

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0          # comment, nice tune...
      * condition # OUCH, Ouch, ouch. This comment must not be here!!
          #         Hm, Old procmail versions don't understand this
          #         Are you sure you want to put comments inside
          #         Condition line?
      * condition
      {               # comment ok
                      # comment ok
          :0          # comment ok
          /dev/null   # comment ok
      }               # comment ok    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        So, the place to watch is the <em class="word">condition</em> line. Later procmail
        versions may understand those, but if you intend to share your
        recipe, play it safe and think about backward portability.



  <a name="brace_placement" id="brace_placement"></a>
  <h2>
      4.10 Brace placement

  </h2>




<p>
<p class="column8">
        Be careful with your braces and remember that old procmail
        versions aren't as forgiving as newer versions. Below you see
        classical &quot;Test OK condition first, and if that fails then do
        something else&quot;. See the side comments.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
                          # No space allowed here!
      {}                  # Wrong, at least _one_ empty space
      :0 E
      {do_something }     # Again mistake, must have surrounding spaces    </PRE></TD>
    </TR>
</TABLE>



  <a name="local_lockfile_usage" id="local_lockfile_usage"></a>
  <h2>
      4.11 Local lockfile usage

  </h2>




<p>
<p class="column8">
        Lock files are only needed when procmail is doing something that
        should be serialized, i.e., when only one process at a time should
        be doing it.


<p class="column8">
        This generally means that any time you write to a file, you should
        have a local lock, preferably based on the name of the file being
        written to. Forwarding actions ('!'), and 99% of all filters don't
        need lock files. However, if a filter action writes to a file while
        filtering, then you may need a lock. Procmail always does kernel
        locking when it writes mail to files via simple file actions. So
        even if you forgot the lock colon, procmail tries to play safe if
        kernel locking has been compiled in.


<p class="column8">
        Beware misplacing the lock colon(:)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
       :0: a      # Ouch! Wrong unless you want a lock file named a
       :0 a:      # Okay.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Note that in delivering recipes where you manually write the
        content, you must use local lock file with <samp class="word">&gt;</samp> token, because
        procmail can't determine lock by itself. It can only determine
        the lock file from the <samp class="word">&gt;&gt;</samp> token. However, putting a lock
        file on a recipe like this is, of course, utterly useless. So
        you might as well omit the locking entirely.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Save last body of message to file mail.body

      :0 b:  mail.body$LOCKEXT
      | cat &gt; mail.body    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>If the command line in the procmail rcfile contains ">",
            a name for the local lock file will be implicit, and the second
            colon alone is enough.
<li>If the command doesn't write to a file, or doesn't write to the
            same file as anything else (including a matching letter that makes
            procmail run the same command) that might run at the same time,
	            the local lock file is unnecessary.</li>
</ul>




<p class="column8">
        Watch this too. A nesting block that does not launch a clone
        cannot take a local lock file on the recipe that starts the
        braces. A nesting block that does launch a clone can. (see the
        error)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0: file$LOCKEXT
      {
          #  error: &quot;procmail: Extraneous local lock file ignored&quot;
          #  - This lock file will be ignored
          #  - If the recipes inside the braces try to use file.lck
          #    as  a lock file, then you'll have a deadlock situation.

          :0 :
          /tmp/tmp.mbx
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Let me also explain why the <samp class="word">w</samp> is so important. Notice, that the
        two here are equivalent. The <samp class="word">W</samp> here is implicit. <strong class="word">NOTE</strong>: this is
        only true on the recipe that opens a nested block. On a recipe with
        a program, forward, or delivery action, <samp class="word">W</samp>' is different from <samp class="word">w</samp>
        is different from missing both.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c: file$LOCKEXT      :0 Wc: file$LOCKEXT
      { ... }                 { ... }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        To quote the comment in source code, &quot;try and protect the user from
        his blissful ignorance&quot;. The parent will always wait for the cloned
        child to exit when a lock file is involved. The only question is
        whether or not it should be logged. If you want failure of the
        cloned child to be logged, then you should use the <samp class="word">w</samp> flag, ala:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 wc: file$LOCKEXT
      { ... }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A local lockfile can be used to lock a clone; the parent procmail
        will remove it when the clone exits (thus it serves as a global
        lock file for the clone). If the braced block does not launch a
        clone, asking for a local lock file generates an error.



  <a name="global_lockfile" id="global_lockfile"></a>
  <h2>
      4.12 Global lockfile

  </h2>




<p>
<p class="column8">
        If you want to block everything while the recipe runs, even
        during the <strong class="word">conditions</strong>, use global lock. For example in this
        construct the <samp class="word">formail</samp> which updates the message-id cache
        file must be protected with a global lock file.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      MID_CACHE_LEN   = 8192
      MID_CACHE_FILE  = $PMSRC/msgid.cache
      MID_CACHE_LOCK  = $PMSRC/msgid.cache$LOCKEXT

      LOCKFILE        = $MID_CACHE_LOCK

      :0
      * ^Message-ID:
      * ? $FORMAIL -D $MID_CACHE_LEN $MID_CACHE_FILE
      {
              LOG = &quot;dupecheck: discarded $MESSAGEID from $FROM $NL&quot;

              :0                  # no lockfile !
              $DUPLICATE_MBOX
      }

      LOCKFILE                    # kill variable    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You cannot use local lockfile as below:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 : $MID_CACHE_FILE$LOCKEXT
      *   ^Message-ID:
      * ? $FORMAIL -D $MID_CACHE_LEN $MID_CACHE_FILE    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        because the local lock file named on the flag line will be created
        only if the conditions have matched and the action is attempted.


<p class="column8">
        One more note: watch carefully, that there is <strong class="word">no</strong> <samp class="word">:</samp> lock when
        delivering to <samp class="word">DUPLICATE_MBOX</samp> because the outer global lock file
        already prevents all other procmail instances from executing this
        part of the recipe.



  <a name="gee_where_do_i_put_all_those" id="gee_where_do_i_put_all_those"></a>
  <h2>
      4.13 Gee, where do I put all those ! * $ ??

  </h2>




<p>
<p class="column8">
        Ahem. I can't tell you exactly what to do or how to write your own
        procmail recipes, but I can show you an example. Here is one possible
        style for condition line token order:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ! ? BH VAR ?? test    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That won't say much unless you see something to compare with. Here
        is one perfectly valid rule, but like the above style.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ ^Subject:.*$VAR
      *! ^From:.*some
      *B ! ?? match-the-string-in-body
      *$? $IS_EXIST $FILE
      *VARIABLE ?? set    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It might be better to line up things in condition lines. The first
        column is reserved for dollar sign, the second for <em class="word">not</em> operator
        and so on. The key here is, that it is possible to see at a glance
        if I variable expansion dollar in the line (leftmost).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$       ^Subject:.*$VAR
      *  !      ^From:.*some
      *  ! B ?? match-the-string-in-body
      *$ ?      $IS_EXIST $FILE
      *         VARIABLE ?? set
       | | |
       | | |
       | | What is matched: (H)eader portion, (B)ody or (HB) both.
       | | The (??) associative operator is required.
       | |
       | Not operator (!) or shell call (?)
       |
       Variable expansion (important)    </PRE></TD>
    </TR>
</TABLE>



  <a name="if_you_send_an_automatic_reply_use_xloop_header" id="if_you_send_an_automatic_reply_use_xloop_header"></a>
  <h2>
      4.14 If you Send an automatic reply, use X-loop header

  </h2>




<p>
<p class="column8">
        Do not send automatic reply without checking &quot;! ^FROM_DAEMON&quot;
        condition and always include <samp class="word">X-Loop</samp> header and check its existence
        to prevent mail loops

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *    conditions-for-auto-reply
      *$ ! ^$MYXLOOP
      *  ! ^FROM_DAEMON
      | $FORMAIL -A &quot;$MYXLOOP&quot; ...other-headers...    </PRE></TD>
    </TR>
</TABLE>



  <a name="avoid_extra_shell_layer_and_check_command_for_shellmetas" id="avoid_extra_shell_layer_and_check_command_for_shellmetas"></a>
  <h2>
      4.15 Avoid extra shell layer and check command for SHELLMETAS

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[dan]</span> It is very important to study your shell command calls and try to
        save the overload of the extra layer of shell. It may be extra work
        once when you write your rcfile but it saves effort on each piece of
        arriving mail. When procmail sees a character from <samp class="word">SHELLMETAS</samp>, it
        runs

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Default SHELLMETAS: &amp;|&lt;&gt;~;?*[
      # Default $SHELLFLAGS: -c

      % $SHELL $SHELLFLAGS &quot;command -opts args&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        instead of

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % command -opts args    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That is because procmail's ability to invoke other programs does not
        include filename globbing ([, *, ?), backgrounding (&amp;), piping
        (|), succession (;), nor conditional succession (&amp;&amp;, ||). If it
        sees any of those characters (before expanding variables), it hands the
        job over to a shell.


<p class="column8">
        Sometimes those characters appear in arguments to a command without
        having their shell meta meaning and procmail really could invoke the
        command directly without the shell. You can see the distinction in a
        verbose log file: if procmail runs the command itself, it logs

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Executing &quot;command,-opts,args&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        with a comma between each positional parameter, but if it calls a
        shell, the original spacing from the rcfile appears unchanged in
        the logfile:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Executing &quot;command -opts args&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        So, if you know you won't be needing shell expansion, wrap your
        shell calls with this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      savedMetas  = $SHELLMETAS
      SHELLMETAS    # Kill variable

      ..command that does not need shell expansion features..

      SHELLMETAS  = $savedMetas    </PRE></TD>
    </TR>
</TABLE>



  <a name="think_what_shell_commands_you_use" id="think_what_shell_commands_you_use"></a>
  <h2>
      4.16 Think what shell commands you use

  </h2>




<p>
<p class="column8">
        For every message, procmail launches the processes you have
        put into your <samp class="word">$HOME/.procmailrc</samp>. If you haven't paid
        attention to optimization before, now it's serious time to
        take a magnifying glass and check every recipe and the
        processes in them. When you write you private shell scripts,
        the performance hit is not so important, but for mail
        delivery, the matter is totally different. First, let's see
        some programs and sizes: The following is from one Unix
        system, where the binaries include debug and symbol table
        code.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      131072  /usr/bin/awk
      196608  /usr/bin/sort
      245760  /usr/bin/grep
      262144  /usr/bin/sed
      303552  /usr/local/bin/gawk
      544768  /usr/contrib/bin/perl       [perl 4.36]
      822232  /opt/local/bin/perl

              text    data     bss
      awk:    72727 + 51316 +  15317   = 139360
      sort:  173225 + 18496 + 183076   = 374797
      sed:   237248 + 16992 +  56252   = 310492
      grep:  221591 + 16176 +  53816   = 291583
      perl4: 502220 + 36044 +  65632   = 603896
      perl5: 633812 + 69612 +   2385   = 705809
      gawk:  160018 +  5264 +   7168   = 172450    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The binary sizes above are not the typical cases: these are from
        another system

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
           4 Sep 28  /usr/local/bin/awk -&gt; gawk
       32768 Nov 16  /usr/bin/grep
       49152 Nov 16  /usr/bin/sed
      114688 Oct 20  /usr/local/contrib/gnu/bin/grep
      155648 Nov 16  /usr/bin/awk
      155648 Nov 16  /usr/bin/nawk
      221184 Nov 16  /usr/bin/gawk
      311296 Jan 27  /usr/local/bin/gawk
      958464 Nov  2  /usr/local/contrib/bin/perl
      1196032 Sep 14 /usr/local/bin/perl    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Stan Ryckman &lt;stanr A T sunspot.tiac.net&gt; wants you to know that:


<p class="column10"><em class="quote10">
          Comparing byte sizes on disk means nothing here... these
          things may or may not have been stripped. Any symbol tables included
          in the byte counts you see above won't affect process start-up time.
          The <samp class="word">size</samp> command will give a better handle on what will be needed
          in starting a process. The three segments may each have their own
          overhead, though, and the relative contributions of those segments
          to startup time may well be system-dependent.</em>



<p class="column8">
        Hm. Can we draw some conclusion? Not anything definitive, but at
        least something:

<ul>
	<li>While <samp class="word">sed(1)</samp> and <samp class="word">grep(1)</samp> may be bigger than <samp class="word">awk(1)</samp> in
            some systems, this is an exception. They are usually much
            smaller and fast to use.
<li>Complex commands that would require many processes to be
            chained together, like `grep -v | grep | sed' could
            be usually accomplished with one <samp class="word">awk(1)</samp> call. Ask somewhere how to
            do it with <samp class="word">awk(1)</samp> if you don't know the language, it's quite alike
            <samp class="word">perl(1)</samp>
	</li>
<li>Try to use standard <samp class="word">awk(1)</samp>. <samp class="word">gawk(1)</samp> and <samp class="word">nawk(1)</samp>
            are bigger and may not be found on all systems.
	</li>
<li>Avoid <samp class="word">perl(1)</samp> at all costs; it's many times (6) bigger than
            <samp class="word">awk(1)</samp>.  Perl is slow-to start up, due to intermediate
            compilation process at startup and hogs oodles of memory.
	</li>
<li>Remember that if procmail is running in a dedicated mail host, it
            probably doesn't even have any goodies installed, just the boring
            standard versions; which may not be even the same as what you see
	            on current host.</li>
</ul>




<p class="column8">
        Here are some more programs. Don't even think of extracting fields with
        <samp class="word">grep</samp> or <samp class="word">awk</samp>, like &quot;grep Subject&quot;, because <samp class="word">formail</samp> is
        much smaller and more optimized for tasks like that. Better yet,
        many times you can do all with procmail's regexp matches.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      37007 Sep  5 15:53 /usr/local/bin/formail   # 3.11pre7
      28672 Jun 10  1996 /usr/bin/tr
      20480 Jun 10  1996 /usr/bin/tail
      20480 Jun 10  1996 /usr/bin/cat
      20480 Sep 26  1996 /usr/bin/expr
      16384 Jun 10  1996 /usr/bin/head
      16384 Jun 10  1996 /usr/bin/cut
      16384 Jun 10  1996 /usr/bin/date
      16384 Jun 10  1996 /usr/bin/uniq
      16384 Jun 10  1996 /usr/bin/wc
      12288 Jun 10  1996 /usr/bin/echo    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_absolute_paths_when_calling_a_shell_program" id="using_absolute_paths_when_calling_a_shell_program"></a>
  <h2>
      4.17 Using absolute paths when calling a shell program

  </h2>




<p>
<p class="column8">
        Shell programmers know that if absolute path is used for calling
        the executable, shell doesn't have to search through long list of
        directories in $PATH. This may speed up shell scripts remarkably.
        The best way to use such an optimization is to define variables to
        those programs.


<p class="column8">
        Should you use such optimization in your procmail code?  That is a
        two folded question. Examine how many shell calls do you use? Do
        you use <samp class="word">grep</samp> or <samp class="word">formail</samp> a lot? Then you could optimize these
        calls. To be portable, define variables for executables:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  perhaps defined in separate INCLUDERC
      #
      #   INCLUDERC = $PMSRC/pm-mydefaults.rc

      FORMAIL     = /usr/local/bin/formail
      GREP        = /bin/grep
      DATE        = /bin/date

      :0 fhw
      | $FORMAIL -rt    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When you port your <samp class="word">.procmailrc</samp> to different environment which
        has different paths, you could use this recipe in addition to one
        just mentioned above:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FORMAIL     = ...as above

      :0
      * HOST ?? second-host
      {
          #   In this host the paths are different. Reset.

          $FORMAIL    = &quot;formail&quot;
          $GREP       = &quot;grep&quot;
          $DATE       = &quot;date&quot;
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="disabling_a_recipe_temporarily" id="disabling_a_recipe_temporarily"></a>
  <h2>
      4.18 Disabling a recipe temporarily

  </h2>




<p>
<p class="column8">
        If you have a recipe that you would like to disable for a while,
        there is an easy way. Just add the &quot;false&quot; condition line before
        any other conditions. The &quot;!&quot; also nicely visually flags that
        &quot;this recipe is NOT used&quot;.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  This recipe stops at &quot;!&quot; and doesn't get past it.

      :0
      * !
      * condition
      * condition
      {
          ...
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="keep_message_backup_no_matter_what" id="keep_message_backup_no_matter_what"></a>
  <h2>
      4.19 Keep message backup, no matter what

  </h2>




<p>
<p class="column8">
        It's good to have a safety measure in your <samp class="word">.procmailrc</samp>.
        Although you are an expert and have checked your recipes 10 times,
        there is still a chance that something breaks. One morning, when you
        browse your <em class="word">BIFF</em> reminder log; you notice &quot;Hm, there is that
        interesting message but it was not filed, where is it?&quot;. And when
        you go to study the procmail logs (you do keep the log going all
        the time) and it hits you: &quot;Gosh; a mistake in my script! Message was
        fed to malicious pipe and I had that <samp class="word">i</samp> flag there... <em class="word">sniff</em>&quot;.
        And you greatly regret you didn't back up the message in the first
        place.


<p class="column8">
        So, before your procmail does anything to your message, put the
        message into some folder which is regularly expired. Emacs Gnus can
        do mailbox's expiring, but one could also use a <samp class="word">cron(1)</samp> to do the
        cleaning. After that, you can relax knowing your mail is safe.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Your incoming messages are stored here, filtered by procmail

      SPOOL      = $HOME/Mail/spool

      #   Backup storage
      #
      #   - This could be directory too. In that case you could use
      #     cron job to expire old messages at regular intervals
      #   - For once a day expiration, see procmail module list
      #     and pm-jacron.rc

      BUP_SPOOL  = $SPOOL/junk.bup.spool

      :0 c:
      $BUP_SPOOL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Naturally you can filter out mailing list messages from the backup,
        because losing one or two (hundred) of them may not be that serious.
        Maybe you could use two backup spools, one for mailing lists and the
        other for your non-list messages.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c:
      * ! mailing-list1|mailing-list2
      $BUP_SPOOL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you have the date variables set up as described below, you
        could also create a backup folder per day:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $BUP_SPOOL    = $SPOOL/junk.bup.$YYYY-$MM-$DD.spool    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This makes it very easy to delete backups that are older than
        a given number of days, either manually or through a cron job.



  <a name="order_of_the_procmail_recipes" id="order_of_the_procmail_recipes"></a>
  <h2>
      4.20 Order of the procmail recipes

  </h2>




<p>
<p class="column8">
        When you start writing a lot of procmail recipes, you soon find out
        that it matters a great deal in which order your put your recipes.
        When each group of recipes starts growing too big, it's good
        practice to move each group to a separate includerc file. Here is
        one recommended order in which yur calls appear in the mail
        $HOME/.procmailrc

<ul>
	<li> backup important messages
<li> cron-subroutine
	</li>
<li> handle duplicate messages
	</li>
<li> handle DAEMON MESSAGES
	</li>
<li> handle plus addressed message  (RFC plus or sendmail plus addresses)
	<li> handle server requests (file server, ping responder...)</li>
</ul>




<p class="column8">
	<ul>
	<li> drop MAILING LIST messages</li>
</ul>



<ul>
	<li> send possible vacation  replies only after all above
<li> apply kill file
	</li>
<li> detect mime and format or modify the message body
	<li> save private messages</li>
</ul>




<p class="column8">
	<ul>
	<li> and last: FILTER UBE.</li>
</ul>




<p class="column8">
        The backup, cron and duplicate handling go naturally to the
        beginning of your <samp class="word">.procmailrc</samp>. Next comes a grey area where
        Daemon, plus handling and server messages can be put.


<p class="column8">
        Mailing lists should be handled as early as possible, but after the
        server messages, because you want your services handled first.


<p class="column8">
        Do not send vacation replies before you have handled mailing lists
        to prevent annoying vacation replies to mailing lists.


<p class="column8">
        After that you are left with &quot;known&quot; private messages and those of
        unknown origin. A kill file (to block based on sender) for rapid
        spammers, who send you message or several per day may need to be
        checked before checking other messages.


<p class="column11">
           Last but not least: Put your UBE checkers to the end to avoid
           mishits of valid mail. <strong class="word">DO</strong> <strong class="word">NOT</strong> <strong class="word">SEND</strong> <strong class="word">AUTOMATIC</strong> <strong class="word">COMPLAINT</strong>
           <strong class="word">BACK</strong>, or you'll get grey hairs when the autoresponder send its
           complaint to valid source. You don't want to answr back with &quot;My
           apologies, the script had an error, it won't happen aagin.&quot; to all
           the valid hate mail that is now addressed to you.


<p class="column8">
        Drop the UBE to a folder, manually select the messages that need
        actions and send message to postmasters in the Received chain
        explaining that their mail relay has been hijacked.

<hr>
               <A name="procmail_flags"  id="procmail_flags"></A>
               <h1>
               5.0 Procmail flags

               </h1>



  <a name="the_order_of_the_flags" id="the_order_of_the_flags"></a>
  <h2>
      5.1 The order of the flags

  </h2>




<p>
<p class="column8">
        The Order of the flags does not matter in practice, but here is one
        stylistic suggestion.  The idea here is that the most important
        flags are put to the left, like giving priority 1 for <samp class="word">aAeE</samp>, which
        affect the recipe immediately. Priority 2 is given to flag
        <samp class="word">f</samp>, which tells if a recipe filters something. Also (h)eader and
        (b)ody should immediately follow <samp class="word">f</samp>, this is considered priority
        3. In the middle there are other flags, and last flag is <samp class="word">c</samp>, which
        ends the recipe, or allows it to continue. In addition according to
        <span class="word-ref">[david]</span>: &quot;...I'm quite sure that putting anything other than the
        opening colon and the number to the left of <samp class="word">AaEe</samp> will cause an
        error.&quot;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 aAeE HBD fhb wWir c: LOCKFILE
         |    |   |   |    |
         |    |   |   |    (c)ontinue or (c)lone flag last.
         |    |   |   (w)ait and other flags
         |    |   (f)ilter flag and to filter what: (h)ead or (b)ody
         |    (H)eader and (B)ody match, possibly case sensitive (D)
         |    Note: Procmail 3.22 bug
         |   &lt;<a href="http://mailman.rwth-aachen.de/pipermail/procmail/2002-February/008355.html" >http://mailman.rwth-aachen.de/pipermail/procmail/2002-February/008355.html</a>&gt;
         The `process' flags first. (A)nd or (E)lse recipe    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You can write the flags side by side

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0Afhw:$MYLOCK$LOCKEXT    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or, as suggested, leave flags in their own slot for more
        distinctive separation. Note that procmail variable <samp class="word">$LOCKEXT</samp> must
        be next to $MYLOCK, because it contains string &quot;.lock&quot;.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 A fhw: $MYLOCK$LOCKEXT    </PRE></TD>
    </TR>
</TABLE>



  <a name="flags_hb_at_top_of_recipe_warning" id="flags_hb_at_top_of_recipe_warning"></a>
  <h2>
      5.2 Flags HB at top of recipe (warning)

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Philip]</span> Version 3.22 has a bug that keeps the 'H' flag from
        being cleared, such that once you use it, it never gets
        cleared. Using the 'H' flag will therefore cause problems with
        latter recipes that use just the 'B' but not the 'H' flag.
        Either way, the only time you should use the 'H' flag is on
        recipes that needs to match against both the header and the
        body. If you want a recipe to match only against the body and
        you're using 3.22, use the &quot;B ??&quot; modifier on the conditions.
        See message
        &lt;<a href="http://mailman.rwth-aachen.de/pipermail/procmail/2002-February/008355.html" >http://mailman.rwth-aachen.de/pipermail/procmail/2002-February/008355.html</A>&gt;.
        So to be most pportable possible, convert all previously used
        condition lines from:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 B
      * body-check-here    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        to use this format:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * B ?? body-check-here    </PRE></TD>
    </TR>
</TABLE>



  <a name="flag_w_and_recipe_with" id="flag_w_and_recipe_with"></a>
  <h2>
      5.3 Flag w and recipe with |

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[alan]</span> If the filter program exits with a 0 status (0 == okay), then
        procmail will replace the original input body with the output of the
        filter program. If the filter program exits with anything but zero,
        procmail will report an &quot;error&quot; to the log, and &quot;recover&quot; the input
        (not filter it)


<p class="column8">
        <span class="word-ref">[david]</span> I am very sure that that's the case <strong class="word">only</strong> if you have the
        <samp class="word">w</samp> or <samp class="word">W</samp> flag on the filtering recipe. Without <samp class="word">w</samp> or <samp class="word">W</samp>,
        procmail won't care about a bad exit status from the filter and will
        replace the filtered portion with whatever standard output the
        filter produced. It may still report an error to the log but it
        won't recover the previous text. This, for example, will destroy the
        body of a message, even without <samp class="word">i</samp>:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fb
      | false    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        With this, however, procmail will recover the original body:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbW      # same results even if we add `i'
      | false    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[stephen]</span> No, not on all occasions. Procmail will not care about the
        exit code here. However, if procmail detects a write error, it <em class="word">will</em>
        recover (because of the missing <samp class="word">i</samp> flag). Procmail will only detect
        a write error in such a case if the mail is long enough and does not
        fit in the pipe buffer that's in the kernel (typically 10KB).



  <a name="flag_w_lock_file_and_recipe_with" id="flag_w_lock_file_and_recipe_with"></a>
  <h2>
      5.4 Flag w, lock file and recipe with |

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[manual]</span> In order to make sure the lock file is not removed until the
        pipe has finished, you have to specify option <samp class="word">w</samp> otherwise the
        lock file would be removed as soon as the pipe has accepted the
        mail. So if you see anything that looks like "&gt;" or ">" in your
        recipe, then that should immediately ring your bells. immediately
        check that you have included the <samp class="word">w</samp> flag <strong class="word">and</strong> the lock file <samp class="word">:</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hwc: headc$LOCKEXT
      * !^FROM_MAILER
      | uncompress headc.Z; cat &gt;&gt; headc; compress headc    </PRE></TD>
    </TR>
</TABLE>



  <a name="flag_f_and_w_together" id="flag_f_and_w_together"></a>
  <h2>
      5.5 Flag f and w together

  </h2>




<p>
<p class="column10"><em class="quote10">
          The <samp class="word">w</samp> tells Procmail to hang around and wait for the script to
          finish. Hm, Wouldn't you think this ought to be implied by the <samp class="word">f</samp>
          flag already?</em>



<p class="column8">
        <span class="word-ref">[david]</span> Of course the <samp class="word">f</samp> flag is enough to make procmail wait for
        the filter to finish, but the <samp class="word">w</samp> means something more: to wait to
        learn the exit code of the filtering command. If sed fails with a
        syntax error and gives no output, without <samp class="word">W</samp> or <samp class="word">w</samp> procmail would
        happily accept the null output as the results of the filter and
        go on reading recipes for the now body-less message. On the other
        hand, with <samp class="word">W</samp> or <samp class="word">w</samp> sed will respond to a non-zero exit code by
        recovering the unfiltered text.



  <a name="flags_h_and_b" id="flags_h_and_b"></a>
  <h2>
      5.6 Flags h and b

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> <samp class="word">hb</samp> is the default; you need to use <samp class="word">h</samp> only when you
        don't want <samp class="word">b</samp> or vice versa. You can think of it this way: <samp class="word">h</samp>
        means &quot;lose the body&quot; and <samp class="word">b</samp> means &quot;lose the header,&quot; but the two
        together cancel each other out.


<p class="column8">
        <span class="word-ref">[philip]</span> <samp class="word">hb</samp> (feeding whole message) is the default for actions.
        You need to specify <samp class="word">h</samp> without <samp class="word">b</samp> if you want the action applied
        only to the head. <samp class="word">H</samp> is the default for conditions. You need to
        specify <samp class="word">HB</samp> or <samp class="word">BH</samp> if you want to test a condition against the
        entire message.



  <a name="flag_h_and_sinking_to_devnull" id="flag_h_and_sinking_to_devnull"></a>
  <h2>
      5.7 Flag h and sinking to /dev/null

  </h2>




<p>
<p class="column8">
        When you drop something to /dev/null, use the <samp class="word">h</samp> flag so that
        procmail does not unnecessarily try to feed whole message there.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 h
      * condition
      /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> Procmail knows that it shouldn't create a local lock on
        /dev/null and that it shouldn't kernel lock /dev/null, and it knows
        to write it &quot;raw&quot; (no &quot;From &quot; escaping or appended newline). This
        means that procmail simply opens /dev/null, does its write with one
        system call, and closes it. I'm not sure if adding the <samp class="word">h</samp> flag
        makes a real difference on modern UNIX kernels. I suppose it
        depends on how optimized the write() data is and in particular,
        whether a user-space to kernel-space copy is required, or whether
        it's delayed. If it's delayed then the code for handling /dev/null
        would presumably not do it, and the size of the write wouldn't
        actually matter.



  <a name="flag_i_and_pipe_flag_f" id="flag_i_and_pipe_flag_f"></a>
  <h2>
      5.8 Flag i and pipe flag f

  </h2>




<p>
<p class="column10"><em class="quote10">
          Flag <samp class="word">i</samp> is useless in mailbox deliveries.</em>



<p class="column8">
        <span class="word-ref">[FAQ]</span> The following will work some of the time, when the message is
        short enough, but that's a coincidence. With a longer message,
        though, Unix starts paying attention to what is happening, because
        it will have to buffer some of the data, and then when the buffered
        data is never read, an error occurs. The error is passed back to
        Procmail, and Procmail tries to be nice and give you back your
        original message as it was before this malicious program truncated
        it. Never mind that in this case you wanted to truncate the
        data. Anyway, the fix is easy: Just add an <samp class="word">:i</samp> flag to the recipe
        ( <samp class="word">:0fbwi</samp> instead of <samp class="word">:0fbw</samp>) to make Procmail ignore the error.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbw
      * condition
      | malicious-pipe    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[dan]</span> here's why the <samp class="word">i</samp> flag is needed (courtesy of Stephan): You
        told procmail to filter the entire mail (header and body), so it
        does and it attempts to write out header and body to the filter.
        Then procmail notices that not the entire body is being consumed.
        Procmail, being rather paranoid when it comes to delivery of mail
        assumes something went wrong and considers this a failure of the
        filter.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbwi
      | head -2    </PRE></TD>
    </TR>
</TABLE>



  <a name="flag_r" id="flag_r"></a>
  <h2>
      5.9 Flag r

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> Procmail automatically turns on the <samp class="word">r</samp> (raw mode) flag for
        deliveries to /dev/null, so there's no need to do it yourself.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 r        # you can leave out the `r'
      * condition
      /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> You can use the <samp class="word">r</samp> flag (for raw mode) on every recipe
        where you do not want a From_ line added. I'm assuming that there
        isn't one already there; the <samp class="word">r</samp> flag keeps procmail from making
        sure that there are a From_ line at the top and a blank line at the
        bottom, but it will not make procmail remove them if they are
        already present. Also, be careful to use the <samp class="word">-f</samp> option on all
        calls to formail so that formail won't add a From_ line.


<p class="column8">
        Someone who didn't need From_ lines &ndash; I forget who &ndash; found it
        annoying to put <samp class="word">r</samp> onto every recipe and altered the source to
        prevent procmail from adding From_ lines at all, ever. I think a
        better idea would be a procmailrc Boolean to enable or disable them
        for all recipes without affecting other users. (Then perhaps we'd
        need a reverse <samp class="word">r</samp> flag to undo raw mode for one recipe at a time?)



  <a name="flag_cs_background" id="flag_cs_background"></a>
  <h2>
      5.10 Flag c's background

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Interesting. My vision of <samp class="word">c</samp> is to think of CONTINUE
          with message processing afterwards even if conditions matched.</em>




<p class="column8">
        <span class="word-ref">[david]</span> Precisely: when you have braces, thinking &quot;continue&quot;
        instead of &quot;copy&quot; or &quot;clone&quot; can get you into trouble.


<p class="column8">
        Early versions of procmail, before braces and before cloning,
        called the <samp class="word">c</samp> flag &quot;continue&quot; in their documentation; I think it
        is still called that in the source.


<p class="column8">
        When Stephen introduced braces (but not cloning at this point), it
        was of course implicit that an action line of &quot;{&quot; was
        non-delivering, and a <samp class="word">c</samp> was extraneous. People put c's there
        because they wanted procmail to continue to the recipes inside the
        braces on a match, and procmail brushed it off with an &quot;extraneous
        c-flag&quot; warning. No harm done.


<p class="column8">
        When Stephen introduced cloning, though, I was rather upset that he
        was giving double duty to <samp class="word">c</samp> instead of introducing something new
        like <samp class="word">C</samp> for it, especially because people who absolutely wanted no
        clone but intended the recipes inside the braces to run in the same
        invocation of procmail as everything else were mistakenly putting
        c's on their braces to make sure procmail would &quot;continue&quot;. People
        would (and did) get double deliveries.


<p class="column8">
        Roman Czyborra, though, said that if you consider <samp class="word">c</samp> to stand for
        &quot;copy&quot;, that covers both uses of <samp class="word">c</samp>: provide a copy to a simple
        recipe or, if there are braces, to a clone procmail that will
        handle the recipes inside the braces. Stephen agreed and changed
        the documentation accordingly.


<p class="column8">
        Longtime users of procmail and people who read old docs may still
        think of it as &quot;continue&quot;, but since the introduction of clones,
        that is not a good way to look at it. &quot;Copy&quot; is much safer.



  <a name="flag_c_before_nested_block_forks_a_child" id="flag_c_before_nested_block_forks_a_child"></a>
  <h2>
      5.11 Flag c before nested block forks a child

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[alan]</span> The combination of a nested block and the <samp class="word">c</samp> flag causes
        procmail to fork a child process for the nested block, while the
        parent skips over it and continues on. The child process doesn't
        necessarily stop unless a <em class="word">delivering</em> recipe (without the <samp class="word">c</samp> flag)
        action succeeds.


<p class="column8">
        <span class="word-ref">[david]</span> When Stephen van den Berg added the use of <samp class="word">c</samp> on a
        recipe that launces a braced nesting block to fork a clone
        procmail, I objected that it should have a different flag, such as
        <samp class="word">C</samp>, because people were always putting <samp class="word">c</samp> on recipes that open
        braces because they thought it was necessary to make procmail
        continue into the braced area. Until then, it had been a harmless
        error for an extraneous flag. Roman Czyborra came up with the idea
        of changing the meaning of <samp class="word">c</samp> from &quot;continue&quot; to &quot;copy&quot;: read <samp class="word">c</samp>
        as &quot;send a <strong class="word">c</strong>opy to the action&quot; and then it would cover both
        simple recipes with <samp class="word">c</samp> flags and cloning blocks.



  <a name="flag_c_and_understanding_possible_forking_penalty" id="flag_c_and_understanding_possible_forking_penalty"></a>
  <h2>
      5.12 Flag c and understanding possible forking penalty

  </h2>




<p>
<p class="column10"><em class="quote10">
          ... I run shell commands that need not to be serialized, so
          instead of doing the standard way:</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hic                  # nbr.1 / standard way
      | command    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          I assume I can avoid the extra fork caused by (c)lone flag
          altogether by using these. Any difference between these two?</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0                      # nbr.2 / alternative
      * ? command
      { }                     # ...No-op, Procmail syntax requires this

      dummy = `command`       # nbr.3 / alternative    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> There is a misunderstanding here. Let me clarify:


<p class="column11">
           Procmail only forks a full-blown clone on a recipe with the 'c'
           flag whose action is a nested block.


<p class="column8">
        If it's a simple mailbox deliver, pipe, or forward action then
        procmail does not fork a 'clone' (for pipe and forward actions
        procmail does have to fork, but only so it can execute the
        action). <samp class="word">nbr.1</samp> and <samp class="word">nbr.2</samp> take the same number of forks to
        execute. They also take the same effective number of writes (in
        case you're concerned about that). The latter also requires that
        procmail wait for the command to finish.  <samp class="word">nbr.3</samp> is worse than the
        above two, as procmail has to not only wait for the command to
        complete but also save the output into the named variable.



  <a name="flags_before_nested_block" id="flags_before_nested_block"></a>
  <h2>
      5.13 Flags before nested block

  </h2>




<p>
<p class="column8">
        Given the following recipe, let's examine the flag part

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 $FLAGS
      {
          do-something
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> <samp class="word">HB</samp> <samp class="word">AaEe</samp> and <samp class="word">D</samp> affect the conditions and thus are
        meaningful when the action is to open a brace. <samp class="word">HB</samp> and <samp class="word">D</samp> would
        be meaningless, of course, on any unconditional recipe, but they
        should not cause error messages.  Generally, flags that affect
        actions are invalid there, and <samp class="word">bhfi</samp> and <samp class="word">r</samp> always are, but the
        others are partial exceptions: if you are using <samp class="word">c</samp> to launch a
        clone, then <samp class="word">w</samp> <samp class="word">W</samp> and a local lock file can be meaningful. If
        there is no <samp class="word">c</samp>, then <samp class="word">w</samp> <samp class="word">W</samp> and a local lock file are invalid at
        the opening of a braced block.



  <a name="flags_aaee_tutorial" id="flags_aaee_tutorial"></a>
  <h2>
      5.14 Flags aAeE tutorial

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> <samp class="word">AaEe</samp> are mutually exclusive and no more than one should
        ever appear on a single recipe. <span class="word-ref">[philip]</span> Actually, this is not
        true. e does not work with <samp class="word">E</samp> or <samp class="word">a</samp> (and procmail gives a warning
        if you try), and <samp class="word">A</samp> is redundant if a is given, but at least some
        of the other combination make sense and work.

<ul>
	<li><em class="word">A</em> = try this recipe if the conditions succeeded on the most
            recent recipe at that nesting level that did not itself have an
            A nor an a
<li><em class="word">a</em> = same as <samp class="word">A</samp>, but moreover the action must have succeeded
            on the most recently tried recipe at that nesting level
	</li>
<li><em class="word">e</em> = Almost like <samp class="word">A</samp>, try this recipe if the conditions matched
            but the action failed on the most recently tried (not skipped)
            recipe at this nesting level. universe, <samp class="word">e</samp> is the opposite of <samp class="word">a</samp>.
            <samp class="word">e</samp> only looks backwards past <samp class="word">E</samp> recipes that were skipped
            because of their <samp class="word">E</samp>. It doesn't care whether a previous recipe
            had an <samp class="word">A</samp> or <samp class="word">a</samp> flag.
	</li>
<li><em class="word">E</em> = try this recipe if the conditions have failed on the most
            recent recipe at that nesting level that did not have an <samp class="word">E</samp> and
            on since then every recipe at that level that did have an <samp class="word">E</samp>;
	            essentially opposite of <samp class="word">A</samp></li>
</ul>




<p class="column8">
        These mnemonics might help:

<ul>
	<li><em class="word">A:</em> if you did the recipe at the start of the chain, try this one
            (A)lso
<li><em class="word">a:</em> if the last action at that nesting level was (a)ccomplished)
	</li>
<li><em class="word">e:</em> if the last action at that nesting level (e)rred
	</li>
<li><em class="word">E:</em> (E)lse because the conditions down the chain so far have not
	            matched. Or &quot;try this recipe unless the last tried recipe matched&quot;.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   [philip] demonstrates `e'

      :0 :            # match, but action fails
      /etc/hosts/foo


          :0 A        # no match
          * -1^0
          /dev/null

      :0 e # this is skipped because the last tried recipe didn't match
      {
          ...whatever
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        How they interact with one another when used consecutively has not
        been fully tested to my knowledge. Consider this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * conditions
      non-delivering-action1

          :0 a
          action2

      :0 e
      action3    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Is action3 done if action2 failed or if action1 failed (or perhaps
        in both situations)? <span class="word-ref">[philip]</span> Action 3 is only done if action2 failed.


<p class="column8">
        If the answer is action2, does this work to get action3 done if
        action1 failed? I think it does, but does it also run action3 if
        the conditions didn't match on the first recipe? <span class="word-ref">[philip]</span> Yes, and
        yes.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0             #   [david]
      * conditions
      non-delivering action1

          :0a
          action2

      :0E
      action3    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> If that's not what you want, combine some flags:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * conditions
      non-delivering action1

          :0 Ae
          action3

      :0 a
      action2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If the conditions match, action1 will be executed. action3 will
        then execute if action1 failed, otherwise action2 will be executed
        <span class="word-ref">[if action1 succeeded]</span>.


<p class="column8">
        <span class="word-ref">[david]</span> I know what this structure does because I use it:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * conditions
      non-delivering action1
          :0A
          action2

      :0E
      non-delivering action3
          :0A
          action 4    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If the conditions match, action1 and action2 are performed and
        action4 is not (of course action3 is not either), even if action2
        is non-delivering; if they fail, action3 and action4 are performed.
        The <samp class="word">A</samp> on the fourth recipe refers back to the third and no farther.
        But I don't know about this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * conditions
      non-delivering action1
          :0A
          * more conditions
          action2

      :0E
      non-delivering action3
          :0A
          action 4    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now, suppose the conditions on the first recipe match but those on
        the second recipe do not match. Would the third recipe (and thus
        the fourth one) be attempted? I would expect so. <span class="word-ref">[philip]</span> Yes. The
        last tried recipe didn't match, therefore the <samp class="word">E</samp> flag will be
        triggered.


<p class="column8">
        If that isn't what you want, you can prevent it this way:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * conditions
      {
          :0
          non-delivering-action1

          :0
          * more-conditions
          action2
      }

      :0 E # ignores mismatch inside braces, looks only at same level
      non-delivering action3

      :0 A
      action4    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If that is what you want, you can be positive this way:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # if action2 is non-delivering or vulnerable to error that
      # would cause fall-through

      DID2         # Kill variable

      :0
      * conditions
      non-delivering-action1

          :0 A
          action3

      :0
      * ! DID2 ?? (.)
      non-delivering-action3

          :0 A
          action4

      # if action2 is delivering and sure to succeed
      :0
      * conditions
      non-delivering-action1

          :0 A
          * more-conditions
          action2

      :0
      non-delivering-action3

          :0 A
          action4    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> or those who are interested, I'll note that there are only
        3 combinations of the <samp class="word">a</samp>, <samp class="word">A</samp>, <samp class="word">e</samp>, and <samp class="word">E</samp> flags that aren't
        either illegal or redundant. They are <samp class="word">Ae</samp>, <samp class="word">aE</samp>, and <samp class="word">AE</samp>. I've
        shown a use for <samp class="word">Ae</samp> up above. Here's an example of <samp class="word">AE</samp>:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition1
      non-delivering action1

          :0 A
          * condition2
          non-delivering action2

      :0 AE
      action3    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        action3 will only be executed if condition1 matched but condition2
        didn't match. Without the A flag, action3 would be executed if
        either of them failed. This can also be done with a instead of A
        with analogous results.


<p class="column8">
        Procmail's &quot;flow-control&quot; flags may not be particularly easy to
        describe in straight terms (and this can all be made more
        complicated by throwing in a more varied mix of delivering vs
        non-delivering recipes), but I've found that it usually does what I
        expect it to do, and when it doesn't or I'm in doubt or I want to
        be particularly clear, I can always fall-back to doing it explicitly
        via nesting blocks. Pick your poison...

<hr>
               <A name="matching_and_regexps_regular_expressions"  id="matching_and_regexps_regular_expressions"></A>
               <h1>
               6.0 Matching and regexps (regular expressions)

               </h1>



  <a name="philosophy_of_abstraction_in_regexps" id="philosophy_of_abstraction_in_regexps"></a>
  <h2>
      6.1 Philosophy of abstraction in regexps

  </h2>




<p>
<p class="column10"><em class="quote10">
          Here are two ways to view or write regexps. Make up your own
          mind. More on regular expressions ar &lt;<a href="http://regexlib.com/" >http://regexlib.com/</A>&gt;.</em>



<p class="column9"><strong>
         People who are in favor of writing pure native regexps in the
         recipes:</strong>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      [    ]&lt;[    ]*(&quot;([^&quot;\]|\\.)*&quot;|[-!#-'*+/-9=?A-Z^-~]+)...  # &quot;    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>I'm not planning on &quot;maintaining&quot; that code, as the syntax for
            XXX will not ever change, it's RFC or something.
<li>I somehow doubt that anyone else will change that regexp more than
            trivially
	</li>
<li>If none of your other regexps use the categorical variables, and
            you're not changing the regexp, then what's the point?
            The variablized version will be slower, and will clutter the
	            environment with subprocesses.</li>
</ul>




<p class="column9"><strong>
         Where someone that immediately wants to abstract things says (This
         is from philip's great Message-Id matching recipe)</strong>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      dq = '&quot;'                                # (literal) double-quote
      bw = &quot;\\&quot;                               # (literal) backwhack
      atom       = &quot;[-!#-'*+/-9=?A-Z^-~]+&quot;
      word       = &quot;($atom|$dq([^$dq\]|$bw.)*$dq)'
      local_part = &quot;$word($s\.$s$word)*&quot;

      $s&lt;$s$local_part...                     # ignore comment here    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        ...abstraction: It makes code clearer when you break it to
        manageable parts, which possibly surfaces reusable parts. It also
        makes thing look simpler, and enables even novices to understand
        what's going on there. After we're not connected to the net
        anymore, others could possibly understand it too.  So, naturally we
        can't agree with any of the previously mentioned arguments
        presented for keeping regexp &quot;in pure native format&quot;.

<ul>
	<li>Although you won't maintain it, it's an example for others. What
            you post first, people will save it to their mailboxes and
            circulate elsewhere in the net: &quot;Hey, I've saved this, try it&quot;
<li>You can write cryptic regexps or break them into parts where
            the whole looks much simpler. Consider novice's welfare :-)
            This has nothing to do with the &quot;It never changes in my lifetime&quot;.
	</li>
<li>The speed penalty imposed by additional variables is not
            something we can measure in practice. CPU won't even hiccup.
            An extra <samp class="word">formail</samp> call in your recipes is 10x as expensive as
            100 variables. (I don't know how to measure that, but launching
            a shell and creating a process is a much more expensive task).
	</li>
<li>Cluttering the env process? C'm on. That won't matter either.
            No outside process use lowercase environment variable names, or
            then it must be real special program. So called &quot;cluttering&quot; of
            environment space is also no-issue. CPU won't even get a hiccup
	            for that.</li>
</ul>





  <a name="matches_are_not_casesensitive" id="matches_are_not_casesensitive"></a>
  <h2>
      6.2 Matches are not case-sensitive

  </h2>




<p>
<p class="column8">
        Okay, okay; if you read the manual you knew that already. But
        sometimes someone with years of experience with Unix may take it for
        granted that procmail would be case-sensitive as the rest of the
        Unix tools are. Use the <samp class="word">D</samp> flag to turn on case-sensitivity.



  <a name="procmail_uses_multi_line_matches" id="procmail_uses_multi_line_matches"></a>
  <h2>
      6.3 Procmail uses multi line matches

  </h2>




<p>
<p class="column8">
        Procmail uses multi line matches by default. This means that ^ and $
        match a newline, even in the middle of a regexp. Now you know this,
        you can easily interpret e.g. <samp class="word">$[^&gt;]</samp> as: `a newline followed by a
        line not starting with a <samp class="word">&gt;</samp>.


<p class="column8">
        If you put a '$' after the '\/' match token then procmail will
        include the matched newline if there's one there. Solution? Don't
        put a dollar sign there unless you really want a newline, use period
        that matches all but newline:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * B ?? ^Search-string: \/.+    </PRE></TD>
    </TR>
</TABLE>



  <a name="headers_are_unfolded_before_matching" id="headers_are_unfolded_before_matching"></a>
  <h2>
      6.4 Headers are unfolded before matching

  </h2>




<p>
<p class="column8">
        If you have a header that continues on separate lines, you don't have
        to worry about the line feeds. Procmail silently unfolds the header onto
        one line, before matching it

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Received: from unknown (HELO Desktop01) (208.11.179.72) by
          palm.bythehand.net with SMTP; 4 Dec 1997 23:29:09 -0000

      :0                          # note, match on continuation line
      * ^Received:.*bythehand\.
      {
          # Do something
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="improving_spacetab_syndrome" id="improving_spacetab_syndrome"></a>
  <h2>
      6.5 Improving Space-Tab syndrome

  </h2>




<p>
<p class="column8">
        Procmail doesn't know about standard escape codes like <samp class="word">\t</samp> and <samp class="word">\n</samp>
        or [\0x00-\0x133]:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  Not what you think       # You have to write: space + tab
      [ \t]                       [   ]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But using the space+tab is not very readable and it's a very error
        prone construct. Here is a suggestion to use variables to improve the
        readability:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      WSPC   = &quot;    &quot;         # whitespace = space + tab
      SPC    = &quot;[$WSPC]&quot;      # regexp whitespace, the short name
                              # SPC was chosen because you use this
                              # a lot in condition lines.
      NSPC  = &quot;[^$WSPC]&quot;      # negation of whitespace

      :0
      *$ var ?? $NSPC
      {
          #   match anything except space and tab
      }

      :0
      *$ ! var ?? ($SPC|$)
      {
          #   match anything ecxept space and tab and newline
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But you cannot use newline inside brackets.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      WSPCL  = &quot;   &quot;'         # Whitespace with line feed
      '

      #   Won't work although WSPCL definition is correct.

      *$ var ?? [$WSPCL]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Instead use variable syntax:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SPCNL = &quot;($SPC|$)&quot;      # space + tab + newline    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you absolutely need a range of characters, see if you have <samp class="word">echo</samp>
        command in your system to define variables like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      NUL_CHAR        = `echo \\00`
      DEL_CHAR        = `echo \\0177`
      REGEXP_NON_7BIT = &quot;[^$NUL_CHAR-$DEL_CHAR]&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="handling_exclamation_character" id="handling_exclamation_character"></a>
  <h2>
      6.6 Handling exclamation character

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> you do need the first backslash, to keep procmail from
        considering the backslash as a request to invert the sense of the
        match. For example, these two conditions are equivalent:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! 200^1 foo
      *   200^1 ! foo    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Therefore, a leading '!' must either be backslashed, enclosed in
        either parens or brackets (I suspect that parens would be more
        efficient), or prefaced with an empty pair of parens. I would
        recommend writing the condition with one of these:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * 200^1 \!!!!
      * 200^1 ()!!!!
      * 200^1 (!!!!)    </PRE></TD>
    </TR>
</TABLE>



  <a name="rules_for_generating_a_character_class" id="rules_for_generating_a_character_class"></a>
  <h2>
      6.7 Rules for generating a character class

  </h2>




<p>
<p class="column8">
        In a &quot;character class&quot; (things between &quot;[&quot; and &quot;]&quot;), metacharacters
        don't need to be escaped. Well, a backslash is an exception.
        e.g. [$<span class="super">^\\</span> would match any one of the literal characters dollar,
        opening bracket, caret, and backslash.

<ul>
	<li>To match &quot;])&quot; use [])]
<li>To match &quot;[(&quot; use [<span class="super">)</span>
	</li>
<li>To include a literal ^          must not be first
	</li>
<li>To include a literal -          must be first, last or \-
	</li>
<li>To include a literal \          you must use \\
	</li>
<li>To include a literal ]          must be first
	<li>To include a literal [ ( ) or $ just use it anywhere</li>
</ul>




<p class="column8">
        <span class="word-ref">[elijah]</span> If you are inverting a character class &quot;first&quot; means just
        after the(^). So the character class that contains everything but ]
        ^ and - must look like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      [^]^-]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> What if I want literal $ inside bracket? A $ inside
        brackets, unless it begins a variable name and the &quot;$&quot; modifier is
        on, always means a literal dollar sign. It cannot mean a newline if
        it appears inside brackets. A good way to keep it exempt from &quot;$&quot;
        interpretation is to put it last inside the brackets (unless one
        also need to include a literal hyphen and one can't put the hyphen
        first; then you'll need to escape the dollar sign with a backslash
        and put the hyphen last &ndash; well, you could alternatively escape the
        hyphen, I guess), because procmail knows that &quot;$]&quot; cannot possibly
        be a reference to a variable.


<p class="column8">
        General guideline:

<ul>
	<li>($) always matches a newline, with or without &quot;$&quot; interpretation;
	<li>[$] always matches a dollar sign, with or w/o &quot;$&quot; interpretation;</li>
</ul>





  <a name="matching_space_at_the_end_of_condition" id="matching_space_at_the_end_of_condition"></a>
  <h2>
      6.8 Matching space at the end of condition

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> If you need to have tab or space at the end of condition line
        you can use these:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * rest of string .*
      * rest of string[ ]
      * (rest of string )
      * rest of string ()
      * rest of string( )         # This may be the best    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> From my looking at the source, the last two should be
        equal in efficiency, and except for a trace difference in regcomp
        time, should match at the same speed as a solitary trailing blank.
        The character class version [ ] will be slower.  Of course, I
        suspect that neither you nor your sysadmin will ever notice the
        difference in speed, and given that 99% of all systems are I/O
        bound and not CPU bound, the system is incredibly unlikely to
        notice either. I can't complain though, as I also go to various
        extremes to seek out every last bit of possible performance. Ah
        well.  The first one would be slower yet, though perhaps no slower
        than the bracket form.



  <a name="beware_leading_backslash" id="beware_leading_backslash"></a>
  <h2>
      6.9 Beware leading backslash

  </h2>




<p>
<p class="column10"><em class="quote10">
          I am trying to come up with a procmail recipe that among other
          things should have the condition 'body does not contain a
          particular word'. Here is what I tried:</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! B ?? \&lt;word\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> You have fallen into the leading backslash problem, If the
        first character of a regexp is a backslash, procmail takes it as &quot;end
        of leading whitespace&quot; and strips it. What you coded means &quot;a less-than
        sign, then the word, then any non-word character.&quot; (It also prevents
        the less-than sign from being taken as a size operator.) Unless the
        non-word character immediately to the left of the word was a less-than
        sign, that regexp would fail (and thus the condition would pass). Try
        this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! B ?? ()\&lt;word\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This would work too:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! B ?? \\&lt;word\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        but in a casual reading it would look like &quot;literal backslash,
        less-than sign, the word, word boundary character,&quot; so we on the list
        generally recommend the empty parentheses.


<p class="column8">
        Do note that the difference in meaning of \&lt; and \&gt; in procmail (where
        they must match a non-word character) from their meaning in perl and
        egrep (where they match the zero-width transition into and out of a
        word respectively) does not come into play here. Because procmail's \&lt;
        and \&gt; can match newlines (both real and putative), it rarely is a
        factor. It's a problem only when a single character has to serve both
        as the ending boundary of one word an also the opening boundary of
        another. Well, it's also a problem when you have one as the last
        character to the right of \/, but that's easily solved.



  <a name="correct_use_of_to_macro" id="correct_use_of_to_macro"></a>
  <h2>
      6.10 Correct use of TO Macro

  </h2>



<p>
<ul>
	<li><samp class="word">TO</samp> is not a normal regular expression; it is a special
            procmail expression that is designed to catch any destination
            specification. For details, see the miscellaneous section of
            the <samp class="word">procmailrc(5)</samp> man pages.
<li>Prefer <samp class="word">TO_</samp> instead of <samp class="word">TO</samp> if you have new procmail. <samp class="word">TO_</samp> is
            better because TO used to be too loose
	</li>
<li>Please remember to write <samp class="word">^TO</samp>, with the anchor in it.
	</li>
<li>Do not put a space between the caret (^) and the word <samp class="word">TO</samp> in
            <samp class="word">^TO</samp>.
	</li>
<li>Do not put a space between the <samp class="word">^TO</samp> and the text that you are
            matching on; it must be <samp class="word">^TOtext</samp> If this bothers you, you can
            use <samp class="word">TO()text</samp> instead to get better separation of text.
	<li>Both letters in <samp class="word">TO</samp> must be capitalized.</li>
</ul>





  <a name="procmails_regexp_engine" id="procmails_regexp_engine"></a>
  <h2>
      6.11 Procmail's regexp engine

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> procmail's regexp engine has no special optimization
        for anchoring against the beginning of the line. Most program that
        have such an optimization have it because they need the line
        distinction for other reasons (for example, grep by default prints
        the entire line containing a match).  Procmail has no such other
        reason, so it treats newline like any other plain character in the
        regexp. There should be no speed difference as long as procmail
        can say: &quot;the first character I see must be a 'foo'&quot;.  Note that
        case insensitivity is handled by making everything lowercase, so a
        letter being first doesn't bring in the spectre of character-classes
        or anything like that.


<p class="column10"><em class="quote10">
          &gt; recipe may have just changed the size of the head, procmail<br>
          &gt; cannot keep a byte-count pointer nor a line-count pointer to<br>
          &gt; where the body begins but must scan through the head to find the<br>
          &gt; blank line at the neck before it begins a body search.</em>
<br>


<p class="column8">
        Procmail does this when it reads in the head, not when it goes to
        search the body, so that cost can't be avoided. Let me repeat; that
        searching the body is no slower than searching the header, if we
        forget the minimum impact of the size of these two.



  <a name="procmail_and_egrep_differences" id="procmail_and_egrep_differences"></a>
  <h2>
      6.12 Procmail and egrep differences

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[By david]</span>

<ul>
	<li>^ and $ are non-zero-width and anchor to real or putative
            newlines (rather than to the zero-width start and end of a line);
<li>An initial ^^ or a final ^^ anchors to the opening or closing
            putative newline respectively;
	</li>
<li>^ and $ in the middle of a procmailrc regexp match to an embedded
            newline (and must be escaped to match to a caret or a dollar sign);
	</li>
<li>\&lt; and \&gt; are non-zero-width and match to a character that
            wouldn't be in a word (or to a real or putative newline) [rather
            than to the zero-width transition into or out of a word]; it
            always matches one non-word character. It will fail when there is
            no whitespace after the colon. This is rather pathological but
            still perfectly compliant with RFC822. For this reason,
            you should use (.*\&lt;)? instead of just .*\&lt; after the colon that
	            terminates a header field name:</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          ^Subject:.*\&lt;humor\&gt;        # Wrong
          ^Subject:(.*\&lt;)?humor\&gt;     # Right, notice ?    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>*, ?, and + in the absence of \/ are stingy rather than greedy,
            and that generally won't matter, but in the presence of \/ they
            are stingy to the left of \/ and greedy to the right of \/,
            while in most applications the leftmost wildcard on a line is
	            the greediest and greed decreases from left to right.</li>
</ul>





  <a name="understanding_procmails_minimal_matching_stingy_vs_greedy" id="understanding_procmails_minimal_matching_stingy_vs_greedy"></a>
  <h2>
      6.13 Understanding procmail's minimal matching (stingy vs. greedy)

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I want to have a procmail recipe that will save certain mail to
          folders where the folder name (always a number) is specified in
          the subject.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * ^Subject: *\/[0-9]*
      $HOME/Mail/$MATCH    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span>...and this won't quite work. For a subject with a space
        after the tab, the '*' on the left hand side will be matched
        minimally (zero times), and then the stuff on the right hand side
        will be matched maximally, but starting at the space still, which
        will match nothing. This is a case were procmail's minimal matching
        can cause massive confusion and frustration. The solution is
        usually the following:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FORCE THE RIGHT HAND SIDE TO MATCH AT LEAST ONE CHARACTER    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        By Changing the recipe to:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * ^Subject: *\/[0-9]+
      $HOME/folders/$MATCH    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        it'll work, because then the left hand side will have to match all
        the way up to the first digit (but not the digit itself). If you
        follow the rule in caps then you'll almost always be able to ignore
        procmail's weirdness in this area.


<p class="column8">
        <span class="word-ref">[david]</span> And examine how procmail matches &quot;Subject: Keywords 9999&quot;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ^Subject:.*Keywords.*\/[0-9]*

      procmail: Match on &quot;^Subject:.*Keywords.*\/[0-9]*&quot;
      procmail: Matched &quot;&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The right side was as greedy as it could be; the problem is that we
        seem to expect greed on the left as well. MATCH is set to null, in
        contrary to our expectation. It is not a bug but rather a frequently
        misunderstood effect of the way extraction is advertised to operate.


<p class="column10"><em class="quote10">
          Remember that only the right side is greedy; the left side is
          stingy, and left-side stinginess takes precedence over right-side
          greed.</em>



<p class="column8">
        Extraction is implemented this way: the entire expression, left and
        right, is pinned to the shortest possible match; then the division
        mark is placed and the right side is repinned to the longest
        possible match starting at the division. The tricky part is to
        remember that the division is marked during the stingy stage.


<p class="column8">
        If the expression is

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^Subject:.*Keywords.*\/[0-9]*    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and the text is

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &lt;newline&gt;Subject:&lt;space&gt;Keywords&lt;space&gt;9999&lt;newline&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        then the shortest possible match to the entirety is

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &lt;newline&gt;Subject:&lt;space&gt;Keywords    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        because &quot;.*&quot; and &quot;[0-9]*&quot; both match to null. Then the division
        mark is placed on the space after &quot;Keywords&quot; and procmail looks for
        the longest possible match to [0-9]* starting with that space.
        That, again, is null, so MATCH is set to null.


<p class="column8">
        We see that it works as expected if regexp is changed to this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^Subject:.*Keywords.*\/[0-9]+    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That is a whole other ball of wax. Now the shortest match to the
        entirety is

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &lt;newline&gt;Subject:&lt;space&gt;Keywords&lt;space&gt;9    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and the division mark is placed at the 9. Then procmail refigures
        the longest match to the right side starting at the division mark
        and sets MATCH=9999. However here

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^Subject:.*Keywords\/.*[0-9]*    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        the second &quot;.*&quot; would have reached not just up to the digits but
        through them to the end of the line. MATCH would contain the rest of
        all of it matched to &quot;.*&quot; plus null match  &quot;[0-9]*&quot;.


<p class="column8">
        <span class="word-ref">[for curious reader]</span>


<p class="column8">
        Given line

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Subject: Keywords 9999    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        the second, which differs only by inserting the extraction marker,
        would not match and would not set $MATCH:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^Subject: Keywords *9999        # matches ok
      ^Subject: Keywords *\/9999      # won't !    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        because the left side would be matched to &quot;&lt;newline&gt;Subject:
        Keywords&quot; and the immediately following text, &quot; 9999&quot;, did not match
        the right side. It would actually make the condition fail and keep
        the recipe from executing. It took a lot of circuitous coding to
        allow for not knowing in advance exactly how many spaces there would
        be before the digits.


<p class="column10"><em class="quote10">
          Call it counterintuitive, but it's not a bug. General advice:
          always make sure that the right side cannot match null or that the
          last element of the left side cannot match null. Or in other words:
          force the right-hand side of the \/ to match at least one character.</em>




  <a name="explaining_and" id="explaining_and"></a>
  <h2>
      6.14 Explaining \/ and ()\/

  </h2>




<p>
<p class="column10"><em class="quote10">
          <samp class="word">MATCH</samp> strips all leading blank lines in 3.11pre7</em>



<p class="column8">
        <span class="word-ref">[david]</span> \/ with nothing to the left of it means &quot;one foreslash&quot;. To
        start a condition with the extraction operator, use ()\/ or \\/;
        the latter looks counter intuitively like &quot;literal backslash and
        literal foreslash&quot; (as it would mean if it appeared farther along
        in the regexp), so most of us prefer the former.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ var ?? $s+\/$d+      # ok, \/ in the middle
      *$ var ?? \/$d+         # Wrong, when \/ is at the beginning
      *$ var ?? ()\/$d+       # No ok, () at the beginning    </PRE></TD>
    </TR>
</TABLE>



  <a name="explaining__and" id="explaining__and"></a>
  <h2>
      6.15 Explaining  ^^ and ^

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> Procmail doesn't think <em class="word">lines</em> when it matches; but it
        concatenates all lines together and then runs the regexp
        engine. This may be a bit surprising, but consider the following where
        we want to discard any message that is likely a HTML advertisement

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Body consists entirely of HTML code
      #   something which'll match any message which has &quot;&lt;HTML&gt;&quot;
      #   in the body

      :0 :
      *$ B ?? $s*&lt;HTML&gt;
      HTML.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The condition test is applied to the entire body. If you want to
        limit it to match only against the beginning of the body, you have
        to say so using the ^^ token, as you discovered. A simple line
        anchor (^ or $) just says that there must be a newline (or the
        beginning or end of the area being searched) at that particular
        point in the text being matched. notice the leading anchors below.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   trap spam where the *very* first line of the body started with
      #   &lt;HTML&gt;

      :0 :
      *$ B ?? ^^$s*&lt;HTML&gt;
      HTML.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          What, exactly, does &quot;Anchor the expression at the very start of
          the search area...&quot; i.e. the ^^ ?</em>



<p class="column8">
        <span class="word-ref">[dan]</span> Technically, an opening ^^ anchors to the putative
        newline that procmail sees before the first character of the search
        area (and a closing ^^ anchors to the putative newline that
        procmail sees after the end of the search area).  When the search
        area is B, that is a point equivalent to the second of the two
        adjacent newlines that enclose the empty line that marks the end of
        the head.


<p class="column8">
        The reason I'm bringing that up is this: if there are multiple
        empty or blank lines between the head and the body, ^^ will mark
        the start of the second of those lines, not the start of the first
        line of the body that contains some text.


<p class="column8">
        So if you want to test whether &lt;pattern&gt; is the first printing text
        in the body, even if it is not necessarily flush left on the very
        first line, you might need a condition like the following, where
        there is space/pipe/tab/pipe/dollar.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ B ?? ^^$SPCNL*&lt;pattern&gt;    </PRE></TD>
    </TR>
</TABLE>



  <a name="anding_traditionally" id="anding_traditionally"></a>
  <h2>
      6.16 ANDing traditionally

  </h2>




<p>
<p class="column8">
        Erm, you knew this already if you read the man pages. Stacking
        condition lines one after another does the AND operation, where
        all of the conditions must be present:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * condition1
      * condition2    </PRE></TD>
    </TR>
</TABLE>



  <a name="oring_traditionally" id="oring_traditionally"></a>
  <h2>
      6.17 ORing traditionally

  </h2>




<p>
<p class="column8">
        Here is simple OR case. There are some cases where it's impossible
        to OR conditions with this style. <span class="word-ref">[philip]</span> knows more about those
        cases.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *  condition1|condition2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Likewise, two exit code tests can often be ORed like this

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ? command1 || command2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But there are many situations where two tests cannot be ORed by
        combining them into one condition:

<ul>
	<li>a regexp search of one area ORed with a regexp search of a
            different area
<li>a positive regexp search <span class="word-ref">[i.e., for a match to its pattern]</span> ORed
            with a negative regexp search [i.e., for the absence of any
            match to its pattern]
	</li>
<li>an exit code condition ORed with a regexp search condition
	</li>
<li>an exit code condition seeking success ORed with an exit code
            condition seeking failure
	<li>a size test ORed with anything else (even another size test)</li>
</ul>




<p class="column10"><em class="quote10">
          How can I make OR conditions that all use the SAME action? I want
          to be able to test for a number of variants on certain requests,
          all in one block.</em>



<p class="column8">
        <span class="word-ref">[hal]</span> Yes, this can be easily done

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      CASE = &quot;&quot;

      :0
      * case 1 tests
      {
          CASE = 1
      }
          :0 E
          * case 2 tests
          {
              CASE = 2
          }

      :0
      * ! CASE ?? ^^^^
      {
          # real work, perhaps with explicit tests on CASE
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column9"><strong>
         Case study: Finding text from header and body</strong>



<p class="column8">
        <span class="word-ref">[david]</span> In addition to the standard ways of coding OR, here's a
        special one for searching the subject and the body for a given word
        in either:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * HB ?? ^^(.+$)*(Subject:(.*[^a-z0-9])?|$(.*\&lt;)*)remove\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If the string doesn't have to be preceded by a word border, it gets
        a little simpler:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * HB ?? ^^(.+$)*(Subject:.*|$(.|$))*string    </PRE></TD>
    </TR>
</TABLE>



  <a name="oring_and_score_recipe" id="oring_and_score_recipe"></a>
  <h2>
      6.18 ORing and score recipe

  </h2>




<p>
<p class="column8">
        Once any of the conditions match, the score gets a positive value and
        the recipe succeeds. Idea by Erik Selke &lt;selke A T tcimet.net&gt;


<p class="column8">
        <span class="word-ref">[era comments]</span> ...allegedly the scoring system is going to cost you
        more than plain old regex matching. Floating-point math and all that,
        even if you use extremely simple scoring. Thus, it would probably be
        slightly more efficient to do it the De Morgan way.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * 1^0 condition1
      * 1^0 condition2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        We can now write the previous case stydy (HB ORing traditionally)
        with scores. I was tempted to write it like this, when <span class="word-ref">[david]</span>
        told me the following.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * 1^0 H ?? match-it
      * 1^0 B ?? match-it    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> That will work, but it isn't the best way to do ORing,
        because if a match is found to the first condition procmail still
        takes the trouble to test the second one. Better, use the supremum
        score on each condition:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $SUPREME = 9876543210

      *$ $SUPREME^0 first_condition_to_be_ORed
      *$ $SUPREME^0 second_condition_to_be_ORed
      * ... etc. ...
      *$ $SUPREME^0 last_condition_to_be_ORed    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Upon reaching the supreme score, procmail will skip all remaining
        weighted conditions on the recipe, deeming them matched. Since all
        conditions on this recipe are weighted, once procmail finds one
        matched condition it will skip the rest and execute the action.



  <a name="oring_by_using_de_morgan_rules" id="oring_by_using_de_morgan_rules"></a>
  <h2>
      6.19 ORing by using De Morgan rules

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Tim Pickett &lt;tbp A T cs.monash.edu.au&gt;]</span> I thought I'd point out that
        there are a few ways to do a logical OR of conditions. Someone posted
        a solution here that involved using procmail's scoring system, but I
        figured you could do it without scoring by taking advantage of De
        Morgan's rule:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      a or b      is same as   not(not a and not b)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        or mathematically:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      a || b &lt;=&gt; !( !a &amp;&amp; !b )    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here's a way to do ORing

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ! condition1
      * ! condition2
      { }             # official procmail no-op. MUST LEAVE SPACE
      :0 E
      action_on_condition1_or_condition2    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="variables"  id="variables"></A>
               <h1>
               7.0 Variables

               </h1>



  <a name="setting_and_unsetting_variables" id="setting_and_unsetting_variables"></a>
  <h2>
      7.1 Setting and unsetting variables

  </h2>




<p>
<p class="column8">
        You have already set variables with the &quot;=&quot; syntax. Variable names
        are case sensitive: <samp class="word">var</samp> is different from <samp class="word">VAR</samp>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = /var/tmp  # directory
      VAR = &quot;this&quot;    # literal
      VAR = 1
      VAR = $FOO      # another.
      VAR = &quot;$VAR at&quot; # combined with previous value    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Unsetting a variable is done like this

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR             # kill variable.
      VAR=            # same, but with old style
      VAR = &quot;&quot;        # Variable is said to be &quot;null&quot; now    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And you can put multiple assignments on the same line, although
        not recommended:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR=1  VAR=2  VAR=3    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Examine the following, which are all equivalent. The back ticks will not
        require a shell in the absence of any <samp class="word">SHELLMETAS</samp> so neither of
        these will spawn a shell

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          #   case1: We Don't care if file exists this time...

          VAR = `cat file`

          #   case2: The use of {} is considered &quot;modern&quot;

          :0
          * condition
          {
              VAR = `cat file`
          }

          #   case3: oldish, and procmail specific and errors have
          #   been reported if you use this construct.
          #   Note: There must be no space in &quot;VAR=|&quot;

          :0
          * condition
          VAR=| cat file    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_initialization_and_sh_syntax" id="variable_initialization_and_sh_syntax"></a>
  <h2>
      7.2 Variable initialization and sh syntax

  </h2>




<p>
<p class="column8">
        Procmail borrows some sh syntax for variable initialization.
        Note that sh's ${var:=default} and ${var=defaultvalue}
        syntaxes are not available in a procmail rcfile.

<ul>
	<li>VAR1 = ${VAR2:-value}
            sets VAR1 to VAR2 if VAR2 is set and non-null, and sets VAR1 to
            default &quot;value&quot; otherwise
<li>VAR1 = ${VAR2-value}
            sets VAR1 to VAR2 if VAR2 is set, and sets VAR1 to default
            otherwise
	</li>
<li>VAR1 = ${VAR2:+value}
            sets VAR1 to &quot;value&quot; if VAR2 is set and non-null, and sets VAR1
            to VAR2 otherwise.
	</li>
<li>VAR1 =${VAR2+value}
            Sets VAR1 to &quot;value&quot; if VAR2 is set and sets VAR1 to VAR2
	            otherwise.</li>
</ul>




<p class="column8">
        And here are the classic usage examples

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = ${VAR:-&quot;yes&quot;}     # set VAR to default value &quot;yes&quot;
      VAR = ${VAR+&quot;yes&quot;}      # If VAR contains value, set &quot;yes&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Ever wondered if this calls `date` in all cases?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = ${VAR:-`date`}    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        No, procmail is smart enough to skip calling <samp class="word">date</samp> if VAR already
        had value. It doesn't evaluate the whole line. Below you see what
        each initialising operator does. Study it carefully

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = &quot;&quot;                # Define variable
      VAR = ${VAR:-&quot;value1&quot;}  # VAR = &quot;value1&quot;
      VAR = &quot;&quot;
      VAR = ${VAR-&quot;value2&quot;}   # VAR = &quot;&quot;

      VAR = &quot;&quot;
      VAR = ${VAR:+&quot;value3&quot;}  # VAR = &quot;&quot;
      VAR = &quot;&quot;
      VAR = ${VAR+&quot;value4&quot;}   # VAR = &quot;value4&quot;

      # Note these:
      VAR = &quot;val&quot;
      VAR = ${VAR:+&quot;value3&quot;}  # VAR = &quot;value3&quot;
      VAR = &quot;val&quot;
      VAR = ${VAR+&quot;value4&quot;}   # VAR = &quot;value4&quot;


      VAR                     # kill the variable
      VAR = ${VAR:-&quot;value1&quot;}  # VAR = &quot;value1&quot;
      VAR
      VAR = ${VAR-&quot;value2&quot;}   # VAR = &quot;value2&quot;

      VAR
      VAR = ${VAR:+&quot;value3&quot;}  # nothing is assigned
      VAR
      VAR = ${VAR+&quot;value4&quot;}   # nothing is assigned    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And if you want to choose from several initial values,
        you might use the recipe below
        instead of the standard var = ${var:-&quot;value&quot;}.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * VAR ?? ^^^^
      {
          #   no value (or was empty), set default value here based on
          #   some guesses

          VAR = &quot;base-default&quot;

          :0
          * condition
          {
              VAR = &quot;another-default&quot;
          }

          ...more conditions..
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You could also use equivalent, but less readable condition line in
        previous recipe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ${VAR:+!}    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It works, because if variable contains a value the line expands to

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
       * !    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Where &quot;!&quot; is the procmail &quot;false&quot; operation. One more way to do the
        same would be, that we require at least one character to be present.
        You could use also regexp (.), which would require at least one
        character to be present, but you might not like matching pure spaces.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! VAR ?? [a-z]    </PRE></TD>
    </TR>
</TABLE>



  <a name="testing_variables" id="testing_variables"></a>
  <h2>
      7.3 Testing variables

  </h2>




<p>
<p class="column8">
        If possible, perform positive tests, rather than negative, like below:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ! TEST_FLAG ?? yes    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        With negative test, this would be:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *  TEST_FLAG ?? no    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Using literal strings like &quot;yes&quot; and &quot;no&quot; might present more clear
        though what is going that a traditional &quot;!&quot; negation of a test.
        Note, that the following fails if the variable is unset or null.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * variable ?? (.)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That was why it would be better to test:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ variable ?? $NSPC    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * variable ?? (.|$)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        to require that <em class="word">variable</em> contain at least one character. But
        neither is a way to check whether a variable is set or not, because
        each treats a null variable the same as an unset one. This is the
        best way to check whether a variable is set or not:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ! ${VAR+!}    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[&lt;gsutter A T pobox.com&gt;]</span> Here is yet another way to test if variable
        is set  and if it isn't, sets it to a default value.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ ! VAR^0
      {
          VAR = &quot;value&quot;
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="what_does" id="what_does"></a>
  <h2>
      7.4 What does $\VAR mean?

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[era and david]</span> Procmail 3.11, $\VAR will escape regexp metacharacters.
        It should produce a suitably backslash-escaped expression for
        Procmail's own use. In addition $\VAR will always begin with leading
        empty parentheses.


<p class="column8">
        You can't pass the $\VAR construct to shell programs, because there
        is that leading parenthesis. Here's a recipe to standardize the regexp.
        You can pass SAFE_REGEXP to an external programs like <samp class="word">sed</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      PROCMAIL_REGEXP = &quot;$\VAR&quot;

      :0
      * PROCMAIL_REGEXP ?? ^^\(\)\/.*
      {
          SAFE_REGEXP = &quot;$MATCH&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[era]</span> Note that this is slightly inexact; Procmail will
        backslash-escape according to Procmail's needs, not sed's. For
        example, Procmail doesn't think braces are magic (although that would
        be nice to have in Procmail as well) whereas many modern variants of
        sed do.



  <a name="common_pitfalls_when_using_variables" id="common_pitfalls_when_using_variables"></a>
  <h2>
      7.5 Common pitfalls when using variables

  </h2>




<p>
<p class="column8">
        Procmail is picky and forgives nothing. Here are some of the favorite
        mistakes one can make:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $EMAIL  = &quot;foo@example.com&quot;    # Done Perl lately? Remove that $

      # Erm, this is ok, but many procmail recipe writers want to
      # take extra precautions and include the regexps in parentheses.
      # So, maybe (yabba|dabba|doo) would be more safe

      REGEXP  = &quot;yabba|dabba|doo&quot;

      *  Subject:.*$REGEXP  # Hey, you need the &quot;*$ Subject...&quot;

      *$  $REGEXP ?? hello  # surely you meant '* REGEXP ?? hello'    </PRE></TD>
    </TR>
</TABLE>



  <a name="quoting_using_single_or_double_quotes" id="quoting_using_single_or_double_quotes"></a>
  <h2>
      7.6 Quoting: Using single or double quotes

  </h2>




<p>
<p class="column8">
        Pay attention to this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = &quot;you&quot;
      NEW = 'hey &quot;$VAR&quot;'  # won't extrapolate $VAR; you get literal
      NEW = &quot;hey '$VAR'&quot;  # extrapolates to: hey 'you'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You can even combine separate words together

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = &quot;1 &quot;&quot;and&quot;&quot; 2&quot; # same as &quot;1 and 2&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Don't let these many quotes disturb you, just count the beginning
        and ending quotes. Superfluous here, but you may need some similar
        construct somewhere else.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = '1 '&quot;'&quot;'and'&quot;'&quot;' 2'  # same as: 1 'and' 2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> Beware forgetting quotes, like when you'd do

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SENDMAILFLAGS = -oQ/var/mqueue.incoming -odq    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail translates <samp class="word">!</samp> into | &quot;$SENDMAIL&quot; &quot;$SENDMAILFLAGS&quot; as the
        procmailrc(5) man page warns us. By the rules of sh quoting, that
        means that shell sees only the first switch

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % sendmail -oQ/var/mqueue.incoming    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        My suggestion: since you need a soft space inside <samp class="word">$SENDMAILFLAGS</samp>,
        use the quotes when you define <samp class="word">$SENDMAILFLAGS</samp> but do this instead
        of using the <samp class="word">!</samp> operator for forwarding:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SENDMAILFLAGS = &quot;-oQ/var/mqueue.incoming -odq&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Walter Haidinger &lt;walter.haidinger A T gmx.net&gt;]</span> Here's yet another
        approach: deliver messages from procmail directly to mailboxes in
        all those users' homes. No sendmail involved, <strong class="word">much</strong> lower loads.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0:
      * &lt;condition&gt;
      /var/spool/mail/someuser    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> Assuming that &quot;someuser&quot; is an actual user in the
        password file (I haven't been following this thread, some maybe
        that isn't true here), then the following is probably better:


<p class="column10"><em class="quote10">
          Walter Haidinger comments on this recipe: I'm happy to announce that
          this works <em class="word">really</em> well. No harm is done to the system-load
          anymore. What a relief!</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 w
      * conditions
      |procmail -d someuser    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That lets procmail's very tricky &quot;screenmailbox()&quot; routine take
        care of bogus mailboxes in a secure fashion.


<p class="column10"><em class="quote10">
          Is that as safe as forwarding? Does another sendmail delivering
          to /var/spool/mail/someuser use the same locking mechanism and notice
          that mailbox is already locked? I don't want to risk a corrupt
          mailbox.</em>



<p class="column8">
        <span class="word-ref">[philip]</span> Sendmail only delivers directly to files through
        aliases that say things like:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          whatever: /some/local/file    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Under normal circumstances, sendmail calls the local mailer to actually
        store mail in a file, and since that's procmail (right?), there
        shouldn't be a problem. Also, sendmail 8 does kernel-level locking
        when it delivers directly.



  <a name="quoting_passing_values_to_an_external_program" id="quoting_passing_values_to_an_external_program"></a>
  <h2>
      7.7 Quoting: Passing values to an external program

  </h2>




<p>
<p class="column8">
        Remember to include the double quotes when you send variables'
        values to the shell programs. Below you see a mistake,
        because the content of the SUBJECT is not quoted and
        thus not available from perl variable <samp class="word">$ARGV[1]</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0                          # Use procmail match feature
      * ^Subject:\/.*
      {
          SUBJECT = &quot;$MATCH&quot;
      }

      :0
      * condition
      | perl-script $SUBJECT      # mistake; use &quot;$SUBJECT&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        There is also another way. If your script can access environment
        variables (almost all programs can), then you do not need to pass
        the variables on the command line. Above, the SUBJECT is already
        in the environment and in Perl you can get it with:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $SUBJECT = $ENV{SUBJECT};    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Next, do you know what is the difference between these two recipes?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      | &quot;command arg1 arg2 arg3&quot;

      :0
      | command &quot;arg1&quot; &quot;arg2&quot; &quot;arg3&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You guessed it. The first one quotes the entire command and does not do
        the right thing, the latter is correct and depending on the content of
        argN variables. Anyway, play safe and always add quotes.


<p class="column8">
        Sometimes you need trickier quoting to to get single quotes around
        the <samp class="word">arg</samp>. Pay attention to this, because this may be the reason
        why your grep command doesn't seem to succeed as you expect.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  If $GREP &quot;$arg&quot; doesn't seem to work

      :0
      * ? $GREP &quot;'&quot;$arg&quot;'&quot; $DATABASE
      {
          # Do something
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="passing_values_from_an_external_program" id="passing_values_from_an_external_program"></a>
  <h2>
      7.8 Passing values from an external program

  </h2>




<p>
<p class="column8">
        External programs cannot set procmail variables directly. Programs
        must write the values to external files and then read the values
        from these files. Capturing only one value is easy:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      var = `command`      # capture STDOUT    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But if a program modifies the body and exports some status
        information it is trickier. We assume here that the script is
        controlled by you and that you have added the switch
        --export-status option which causes the program to print
        information to a separate file.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LOCKFILE    = $HOME/.run$LOCKEXT  # protect external file writing
      valueFile   = $HOME/tmp/values

      #   modify body, and export status values to external file: one
      #   value in every line
      #
      #       VALUE1
      #       VALUE2
      #       VALUE3

      :0 fb
      | $NICE script.pl --export-status $valueFile

      values = `cat $valueFile`

      # Derive values from each line

      :0                              # line 1
      *$ values ?? ^^\/[^$NL]+
      {
          var1 = $MATCH
      }

      :0                              # line 2
      *$ values ?? ^^.*$\/[^$NL]+
      {
          var2 = $MATCH
      }

      :0                              # line 3
      *$ values ?? ^^.*$.*$\/[^$NL]+
      {
          var3 = $MATCH
      }

      LOCKFILE    # Release lock    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[richard]</span> Alternatively write valueFile from your rc or external
        program with lines like

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      PARAM1=&quot;value for param 1&quot;
      PARAM2=&quot;value for param 2&quot;
      PARAM3=&quot;value for param 3&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and read it with

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      INCLUDERC $valueFile    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now there is no need to worry about synchronizing the read with the
        lines, or about adding new parameters, since each is labeled in
        valueFile.



  <a name="incrementing_a_variable_by_a_value_n" id="incrementing_a_variable_by_a_value_n"></a>
  <h2>
      7.9 Incrementing a variable by a value N

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[dan, phil and Richard]</span> Here's a recipe for incrementing a variable
        by a value N. If $VAR is not a number, we get an error. Note that
        if $VAR + $N is not greater than 0, this recipe will not change the
        value of VAR if the assignment happens inside braces. You must
        place the assignment after the closing curly brace.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ $VAR ^0
      *$ $N   ^0
      { }             # procmail no-op
      VAR = $=    </PRE></TD>
    </TR>
</TABLE>



  <a name="comparing_values" id="comparing_values"></a>
  <h2>
      7.10 Comparing values

  </h2>




<p>
<p class="column8">
        It's too expensive to call the shell's <samp class="word">test</samp> function to do
        [-lt|-eq|-gt] because you can do the same with procmail. The
        do-something below is run if SCORE &lt;= MAXIMUM. The recipe simply
        subtracts SCORE from MAXIMUM and determines if the result is
        positive.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ -$SCORE   ^0
      *$  $MAXIMUM ^0
      {
          .. do-something
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[idea by era]</span> it's getting slightly cumbersome if it's between MIN
        and MAX:


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$   $SCORE ^0
      *$  -$MIN   ^0
      {
          dummy               # no-op, just for the LOG

          :0
          *$ -$SCORE  ^0
          *$  $MAX    ^0
          {
              suitable
          }
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Eg. When values are MIN=1, MAX=5, SCORE=4

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      procmail: Assigning &quot;SCORE=4&quot;
      procmail: Score:       4       4 &quot;&quot;
      procmail: Score:      -1       3 &quot;&quot;
      procmail: Assigning &quot;dummy&quot;
      procmail: Score:      -4      -4 &quot;&quot;
      procmail: Score:       5       1 &quot;&quot;
      procmail: Assigning &quot;suitable&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="strings_how_many_characters_are_there_in_a_given" id="strings_how_many_characters_are_there_in_a_given"></a>
  <h2>
      7.11 Strings: How many characters are there in a given string?

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *  1^1 VAR ?? .
      { }
      LENGTH = $    </PRE></TD>
    </TR>
</TABLE>



  <a name="strings_how_to_strip_trailing_newline" id="strings_how_to_strip_trailing_newline"></a>
  <h2>
      7.12 Strings: How to strip trailing newline.

  </h2>




<p>
<p class="column8">
        Suppose you have used regexp, which left newline($) in the <samp class="word">MATCH</samp>.
        If you wonder why the recipe works, remind yourself that regexp
        operator &quot;.&quot; never matches a newline.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * VAR ?? ^^\/.+
      {
          VAR = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="strings_deriving_the_last_n_characters_of_a_string" id="strings_deriving_the_last_n_characters_of_a_string"></a>
  <h2>
      7.13 Strings: deriving the last N characters of a string.

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   1998-06-23 PM-L [walter] Note the use of
      #   the $ sign below to anchor to end-of-string...
      #
      #   For last 2 characters use * VAR ?? ()\/..$
      #   For last 5 characters use * VAR ?? ()\/.....$

      :0                      # Last character
      * VAR ?? ()\/.$
      {
          TAIL = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="strings_getting_partial_matches_from_a_string" id="strings_getting_partial_matches_from_a_string"></a>
  <h2>
      7.14 Strings: Getting partial matches from a string.

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[dan]</span> Getting a match to the right is quite easy with procmail's
        <samp class="word">match</samp> operator.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = &quot;1234567890&quot;

      :0
      * VAR ?? ()\/3.*
      {
          result = $MATCH                         # now 34567890
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        but deleting 2 characters from the end is nearly impossible without
        forking an outside process. The cheapest might be <samp class="word">expr</samp> because it
        doesn't need a shell to pipe <samp class="word">echo</samp> to it (as <samp class="word">sed</samp> would and I
        believe <samp class="word">perl</samp> would):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   by resetting the shellmetas, this will only call
      #   `expr'. If we wouldn't have fiddled with shellmetas,
      #   this would have called two processes: sh + expr

      saved       =   $SHELLMETAS
      SHELLMETAS
      result      =   `expr &quot;$VAR&quot; : '\(.*\)..'`  # now 12345678
      SHELLMETAS  =   $saved    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        ksh or bash could do it as well:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   semicolon to force invoking a shell, actually
      #   first question mark will force a shell already.

      saved       = $SHELL
      SHELL       = /bins/sh
      result      = `echo ${VAR%??} ;`
      SHELL       = $saved    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now, if you know that the last two characters will be &quot;90&quot;, that's
        different. Of course, this totally screws up if the third-to-last
        character is a 9.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * VAR   ?? ()\/.*[^0]
      * MATCH ?? ()\/.*[^9]
      {
          result = $MATCH                         # now 12345678
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[jari]</span> Comments: If a shell must be used, then <samp class="word">awk</samp> is a good tool for
        simple string manipulation. Its startup time is faster that perl's
        whose overhead is due to internal compilation. <samp class="word">awk</samp> also consumes
        less recourses overall than <samp class="word">perl</samp>. Following will only work if VAR
        is a string of continuous block of characters. (ARGV<span class="super">1</span> can be used)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      saved       =   $SHELLMETAS
      SHELLMETAS

      VAR = ` awk 'BEGIN{ v = ARGV[1];                                \
              print substr(v,1,length(v)-2); exit }'                  \
              &quot;$VAR&quot;                                                  \
            `

      SHELLMETAS = $saved    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This version requires <strong class="word">some</strong> file, any file, so that we get awk
        started. In the previous code all the work was done in the BEGIN
        block and no file was ever opened.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      saved       =   $SHELLMETAS
      SHELLMETAS

      VAR = ` awk '{print substr(v,1,length(v)-2); exit }'            \
              v=&quot;$VAR&quot; /etc/passwd                                    \
            `

      SHELLMETAS = $saved    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[dan]</span> comments awk: <samp class="word">expr</samp> is sure to be a smaller binary than awk
        for procmail to fork, and it needs much less command-line code to
        do this job. Note also that one still has to diddle with SHELLMETAS
        to avoid a shell, because the awk code contains brackets; thus it
        doesn't replace all.


<p class="column8">
        There is also a way to remove words from the end of string by
        procmail means if the strings are separated by same separator. Let's
        use the word this-mailing-list-request which we would like to shorten
        to this-mailing-list. <span class="word-ref">[david]</span> presented the recipe 1998-06-16 in PM-L.


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR = &quot;this-mailing-list&quot;

      #   1) if there is match at the end ending to these words
      #   2) Get everything up till last match and store it to MATCH
      #   3) Read MATCH, but exclude last dash &quot;-&quot;

      :0
      * VAR   ?? -(owner|request|help)^^
      * VAR   ?? ^^\/.*-
      * MATCH ?? ^^\/.*[^-]
      {
          VAR = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="strings_procmail_string_manipulation_example" id="strings_procmail_string_manipulation_example"></a>
  <h2>
      7.15 Strings: Procmail string manipulation example

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[1998-06-23 PM-L walter]</span> ... Now we get to apply these formulas
        to strip the last character off a string. It gets a bit ugly for
        special cases. I've deliberately chosen a worst-case scenario.


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR         = &quot;Testing 012301230111&quot;
      RC_APPEND   = $PMSRC/pm-myappend.rc

      :0
      * VAR ?? ()\/.$
      {
          TAIL = $MATCH           # last character of VAR &quot;1&quot;

          # Get the longest match that does not end in the TAIL character

          :0
          *$ VAR ?? ()\/.*[^$TAIL]
          {
              HEAD = $MATCH      # now &quot;Testing 012301230&quot;

              #   if the last two or more characters in VAR are
              #   identical, they all get chopped, oops

              :0
              * -1^0
              *  1^1 VAR  ?? (.)
              * -1^1 HEAD ?? (.)
              {
                  dummy     = &quot;tooshort&quot;
                  INCLUDERC = $RC_APPEND
              }
          }
      }

      result = $HEAD              # &quot;Testing 01230123011&quot;

      # ........................................ pm-myappend.rc
      #   LENGTH(HEAD) plus 1 SHOULD equal LENGTH(VAR). That is
      #   not the case when the last 2 (or more) ending
      #   characters are identical. in that case, call appendrc
      #   recursively to stick back an appropriate number of
      #   TAIL characters.

      :0
      * -1^0
      *  1^1 VAR  ?? (.)
      * -1^1 HEAD ?? (.)
      {
          HEAD      = &quot;$HEAD$TAIL&quot;
          INCLUDERC = $RC_APPEND
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_raise_a_flag_if_the_message_was" id="how_to_raise_a_flag_if_the_message_was"></a>
  <h2>
      7.16 How to raise a flag if the message was filed

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FILED = !       # ! is procmail &quot;false&quot;

      :0 c:           # We process the message more
      * condition
      foo

          :0 a
          {
              FILED   # Kill variable
          }

      ...

      :0              # Stop if previous cases filed the message
      *$ $FILED
      {
          HOST = &quot;_done_&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or alternatively: procmail automatically sets <samp class="word">LASTFOLDER</samp> if
        it delivers message to mailbox.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LASTFOLDER      # kill variable

      :0 c:
      * condition
      foo

      :0 c:
      * condition
      bar

      ... et cetera ...

      :0
      * ! LASTFOLDER ?? ^^^^      # Or   ${LASTFOLDER+!}!
      {
          HOST = &quot;_done_&quot;         # Force procmail to stop
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="dollar_sign_in_condition_lines" id="dollar_sign_in_condition_lines"></a>
  <h2>
      7.17 Dollar sign in condition lines.

  </h2>




<p>
<p class="column8">
        #todo, check this recipe

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      This doesn't seem to work for me...

      * ^TO()$\foo@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> An unescaped dollar sign later in the line represents a
        newline, so what you have there is searching for the following:

<ol>
	<li>An expression that matches the expansion of the ^TO token (which
            is anchored to the start of a line by its definition), followed
            by
<li>A newline, followed at the start of the next line by
	</li>
<li>&quot;foo@bar&quot; [the backslash escapes the f, which didn't need
            escaping], followed by
	</li>
<li>any character that is not a newline (the period is unescaped),
            and finally
	<li>&quot;com&quot;.</li>
</ol>




<p class="column8">
        Try this instead:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ^TO()$\foo@example\.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        #todo: the dollar seems exactly the same in the above two
        #todo Examples: are you sure that this is correct?


<p class="column8">
        In fact, to avoid matches to things like foo@example.community.edu,
        you might want to do it this way:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ^TO()$\foo@example\.com\&gt;    </PRE></TD>
    </TR>
</TABLE>



  <a name="finding_mysterious_foo_variable" id="finding_mysterious_foo_variable"></a>
  <h2>
      7.18 Finding mysterious foo variable

  </h2>




<p>
<p class="column10"><em class="quote10">
          I have my fellow worker's procmail code and he uses a variable FOO
          that I can't find in his code anywhere. It's not a shell variable
          either, because it's literal. Where does it come from?</em>



<p class="column8">
        Your procmail runs /etc/procmailrc when it starts, please check
        that. It may define some common variables already for all users.



  <a name="storing_code_to_variable" id="storing_code_to_variable"></a>
  <h2>
      7.19 Storing code to variable

  </h2>




<p>
<p class="column8">
        One way to run complex code in a procmail recipe is first to store
        it in a variable. Idea by <span class="word-ref">[era]</span>. You could do this in a separate shell
        script too. The following example reads URLs from the body of
        a message: the URLs have been put to separate lines and some special
        Subject is used to trigger the dumping of the HTML pages:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Code by [era]
      #
      COMMAND='while read url; do
          case &quot;$url&quot; in
            *://*)
              lynx -traversal -realm -crawl -number_links &quot;$url&quot; |
              $SENDMAIL $LOGNAME
              ;;
          esac
      done'


      #  Notice the trailing semicolon after `eval' !
      :0 bw
      * ^Subject: xxxxx
      | eval &quot;$COMMAND&quot; ;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you want to run the code inside the nested block, then look
        carefully, there are double quotes around the command in back ticks.
        If you leave double quotes out, then each word in SH_CMD would be
        interpreted separately:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      $SH_CMD = '$echo &quot;$VAR&quot; &gt;&gt; $HOME/test.tmp'

      :0
      * condition
      {
          #   condition satisfied; run the given shell command
          #   and do something more.

          dummy = `&quot;$SH_CMD&quot;`

          ..rest of the code..
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A similar construct works for message echoing too:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      MESSAGE='Thank you so much for your message.
      Unfortunately, the volume of mail I receive .... (blah blah blah).
      If your matter is urgent, try calling +358-50-524-0965.
      '

      :0 hw
      * ! ^X-Loop: moo$
      | ($FORMAIL -rt -A &quot;$MYXLOOP&quot;; echo &quot;$MESSAGE&quot;) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>



  <a name="getting_headers_into_a_variable" id="getting_headers_into_a_variable"></a>
  <h2>
      7.20 Getting headers into a variable

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Here are several ways to get the entire header into a variable:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HEADER = `$FORMAIL -X &quot;&quot;` # The space after the X is vital.
      HEADER = `sed /^$/q`      # also writable as  HEADER=`sed /./!q`

      :0 h
      HEADER=|cat -    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        will save the entire header into one variable. It has to be smaller
        than <samp class="word">LINEEBUF</samp>, though. This way might work as well, and will require no
        outside processes if it does:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^^\/(.+$)*$
      {
          HEADER = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="converting_value_to_lowercase" id="converting_value_to_lowercase"></a>
  <h2>
      7.21 Converting value to lowercase

  </h2>




<p>
<p class="column8">
        If you know that a word belongs to set of choices, you can do
        this inside procmail

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LIST = &quot;:word1:word2:word3:word4&quot;   # Colon to separate words
      WORD = &quot;WORD1&quot;

      :0
      *$ LIST ?? :\/$WORD
      {
          WORD = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But if you don't know the word or string beforehand, then this is
        the generalized way: <span class="word-ref">[idea by era and david]</span>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 D
      * WORD ?? [A-Z]
      {
          WORD = `echo &quot;$MATCH&quot; | tr A-Z a-z`
      }    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="suggestions_and_miscellaneous"  id="suggestions_and_miscellaneous"></A>
               <h1>
               8.0 Suggestions and miscellaneous

               </h1>



  <a name="speeding_up_procmail" id="speeding_up_procmail"></a>
  <h2>
      8.1 Speeding up procmail

  </h2>



<p>
<ul>
	<li>Use absolute paths to take the burden of searching binary along path
	            from shell: Use $FORMAIL variable abstraction.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          $FORMAIL = &quot;/usr/local/bin/formail&quot;

          :0 fhw
          | $FORMAIL -I &quot;X-My-Header: value&quot;    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Multiple <samp class="word">echo</samp> commands that spread many lines can be converted
            to single echo command if \n escape is supported. You usually
	            see these in auto responders</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          echo &quot;.........&quot;; \
          echo &quot;.........&quot;; \
          echo &quot;.........&quot;;

          --&gt;

          echo &quot;.........\n&quot; \
               &quot;.........\n&quot; \
               &quot;.........\n&quot;;    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>You can avoid multiple and possible expensive FROM_DAEMON tests
            by caching the result at the top of your .procmailrc. You can
            now use variable $from_daemon like the big brother FROM_DAEMON.
            The same idea can be applied to FROM_MAILER regexp. If you have
            <em class="word">pm-javar.rc</em>, it already defines variables <samp class="word">$from_daemon</samp> and
	            <samp class="word">from_mailer</samp> exactly like here:</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          from_daemon = &quot;!&quot;

          :0
          * ^FROM_DAEMON
          {
              from_daemon = &quot;!!&quot;  # double !! means &quot;OK&quot;
          }

          :0
          *$ ! $from_daemon
          {
              ..do-it..
          }    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Count the back ticks and you know how many shell calls procmail
            has to launch. See if you can minimize them and use some procmail
            code instead.
<li>^TO and other macros are expensive, see if you can use simple
            Header:.*\&lt;match-it\&gt; instead. Well, it's not clear if this
            gives you much speed advantage.
	</li>
<li>Don't call &quot;$FORMAIL -xHeader:&quot; every time you need a header
            value, consider if it suffices to use <samp class="word">match</samp> operator \/.
	</li>
<li>You can minimize the calls to only one <samp class="word">formail</samp> if you add many
            headers along the way: See formail usage tips in this document
	</li>
<li>Searching body is expensive, simply because it contains more text.
            There isn't much to do about this, because you use <samp class="word">B</samp> anyway
            when you need it.
	</li>
<li>See if you can move some tasks to your .cron file. procmailrc is
            not meant for those purposes. Instead of calculation daily
            values every time in procmail, let cron do that at 04:00 or
            21:00. Don't run cron at midnight if you can, because everybody
            else is running their crons at the same time. If &quot;logical&quot; date
            change time can be used (when you arrive to work, when you
            leave the work), use it in cron jobs.
	</li>
<li><span class="word-ref">[philip]</span> Setting <samp class="word">LINEBUF</samp> permanently to a big value slows
            procmail down.
	</li>
<li>Remove all calls to <samp class="word">perl</samp> and use programs that are nicer to
            the system (If you just call command line perl, there is
            probably an equivalent alternative with <samp class="word">awk</samp> <samp class="word">tr</samp> <samp class="word">sed</samp> <samp class="word">cut</samp>)
	</li>
<li>Examine each shell command and see if you do need <samp class="word">SHELLMETAS.</samp>
            If you can set <samp class="word">SHELLMETAS</samp> to empty, this saves calling &quot;sh&quot; for
	            each invocation of the external command.</li>
</ul>





  <a name="see_the_procmail_installations_examples" id="see_the_procmail_installations_examples"></a>
  <h2>
      8.2 See the procmail installation's examples

  </h2>




<p>
<p class="column8">
        Did you remember to look at the examples that come with procmail? If
        not, it's time to give them a chance to educate you. Here is one
        possible directory you could take a look. Ask from your sysadm if you
        can't find the directory where to look into.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % ls /usr/local/lib/procmail-3.11pre7/examples/    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or if you're really anxious to get on your own, try this. The directory
        /opt/local is for HP-UX 10 machines and the <em class="word">forward</em> contains example
        how to define your <samp class="word">.forward</samp> for procmail.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % find /opt/local/ -name &quot;forward&quot; -print    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If the find succeeded and found the file, then you know where the
        procmail files installation directory is.



  <a name="printing_statistics_of_your_incoming_mail" id="printing_statistics_of_your_incoming_mail"></a>
  <h2>
      8.3 Printing statistics of your incoming mail

  </h2>




<p>
<p class="column8">
        If you keep the procmail log crunching, it will record to which
        folder the messages was filed. There is program <samp class="word">mailstat</samp> which
        can process the procmail.log file and print nice summary out of it.
        If you generate the summary at midnight and clear the log, you
        get pretty nice per day/per folder traffic analysis.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # -m merges all error messages into a single line

      % mailstat -km procmail.log    </PRE></TD>
    </TR>
</TABLE>



  <a name="storing_ube_mailboxes_outside_of_quota" id="storing_ube_mailboxes_outside_of_quota"></a>
  <h2>
      8.4 Storing UBE mailboxes outside of quota

  </h2>




<p>
<p class="column10"><em class="quote10">
          I want to store spam outside disk space. Problem: if I tell
          procmail to deliver to, say, /tmp/spam.box, it does so just fine
          (according to the log). Unfortunately, it delivers to /tmp on the
          mail host which I cannot access. spam.box doesn't appear in the
          /tmp directory of the shell machine when procmail is invoked for
          incoming mail.</em>



<p class="column8">
        <span class="word-ref">[philip]</span> Under the most likely configuration of sendmail in
        this situation, it is impossible to have procmail invoked by
        sendmail on the shell machine: sendmail is probably set to just
        forward all mail to the designated mail delivery machine.


<p class="column8">
        There are other options: you could temporarily store the mail in
        your account, then have a cron job on the shell machine that
        reprocesses the message. That would probably be more efficient than
        having each message trigger an rsh to the shell machine. If you
        actually get enough spam that it's pushing against your quota, then
        the rsh is too expensive &ndash; use a cron job that invokes something
        like:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      cd your-maildir     &amp;&amp;
      lockfile spam.lock  &amp;&amp;
      test -s spam        &amp;&amp;
      {
          cat spam &gt;&gt; /tmp/spam.box &amp;&amp; rm -f spam spam.lock || \
          rm -f spam.lock;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        WARNING: the above assumes the following:

<ul>
	<li>everything in your-maildir/spam is spam and belongs in
            /tmp/spam.box
<li>no further filtering of the messages is necessary: they just need
            to be moved (it actually treats everything in the
            your-maildir/spam as a single message and uses procmail as a
            reliable copy command, thus the <samp class="word">DEFAULT</samp> assignment as the use
            of /dev/null as a empty procmailrc)
	<li>/tmp/spam.box is a not a directory</li>
</ul>




<p class="column8">
        If the latter two of those conditions isn't true OR IF THEY MIGHT
        CHANGE then you should use <samp class="word">formail</samp> <samp class="word">-s</samp> to break the message apart
        and invoke procmail on each one separately.


<p class="column8">
        <span class="word-ref">[era]</span> Many sites cross-mount directories for various reasons. /tmp
        is always local but /var/tmp might be cross-mounted between the
        login host and the mail host; another one to try is /scratch &ndash; and
        if all else fails, ask your admin to set up an NFS share for this
        purpose.



  <a name="using_first_530_lines_from_the_message" id="using_first_530_lines_from_the_message"></a>
  <h2>
      8.5 Using first 5-30 lines from the message

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[era]</span> The regexp to grab few lines (or all of them, if there are
        less than fifty) is not going to be very pretty, but it saves launching
        an extra process.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ B ?? ^^$SPCNL*\/$NSPC.*$(.*$)?(.*$)?
      {
          toplines =  $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The skipping of whitespace at the beginning of the message is of
        course not necessary. You should probably set <samp class="word">LINEBUF</samp> reasonably
        high if you grab many lines, say 30: 80*30 = 2400 bytes; probably
        setting it to 8192 or 16384 is a good idea, depending how much you
        want to match. The above gets ugly quickly, so

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  But if N=30, sed ${N}q if you don't have head

      :0 i
      {
          toplines = `head -$N`
      }

      :0 a
      * toplines ?? pattern
      {
          ...do-it
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_cat_or_echo_in_scripts" id="using_cat_or_echo_in_scripts"></a>
  <h2>
      8.6 Using cat or echo in scripts?

  </h2>




<p>
<p class="column10"><em class="quote10">
          I have seen a lot of examples that use 'echo', i.e.,</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
      | echo &quot;first line of message&quot;  \
             &quot;second ...&quot;             \
             &quot;et cetera&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          I started out with spam.rc from &quot;ariel&quot; which got me into the
          habit of</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
      | cat file_containing_message    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          although I note that spam.rc did have one recipe using the echo
          method. What are the reasons for choosing each method over the
          other?</em>



<p class="column8">
        Here is a comparison table. Choose the one you think is best for you

<ul>
	<li>Echos don't have dependency on an external file:
            everything is contained in the .procmailrc file. Echos keep
            all the relevant stuff in one file. Cat's make you
            maintain multiple files. That's the main
            reason I lean toward echo's; you may have accounts on
            several machines. It is easier to be able to copy just one
            generic .procmailrc between them without having to copy a bunch
            of messages also. Mostly, though, there's no real difference
            between the two methods.
<li>Echo is easier to use with variables.
	</li>
<li>Echo starts many processes, cat only starts one, but this is
            not always true: In most current Bourne shell implementations,
            echo is a built-in. This holds true with tcsh too.
	</li>
<li>The main problem I see with the use of cat is &quot;what happens when
            you forget the file or destroy it ?&quot;. I suggest to, at least,
            test that the file is readable before catting it.
	</li>
<li><span class="word-ref">[richard]</span> An argument against echo is that it is not well
            standardized, and different versions may exist on the same
            machine. Some recognize -n, some don't; some recognize embedded
            metacharacters, some don't.This is an argument in favor of
            <samp class="word">print</samp>. Print, however, is not a built-in on all systems. The
            comment on built-ins is pertinent to situations when a shell is
            spawned. When procmail handles the call directly, it will
            always look for a stand-alone executable. I guess echo may be
            better, as long as we are aware of any differences in behavior
	            between built-in and stand-alone versions.</li>
</ul>





  <a name="how_to_run_an_extra_shell_command_as_a" id="how_to_run_an_extra_shell_command_as_a"></a>
  <h2>
      8.7 How to run an extra shell command as a side effect?

  </h2>




<p>
<p class="column10"><em class="quote10">
          <span class="word-ref">[jari]</span> I was once wondering what would be the wisest way to send
          messages to my daily &quot;biff&quot; log file about the events that
          happened during my .procmailrc execution. This is how <span class="word-ref">[david]</span>
          commented on my ideas</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # case 1: print to BiffLog

      dummy = `echo &quot;message: $FROM $SUBJECT&quot; &gt;&gt; $biff`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> Problems you get no locking on the destination file, and
        unless you put it inside braces you have to run it on every message
        unconditionally. (Also procmail tries to feed the whole message to
        a command that won't read it, but the remedies for that don't help
        very much.)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # case 2: We consume delivering recipe and therefor have to use
      #        `c' flag.

      :0 whic:
      | echo &quot;message: $FROM $SUBJECT&quot; &gt;&gt; $biff    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here it locks the destination file and you can add conditions to
        it, so it's probably the best. If the head or the body is less than
        one bufferful, you can limit the unnecessarily written data with <samp class="word">h</samp>
        or <samp class="word">b</samp>, but I think that in most OSes a partial buffer and a full
        one are the same amount of effort.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # case 3: We use side effect of &quot;?&quot; here. Cool, but this
      # doesn't do $biff file locking thus message order may
      # not be what you expect.

      :0
      *  condition
      *  ? echo message: $FROM $SUBJECT &gt;&gt; $biff
      { }         # procmail no-op    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        We have conditions possible, but there is no locking on the
        destination file. I'd go with method #2 or a variation thereof:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hic:                 #   we don't necessarily need `w'
      * condition
      | echo message: $FROM $SUBJECT &gt;&gt; $biff


      :0 hi:                  #   Or you could use this
      * condition
      dummy=| echo message: $FROM $SUBJECT &gt;&gt; $biff    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          <span class="word-ref">[jari]</span> Now, when <span class="word-ref">[david]</span> has explained how various ways differ
          from each other, I present the recipe where I used the case 3.
          When I was dropping a message to a folder, I wanted to send a
          message to my biff log too. The idea is that the drop-conditions
          have already matched and then we run extra command by using side
          effect of &quot;?&quot; token. As far as the recipe is concerned, the &quot;?&quot;
          is a no-op. The pedantic way would have been to add the LOCKFILE
          around to the recipe, but imagine 50 similar recipes like
          this...and you understand why the LOCKFILE was left out. It's
          only necessary if you worry about sequential writing to the biff
          file.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * drop-condition
      * ? echo message: $FROM $SUBJECT &gt;&gt; $biff
      $MBOX    </PRE></TD>
    </TR>
</TABLE>



  <a name="forcing_ok_return_status_from_shell_script" id="forcing_ok_return_status_from_shell_script"></a>
  <h2>
      8.8 Forcing &quot;ok&quot; return status from shell script

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...the &quot;?&quot; trick only allows running some additional shell
          commands (<samp class="word">true</samp> command always succeeds) while conditions
          above have already determined that drop will take place. And you
          can always make condition to succeed if a misbehaving shell script
          always returns a failure exit code.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * ? misbehaving-shell-script || true    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> If the script <em class="word">always</em> returns a failure code, just do this:


<p class="column10"><em class="quote10">
          * ! ? misbehaving-shell-script</em>



<p class="column8">
        The more complex case is a script that can return either success or
        failure but you don't care which; if the drop conditions passed,
        you want to run the action line. <samp class="word">echo</samp> can also fail if the
        process lacks permission or opportunity to write to stdout. A more
        reliable choice is true(1); its purpose in life is to do nothing
        but exit with status 0.


<p class="column8">
        The command <samp class="word">:</samp> is a shell built-in which always returns true
        status. Not exactly more readable than true(1) &quot;|| :&quot; will save the
        invocation of true (unless true is built into $SHELL), but procmail
        will still run a shell. On the other hand, as long as the command
        itself has no characters from <samp class="word">SHELLMETAS</samp> a weight of 1^1 and no
        &quot;|| anything&quot; will avoid the shell process as well.


<p class="column8">
        However, there is yet a better way to make sure that a failure by the
        script doesn't make procmail abort the recipe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 flags
      * other conditions
      * 1^1 ? shell-script
      action    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Regardless of the exit status of the script, the condition will score
        1 and not interfere with procmail's decision about the action line of
        the recipe. Weighted exit code conditions behave like this (see the
        procmailsc(5) man page):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * w^x ? command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        scores w on success or x on failure.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * w^x ! ? command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        scores the same as this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * w^x  pattern_that_appears_in_the_search_area_$?_times    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_grep_with_file_lists_to_mach_messages" id="using_grep_with_file_lists_to_mach_messages"></a>
  <h2>
      8.9 Using grep with file lists to mach messages

  </h2>




<p>
<p class="column8">
        If you want to implement blacklisting or whitelisting, here is the
        idea how to call <samp class="word">grep</samp> program to do matches. First, suppose you
        want to match against bad words. The following example supposes GNU
        tools for sed, egrep. The <em class="word">regexp</em> variable is read from file by
        first calling <samp class="word">tr</samp> to produce &quot;this |that|\&lt;get this!|&quot; which is a
        combined string from file's lines. It is further post processed
        with <samp class="word">sed</samp> by a) deleting any trailing whitespaces before (|) and
        by b) deleting unnecessary trailing or(|) token(s) added by <samp class="word">tr</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      EGREP       = &quot;/bin/egrep&quot;
      SED         = &quot;/bin/sed&quot;
      TR          = &quot;/usr/bin/tr&quot;
      file        = $HOME/procmail/spam-regexp.lst
      regexp      = `$TR '\n' '|' &lt; $kwdfile | $SED -e &quot;s/[ \t]+|/|/ ; s/|+$//&quot; `

      :0 HBw
      * ! regexp ?? ^^^^
      *$ ? $EGREP --quiet --ignore-case --regexp='$regexp'
      {
          #  Matches, do something
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It is a little easier to check sender's address against a
        whitelist, because it is possible to use &quot;word&quot; based checking in
        contrast to regular expression checking aboce. Supposing that
        <samp class="word">file</samp> contains known email addresses listed one at a time, the
        recipe recipe would be:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      file         = $HOME/procmail/spam.keywords
      searchFields = &quot;-xSender: -xFrom -xFrom: -xReturn-Path: -xReply-To:&quot;

      :0 w
      *$ $FORMAIL $searchFields | $EGREP --quiet --ignore-case --file='$file'
      {
          # This sender is known
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">A</strong> <strong class="word">word</strong> <strong class="word">of</strong> <strong class="word">caution:</strong> white list or black list based sender
        matching does not work 100%. The spammers hijack large amount of
        other people's email addresses which they ruthlessly use in
        identifying the message's sender. It is no surprise to receive a
        Unsolicited Bulk Email from friend &ndash; he is not the real sender,
        but his address was drifted to spammers email database.



  <a name="make_your_own_procmailrc_available_to_others" id="make_your_own_procmailrc_available_to_others"></a>
  <h2>
      8.10 Make your own .procmailrc available to others

  </h2>




<p>
<p class="column8">
        There is never too much to learn about procmail and the best source
        is the rc files that people have done. Remember to comment your
        procmailrc file well before you put it available. Below is a<br>
        recipe for sending your .procmailrc upon request. If you want to
        send anything more that one or two files (many times you want to
        put other files available too), then please do not use this code
        but a general file server module.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ! ^Subject:.Re:
      *   ^Subject:.*send.*procmailrc
      * ! ^FROM_DAEMON
      {
          :0 fhw:
          | $FORMAIL -rt                                              \
                     -A &quot;Precedence: junk&quot;                            \
                     -I &quot;Subject: Requested .procmailrc&quot;;             \
                     -I &quot;$MYXLOOP&quot;

          :0 a hwic
          | ( cat - $HOME/.procmailrc ) | $SENDMAIL

          :0              # trash the &quot;Send procmailrc&quot; request
          /dev/null
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_dates_efficiently" id="using_dates_efficiently"></a>
  <h2>
      8.11 Using dates efficiently

  </h2>




<p>
<p class="column10"><em class="quote10">
          <strong class="word">Note</strong>: See module list, where you will find <samp class="word">date</samp> and <samp class="word">time</samp>
          parsing modules. You can also parse the date from the first
          <samp class="word">Received</samp> or <samp class="word">From_</samp> header if it is the same each time in your
          system. That would be orders of magnitude faster and decreases
          your system load if you receive lot of mail.</em>



<p class="column8">
        Calling <samp class="word">date</samp> in your procmail script <strong class="word">many</strong> times is not a good
        idea. Use the <samp class="word">MATCH</samp> as much as possible to be efficient in
        procmail, like below where we call <samp class="word">date</samp> only once. If you are not
        in the same time zone as your server, and you want an accurate
        report of the date, you might amend the invocation to the following:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      date = `TZ=&quot;KDT9:30KST10:00,64/5:00,303/20:00&quot;;date &quot;+%Y %m %d&quot;`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The basic recipe is here

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # By [richard] add %H:%M%S if you want these as well

      :0
      * date ?? ^^()\/....
      {
          YYYY = $MATCH
      }

      :0
      * date ?? ^^..\/..
      {
          YY = $MATCH
      }

      :0
      * date ?? ^^.....\/..
      {
          MM = $MATCH
      }

      :0
      * date ?? ()\/..^^
      {
          DD = $MATCH
      }

      TODAY   = &quot;$YYYY-$MM-$DD&quot; # ISO std date: like 1997-12-01    </PRE></TD>
    </TR>
</TABLE>



  <a name="keep_simple_header_log" id="keep_simple_header_log"></a>
  <h2>
      8.12 Keep simple header log

  </h2>




<p>
<p class="column8">
        Here is a simple strategy: record all what comes in and record all what
        happened to that message. See how brief info is constantly recorded to
        <em class="word">BIFF</em> folder. You can now check the <em class="word">BIFF</em> log every day to
        see if the messages were sunk to right folders: Remember to add <em class="word">BIFF</em>
        rule to every recipe, so that the sink message <span class="word-ref">[sunk-somewhere]</span> is
        recorded after incoming message headers.


<p class="column8">
        Emacs can display the file in one buffer window and keep it updated
        with <samp class="word">M-x</samp> <samp class="word">auto-revert-mode</samp>. It gives a nice overview of arriving
        mail messages and is equivalent to <samp class="word">biff(1)</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # this requires that HH and MM have been setup before,
      # see pm-jadate.rc

      NOW     = &quot;$HH:$MM&quot;            # the time only
      TODAY   = &quot;$YY-$MM-$DD $NOW&quot;   # ISO 8601: date and time

      $NULL   = $SPOOL/junk.null.spool    # /dev/null is dangerous
      BIFF    = $PMSRC/pm-biff.log

      # If you prefer a log per day (easy for cleanup):
      # BIFF   = $PMSRC/pm-biff.log.$YYYY$MM$DD

      # .............................................. headers ...

      # DON'T USE THESE: they call shell
      #
      # FROM    = `$FORMAIL -zxFrom:`
      # SUBJECT = `$FORMAIL -zxSubject:`

      :0                    # Use procmail match feature
      * ^From:\/.*
      {
          FROM = &quot;$MATCH&quot;
      }

      :0                    # Use procmail match feature
      * ^Subject:\/.*
      {
          SUBJECT = &quot;$MATCH&quot;
      }

      # ............................................. incoming ...
      #  record log of incoming mail

      :0 hwic:
      |  echo &quot;$TODAY $FROM $SUBJECT&quot; &gt;&gt; $BIFF

      # ......................................... null recipe ...
      # Now, this is how you add the &quot;message&quot; what happened
      # to that mail. See &quot;?&quot; shell call in the recipe

      :0 :
      * From:.*(remove|delete|free|friend@)
      * ? echo &quot;  [null-AddrReject]&quot; &gt;&gt; $BIFF
      $NULL    </PRE></TD>
    </TR>
</TABLE>



  <a name="gzipping_messages" id="gzipping_messages"></a>
  <h2>
      8.13 Gzipping messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Sean B. Straw &lt;PSE-L A T mail.professional.org&gt;]</span> On the recipe
        delivery line where you'd normally be tossing it into a folder do
        this instead:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c:
      |gzip -9fc &gt;&gt; $MAILDIR/mail.mbox.gz    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This will compress each message as it comes in (and since most are
        TEXT, it does a fine job - MIME, OTOH is one of the best ways to
        mailbomb someone since it doesn't compress well - but the indirect
        bombing via mailing lists doesn't do this), reducing the disk space
        required, usually dramatically. Done in conjunction with something
        like the following at the end of your .procmailrc, you could have a
        header file you could quickly rummage through looking for valid
        messages to add to a procmail recipe, then run:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      gzip -d -c mail.mbox.gz | formail -s procmail -m recipe.rc    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        (note that if the recipe delivers into the mail.mbox.gz file on any
        condition, then you should look to MOVE the file before running
        this process, and use the moved version. In fact, this would be a
        good idea anyway, as newly delivered mail may appear in the end of
        the gzip file while you're doing this - and since your ultimate
        goal is to be able to eliminate junk, you'll want to know that
        after you've processed a gzipped mail file, you can delete it
        without accidentally whacking new mail).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * LASTFOLDER ?? ^^^^
      {
          # Save the message in case we need to retrieve it.

          :0 c:
          |gzip -9fc &gt;&gt; $MAILDIR/mail.mbox.gz

          # copy headers for easy browsing - including being able to
          # identify lists you're being subscribed to.

          :0 h:
          header.log
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="emergency_stop_for_your_procmailrc" id="emergency_stop_for_your_procmailrc"></a>
  <h2>
      8.14 Emergency stop for your .procmailrc

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[jari]</span> If I have a bad luck while I am testing a new recipe, it may
        run in a loop and and it may send me continuously mail messages. I
        then have to quickly recall .procmailrc and start disabling my
        individual &quot;control&quot; recipe files. Yet I figure, in situations like
        this where every second is important, there must be a better way.
        <span class="word-ref">[alan]</span> This is quite easy already; put this at the top of your
        procmailrc:<br>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   instead of leading dot file, you may prefer
      #   stopFile = $HOME/procmailrc.stop which shows up in default ls.
      #   In the other hand you can do ls ~/.procmail* to see both...

      stopFile = $HOME/.procmailrc.stop

      :0
      *$ $IS_EXIST $stopFile
      {
          EXITCODE = $EX_TEMPFAIL # Means: retry later; requeue
          HOST     = &quot;_stopped_by_external_request_&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Then, when testing your procmailrc and disaster happens, you can
        simply do following to disable your procmailrc filtering.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % touch $HOME/.procmailrc.stop    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[richard]</span> This is also a candidate recipe for including in
        an INCLUDERC. Combining the two ideas, we have a file
        procmailrc.stop which contains the recipe and is included near the
        top of .procmailrc, When you don't want it, mv it to procmailrc.go.
        Procmail complains about missing INCLUDERCs, but it does not
        complain about them if they exist and are empty. Another reason to
        not use dotted file names, but to use cp instead of mv.

<hr>
               <A name="scoring"  id="scoring"></A>
               <h1>
               9.0 Scoring

               </h1>



  <a name="using_scores_by_an_example" id="using_scores_by_an_example"></a>
  <h2>
      9.1 Using scores by an example

  </h2>




<p>
<p class="column8">
        First make all the needed matches and let the <samp class="word">SCORE</samp> value to be
        set. Examine the score after the final value has been calculated.
        The condition lines say:

<ul>
	<li>Start with some threshold: -250.
<li>Read the subject into <samp class="word">MATCH</samp>
	</li>
<li>Add 50 for each match of !. Notice the &quot;^1&quot;: if it read
            &quot;^0&quot;, only one 50 would be added for &quot;!!!!&quot;, now that counts
            as 4 x 50 = 200. See procmailsc(1) for &quot;^N&quot; syntax.
	</li>
<li>Any dollar sign is likely spam.
	</li>
<li>find uninteresting subject words
	</li>
<li>And a negative count for replies.
	</li>
<li>Usually spam doesn't seem to have Re: in subject field.
            (but don't rely on this, spammers have started to use &quot;re:&quot;)
	</li>
<li>letters such as !!! frequently found in the body are usually
	            indication of spam. Add 100 for each match.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Idea by 26 Sep 97 Stephane Bortzmeyer &lt;bortzmeyer A T pasteur.fr&gt;

      :0
      *     -250 ^0
      * ^Subject:\/.+$
      *       50 ^1    MATCH ?? [!]
      *       50 ^1    MATCH ?? [$]
      *      100 ^1    MATCH ?? ()\&lt;(free|sex|opportunity|money|great)\&gt;
      *     -250 ^0   ^Subject: *(Fwd|Fw|re):
      * B ?? 100 ^0    ()!!!
      { }             # official procmail no-op

      SCORE = $=      # Score has been calculated

      :0 fhw
      | $FORMAIL -i &quot;X-Spam-Score: scored $SCORE&quot;


      :0:             # If score had positive value, sink message
      *$ $SCORE^0
      junk.spam.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Given the following subject:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &quot;Great opportunity for free sex; no money required!!!!&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        procmail scores it this way: ! was found 4 times (200/weight 50),
        &quot;free|sex...&quot; regexp matched 4 times (400/weight 100).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
               condition score    Total sum so far
                          ----    ----------------
      procmail: Score:    -250    -250 &quot;&quot;
      procmail: Score:     200     -50 &quot;[!]&quot;
      procmail: Score:       0     -50 &quot;[$]&quot;
      procmail: Score:     400     350 &quot;^Subject:.*\&lt;free|sex|...
      &gt;&quot;
      procmail: Score:       0     350 &quot;^Subject: *(Fwd|Fw|re):&quot;
      procmail: Score:       0     350 ! &quot;&quot;
      procmail: Assigning &quot;SCORE=350&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> Some notes on possible regexps and their differences:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * 100^1 ^Subject:.*\&lt;(free|sex|opportunity|money|great)\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That condition says to score 100 for every subject line that
        contains any of those five words ... not to score 100 for every one
        of those words in the subject, but 100 for every subject line that
        contains any of those words. So it will never score more than 100
        unless there are multiple subject lines. You see, it offers five
        alternative regexps:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^Subject:.*\&lt;free\&gt;
      ^Subject:.*\&lt;sex\&gt;
      ^Subject:.*\&lt;opportunity\&gt;
      ^Subject:.*\&lt;money\&gt;
      ^Subject:.*\&lt;great\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Offhand, I think regexp below would score 400: 100 for
        &quot;Subject.*free&quot; and 100 for &quot;sex&quot; etc. Of course, the score might
        be higher if other lines in the header included the strings &quot;sex&quot;,
        &quot;opportunity&quot;, &quot;money&quot;, or &quot;great&lt;word border&gt;&quot;, but appearances of
        &quot;&lt;word border&gt;free&quot; outside the subject wouldn't be counted.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      * 100^1 ^Subject:.*\&lt;free|sex|opportunity|money|great\&gt;

      [translates to]

      ^Subject:.*\&lt;free
      sex
      opportunity
      money
      great\&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And this one would score 400 too. How? <samp class="word">MATCH</samp> would contain whole
        subject and there would be non-overlapping matches to &quot; great &quot;, &quot;
        opportunity &quot;, and &quot; free &quot;. If we got rid of either or both of the
        word-border marks, it would score 500.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Subject: Great opportunity for free sex; no money required!!!!
      * 100^1 MATCH ?? ()\&lt;(free|sex|money|opportunity|great)\&gt;    </PRE></TD>
    </TR>
</TABLE>



  <a name="brief_score_tutorial" id="brief_score_tutorial"></a>
  <h2>
      9.2 Brief Score tutorial

  </h2>




<p>
<p class="column8">
        #todo: test


<p class="column8">
        <span class="word-ref">[elijah]</span> If you're serious about using scores, please spend
        a minute reading this short example.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VERBOSE = &quot;yes&quot;

      :0
      *  1^1 foo
      * -2^2 bar
      { }
      a = $=

      :0
      *  1^1 foo
      * -2^2 bar
      {
          :0 f
          | echo Whee: fun ; cat -
      }
      b = $=

      :0
      *  1^1 foo
      * -2^2 bar
      {
          whee = &quot;fun&quot;
      }
      c = $=

      :0 h
      /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Then if you would send a message

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From foo Fooof
      To: bar
      Subject foobar

      body-something-here    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The log file will tell you what happened.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      procmail: [20175] Fri Sep 26 10:25:23 1997
      procmail: Score:       3       3 &quot;foo&quot;
      procmail: Score:      -6      -3 &quot;bar&quot;
      procmail: Assigning &quot;a=-3&quot;
      procmail: Score:       3       3 &quot;foo&quot;
      procmail: Score:      -6      -3 &quot;bar&quot;
      procmail: Assigning &quot;b=0&quot;
      procmail: Score:       3       3 &quot;foo&quot;
      procmail: Score:      -6      -3 &quot;bar&quot;
      procmail: Assigning &quot;c=-3&quot;
      procmail: Assigning &quot;LASTFOLDER=/dev/null&quot;
      procmail: Opening &quot;/dev/null&quot;
      From foo Fooof
        Folder: /dev/null 46    </PRE></TD>
    </TR>
</TABLE>



  <a name="scores_scope" id="scores_scope"></a>
  <h2>
      9.3 Score's scope

  </h2>




<p>
<p class="column8">
        If you have a delivering recipe and the score is positive, the
        action lines are executed. If the score is less or equal to 0, then
        the <samp class="word">$=</samp> information is lost, but also at the next recipe
        definition, even if the recipe is never executed. Study following
        example:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 10^0
      {
          dummy = &quot;Score for condition xxxx was: $= $NL&quot;

          :0
          {
              dummy = &quot;Next recipe, Score no longer available: $= $NL&quot;
          }
      }

      #   Wont' work.  $= is getting set back to 0 outside of
      #   the delivering recipe.

      dummy = &quot;Score outside of all recipes: $= $NL&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here is interesting anomaly which <span class="word-ref">[richard]</span> discovered. It is
        presented here only as a curiosity. DO NOT USE IT IN YOUR RECIPES.
        (this not &quot;clean programming&quot;, but a hack)



<p class="column8">
        <span class="word-ref">[david]</span> If you want to save the score for later use (even if it is
        zero or negative):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 10^0
      { }                     # procmail no-op

      SCORE = $=

      :0 A
      action_if_positive    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If other recipes that clobber the references for the <samp class="word">A</samp> flag
        intervene, this will work:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 10^0
      { }                     # procmail no-op

      SCORE = $=

      ... more stuff ...

      :0
      *$ $SCORE^0
      action_if_positive    </PRE></TD>
    </TR>
</TABLE>



  <a name="counting_length_of_a_string" id="counting_length_of_a_string"></a>
  <h2>
      9.4 Counting length of a string

  </h2>




<p>
<p class="column8">
        Supposing <samp class="word">VAR</samp> contains some text, we can count the characters
        by using dot to match every character and increasing score for
        every match.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 1^1 VAR ?? .
      { }

      LENGTH = $=    </PRE></TD>
    </TR>
</TABLE>



  <a name="counting_lines_in_a_message_adding_lines_header" id="counting_lines_in_a_message_adding_lines_header"></a>
  <h2>
      9.5 Counting lines in a message (Adding Lines: header)

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[1995-10-03 PM-L Idea by David Karr &lt;dkarr A T nmo.gtegsc.com&gt;]</span> <span class="word-ref">[david]</span>
        later corrected 1998-01-02: For one thing, the second condition
        always counts one too many (the final newline plus the closing
        putative newline create the extra match); second, after making that
        correction, an empty body would score zero and leave the variable
        undefined.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 1^1 .
      * 1^1 ^.*$
      * -1^0
      { }
      lines = $=

      :0 fhw
      * ! ^Lines:
      | $FORMAIL -a &quot;Lines: $lines&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The reason we used it at all was that size conditions worked only on
        the entire text regardless of H or B or HB flags at the top of the
        recipe. Nowadays we can do this and get the accurate figure in one
        condition:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # leave `B ??' out to measure the entire message
      :0
      * 1^1 B ?? &gt; 1
      { }
      size = $=    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you want to be silly about it (as some of us very often do),

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * -1^1 B ?? &gt; -1
      { }
      size = $=    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        gives the same result, and as long as the search area is non-empty,
        so do these, which are even sillier:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * 1^-1 B ?? &lt; 1
      { }
      size = $=

      :0
      * -1^-1 B ?? &lt; -1
      { }
      size = $=    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Karr]</span> This recipe counts bytes in the message, you could use this
        Content-length replacement, prefer using the next recipe. The first
        score counts every character, and the second score sums up every
        line (that is: newlines are added).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 H                        # use B to measure body only
      *    1^1 B ?? .
      *    1^1 B ?? ^.*$
      {
          textsize = $=

          :0 fhw
          * ! ^Content-length:
          | $FORMAIL -a &quot;Content-length: $textsize&quot;
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="determining_if_body_is_longer_than_header" id="determining_if_body_is_longer_than_header"></a>
  <h2>
      9.6 Determining if body is longer than header

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *  1^1 B ?? &gt; 1
      * -1^1 H ?? &gt; 1
      {
          ..body was longer
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="matching_last_received_header" id="matching_last_received_header"></a>
  <h2>
      9.7 Matching last Received header

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Here is way to use scores to hit the bottommost <samp class="word">Received</samp>
        header.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ 1^1 ^Received:.*by$s+\/.*
      action    </PRE></TD>
    </TR>
</TABLE>



  <a name="testing_value_range_with_scoring_bogofilter" id="testing_value_range_with_scoring_bogofilter"></a>
  <h2>
      9.8 Testing value range with scoring (bogofilter)

  </h2>




<p>
<p class="column8">
        Bogofilter adds headers to the message that contains the
        propbability scode of the message being spam in range 0.0 - 1.0:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      X-Bogosity: No, tests=bogofilter, spamicity=0.365761 ...    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If the filter runs at MTA, the values that affects the word &quot;No&quot; at
        canoot necessarily be configured. To test directly the result score
        to catch messages in range 0.2 - 0.9 as &quot;Unsure&quot; can be done with
        scoring. If the spamicity value was 0.92, the first score would
        return: 1.90 - 0.92 = 0.98, which is lower than <strong class="word">1</strong> the score OK
        value.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^X-Bogosity:.*spamicity=\/0\.[0-9][0-9][0-9]
      {
          #   check for maximum
          :0
          * $ -$MATCH^0
          *    1.90^0
          {
              # check for minimum
              :0:
              * $  $MATCH^0
              *    0.8^0
              {
                  # VAlue is betweeb A .. B
              }
        }    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_add_contentlength_header" id="how_to_add_contentlength_header"></a>
  <h2>
      9.9 How to add Content-Length header

  </h2>




<p>
<p class="column10"><em class="quote10">
          We use procmail for local delivery, and would like to get it
          to generate the content-length header, if one doesn't exist. SUN-OS
          mailtool at least gets confused and merges messages together if
          there is no message body.</em>



<p class="column8">
        <span class="word-ref">[stephen]</span> All you need to do is: a) Make sure that procmail is started
        without the -Y flag. b) Either, in your sendmail.cf, insert:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      H?l?Content-Length: 0000000000    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or (slightly less efficient), insert the following recipe in your
        /etc/procmailrc file and Procmail will take care of any necessary
        magic.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hfw
      * !^Content-Length:
      | /usr/bin/formail -a &quot;Content-Length: 0000000000&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="testing_message_size_or_number_of_lines" id="testing_message_size_or_number_of_lines"></a>
  <h2>
      9.10 Testing message size or number of lines

  </h2>




<p>
<p class="column8">
        Size conditions ignore <samp class="word">H</samp> and <samp class="word">B</samp> on the flag line and always work on
        <samp class="word">HB</samp> unless another search area is specified on the condition's own
        line. To test <em class="word">only</em> the body,

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0                      # Note: this is in BYTES
      *$ B ?? &lt; $NBR
      {
          ...whatever when fewer bytes
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This syntax would obey a B flag on the flag line:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0                      # Note: this counts LINES
      * -1^1 B ?? .
      * -1^1 B ?? ^.*$
      *$ $NBR^0
      {
          ...whatever when fewer lines
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="counting_commas_with_recursive_includerc" id="counting_commas_with_recursive_includerc"></a>
  <h2>
      9.11 Counting commas with recursive includerc

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[jari]</span> Foreword: David and Phil really are experts with procmail,
        and let this section serve as an example to &quot;what on Earth is
        recursive procmailrc and how it is used?&quot;. I would not personally
        use recursive includerc, simply because I would not trade clarity:
        I find this easier to understand and maintain. <samp class="word">split</samp> just
        explodes input according to comma and the <samp class="word">print</samp> return how many
        elements were exploded to array <samp class="word">a</samp>. The performance hit is not
        bigger than forked <samp class="word">procmail</samp> binaries in recursive version.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^CC:\/.*
      {
          field       = $MATCH

          saved       = $SHELLMETAS
          SHELLMETAS
          commaCount  = `echo $field | awk '{print split($0,a,&quot;,&quot;)}' `
          SHELLMETAS  = $saved
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[richard]</span> Here is recipe that needs no recursion. MAX_RECIP
        is set to 9, but you may prefer some other value. This counts each
        comma. It allowed in addresses.Some folks sum Resent-xx <em class="word">or</em>
        non-Resent-xx headers. I sum all.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *             1^1 ^(resent|apparently-)?(to|b?cc):\/.*
      *             1^1 MATCH ??,
      *$ -$MAX_RECIP^0
      {
          :0
          *$         $=^0
          *$ $MAX_RECIP^0
          {
              RESULT = &quot;Count of commas is $=&quot;
          }
      }    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="formail_usage"  id="formail_usage"></A>
               <h1>
               10.0 Formail usage

               </h1>



  <a name="fetching_fields_with_formail_x" id="fetching_fields_with_formail_x"></a>
  <h2>
      10.1 Fetching fields with formail -x

  </h2>




<p>
<p class="column8">
        If you're new to procmail your first though to read a header
        content from the message would might be call:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SUBJECT = `$FORMAIL -xSubject:`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That's not good. DON'T Do THAT. You just created expensive shell
        subprocess where procmail calls <samp class="word">formail</samp> and feeds full message to
        it. We can do the same with minimum efforts:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject:\/.*
      {
          SUBJECT = $MATCH
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        No shell subprocess called. This is much faster and consumes
        fewer resources, while it may need more typing. Use it and
        your your sysadm is happy with your well behaving procmail
        recipes that don't load the CPU unnecessarily. The equivalent
        with <samp class="word">formail</samp> might be more secure, because it contains full
        RFC-compliant parser. The traditional way of deriving the
        address with <samp class="word">formail</samp> is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FROM = `$FORMAIL -rtzxFrom:`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But you can still make this more efficient. Here is one example where
        you actually want to use &quot;old&quot; <samp class="word">=|</samp> style variable assignment,
        make sure there are <strong class="word">no</strong> extra spaces:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hw
      FROM=|$FORMAIL -rtzxFrom:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That way only the <strong class="word">header</strong> gets fed into formail, whereas the
        previous back tick fed the <strong class="word">whole</strong> message. Another benefit is,
        that you can then check the return code of formail with <samp class="word">a</samp> or
        <samp class="word">A</samp> recipe after this one.



  <a name="always_use_formails_rt_switch" id="always_use_formails_rt_switch"></a>
  <h2>
      10.2 Always use formail's -rt switch

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Philip]</span> As of version 3.14 you should now usually leave out the
        <samp class="word">-t</samp>. To quote the formail manpage:


<p class="column10"><em class="quote10">
          By default, when generating an auto-reply header procmail selects
          the envelope sender from the input message. This is correct for
          vacation messages and other automatic replies regarding the
          routing or delivery of the original message. If the sender is
          expecting a reply or the reply is being generated in response to
          the contents of the original message then the -t option should be
          used.</em>



<p class="column7"><em><strong>
       10.2.1 For procmail versions prior 3.14</strong></em>



<p class="column8">
        <span class="word-ref">[FAQ]</span> <samp class="word">-r</samp> breaks RFC822, so always use <samp class="word">-rt</samp> if you don't know
        what this means. Perhaps you should always use it anyway.


<p class="column8">
        <span class="word-ref">[david]</span> There is formail -r<span class="super">t</span> rank bar graph in the source code of
        3.11pre4. It might be easier to follow as a top-to-bottom listing
        (and again, Tom Zeltwanger appears to be using one of the older
        versions where From_ was mistakenly over promoted). These are the
        rankings in version 3.11pre4:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -r:                     formail -rt:

      Resent-Reply-To:                Resent-Reply-To:
      Resent-Sender:                  Resent-From:
      Resent-From:                    Resent-Sender:
      Return-Receipt-To:              Reply-To:
      Errors-To:                      From:
      Reply-To:                       Sender:
      Sender:                         Return-Receipt-To:
      From_                           Errors-To:
      Return-Path:                    Return-Path:
      Path:                           From_
      From:                           Path:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Stephane Bortzmeyer &lt;bortzmeyer A T pasteur.fr&gt;]</span> Always use <samp class="word">-rt</samp> and
        never <samp class="word">-r</samp>. Because such precedence (Sender over From) is an
        important violation of RFC 822. There is one canonical order,
        described in the RFC and nothing else should be used, like fuzzy
        ranking or, worse, reordering. This is a serious problem with
        formail.


<p class="column8">
        The proper order is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Reply-To, else From, else Sender, else &lt;error&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          And, how would you deal with resent mail?? Ie: Resent-Reply-To,
          Resent-From, and Resent-Sender?</em>



<p class="column8">
        It treats <samp class="word">Resent-X</samp> as X (&quot; Whenever the string <samp class="word">Resent-</samp> begins a
        field name, the field has the same semantics as a field whose name
        does not have the prefix. &quot;). So you have to choose an order between
        them, the RFC does not specify it.


<p class="column8">
        <span class="word-ref">[david]</span> I think that the idea is that <samp class="word">-r</samp> is intended to determine
        the origination address, not the place to reply; <samp class="word">-rt</samp> is for
        determining the place to send replies. For addressing a response,
        yes, <samp class="word">-rt</samp> will invert the header in a way more in line with the
        rules; for figuring out the origination point,

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -r -zxTo:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        might be better than

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -rt -zxTo:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And here's an additional problem: <samp class="word">formail</samp> <samp class="word">-rD</samp> always uses the
        <samp class="word">-r</samp> precedences; you can't make it use the <samp class="word">-rt</samp> precedences
        and the <samp class="word">-D</samp> cache checking function at the same time.


<p class="column9"><strong>
         4.4.4.  AUTOMATIC USE OF FROM / SENDER / REPLY-TO (RFC 822 excerpt)</strong>



<p class="column8">
        For systems which automatically  generate  address  lists  for
        replies to messages, the following recommendations are made:

<ul>
	<li>The <samp class="word">Sender</samp> field mailbox should be sent notices of
            any  problems in transport or delivery of the original
            messages. If there is no  <samp class="word">Sender</samp>  field, then  the
            <samp class="word">From</samp> field mailbox should be used.
<li>The <samp class="word">Sender</samp> field mailbox should NEVER be used
            automatically, in a recipient's reply message.
	</li>
<li>If the <samp class="word">Reply-To</samp> field exists, then the reply should
            go to the addresses indicated in that field and not to
            the address(es) indicated in the <samp class="word">From</samp> field.
	</li>
<li>If there is a &quot;From&quot; field, but no <samp class="word">Reply-To</samp> field,
            the  reply should be sent to the address(es) indicated
	            in the <samp class="word">From</samp> field.</li>
</ul>




<p class="column8">
        Sometimes, a recipient may actually wish to communicate with the
        person that initiated the message transfer. In such cases, it is
        reasonable to use the <samp class="word">Sender</samp> address.


<p class="column8">
        This recommendation is intended only for automated use of
        originator-fields and is not intended to suggest that replies may
        not also be sent to other recipients of messages. It is up to the
        respective mail-handling programs to decide what additional
        facilities will be provided.



  <a name="using_rt_and_rewriting_the_from_address" id="using_rt_and_rewriting_the_from_address"></a>
  <h2>
      10.3 Using -rt and rewriting the From address

  </h2>




<p>
<p class="column8">
        Sendmail adds the <samp class="word">From</samp> header which points to your account. But in
        some cases you may wish to rewrite the <samp class="word">From</samp>.

<ul>
	<li>You respond to spammer and you want to hide in some extents your
            address. ( The headers will still be there, but at least
            hitting <samp class="word">r</samp> in most MUA's pick up the <samp class="word">From</samp> )
<li>You want to rewrite <samp class="word">From</samp> to show your virtual address
            me@forever-lasting-address.com instead.
	</li>
<li>You are in some other account currently, but you want to send
            message to some Net service (e.g Mailing list) that expects to
	            see the same address you first time used in subscription.</li>
</ul>




<p class="column8">
        You could also use <samp class="word">Reply-To</samp> to signify where you want further
        responses to go, but that doesn't hide your true <samp class="word">From</samp> address. And
        there are still MUAs that don't obey <samp class="word">Reply-to</samp>. Whatever reason
        you have to rewrite From header, here is the command.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      | $FORMAIL -rt -I &quot;From: me@forever-lasting-address.example.com&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="formail_rt_and_resentfrom_header" id="formail_rt_and_resentfrom_header"></a>
  <h2>
      10.4 Formail -rt and Resent-From header

  </h2>




<p>
<p class="column8">
        Here is something that made me scratch my head a lot. Let's examine
        scenario first which explains how the mail travels.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      account --&gt; virtual-address --&gt; Local-address    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        In this chain I was sending message from my one account to
        another address, the <em class="word">virtual-address</em> delivers
        the mail to right local domain. There is only one problem with this
        picture. When a response is generated from <em class="word">Local-address</em> with
        <samp class="word">formail</samp> <samp class="word">-rt</samp>, the generated address pointed back to
        <em class="word">virtual-address</em>, which pointed back to <em class="word">Local-address</em> of
        course. A loop back was ready, you could not get the route to travel to
        original address: <em class="word">account</em>


<p class="column8">
        What was happening here was that the mail server that handled the
        virtual-address, didn't <em class="word">forward</em> the message, but instead
        <em class="word">resent</em> the message. In this process a set of new headers were
        generated:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Resent-From: &lt;virtual-address&gt;
      X-From-Line: &lt;account&gt;
      Received: from &lt;the virtual-address mailserver&gt;
      Resent-Message-Id: &lt;199710151903.WAA28670@virtual-address&gt;
      Resent-Date: &lt;date&gt;
      Resent-To: &lt;local-address&gt;
      Received: ...&lt;account domain&gt;
      Message-Id: &lt;199710151904.WAA05050@account-domain&gt;
      From: &lt;account-domain&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And now when the formail <samp class="word">-rt</samp> command was used, it picked up the
        <samp class="word">Resent-From</samp> added destination where the message should be returned.
        Surprising, but according to procmail, 100% correct. <samp class="word">Resent-From</samp>
        has higher priority than <samp class="word">From</samp>.


<p class="column8">
        The Resent-* headers are considered <em class="word">informative</em>, and should never
        be used when automatically generating a response. The problem here
        is the middleman, it should not <strong class="word">resend</strong> a message, but rather
        <strong class="word">forward</strong> it. So I put this into my .procmailrc to handle the broken
        middleman in our site.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Remove that misleading Resent-From if it was added by our
      #   &quot;middleman&quot;

      :0 fhw
      * Resent-From: &lt;our-domain&gt;
      | $FORMAIL -IResent-From:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[edward]</span> adds to this that: As you know, <samp class="word">formail</samp> <samp class="word">-rt</samp> is
        for composing a response to the address from which an e-mail was
        sent. Let's say you are on vacation and have set up a procmail
        recipe to auto respond to all e-mail you receive. Furthermore, let's
        say Joe sends me an e-mail and I re-send it to you. If you wanted
        to respond to the sender of the e-mail that you received, would you
        e-mail me or Joe? You better e-mail me because I was the one who
        sent it to you. Joe may not even know you. Imagine if you did send
        your response to Joe. It would probably cause him considerable
        confusion as to why you are sending him e-mail informing him that
        you are vacation.


<p class="column8">
        formail <samp class="word">-rt</samp> uses a heuristic algorithm to determine who it should
        respond to, based on the presence of various headers and their
        contents. If you look at the formail.c source code, you'll see a
        graphical representation of this algorithm. It will also explain
        difference between the results of <samp class="word">-r</samp> and  <samp class="word">-rt</samp>.


<p class="column8">
        <samp class="word">Resent-Reply-To</samp> has the highest relative importance/reliability of
        all header fields. Next is Resent-From and Resent-Sender, followed
        by Reply-To, From, Sender, et al.



  <a name="quoting_the_message" id="quoting_the_message"></a>
  <h2>
      10.5 Quoting the message

  </h2>




<p>
<p class="column8">
        Use formail -rtk



  <a name="without_quoting_the_message" id="without_quoting_the_message"></a>
  <h2>
      10.6 Without quoting the message

  </h2>




<p>
<p class="column8">
        Use formail -rkb or formail -rkt -p ''



  <a name="how_to_include_headers_and_body_to_the_reply" id="how_to_include_headers_and_body_to_the_reply"></a>
  <h2>
      10.7 How to include headers and body to the reply message

  </h2>




<p>
<p class="column8">
        The idea is that you first capture whole header in a
        variable, then add it to the body of message. Here a
        custom message is added to the beginning and the headers next.
        Notice that the orginal body is already added by <samp class="word">rtk</samp>. Be
        sure to have that space inside braces; they are important.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #todo:

      :0
      * ^^\/(.+$)+$
      {
          header=&quot;$MATCH&quot;
      }

      :0 fhw
      | $FORMAIL -rt; ... now generate reply ...    </PRE></TD>
    </TR>
</TABLE>



  <a name="adding_text_to_the_beginning_of_message" id="adding_text_to_the_beginning_of_message"></a>
  <h2>
      10.8 Adding text to the beginning of message

  </h2>




<p>
<p class="column8">
        We don't actually filter anything here. It's just a trick to
        reprint headers and add some text after them: text appears
        at the beginning of body.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      | cat - ; echo &quot;This text comes after the headers.&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="adding_text_to_the_end_of_message" id="adding_text_to_the_end_of_message"></a>
  <h2>
      10.9 Adding text to the end of message

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fb
      | cat -; echo &quot;added text after body&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="adding_text_before_quoted_message" id="adding_text_before_quoted_message"></a>
  <h2>
      10.10 Adding text before quoted message

  </h2>




<p>
<p class="column8">
        If you are generating an auto-reply message where you want to place
        the notification to the beginning of body followed by the quoted
        original message, here is recipe for it. Substitute <em class="word">condition</em> to
        trigger the reply condition.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
      {
          :0 fhb
          | $FORMAIL -rtk -p '&gt;'   \
            -I &quot;From: me@example.com&quot; \
            -I &quot;$MYXLOOP&quot;

          :0 fhw
          | cat -; echo &quot;added message at the start of body&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column3">
   12.10 How to truncate headers (save filing space)


<p class="column8">
        <span class="word-ref">[Idea by Rodger Anderson &lt;rodger A T hpbs2245.boi.hp.com&gt;]</span> As a last
        recipe, if you're tight of space, you could remove extraneous
        headers. But make sure you want to that, because headers may
        contain useful information about URLs and other things like mail
        server addresses. Some people keep signature information in
        separate X-header (say: <samp class="word">X-My-Info</samp>) instead of at bottom of
        message so that it won't bother people and disturb reply quoting.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Strip header to bare minimum
      #   If this is MIME multipart, then skip recipe

      :0 fhw
      * ! multipart
      |   $FORMAIL -k                                                 \
          -X Date:                                                    \
          -X Subject:                                                 \
          -X Message-Id:                                              \
          -X From                                                     \
          -X To:                                                      \
          -X Cc:                                                      \
          -X Reply-To:                                                \
          -X Mime-Version:                                            \
          -X Content-type:

      :0 :
      mail.default.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> comments the final recipe

<ul>
	<li>You should keep the <samp class="word">Reply-To</samp> header if there is one. If the
            sender wanted replies directed to a different address than that
            in the <samp class="word">From</samp> header, you are losing that information and, when
            you respond, writing to the wrong place.
<li>You ought to keep <samp class="word">To</samp> and <samp class="word">Cc</samp> so that you can tell when you read
            your mail who else was sent it. If your mail user agent has a
            group-reply or reply-all function, keeping <samp class="word">To</samp> and <samp class="word">Cc</samp> will allow
            that feature to continue working. This way you are cheating
            yourself out of it.
	</li>
<li>'-X From' is enough to keep both the <samp class="word">From_</samp> line and the <samp class="word">From</samp>
            header. You don't need to specify -X From: again after it.
            (To keep <samp class="word">From_</samp> without <samp class="word">From:</samp> you need to say -X &quot;From &quot; or
            something similar, with a quoted space.)
	</li>
<li>All mail is going to have a line (usually two) beginning
	            'From'.</li>
</ul>




<p class="column8">
        Another slightly different approach is to kill the headers that
        take the most of the space. If you're not interested in tracking
        down the original sender of possible UBE message, then you can
        remove the <samp class="word">Received</samp> headers. You may want to fill out the
        condition line to simplify only your work or campus messages,
        and let other messages retain their full headers.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0  fhw
      *   possible-condition-to-handle-only-certain-messages
      |   $FORMAIL -I Received:    </PRE></TD>
    </TR>
</TABLE>



  <a name="adding_extra_headers_from_file" id="adding_extra_headers_from_file"></a>
  <h2>
      10.11 Adding extra headers from file

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[stephen]</span> Notice that the obvious solution won't do here:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      * condition
      | $FORMAIL -rt | cat - $HOME/newHeaders    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The problem here is that there will be a newline in the middle, which
        causes the header to be shortened (procmail determines the new
        header/body boundary after having processed each filter). Use the
        following instead.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      * condition
      | $FORMAIL -rt -X &quot;&quot; ; cat $HOME/pm-newHeaders.txt ; echo    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> If $HOME/newHeaders ends in a blank line, you don't
        need the &quot;; echo&quot;.  Under some circumstances procmail puts back the
        blank separating line if it gets lost, but I'm not sure exactly what
        those are, and you have a SHELLMETAS character in there already (the
        first semicolon), so a shell is forked anyway.


<p class="column8">
        But this is my favorite way (it assumes that formail -r will never
        generate a continuation line for From:); if you use it, make sure
        that the newHeaders file does NOT contain a trailing blank line:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      * whatever
      | $FORMAIL -rtn

        :0 A fhw
        | sed &quot;/^From:/r $HOME/newHeaders&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="splitting_digest" id="splitting_digest"></a>
  <h2>
      10.12 Splitting digest

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Idea by David Hunt]</span> One interesting idea to handle digests
        automatically as single messages if that we call procmail
        recursively. First Call formail to split the mail when headerfields
        are contained in the body, calling procmail again as the
        output-program of formail. Insertion of X-Loop makes it possible to
        reuse <samp class="word">~/.procmailrc</samp> for the separate messages.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   If it more than one mail, send to formail for
      #   splitting, then send back to procmail for sorting again.

      :0
      *    B ?? ^From [-_+.@a-z0-9]+  (Sun|Mon|Tue|Wed|Thu|Fri|Sat)
      *    B ?? ^From:
      *    B ?? ^TO
      *$ ! H ?? ^$MYXLOOP
      | $FORMAIL -A &quot;$MYXLOOP&quot; -m4s procmail    </PRE></TD>
    </TR>
</TABLE>



  <a name="mailbox_splitting_to_individual_files" id="mailbox_splitting_to_individual_files"></a>
  <h2>
      10.13 Mailbox: Splitting to individual files

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> To split some old mail archives into individual
        files while stripping unimportant header fields, use following. The
        keys are to use procmail's <samp class="word">-p</samp> option, to strong-quote <samp class="word">$FILENO</samp> in
        the setting of <samp class="word">DEFAULT</samp>, and to use /dev/null or a known empty file
        as the rcfile.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % setenv FILENO 0000
      % formail -kXDate: -XFrom: -XTo: -XSubject: -XIn-Reply-To:      \
          -XX-Mailer +1ds                                             \
          procmail -p DEFAULT=`pwd`/'$FILENO.txt'                     \
          /dev/null &lt; inputfile    </PRE></TD>
    </TR>
</TABLE>



  <a name="mailbox_extracting_all_from_addresses_from_mailbox" id="mailbox_extracting_all_from_addresses_from_mailbox"></a>
  <h2>
      10.14 Mailbox: Extracting all From addresses from mailbox

  </h2>




<p>
<p class="column8">
        The <samp class="word">-ns</samp> option causes formail to split the mailbox and feed each
        mail separately to next process.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % formail -ns formail -xFrom: &lt; mailbox | sort -u    </PRE></TD>
    </TR>
</TABLE>



  <a name="mailbox_applying_procmail_recipe_on_whole_mailbox" id="mailbox_applying_procmail_recipe_on_whole_mailbox"></a>
  <h2>
      10.15 Mailbox: Applying procmail recipe on whole mailbox

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % formail -ns procmail pm-experiments.rc &lt; mailbox    </PRE></TD>
    </TR>
</TABLE>



  <a name="mailbox_run_series_of_commands_for_each_mail_split" id="mailbox_run_series_of_commands_for_each_mail_split"></a>
  <h2>
      10.16 Mailbox: run series of commands for each mail (split mailbox)

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Maybe the heat has melted my brain, but I can't seem to get
          formail to perform a series of commands on each mail that it has
          split from a folder. Here's an example of a simple debugging
          attempt: I've tried parentheses, putting the commands into a
          shell function, and other flailings too numerous to remember, all
          to naught.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % formail -s addr=`formail -XFrom: | formail -r | formail -zx To`;\
          echo &quot;$addr&quot; &gt;&gt;output    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It appears that formail doesn't use the shell when executing the
        command specified when splitting. No SHELLMETAS here. Given that, the
        secret is to fire up the shell explicitly yourself to do the piping:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % formail -s sh -c 'formail -XFrom: | formail -rzxTo:' &gt;&gt; output    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Note that you only need two formails in the pipe, not three, as the -r
        flag works correctly when combined with other flags.


<p class="column10"><em class="quote10">
          ...To me, a large mailbox would consists of about 10,000 messages
          per month (that's about what I get). That would mean that my
          mailbox would contain 60,000 messages in 6 months. I sure as heck
          wouldn't want to skim through it all or even try to load it up in
          an MUA.</em>



<p class="column8">
        <span class="word-ref">[1998-08-27 Bennett Todd &lt;bet A T mordor.net&gt;]</span> I also deal with monster
        volumes of mail. I've switched over entirely to Maildir in all my
        mail handling; the only place I still see mboxes is in the save
        folders of my netnews reading (using slrn) and whenever I want to
        process them I either convert them into Maildir (e.g. for archival)
        or simply split them into multiple messages. Splitting into
        multiple messages turns out to be preposterously easy; using GNU
        csplit:


<p class="column10"><em class="quote10">
          <span class="word-ref">[richard]</span> The csplit invocation shown here will catch
          occurences of ^From embedded in the message body if your MUA
          hasn't escaped them with a &gt;. Some MUAs use content-length
          headers and don't escape ^From. Procmail supports this. Be cautious
          if you choose to use this simple split.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      csplit -n4 - '/^From /' '{*}'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That will create an empty xx0000 which I delete, and leave the
        messages in files named xx0001, xx0002, etc. If you have more than
        9999 messages in a folder then go -n6, or -n9, or whatever. Once
        they're split it's really easy to use shell tools to bundle
        messages into batches, file them into categories, etc.


<p class="column8">
        If you are archiving all mail traffic forever (which I do) then
        another dandy tool to add to the mix is glimpse
        <a href="http://glimpse.cs.arizona.edu/" >http://glimpse.cs.arizona.edu/</A> it takes a while to build the index,
        but that's a fine job to run out of cron at night. Once the index
        is built it's a pleasingly quick way to root through big archives
        of messages.



  <a name="option_d_and_cache" id="option_d_and_cache"></a>
  <h2>
      10.17 Option -D and cache

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Bob Weissman &lt;b_weissm A T kla.com&gt;]</span> and <span class="word-ref">[stephen]</span> These files are
        self-limiting. The number after the <samp class="word">-D</samp> is the size in bytes above
        which the older entries will be removed. E.g., my .procmailrc has

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 Wh:  .msgid.cache$LOCKEXT
      |$FORMAIL -Y -D 12288 .msgid.cache    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And the file never exceeds 12288 bytes by very much. Though
        formail indeed exceeds this size by as much as the length of one
        <samp class="word">message-ID</samp>, the file size should never grow significantly beyond
        that, even if used indefinitely. The file is in binary format, each
        entry terminated by single null byte, and an occasional (significant
        placeholder) double null


<p class="column8">
        <span class="word-ref">[philip]</span> The format of the cache is initially as follows:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      entry\0entry\0entry\0\0    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When the file size grows to equal-to or greater-than the size
        specified on the command line, formail starts over at the
        beginning, using a double-null to mark where it stopped. However,
        entries after the double-null, except for the partially overwritten
        one, are still valid and checked, so that the file is then in the
        format:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      entry\0entry\0entry\0\0partial-entry\0entry\0entry\0\0    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        New entries will be written after the first double-null, so that it
        implements a circular cache. Check out lines 319-322 of formail.c



  <a name="option_d_and_messageid_in_the_body" id="option_d_and_messageid_in_the_body"></a>
  <h2>
      10.18 Option -D and message-id in the body

  </h2>




<p>
<p class="column10"><em class="quote10">
          Some of my messages contain the original Message-ID in the body
          of the letter and not the Header. Is there an option for Formail to
          over come this problem?</em>



<p class="column8">
        <span class="word-ref">[david]</span> This is strictly untested; I don't know where in the
        body the Message-ID's appear, but if they're at the top of the body,
        this might help:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hW        # Message-Id: in the head,
      *$ ^Message-Id:.*$NSPC
      | $FORMAIL -D $cache_size $cache_name

      :0 E bW    # If not but there's one the body, try body.
      *$ B ^Message-Id:.*$NSPC
      | $FORMAIL -D $cache_size $cache_name    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You might want to copy a <samp class="word">Message-Id</samp> from the body to the head in
        any case (if there's none already in the head) just to have it in
        the right place, so we could do that first and then <samp class="word">formail</samp> <samp class="word">-D</samp>
        will work normally. This form will run formail twice if the
        <samp class="word">Message-Id</samp> header is in the body instead of the head, but it will
        look for <samp class="word">Message-Id</samp> on <em class="word">any</em> line of the body, not just at the
        top:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      *$ ! H   ?? ^Message-Id:.*$NSPC
      *$   B   ?? ^\/Message-Id:.*$NSPC
      | $FORMAIL -A &quot;$MATCH&quot;

      :0 hW
      | $FORMAIL -D $cache_size $cache_name    </PRE></TD>
    </TR>
</TABLE>



  <a name="reducing_formail_calls_conditionally_adding_fields" id="reducing_formail_calls_conditionally_adding_fields"></a>
  <h2>
      10.19 Reducing formail calls (conditionally adding fields)

  </h2>




<p>
<p class="column8">
        #todo: url


<p class="column8">
        Suppose you want add fields to the message when some condition is met:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0              # compose initial reply
      | $FORMAIL -rt

      :0
      * condition1
      | $FORMAIL -A &quot;X-Header1: value1&quot;

      :0
      * condition2
      | $FORMAIL -A &quot;X-Header2: value2&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Hm, we have three processes called here, can we minimize the calls?
        Yes, this is idea from <span class="word-ref">[philip]</span> and <span class="word-ref">[david]</span>. Notice that there is
        only ONE process needed.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition1
      {
          hdr1 = &quot;-AX-Header1:value&quot;
      }

      :0
      * condition2
      {
          hdr2 = &quot;-AX-Header2: value&quot;
      }

      :0 fhw
      | $FORMAIL -rt  ${hdr1+&quot;$hdr1&quot;} ${hdr2+&quot;$hdr2&quot;}    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And if you want to stack all headers to only one variable, it is
        a bit of extra work. Below we use short variable names only because
        of the line space: the calls fit on one line.

<ul>
	<li>field  = all (f)ields stacked to one string.
	<li>nl     = continuation newline terminator of previous field</li>
</ul>




<p class="column8">
        The recipe says: if <em class="word">field</em> has previous value, set <samp class="word">nl</samp> to newline
        separator, later concat previous contents of <em class="word">field</em> with possible
        newline and new header field.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      field       # kill variable
      :0
      {
          nl
          nl     = ${field+&quot;$NL&quot;}
          field  = &quot;$field${nl}X-Header1: value&quot;
      }

      :0
      {
          nl
          nl     = ${field+&quot;$NL&quot;}
          field  = &quot;$field${nl}X-Header2: value&quot;
      }


      :0 fhw                          # If we have something in *field*
      * ! field ?? ^^^^
      | $FORMAIL ${field+-A&quot;$f&quot;}    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The above recipe was the most general one, each recipe determined
        by itself if the <em class="word">f</em> existed previously or not. But if you know
        that <em class="word">f</em> is already set, you can write simpler recipe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0          # We know f has value before our module
      {
          field = &quot;$field${NL}X-Header1: value&quot;
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="formail_a_a_options" id="formail_a_a_options"></a>
  <h2>
      10.20 Formail -A -a options

  </h2>




<p>
<p class="column8">
        You can't use option -A with -a or -I if the header name is the same.
        Like below where you try to keep only the last definition of X-1,
        but the first -A isn't seen when -a is applied.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -A &quot;X-1: 1&quot; -a &quot;X-1: 2&quot;
      --&gt;
      X-1: 1
      X-1: 2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Whereas; separate pipes give you the desired results.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -A &quot;X-1: 1&quot; | formail -a &quot;X-1: 2&quot;
      --&gt;
      X-1: 1

      formail -A &quot;X-1: 1&quot; | formail -I &quot;X-1: 2&quot;
      --&gt;
      X-1: 2    </PRE></TD>
    </TR>
</TABLE>



  <a name="formail_e_s_options" id="formail_e_s_options"></a>
  <h2>
      10.21 Formail -e -s options

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> I had a file of alternating <samp class="word">From</samp> and <samp class="word">Date</samp> lines and
        wanted to convert it into an mbox.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      formail -dem2 -s &lt; input &gt; mailbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        should have done it, right? Nope; <samp class="word">formail</samp> <samp class="word">-s</samp> took it all as one
        message, even with -m1. When I edited in blank lines, the command
        worked. My first reaction was that the -e option wasn't working as
        advertised and that the blank lines were necessary after all.


<p class="column8">
        Then I realized the real problem: there was no interruption in the
        succession of valid header lines in the input for anything that
        could look like a body. I could have put something other than blank
        lines between each pair of header fields and then -e would have done
        its job, but as long as every additional line looked like a valid
        RFC822 header field, even if its name was the same as one that had
        appeared earlier, <samp class="word">formail</samp> <samp class="word">-s</samp> assumed that it was still the same
        message's head.

<hr>
               <A name="saving_mailing_list_messages"  id="saving_mailing_list_messages"></A>
               <h1>
               11.0 Saving mailing list messages

               </h1>



  <a name="using_subroutine_pmjalist_rc_to_detect_mailing_lists" id="using_subroutine_pmjalist_rc_to_detect_mailing_lists"></a>
  <h2>
      11.1 Using subroutine pm-jalist.rc to detect mailing lists

  </h2>




<p>
<p class="column8">
        Because I didn't have sendmail plus addressing capabilities
        (explained in next section) I wrote module <em class="word">pm-jalist.rc</em>. It
        is included in the pm-code.zip


<p class="column8">
        The subroutine tries to detect and derive the mailing list name
        directly from the message. Many Mailing daemons: ezlm, smarlist,
        listserv, majordomo use standardized headers from where the list name
        can be picked. After this subroutine has been applied to message,
        the variable <samp class="word">LIST</samp> contains the mailing list name. You no longer
        have to manually insert separate recipes for each new mailing list
        you subscribe to, because this subroutine adaptively finds new new
        mailing lists.


<p class="column8">
        Once the mailing list name has been grabbed, you can easily &quot;map&quot;
        or convert the name to any suitable folder name before saving it:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LIST            LIST name    Description of mailing list
      (as grabbed)    you want
      --------------------------------------------------------------
      jde             java.jde    Java Development Env
      java            java.prog   Java programming
      FLAMENCO        flamenco    Flamenco music
      tango-l         tango       Argentine Tango dancing
      tm-en-help      tm-en       Emacs TM mime package mailing list
      w3-beta         w3          Emacs WWW mailing list    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You set then conver grabbed <samp class="word">LIST</samp> to new folder name with
        conversion table:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      JA_LIST_CONVERSION = &quot;\
      jde       java.jde,\
      java      java.prog,\
      FLAMENCO  flamenco,\
      &quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And to detect all mailing lists, you only need one recipe, like
        below:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      INCLUDERC = $PMSRC/pm-jalist.rc

      :0 :                          # if list name was grabbed
      * ! LIST ?? ^^^^
      $LIST_SPOOL_DIR/list.$LIST    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_plus_addressing_foobar" id="using_plus_addressing_foobar"></a>
  <h2>
      11.2 Using plus addressing foo+bar@address.com

  </h2>




<p>
<p class="column8">
        If you have a recent enough (8.8.8+) <samp class="word">sendmail</samp>, please ask your
        sysadm to activate the plus addressing. Procmail gets <samp class="word">bar</samp> in <samp class="word">$1</samp>
        automatically.


<p class="column8">
        <a href="http://www.faqs.org/faqs/mail/addressing/" >http://www.faqs.org/faqs/mail/addressing/</A>


<p class="column8">
        <span class="word-ref">[Bennett Todd &lt;bet A T mordor.net&gt;]</span> The PLUS feature has also been
        Implemented in <em class="word">qmail</em> and <em class="word">Postfix</em> (nee VMailer). By default
        qmail uses &quot;-&quot; rather than &quot;+&quot;, but it can be configured to use
        different rules; Postfix doesn't come with either enabled, but its
        example main.cf has a commented-out line to enable &quot;+&quot;-based
        support.


<p class="column8">
        <span class="word-ref">[Roy S. Rapoport &lt;rsr A T macromedia.com&gt;]</span> Plus addressing is
        implemented using sendmail (well, I'm sure the other MTAs can also
        do it, but my experience is with sendmail). The last few releases
        of sendmail (8.8.6, 8.8.7, 8.8.8) all seem to automatically default
        to allowing it. Basically, for any address of the form <samp class="word">foo+baz</samp>,
        sendmail ignores the <samp class="word">+baz</samp> part and just delivers it to foo.


<p class="column8">
        If you want the easiest method to handle mailing list mails, then
        subscribe to list by using dedicated plus address:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      login+list.procmail@example.com
      login+list.debian@example.com
      login+list.linux@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When you receive message from any of these mailing lists to your
        <samp class="word">login</samp> account, the <samp class="word">list.procmail</samp> is already in variable <samp class="word">$1</samp> and
        the recipe to sink all mailing lists to their individual folders is
        very simple:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Note: The $1 contains value only _IF_ procmail
      #   is invoked with option -m or -a (with an argument).
      #   Be sure procmail is invoked with that oprion either as from
      #   LDA or ~/.forward.
      #
      #   $1 is pseudo variable and it can't be used in condition line,
      #   so we copy the value to ARG.

      ARG = $1

      :0 :
      * ARG ?? list
      $ARG    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> Here is what I have configured to sendmail.cf to support
        plus addressing:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Mprocmail, P=/usr/bin/procmail, F=DFMmShu,                      \
                      S=11/31, R=21/31,                               \
                      T=DNS/RFC822/X-Unix,                            \
                      A=procmail -m $h $f $u    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Well, this is definition of the procmail mailer, not the local
        mailer. Furthermore, there's more to plus-addressing support than
        the definition of the local mailer. Ruleset 0 or 5 needs to be set
        up to move everything after the + into the 'host' variable ($h).
        Unless you have a strong understanding of sendmail rule sets and
        rewriting rules, you should not attempt to add plus-addressing to
        your sendmail.cf, but instead just install the latest version of
        sendmail and use the m4 sendmail.cf generation tools with a .mc
        file that contains:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FEATURE(local_procmail, `/usr/local/bin/procmail')    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        plus whatever else your site requires.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ...Ok, I corrected it. Well, here's what that looks like. I did
      look into the part about Ruleset 5 while trying it on
      originally. But all I could do was make sure that the
      plus-addressing section was there.

      Mlocal, P=/usr/bin/procmail, \
                      F=lsDFMAw5:/|@qSPfhn9, S=10/30,
      R/40,
                      T=DNS/RFC822/X-Unix,
                      A=procmail -Y -a $h -d $u
      Mprog, P=/bin/sh, F=lsDFMoqeu9, S=10/30, R/40, D=$z:/,
                      T=X-Unix,
                      A=sh -c $u    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_rfc_comment_trick_for_additional_information" id="using_rfc_comment_trick_for_additional_information"></a>
  <h2>
      11.3 Using RFC comment trick for additional information

  </h2>




<p>
<p class="column8">
        Recall from <span class="word-ref">[rfc1036]</span> that the preferred Usenet mail address
        formats are following

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
        From: login@example.com
        From: login@example.com (First Surname)
        From: First Surname login@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        I invented this idea after reading Eli's excellent FAQ about mail
        addressing. Please read it (especially section 19.) before you
        continue in order to understand what I'm going to present.


<p class="column8">
        I have an account which does not support plus addressing and I was
        kinda jealous to everyone that could use this neat sendmail
        addressing scheme. The plus addressing helps so much better to deal
        with mailing list messages.


<p class="column8">
        But as it turns out, we can simulate in some extent plus addressing
        with pure RFC compliant address. We exploit RFC comment syntax,
        where comment is any text inside parentheses. According to Eli's
        paper, comments should be preserved during transit. They may not
        appear in the exact place where originally put, but that shouldn't
        be a problem. So, we send out message with following <samp class="word">From</samp> or
        <samp class="word">Reply-To</samp> line:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      first.surname@domain (First Surname+list.procmail)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now, when someone replies to you, the MUA usually copies that
        address as is and you can read in the receiving end the PLUS
        information and drop the mail to appropriate folder: <samp class="word">mail.procmail</samp>.


<p class="column7"><em><strong>
       <span class="word-ref">[About subscribing to mailing lists with RFC comment-plus address]</span></strong></em>



<p class="column8">
        It's very unfortunate that when you subscribe to lists, the comment
        is not preserved when you're added to the list database. Only the
        address part is preserved. I even put the comment inside angles to
        fool program to pick up everything between angles.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      first.surname(+list.procmail)@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But I had no luck. They have too good RFC parsers, which throw away
        and clean comments like this. Eg. procmail based mailing lists, the
        famous <samp class="word">Smartlist</samp>, use <samp class="word">formail</samp> to derive the return address and
        <samp class="word">formail</samp> does not preserve comments. The above gets truncated to

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      first.surname@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Also many mailing lists send out messages as <samp class="word">Bcc</samp>, so your address
        is not even available in headers anywhere, neither is this nice RFC
        comment. Ah well, but this RFC comment trick works very well in
        private communication, virtually all MUAs copy whole contents of a
        <samp class="word">From</samp> or <samp class="word">Reply-To</samp> header to <samp class="word">To</samp> header, preserving comments and
        you get the benefit of plus addressing. Here is procmail code
        to demonstrate reading the PLUS information from RFC comment-plus
        field:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      RC_EMAIL = $PMSRC/pm-jaaddr.rc      # Address explode module

      :0
      *$ To:\/.*
      {
          INPUT       = $MATCH
          INCLUDERC   = $RC_EMAIL         # Explore grabbed To address

          #  If COMMENT_PLUS was defined, module found &quot;+&quot;
          #  address which contained, say, &quot;mail.procmail&quot;.
          #  Save it to folder.

          :0 :
          * COMMENT_PLUS ?? [a-z]
          $COMMENT_PLUS
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Pretty simple. And you can put anything inside RFC comment and do
        whatever you want with these plus addresses. <strong class="word">NOTE</strong>: there are no
        guarantees that the RFC comment is preserved every time. Well, the
        standard RFC822 says is must be passed untouched, but I'd say it is
        90% of the cases where mail is delivered from one server to
        another, it is kept.


<p class="column8">
        Example: if you discuss in Usenet groups, you could use address

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      first.surname@example.com (First Surname+Usenet.default)
      first.surname@example.com (First Surname+Usenet.games)
      first.surname@example.com (First Surname+Usenet.emacs)
      first.surname@example.com (First Surname+Usenet.linux)    </PRE></TD>
    </TR>
</TABLE>



  <a name="simple_mailing_list_handling" id="simple_mailing_list_handling"></a>
  <h2>
      11.4 Simple mailing list handling

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Peter S Galbraith &lt;galbraith A T mixing.qc.dfo.ca&gt;]</span> I have used
        this in the past (by simply looking at the spool file and seeing the
        <samp class="word">From_</samp> line of the message):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * ^From debian
      list.debian.mbox

      :0 :
      * ^From procmail
      list.procmail.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now, I collect specific high-volume mailing lists (like Debian) into
        their own spool files like above, and let other recipes catch all
        other mailing lists (like procmail and fvwm) into a single spool
        file with later rules:


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :                                    # Majordomo lists
      * ^Sender: owner-\/[-a-zA-Z0-9_.]*
      list.$MATCH.mbox


      :0 :
      * ^X-Mailing-List: &lt;\/[-a-zA-Z0-9_.]*   # SmartList lists
      list.$MATCH.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        So Debian mailing list mail goes to Debian, procmail and fvwm mail
        go to mail lists and mail addressed to me yet CC'ed to a list go to
        my main spool file.



  <a name="archiving_according_to_to" id="archiving_according_to_to"></a>
  <h2>
      11.5 Archiving according to TO

  </h2>




<p>
<p class="column8">
        Traditional way to detect and save mailing list messages is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * ^TO()procmail
      list.procmail

      [and so on...]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The following code will save the message to folders list.foo, list.bar,
        list.procmail when the name is in the TO address.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   generalised version By David W. Tamkin. Cases desired
      #   for foldernames

      LISTS = &quot;(foo|bar|procmail)&quot;

      :0:
      *$ ^TO_()\/$LISTS
      *$ LISTS ?? ()\/$\MATCH
      list.$MATCH    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_returnpath_to_detect_mailing_lists" id="using_returnpath_to_detect_mailing_lists"></a>
  <h2>
      11.6 Using Return-Path to detect mailing lists

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> For most mailing lists, a more accurate way to determine
        whether it came from the list is to examine the Return-Path:, From_
        or Resent-From: header. This catches messages from the list,
        regardless of whether they were To: the list, Cc: the list, or even
        Bcc: the list, something which doesn't show in the message at all.


<p class="column8">
        For instance, I refile message from the procmail mailing list using
        the following recipe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Return-Path: +&lt;procmail-request@informatik
      ~/Lists/procmail/.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        There's one tricky thing to note: if someone sends a message to
        both me and the list (say, responding to a message I
        sent to the list), then the copy that got to me through the list
        will end up in my procmail folder, while the copy that went
        directly won't. I like this behavior, but some people, possibly
        yourself, may prefer it if both messages end up re-filed. If so,
        your best bet is to combine the above with matching against the To:
        and Cc: headers via the ^TO_ token:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Return-Path: +&lt;procmail-request@informatik|\
      ^TO()_procmail@informatik
      ~/Lists/procmail/.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        (If you have a version of procmail before 3.11pre4, then you'll
        need to use &quot;^TOprocmail&quot; instead of &quot;^TO_procmail&quot;.). If you're
        subscribed to many mailing lists, here is one general recipe


<p class="column8">
        <strong class="word">Notice</strong>: you don't want to include &lt; in the recipe like:
        ^TO_\&lt;\/$LISTS because The ^TO_ token contains something similar to
        \&lt; but better, so that the \&lt; can only cause problems. A trailing
        \&gt; is not a bad idea, though because it's not a zero-width
        assertion but rather an actual character class, you have to strip
        it from the match

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LISTS  = &quot;(foo-list|bar-list)&quot;

      #   1) to get the match
      #   2) rematch sans the trailing \&gt;
      #   3) Note: preserves capitalization of the string

      :0
      *$ ^TO_()\/$LISTS\&gt;
      *$ MATCH ?? \/$LISTS
      *$ LISTS ?? ()\/$\MATCH
      {
          M = $MATCH
          &lt;action&gt;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Era]</span> gives this sample example to describe what happens above:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VAR =  &quot;MOO&quot;
      what = &quot;(moo|bar|baz)&quot;

      :0                              # Search what from VAR
      *$ VAR ?? ()\/$what
      {
          #  Now; what is was that really matched, there were several
          #  choices: moo,bar,bar
          #  Beware: $MATCH must not contain regexp characters

          :0
          *$ what ?? ()\/$MATCH
          { }                         # no-op

          # Fine, New MATCH contains moo
      }    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="procmail_mime_and_html"  id="procmail_mime_and_html"></A>
               <h1>
               12.0 Procmail, MIME and HTML

               </h1>



  <a name="mime_bibliography" id="mime_bibliography"></a>
  <h2>
      12.1 Mime Bibliography

  </h2>




<p>
<p class="column8">
<span class="quote7">List of annoying things that various MIME implementations do.</span><BR>
        ...The result is a sort of style guide for implementors of things that
        generate MIME. Feel free to send comments or contributions.
        <a href="http://www.cs.utk.edu/~moore/mime-style.html" >http://www.cs.utk.edu/~moore/mime-style.html</A>



  <a name="mime_content_type_applicationmstnef" id="mime_content_type_applicationmstnef"></a>
  <h2>
      12.2 Mime content type application/ms-tnef

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...A member of one of my mailing lists appears to be using
          Microsoft Mail. His messages to the list are usually accompanied my
          an encoded attachment like this one:
          &quot;c:\eudora\users\steven@idma.com\attach\WINMAIL11.DAT&quot; The message
          headers include the following clause: Content-Type: multipart/mixed;
          boundary=&quot;openmail-part-058c9f3d-00000001&quot; This is driving people
          crazy. What is causing this and is there any way to make it stop?</em>



<p class="column8">
        Most likely the sender is using Exchange (or Windows Messaging or
        Outlook97) and sent the messages in Rich Text Format. It puts the RTF
        message in an attachment called WINMAIL.DAT (application/ms-tnef). But
        this attachment is useless unless the recipient is also using
        Exchange.


<p class="column8">
        The sender can turn off the RTF option for messages to you. For more
        information, see: XCLN: Sending Messages In Rich-Text Format
        <a href="http://support.microsoft.com/support/kb/articles/q136/2/04.asp" >http://support.microsoft.com/support/kb/articles/q136/2/04.asp</A>



  <a name="trapping_html_mime_messages" id="trapping_html_mime_messages"></a>
  <h2>
      12.3 Trapping HTML mime messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[era]</span> Here's a simple filter to throw out unwanted HTML that is sent
        by using mime. <span class="word-ref">[jari]</span> This recipe detects if the message is
        classified as mime <em class="word">text/HTML</em> and junks it to separate folder. It
        does not change the message content. If you want to actually
        remove HTML or other attachments from the message, see
        <samp class="word">pm-jamime-kill.rc</samp> in the module list.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0:
      *$ ^Content-Type:$s*multipart/(mixed|alternative);\
         $SPCNL*boundary=&quot;?\/[^;&quot;]+
      *$ B ?? ^--$\MATCH\$([-a-z]+:.*)*Content-type:$s*text/HTML
      junk.html.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Some more examples can be found from section: 'Explaning  ^^ and ^'



  <a name="complaining_about_html_messages" id="complaining_about_html_messages"></a>
  <h2>
      12.4 Complaining about HTML messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Marek Jedlinski &lt;eristic A T gryzmak.lodz.pdi.net&gt;]</span>. This how I
        respond to HTML messages. In my <samp class="word">noHTML.txt</samp> I politely explain
        why I don't appreciate receiving HTML mail, and ask to resend the
        message as plain text. What happens in the majority of cases is that
        the sender resends the same message again (&quot;oh, it bounced, let's
        try again&quot;) and I assume they don't actually read my explanation
        since they just happily resend the HTML cr*p. It bounces again at
        which point they give up... Tough luck, I say ;)


<p class="column8">
        BTW, the above recipe is placed <em class="word">after</em> mailing list mail gets
        sorted. When someone sends HTML mail to a mailing list I read, I
        just flame them in person

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      TXT_NO_HTML = $HOME/noHTML.txt

      :0
      *  ! H  ?? ^FROM_DAEMON
      *$ ! H  ?? ^$XLOOP
      *    HB ?? ^Content.Type.+multipart.alternative
      *    HB ?? ^Content.Type.+text.html
      {
              LOG = &quot;$NL --TRASH: multi-part HTML $NL&quot;

              :0
              | ($FORMAIL                                             \
                    -rtk                                              \
                    -A &quot;X-Mailer: Procmail Autoreply&quot;                 \
                    -A &quot;$XLOOP&quot; ;                                     \
                  cat $TXT_NO_HTML                                    \
                  ) | $SENDMAIL
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="converting_html_body_to_plain_text" id="converting_html_body_to_plain_text"></a>
  <h2>
      12.5 Converting HTML body to plain text

  </h2>




<p>
<p class="column10"><em class="quote10">
          <strong class="word">Note:</strong> Older lynx has security holes:
          <a href="http://ciac.llnl.gov/ciac/bulletins/h-82.shtml" >http://ciac.llnl.gov/ciac/bulletins/h-82.shtml</A>
          <a href="http://lynx.browser.org/" >http://lynx.browser.org/</A></em>



<p class="column8">
        The most popular solution to convert HTML body into plain text is to
        use <samp class="word">lynx</samp>. Another more straightforward method is to use a perl one
        liner: it's quicker, easier to use with procmail but it doesn't pretend
        to know about HTML DTD. The recipe below should be taken with grains of
        salt: seeing HTML tag is no guarantee that the body &quot;only&quot; has HTML. A
        cautious recipe writer also watches for MIME multi part messages. (See
        <samp class="word">pm-jamime.rc</samp> to draw some mime characteristics from message)


<p class="column8">
        This recipe has been written so that you can add more alternative
        HTML conversion scripts. You may even want to select the appropriate
        conversion for a message: e.g perl for unimportant ones.


<p class="column8">
        <strong class="word">Note</strong>: This is oversimplified method of checking if body contains
        HTML. It would be probably a good idea to check mime headers which
        indicate HTML encoding here as well.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * B ?? ()&lt;HTML&gt;
      * B ?? ()&lt;/HTML&gt;
      {
          conversion = &quot;lynx&quot;     # or select this conditionally

          :0
          * conversion ?? lynx
          {
              # In new lynx version you can read from stdin. If
              # /dev/stdin doesn't exits try /dev/fd/0
              #
              # lynx -dump -force_HTML -nolist -restrictions=all \
              #   /dev/stdin
              #
              #  Without a global lock on this, you have a chance
              #  that two procmail instances will try to write to
              #  msg.dump

              file = &quot;$HOME/tmp/msg.dump&quot;

              LOCKFILE = $file$LOCKEXT

              :0 fbw
              | cat &gt; $file &amp;&amp; lynx -dump $file

              LOCKFILE

          }

          :0 E fbw
          | perl -0777 -pe 's/&lt;[^&gt;]*&gt;//g'

      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="getting_rid_of_unwanted_mime_attachments_html_vcard" id="getting_rid_of_unwanted_mime_attachments_html_vcard"></a>
  <h2>
      12.6 Getting rid of unwanted mime attachments (HTML, vcard)

  </h2>




<p>
<p class="column8">
        Microsoft and Netscape MUAs are conquering the PC world and it's
        likely that you will receive messages from people that use this
        software. The unfortunate thing is that you receive the message in
        mime format:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HEADERS
      --mime-boundary
      plain text
      --mime-boundary
      Some idiotic HTML (or other type) copy of the text
      --mime-boundary    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When you would like to see a traditional message in the format:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HEADERS
      plain text    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Good news. There's a procmail module that addresses this problem. The
        module can kill any mime attachment and the predefined sets include
        typical cases:

<ul>
	<li>Microsoft Explorer has a bad habit of including 7k
            application/ms-tnef attachment to the end of message.
<li>Lotus Notes sends similar extra attachment.
	</li>
<li>Microsoft Express sends a copy of message in HTML format in the
            attachment.
	</li>
<li>Netscape's Mozilla sends a copy of message in HTML. See
	            example. It Also sends annoying <samp class="word">vcards</samp>.</li>
</ul>




<p class="column8">
        The module is called <samp class="word">pm-jamime-kill.rc</samp> and included in Jari's
        <samp class="word">pm-code.zip</samp>.
        (Note: <a href="#procmail_module_list " >Procmail module list</A>)



  <a name="sending_contents_of_a_html_page_in_plain_text" id="sending_contents_of_a_html_page_in_plain_text"></a>
  <h2>
      12.7 Sending contents of a HTML page in plain text to someone

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[timothy]</span> Send an mail with the subject: &quot;GetPage:
        some.url.here/&quot;. And it comes back. Kurt Thams &lt;thams A T thams.com&gt;
        also pointed out that lynx allows <a href="file://" >file://</A> protocol and since
        procmail is running as you, this would be a security risk.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      GetFile: ~user/.login    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        We make the script safe here by forcing &quot;<a href="http://$MATCH&quot" >http://$MATCH&quot</A>; and not
        simply using &quot;$MATCH&quot;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$   ^Subject:$s+GetPage:()\/.*
      *$ ! ^$MYXLOOP
      |   ($FORMAIL                                                   \
              -rt                                                     \
              -I &quot;Precedence: junk&quot;                                   \
              -I &quot;Subject: Requested page: $MATCH&quot;                    \
              -I &quot;$MYXLOOP&quot; ;                                         \
           lynx -dump &quot;<a href="http://$MATCH&quot" >http://$MATCH&amp;quot</a>;                                 \
          )| $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[era]</span> If all you need is to create a suitable MIME package, there
        are various MIME command-line utilities such as metasend (which is
        for interactive use, and so doesn't work very well with Procmail)
        and mpack you can try. If your needs are simple, you could even
        read up a bit on the MIME spec and generate the necessary headers
        and separators yourself (echo Content-Type: multipart/mixed etc etc
        etc). Conversely, if your needs are complex, get the Perl MIME
        package from CPAN and cook up your own tool. The MIME FAQ
        (especially part 6) is a good place to look for info.
        <a href="http://www.faqs.org/faqs/by-newsgroup/comp/comp.mail.mime.html" >http://www.faqs.org/faqs/by-newsgroup/comp/comp.mail.mime.html</A>

<hr>
               <A name="simple_recipe_examples"  id="simple_recipe_examples"></A>
               <h1>
               13.0 Simple recipe examples

               </h1>



  <a name="saving_mh_folders_numbered_messages" id="saving_mh_folders_numbered_messages"></a>
  <h2>
      13.1 Saving: MH folders &ndash; numbered messages

  </h2>




<p>
<p class="column8">
        Hm. This is explained in the procmail man pages, but not very
        well. There are just one or two occasions where the man page tells
        how to create individual files instead of catenating messages
        to a folder. Notice the <samp class="word">/.</samp> at the end of folder name

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
      dir-folder/.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[manual]</span> When delivering to directories (or to MH folders) you
        don't need to use lockfiles to prevent several concurrently run-
        ning procmail programs from messing up.



<p class="column10"><em class="quote10">
          On a save to a directory, how does procmail determine what to put
          after $MSGPREFIX to complete the name of the file?</em>



<p class="column8">
        <span class="word-ref">[philip]</span> It's the inode number of the file encoded in
        base-64 with the set of characters A-Za-z0-9-_, in reverse order.
        So, for example, the inode numbered 59699 would be encoded as
        follows:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      59699 = 51 + 64 * ( 36 + 64 * 14 )
      A=0, B=1, ..., N=13, O=14, ..., a=26, ..., k=36, ..., z=51,
      0=52, ...
      --&gt; zkO    </PRE></TD>
    </TR>
</TABLE>



  <a name="saving_to_monthly_folders" id="saving_to_monthly_folders"></a>
  <h2>
      13.2 Saving: to monthly folders

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Use any date method mentioned previously to define variables
      # YYYY YY MM DD. Archive digests monthly

      :0 c:
      * ^From:.*\/mailing-list-digest@example.com
      {
          # Get the &quot;mailing-list-digest&quot; string, do not use following
          #
          #       MBOX = `echo $MATCH | sed -e 's/@.*//' `
          #
          # Because we really don't need those extra shell processes.
          # Procmail can derive the word 10x more efficiently

          :0
          * MATCH ?? ()\/[^@]+
          {
              MBOX = $MATCH
          }

          :0 :
          $YYYY-$MM-$MBOX
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="modifying_filtering_basics" id="modifying_filtering_basics"></a>
  <h2>
      13.3 Modifying: Filtering basics

  </h2>




<p>
<p class="column8">
        Pay attention to the <samp class="word">cat</samp> command position in each recipe.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbw
      | echo &quot;This is a line of text _before_ the body&quot;; \
        cat -

      :0 fbw
      | cat - ; \
        echo &quot;This is a line of text _after_ the body&quot;

      :0 fbw               # prepend text before the body
      | cat msg.txt -

      :0 fbw               # append text at the end of body
      | cat - msg.txt

      :0 fbwi              # replace the body with text from file
      | cat msg.txt    </PRE></TD>
    </TR>
</TABLE>



  <a name="modifying_squeezing_empty_lines_around_message_body" id="modifying_squeezing_empty_lines_around_message_body"></a>
  <h2>
      13.4 Modifying: Squeezing empty lines around message body

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Anything that replaces the body is going to require an outside
        process, even if it's only /bin/echo. In order to trim empty lines
        from the beginning of message and from the end of message, you can
        do this, if the entire body fits into <samp class="word">LINEBUF</samp>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbw
      * B ?? ^^$*\/.(.|$)*.$
      | echo &quot;$MATCH&quot; # trailing extra newline intended    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If your version of cat is BSD-ish,

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # SysV's cat has a different meaning for -s and cannot do this

      :0 fbw
      * B ?? $$$
      | cat -s    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        otherwise, it can be done with a very simple sed filter:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbw
      * B ?? ^^($)|$$$
      | sed /./,/^$/!d    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Note that cat -s has slightly different results from the others: if
        there are any empty lines at the top of the body, cat -s will keep
        one. The echo and sed suggestion will remove all empty lines from
        the top and, like cat -s, keep one at the bottom.



  <a name="modifying_shuffling_headers_always_to_same_order" id="modifying_shuffling_headers_always_to_same_order"></a>
  <h2>
      13.5 Modifying: shuffling headers always to same order

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[phil]</span> To sort the headers in the message into predictable order,
        you can use following recipe. The spaces have been eliminated
        between the <samp class="word">-I</samp> and its argument in the above. The shell may or
        may not allow unquoted spaces in the second part of the
        ${variable:+blah}. For example, under solaris 2.6, /bin/sh barfs on
        ${FROM:+-I &quot;From: $FROM&quot;}, while /bin/ksh handles it just fine. I
        think the POSIX shell standard requires that it be allowed, but,
        well, will your <strong class="word">next</strong> system be POSIX compliant?


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ()\/^From: +\/.*
      {
          FROM = $MATCH
      }

      :0
      * ()\/^Reply-To: +\/.*
      {
          RT = $MATCH
      }

      :0
      * ()\/^X-Mailer: +\/.*
      {
          XM = $MATCH
      }

      :0
      * ()\/^Message-Id: +\/.*
      {
          MID = $MATCH
      }

      :0
      * ()\/^Date: +\/.*
      {
          DATE = $MATCH
      }

      :0
      * ()\/^To: +\/.*
      {
          TT = $MATCH
      }

      :0
      * ()\/^CC: +\/.*
      {
          CC = $MATCH
      }

      :0
      * ()\/^Subject: +\/.*
      {
          SUBJ = $MATCH
      }

      :0 fh w
      | $FORMAIL                                                      \
          ${XM:+-I&quot;X-Mailer: $XM&quot;}                                    \
          ${TT:+-I&quot;To: $TT&quot;}                                          \
          ${FROM:+-I&quot;From: $FROM&quot;}                                    \
          ${RT:+-I&quot;Reply-to: $RT&quot;}                                    \
          ${CC:+-I&quot;Cc: $CC&quot;}                                          \
          ${MID:+-I&quot;Message-Id: $MID&quot;}                                \
          ${DATE:+-I&quot;Date: $DATE&quot;}                                    \
          ${SUBJ:+-I&quot;Subject: $SUBJ&quot;}    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_auto_answerer_to_empty_messages" id="service_auto_answerer_to_empty_messages"></a>
  <h2>
      13.6 Service: Auto answerer to empty messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[elijah]</span> Here is piece of code that responds to empty
        messages.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ! B ?? ...
      | (echo &quot;From: me@example.com&quot; ;                                \
        $FORMAIL -r -A&quot;Precedence: junk&quot;                              \
        -A&quot;X-Loop: me@example.com&quot; ;                                  \
        echo &quot;Your blank message was received.\n&quot;                     \
             &quot;Did you mean to say something?\n&quot;                       \
             &quot;\n&quot;                                                     \
             &quot;-- \n&quot;                                                  \
             &quot;My Signature\n&quot;                                         \
             &quot;this has been an automated response\n&quot;                  \
        ) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_ping_responder" id="service_ping_responder"></a>
  <h2>
      13.7 Service: Ping responder

  </h2>




<p>
<p class="column8">
        Sometimes I'm on the road and I don't seem to get access to the
        site where my messages are. The telnet connection fails and
        standard Unix &quot;ping&quot; plays dead for me. &quot;What's happening in that
        site?&quot; I wonder. Here is a recipe that I have added to all of my
        accounts. It sends an immediate reply if at least the mailhost is
        up and gives some status information.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject: ping$
      {
          :0 fh
          | $FORMAIL -rt

          #   Remember, Don't send back anything that would be vital to
          #   attacker. It doesn't matter if the `uptime` or other
          #   scripts fail, the reply is sent anyway.

          :0 c    # Record this ping request
          |   ( cat -;                                                \
                echo `uptime`;                                        \
                echo &quot;$HOST User count: &quot; `who | wc -l`;              \
              ) | $SENDMAIL

          :0 :                    # or sink to $DEFAULT
          $PING_SPOOL
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_simple_vacation_with_procmail" id="service_simple_vacation_with_procmail"></a>
  <h2>
      13.8 Service: simple vacation with procmail

  </h2>




<p>
<p class="column8">
        Don't forget to look into procmailex(5) man pages which also has
        vacation example. The ones presented below may not work for you.
        Here is a very simple vacation recipe. Whenever the file ~/.vac
        exists, the vacation program is called. Be sure that you have the
        ~/.vacation.msg file ready too. Remember that <samp class="word">vacation</samp> does not
        <strong class="word">save</strong> you messages; so we need <samp class="word">c</samp> flag here.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  Some prefer the non-dotted file which shows up in ls listing

      vacationFlagFile = $HOME/.vac

      :0 wc
      *$ ? $IS_EXIST $vacationFlagFile
      |  vacation $LOGNAME    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Some people like to raise a flag in .procmailrc instead of creating a
        file. If you like the variable approach better, here is the equivalent
        implementation of the above

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      VACATION = &quot;yes&quot;    # Comment this when not in vacation

      :0 wc
      * VACATION ?? yes
      | vacation $LOGNAME    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> and <span class="word-ref">[era]</span> Since vacation only sends replies &ndash; it
        never sends the original # messages, one way to do two things with
        your .forward file. Substitute &quot;abc&quot; with your login name.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      |/usr/ucb/vacation&quot;,&quot;exec /usr/local/bin/procmail -f- ||exit 75 #abc    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_vacation_code_example" id="service_vacation_code_example"></a>
  <h2>
      13.9 Service: vacation code example

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[By Eric Black &lt;eric A T Mirador.COM&gt;]</span> Here is the procmail part

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      OFFSITE = &quot;my_guest_login@wherever.I.am.example.com&quot;

      #  Forward urgent mail to me at my off site address; afterward,
      #  continue processing it as normal The procmail pattern match
      #  may be case-insensitive, in which case this rule could be
      #  simplified...

      :0 c
      * ^Subject: .*urgent
      | $SENDMAIL $OFFSITE


      #  Use &quot;vacation&quot; to tell other people I'm not here To enable,
      #  un-comment the next two lines; to disable, comment them out
      #
      #  The -a Identifies another name that can legitimately
      #         appear in the To: line of the mail header instead
      #         of your login name

      :0 wc
      | vacation -a ericb eric    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And here the ~/.vacation.msg file

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Subject: I'm out of town for a while
      From: eric (via the vacation program)

      I'm out of town until &lt;return-date&gt;.  Your mail regarding
             &quot;$SUBJECT&quot;
      will be read when I return, or possibly at some unknown
      time before then if I get a chance to check for mail.

      If your message must be seen by me before I return,
      you can send it with the word &quot;URGENT&quot; in the subject header.
      Such mail will be automatically forwarded to me so that
      I see it sooner.
      --Eric    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_autoforwarding" id="service_autoforwarding"></a>
  <h2>
      13.10 Service: Auto-forwarding

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[timothy]</span> I have my .procmailrc setup to forward mail to another
        (mail only) account. When I am not going to be at the account, I
        want to turn forwarding off

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   look for the file to tell us whether or not to forward mail
      #   if the file exists, forward the mail
      #   or not

      ELSWHERE = &quot;me@elsewhere.example.com&quot;
      FILE     = &quot;$HOME/.forwardmail&quot;

      :0 c
      *$ ? $IS_EXIST $FILE
      ! $ELSWHERE

      #   if a message arrives from the other account
      #   with the Subject 'forward-off' then remove the
      #   file, efectively turning off forwarding

      :0 hwic
      *$ ^From:.*$ELSWHERE
      *  ^Subject: forward-off
      | $NICE mv -f $FILE $FILE.off

      #   if a message arrives from the other account
      #   with the Subject 'forward-on' then remove the
      #   file, efectively turning off forwarding on

      :0 hwic
      *$ ^From:.*$ELSWHERE
      * ^Subject: forward-on
      | $NICE mv -f $FILE.off $FILE    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_forward_only_specific_messages" id="service_forward_only_specific_messages"></a>
  <h2>
      13.11 Service: forward only specific messages

  </h2>




<p>
<p class="column8">
        Here is piece of code that triggers forwarding according to
        addresses. If you have lot of these kind of forwarding,
        you should use simple <samp class="word">awk</samp> database which you would grep.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   By Jim Hribnak &lt;hribnak A T nucleus.com&gt;
      #   info@1.example.com goes to joe@1.example.com
      #   info@2.example.com foes to fred@2.example.com

      :0
      * ^TO_()info@1.example.com\&gt;
      {
          FORWARDTO = &quot;$FORWARDTO joe@1.example.com&quot;
      }

      :0
      * ^TO_()info@2.example.com\&gt;
      {
          FORWARDTO = &quot;$FORWARDTO fred@2.example.com&quot;
      }

      :0 fhw
      *    FORWARDTO ?? @
      * ! ^$MYXLOOP
      | $FORMAIL -A &quot;$MYXLOOP&quot;

        :0 a
        ! $FORWARDTO    </PRE></TD>
    </TR>
</TABLE>



  <a name="service_making_digests" id="service_making_digests"></a>
  <h2>
      13.12 Service: Making digests

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # By &lt;jimo A T eskimo.com&gt;
      # Add this message to the digest accumulator

      :0 c:
      | $FORMAIL -k -X From: -X Message-Id -X Date -X Subject &gt;&gt; $DIGEST

      # Check size of digest, and send it off if it's big enough

      :0
      *$       -$DIGSIZE     ^0
      *$ `wc -l &lt;$DIGEST`    ^0
      | $NICE send-digest $DIGEST    </PRE></TD>
    </TR>
</TABLE>



  <a name="kill_killing_advertisement_headers_and_footers" id="kill_killing_advertisement_headers_and_footers"></a>
  <h2>
      13.13 Kill: killing advertisement headers and footers

  </h2>




<p>
<p class="column10"><em class="quote10">
          A mailing list that I subscribe recently began adding a block of
          &quot;boiler plate&quot; text to the beginning and end of every message
          that goes through the list (groan). The text is always the same,
          and is always at the beginning and end of the message.</em>



<p class="column8">
        <span class="word-ref">[david]</span> sed could do both at once, but the problem is that
        sed never knows when it is N lines from the end if N&gt;0; it knows
        the last line when it reads it, but when it is looking at the
        next-to-last line it doesn't know that there is only more one line
        to come. It does, however, know how many lines of input it has
        already read.


<p class="column8">
        So I have three suggestions: if you know that the header is X lines
        long <span class="word-ref">[let's say 5 for this example]</span> and that the first line of the
        footer contains some string or pattern that will not occur in the
        significant part of the post,

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbwi
      * conditions
      | sed -ne 1,5d -e '/pattern/q' -e p    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you recognize the end by the last line that you want to keep
        instead of the first line that you want to delete, omit the n
        option and the p instruction:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      | sed -e 1,5d -e '/pattern/q'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Finally, if the only reliable way to spot the footer is by reaching
        so many lines from the end (because any search pattern might occur
        in the real text as well), we can score as you've been doing to get
        the number of the last significant line. Let's say the footer is
        three lines long; because ^.*$ always counts one line too many
        (long story), we subtract four instead of three:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbwi
      * conditions
      * 1^1 B ?? ^.*$
      * -4^0
      | sed -e 1,5d -e &quot;$=&quot;q    </PRE></TD>
    </TR>
</TABLE>



  <a name="kill_simple_kill_file_recipe_with_procmail" id="kill_simple_kill_file_recipe_with_procmail"></a>
  <h2>
      13.14 Kill: simple kill file recipe with procmail

  </h2>




<p>
<p class="column8">
        Kill files are widely used with news readers to delete uninteresting
        posts when you enter a newsgroup. A kill file usually contains one
        single entry per line to match the message content and this can be
        easily done with procmail. Remember however that for every message
        procmail forks a process, so before you apply the kill file rules to
        the messages, be sure your recipes are in this order: the kill file
        rules are applied only to <em class="word">unknown</em> messages

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SINK MAILING-LISTS
      SINK ANNOUNCEMENTS
      SINK WORK MESSAGES
      OTHER DELIVERIES
      apply kill file rules and UBE recipes to the rest    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Recipe will drop the message (i.e. consider it 'delivered') if one
        of its headers matches a pattern in kill file.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hW:  $HOME/.kill file$LOCKEXT
      | egrep -i -f $HOME/.kill file    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The reason why there is explicit lock file is that you must be able to
        update the kill file while your procmail is running. An example edit
        script is presented below.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #!/bin/sh
      # program: kill file.sh
      #
      file=$HOME/.kill file
      lock=$file.lock
      cp $file $file.tmp
      emacs -q $file          # or use whatever you prefer: vi, pico
      lockfile $lock
      mv $file.tmp $file
      rm -f $lock    </PRE></TD>
    </TR>
</TABLE>



  <a name="kill_duplicate_messages" id="kill_duplicate_messages"></a>
  <h2>
      13.15 Kill: duplicate messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Lars Kellogg-Stedman &lt;lars A T bu.edu&gt;]</span> Put this as a first entry in
        your .procmailrc and you won't see any duplicates as long as the 8K
        cache doesn't get full. The duplicates folder is cleaned out
        weekly via a cron job. While it may be tempting to simply sink
        duplicates to /dev/null, I have come across broken mail clients the
        stick the same value in the <samp class="word">Message-id</samp> header of all outgoing
        mail.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject:\/.*
      {
          SUBJECT = $MATCH
      }

      MID_CACHE_LEN   = 8192
      MID_CACHE_FILE  = $PMSRC/msgid.cache
      MID_CACHE_LOCK  = $PMSRC/msgid.cache$LOCKEXT

      LOCKFILE = $MID_CACHE_LOCK

      # IF  the message has a message-id header
      # AND formail -D is successful (exit status=0)
      # THEN
      #   log a message to the procmail log
      #   sink the message

      :0
      *  ^Message-Id:
      * ? $FORMAIL -D $MID_CACHE_LEN $MID_CACHE_FILE
      {
          LOG=&quot;dupecheck: discarded message, $SUBJECT $NL&quot;

          :0              # Store duplicates, notice no lock!
          duplicate.mbox
      }

      LOCKFILE            # Release lock by killing variable    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And here is a bit simpler recipe, a slightly modified version from
        the <span class="word-ref">[manual]</span>. Procmail notices formail's success, considers the
        message delivered and does not stop processing the rcfile due to
        <samp class="word">c</samp> flag, which let's a message to fall into safety copy inbox.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hWc: $PMSRC/pm-msgid.cache$LOCKEXT
      *  ^Message-id:
      | $FORMAIL -D 8192 $PMSRC/pm-msgid.cache

        :0 a:
        duplicate.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        There was a pretty heavy thread around September 1997 about
        duplicate detection, where some promising stuff was posted.
        One item you should definitely have in your collection is
        Eli's <samp class="word">hashd</samp> <span class="word-ref">[in Procmail mailing list 1997-09]</span>



  <a name="kill_spam_filter_with_simple_recipes" id="kill_spam_filter_with_simple_recipes"></a>
  <h2>
      13.16 Kill: spam filter with simple recipes

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Ed McGuire &lt;emcguire A T i2.com&gt;]</span> Seeing several junk mail filters
        posted recently, varying from the simple to the complex, I thought
        I would also share my own. I junk whatever comes from my ISP but is
        not addressed to my domain or to one of the mailing lists I
        subscribe to.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   1.  mail to my domain
      #   2.  NOT addressed to me directly
      #   3.  NOT coming from mailing lists I'm subscribed to.

      0:
      * ^(received):.*psi\.com
      * ! ^((apparently-)?to|cc):.*(i2|intellection)\.com
      * ! ^(to|cc):.*(pdp-?8-lovers|procmail|sunshine|info-pdp11)
      junk.ube.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Gordon Matzigkeit &lt;gord A T m-tech.ab.ca&gt;]</span> I have just
        discovered an effective rule for separating SPAM from the rest
        of my e-mail. Just substitute your username for <samp class="word">gord</samp> in the
        line below

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Anything which is not addressed to me is probably SPAM.
      :0:
      * !^TO().*\&lt;gord\&gt;
      junk.ube.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This only works because I handle all mailing list addresses above
        that point in my .procmailrc (i.e. all traffic that arrives from
        mailing lists that I am subscribed to goes into other folders).
        Most SPAMmers seem to do it nowadays by sending mail via mailing
        lists, rather than creating huge <samp class="word">To</samp> lists of users


<p class="column8">
        Many times sysadm install a list of know addresses that
        send spam and then they check the incoming mail against the &quot;black
        list&quot;. Keep in mind that that some <samp class="word">fgrep</samp> implementations have a
        problem with the -w word switch. Note that the above recipe scans
        the FULL HEADER, so use it with some caution, i.e., be careful what
        you add to your list of spam domains.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # by [philip]; egrep would do here too, if it is posix
      # compliant, it may have -f switch that makes it behave
      # like fgrep.
      #
      # Note: option -F would make [ef]grep to search fixed string
      #       instead of regexps.
      #

      BLOCK_FILE  = $HOME/Mail/DeniedNames.lst
      UBE_MBOX    = $HOME/Mail/junk-ube.mbox

      # To filter out the Subject lines, so that mails sent
      # with the subject &quot;Have you received a message from
      # blah-blah@spam&quot; don't get filtered.
      # [era] suggested we use formail
      #
      # Edsel Adap &lt;edsel.adap A T Canada.Sun.COM&gt; agrees there is a
      # likely bug in Solaris 2.5.1 &quot;/usr/bin/fgrep -i&quot; and
      # suggested the use of /usr/xpg4/bin/fgrep instead.
      #
      # &lt;edsel.adap A T canada.sun.com&gt; Sun Microsystems Developer Support
      # Files in /usr/xpg4 are available via the SUNWxcu4 package,
      # which is part of the user, developer, all, or Xall Solaris
      # clusters.
      #
      # Solaris 2.4 doesn't have /usr/xpg4/bin/fgrep :-(, you
      # must use  `tr A-Z a-z' before piping the message to fgrep.

      :0 hw:
      *$ ? $FORMAIL -ISubject: |fgrep -i -f $BLOCK_FILE
      $UBE_MBOX    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The file DeniedNames.lst is simply a list of addresses

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      82338201@compuserve.example.com
      Dwnliner@ix.netcom.example.com
      Emerald@earthstar.example.com
      FreeWay@dm1.example.com    </PRE></TD>
    </TR>
</TABLE>



  <a name="kill_unsubscribe_messages" id="kill_unsubscribe_messages"></a>
  <h2>
      13.17 Kill: (un)subscribe messages

  </h2>




<p>
<p class="column10"><em class="quote10">
          I'm getting tired of those pesky (un)subscribe messages that
          certain &quot;other&quot; mailing lists seem to pass through to the list at
          large instead of capturing them at the list server, like SmartList
          does.</em>



<p class="column8">
        <span class="word-ref">[Adam Shostack &lt;adam A T bwh.harvard.edu&gt;]</span> The following do help,
        although they're often too broad. (I use a .safe rule to cover those
        cases) The &lt; 1000 is a useful hueristic. It's rare that unsubscribe
        messages are long.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      * (Delete|u*n*Sub(s| )*| add | leave | help )
      * &lt; 1000
      junk.misc.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Rodger Anderson &lt;rodger A T hpbs2245.boi.hp.com&gt;]</span> I've been
        working on a recipe to filter out those pesky s*bscribe and
        uns*bscribe messages from mailing lists, and I'm posting what I have
        so far. As an aside, it also filters out very short messages, which
        I've found are usually some sort message meant for list owner/request
        address.


<p class="column8">
        I give heavy weight to Subjects starting with (un)?s*bscribe, with
        also pretty heavy weight to Subjects containing either of those
        words. I then give heavy weight to the body of messages starting
        with those words, and a lighter weight to lines starting with them.
        Then multiple occurrences get some weight too, up to a point. Then I
        count the words in the message against all that.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *  1^0
      *  30^0 H ?? ^Subject: +(un)?subscribe\&gt;
      *  20^0 H ?? ^Subject:.*\&lt;(un)?subscribe\&gt;
      *$ 20^0 B ?? ^^$SPCNL*(un)?subscribe\&gt;
      *$ 10^0 B ?? ^$SPC*(un)?subscribe\&gt;
      *  8^.4 B ?? \\&lt;(un)?subscribe\&gt;
      * -.4^1 B ?? \\&lt;$a+\&gt;
      junk.misc.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Adam Shostack &lt;adam A T bwh.harvard.edu&gt;]</span> How about looking for sub &amp;
        unsub, as well as a perennial misspelling 'unsuscribe me'?  I also
        find filtering on add, leave and help to be useful. This may well be
        the only word on the line. I think it has to do with broken list
        management packages.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      | :0
      | * 1^0
      | * 30^0 H ?? ^Subject: +(un)?subscribe\&gt;

      * 20^0 H ?? ^Subject: +(un)?sub?(scribe)?\&gt;

      (The B is often missing, as is the word fragment 'scribe')

      | * 20^0 H ?? ^Subject:.*\&lt;(un)?subscribe\&gt;

      * 20^0 H ?? ^Subject: +(add|leave|help)$

        # fewer points if more words

      * 15^0 H ?? ^Subject: +(add|leave|help)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david 1998-10-20]</span> You want to match on messages where the
        first non-blank thing in the body is &quot;unsubscribe&quot; at the end of a
        line, where there are five lines or fewer in the body?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      *$ B ??       ^^$SPCNL*unsubscribe$
      *        7^0
      *  B ?? -1^1  ^.*$
      junk.misc.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        ^.*$ always counts one line too many, so a five-line body will be
        counted as six; that's why we need a prejudice of 7. But if the
        first non-blank text in the body is &quot;unsubscribe&quot; alone on a line,
        is a line count really necessary? True posts that include the word
        will have it in the middle of a sentence, such as the preceding
        one. What you'll find by specifying a line limit is that
        unsubscribe requests with long signatures or attachments at the
        bottom of a previous message will get through.



  <a name="time_once_a_day_cronlike_job" id="time_once_a_day_cronlike_job"></a>
  <h2>
      13.18 Time: Once a day cron-like job

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Bill Moseley &lt;moseley A T netcom.com&gt;]</span> If you want to do
        something only once a day, they you have to store the date
        somewhere and check against that stored date.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      YYMMDD_FILE = $HOME/.yymmdd
      YYMMDD      = $YY-$MM-$DD

      #   Contains single line of procmail code
      #   YYMMDD_PREV = ..

      INCLUDERC = $YYMMDD_FILE

      #   If different date, then enter this block
      #   The echo updates stamp in file.

      :0
      *$ ! YYMMDD ?? ^^$YYMMDD_PREV^^
      *  ? echo &quot;YYMMDD_PREV = $YYMMDD&quot; &gt; $YYMMDD_FILE
      {
          ...do the cron jobs..
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="time_running_a_recipe_at_a_given_time" id="time_running_a_recipe_at_a_given_time"></a>
  <h2>
      13.19 Time: Running a recipe at a given time

  </h2>




<p>
<p class="column10"><em class="quote10">
          If I put a program to my recipes, it will be executed every time
          message arrives. That's a problem, and I'm not allowed to use cron
          in this account. I'm looking for some sort of condition to check
          the current time and if its outside of the hours 11pm and 7am then
          execute the action.</em>



<p class="column8">
        <span class="word-ref">[david]</span> How do your From_ lines look? If they're the traditional
        kind that sendmail and smail add, they include the local time on your
        system at receipt. So include a check that the hour is between 07
        and 22 inclusive, like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c
      *  ^From .*some-address.* (0[789]|1.|2[012]):[0-5][0-9]:
      |  command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        I included the minutes and the colon that separates the minutes from
        the seconds so that the expression for testing the 07-22 range can
        match only on the hour.



  <a name="time_triggering_mail_and_using_cron" id="time_triggering_mail_and_using_cron"></a>
  <h2>
      13.20 Time: Triggering mail and using cron

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Put something like the following entries in your personal
        crontab for your userid (and not knowing if you particular cron
        &quot;cd's&quot; to your home directory first):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      0 23 * * *        touch $HOME/.mail.relay.on
      0 7 * * * rm -f $HOME/.mail.relay.on    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And if your cron doesn't know the HOME variable (that'd be an
        exception)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      0 23 * * *  /bin/csh -c 'touch ~LOGNAME/.mail.relay.on'
      0 7 * * *   /bin/csh -c 'rm -f ~LOGNAME/.mail.relay.on'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Then, in your .procmailrc do:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c
      *  ^From.*some-address
      *$  $IS_FILE $HOME/.mail.relay.on
      | command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        the script will run_my_program only if both the subject matches and
        the file test succeeds. The file test will succeed only between 11pm
        and 7am.


<p class="column8">
        In all honesty, if system gives usable From_ lines, I like following
        suggestion better. I use it all the time to turn blocks of procmail
        code on and off at given times or dates, and it works likes a charm.
        It uses many fewer processes and is less likely to get the status
        wrong if for any reason one of the cron jobs fails to run or doesn't
        do its job.


<p class="column8">
        This pages only at day time

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c
      * ^From .*some-address.* (0[789]|1.|2[012]):[0-5][0-9]:
      | command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This pages at night

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 c
      * ^From .*some-address.* (0[0-6]|23):[0-5][0-9]:
      | command    </PRE></TD>
    </TR>
</TABLE>



  <a name="decoding_uudecode" id="decoding_uudecode"></a>
  <h2>
      13.21 Decoding: Uudecode

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> here is piece of code to do uudecode match when certain
        condition is matched. The magic string here is &quot;begin ...file&quot;,
        the <em class="word">body</em> is then fed to <samp class="word">my_uudecode_program</samp> whatever it does
        to it.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 b
      *      ^From:.*someone@example\.com
      *      ^Subject: Subject
      * B ?? ^begin 644 file.tar.gz
      | my_uudecode_program    </PRE></TD>
    </TR>
</TABLE>



  <a name="decoding_mime" id="decoding_mime"></a>
  <h2>
      13.22 Decoding: MIME

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   by Peter Galbraith &lt;galbraith A T mixing.qc.dfo.ca&gt;
      #   MIME filtering of accented characters and split lines.
      #
      :0
      * ^Content-Type: *text/plain
      {
        :0 fbw
        * ^Content-Transfer-Encoding: *quoted-printable
        | mimencode -u -q

          :0 A fhw
          | $FORMAIL -I &quot;Content-Transfer-Encoding: 8bit&quot;

        :0 fbw
        * ^Content-Transfer-Encoding: *base64
        | mimencode -u -b

          :0 A fhw
          | $FORMAIL -I &quot;Content-Transfer-Encoding: 8bit&quot;
      }


      #   1995-10-18 Tim Pickett &lt;tbp A T cs.monash.edu.au&gt;
      #
      #       Decode MIME quoted-printable Content-Transfer-Encoding
      #
      #   Conditions
      #
      #       Mail has a MIME-Version header with a number in it.
      #       Header saying &quot;Content-Transfer-Encoding: quoted-printable&quot;
      #       exists

      :0
      *$ ^MIME-Version:$s*$d*(\.$d*)
      *$ ^Content-Transfer-Encoding:$s*quoted-printable
      {
        :0 fhw     # Remove header
        | $FORMAIL -I&quot;Content-Transfer-Encoding:&quot;

        :0 fbw             # Decode the body.
        | mmencode -u -q
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_send_commands_in_the_messages_body" id="how_to_send_commands_in_the_messages_body"></a>
  <h2>
      13.23 How to send commands in the message's body

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 b
      * ^Subject: ARCHIVE
      | sed -e '/$s*[^a-zA-Z]/,$ d' | sh    </PRE></TD>
    </TR>
</TABLE>



  <a name="matching_two_words_on_a_line_but_not_one" id="matching_two_words_on_a_line_but_not_one"></a>
  <h2>
      13.24 Matching two words on a line, but not one

  </h2>




<p>
<p class="column8">
        How does one write a recipe that will do this: Put mail in mailbox
        which has a line with two string (one and two) like:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          one     two    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          but save mail in error-folder if the line as only the first
          string like: one (string two is missing)</em>




<p class="column8">
        <span class="word-ref">[philip]</span> I presume these lines would be located in the body of the
        message, and that by &quot;space between one and two&quot; you mean
        &quot;whitespace between one and two&quot;.  If those assumptions are wrong
        then you'll need to tweak the following recipes:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # The 'B' tells procmail to look in the body instead of the header.
      # The second colon tells procmail to lock the mailbox with a
      # local lock file -- if mailbox is a directory then you don't need
      # it. The brackets in the condition contain a space and a tab.

      :0 :
      *$ B ?? one$s*two
      default.mbox

      :0 :
      * B ?? one
      error.mbox    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Now, the above will match even if &quot;one&quot; or &quot;two&quot; is part of another
        word (at the end in the case of &quot;one&quot; and at the beginning in the
        case of &quot;two&quot;).  If you don't want that then you'll need to change
        the recipes to read:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      *$ B ?? ()\&lt;one$s*two\&gt;
      default.mbox

      :0 :
      * B ?? ()\&lt;one\&gt;
      error.mbox    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_define_personal_xx_macros" id="how_to_define_personal_xx_macros"></a>
  <h2>
      13.25 How to define personal XX macros?

  </h2>




<p>
<p class="column8">
        By macro, I'm referring to the procmail's FROM_DAEMON, TO and TO_
        that you can use in matches. Here is one way to make one's own macro


<p class="column8">
        <span class="word-ref">[alan]</span> Define HEADERS to include those headers you care about. Pick
        one of the definitions below (and remove or comment out the
        others). Here are three ways to define user <samp class="word">to_</samp> macro

<ol>
	<li>use only To:
<li>use either To: or Cc:
	<li>To:, Cc:, or Apparently-To:</li>
</ol>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      to_ = '^To:(.*\&lt;)?'
      to_ = '^(To|Cc):(.*\&lt;)?'
      to_ = '^((Apparently-)?To|Cc):(.*\&lt;)?'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And you use it like this

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 :
      *$ $to_()foo@example.com
      address-matched.mbx    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[jari]</span> and here are some more examples

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      cc_      = &quot;(^((Original-)?(Resent-)?(Cc|Bcc)):(.*[^a-zA-Z])?)&quot;
      from_    = &quot;(^(Apparently-|Resent-)*\
      (From|Reply-To|Sender):(.*\&lt;)?|\
      ^From $NSPC+)&quot;}    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_change_subject_by_body_match" id="how_to_change_subject_by_body_match"></a>
  <h2>
      13.26 How to change subject by body match

  </h2>




<p>
<p class="column8">
        Suppose you to change the mail's subject when there is a match in
        the body. The desired outcome would be this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From: foo@this.is
      Subject: Fault: NNNN in program block YYY    &lt;&lt; changed

      Fault: NNNN in program block YYY    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here is the answer

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fhw
      *       ^Subject: NOK case report
      *$ B ?? ^$s*\/Fault: [0-9a-f]+ in program block.*
      | $FORMAIL -I &quot;Subject: $MATCH&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="how_to_change_subject_according_to_some_other_header" id="how_to_change_subject_according_to_some_other_header"></a>
  <h2>
      13.27 How to change Subject according to some other header

  </h2>




<p>
<p class="column8">
        Suppose you want to change the subject when mail comes to some
        particular address; or when some other header field. Here is one
        way to do it, we suppose that mail comes to various internal mail
        addresses. See the HEADERS macro in previous section.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # By [alan]
      # Examine headers, create a subject tag if we recognize a list

      TAG = &quot;&quot;

      :0
      *$ ${HEADERS}info@example.com
      {
          TAG = &quot;info&quot;
      }

      :0 E
      *$ ${HEADERS}check@example.com
      {
          TAG = &quot;check&quot;
      }

      # ...and so on...
      # now, if TAG is set, insert it into the subject

      MATCH       # kill this

      :0 fhw
      * !  TAG ?? ^^^^
      *   ^Subject: *\/[^ ].*
      | $FORMAIL -I &quot;Subject: $TAG - ${MATCH:-&lt;no subject&gt;}&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <em class="word">Or</em> you could use the command line arguments, add following
        line to your <samp class="word">.forward</samp>. (alias file syntax)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      foo: &quot;|/usr/local/bin/procmail -m /usr/local/etc/pm-tagit.rc foo&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Then in <samp class="word">tagit.rc</samp> you would instead say:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ARG = $1

      :0
      * ARG ?? ^^foo^^
      {
          TAG = &quot;foo@go&quot;
      }

      :0
      * ARG ?? ^^somethingelse^^
      {
          TAG = &quot;somethingelse@go&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This method will work even if someone Bcc:s a message to
        foo@example.com.



  <a name="how_to_call_program_with_parameters" id="how_to_call_program_with_parameters"></a>
  <h2>
      13.28 How to call program with parameters

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...now, suppose I want to call <samp class="word">program</samp> with parameter $FOUND,
          and get the result back in RESULT, how do I do it ?</em>



<p class="column8">
        The stdout of myprogram will be captured at stored in the variable
        RESULT. Also consider what should happen if there are spaces or tabs
        in the value of $FOUND. Perhaps it should be better off enclosed with
        quoted.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Make sure FOUND is not empty before passed to program

      :0
      * ! FOUND ?? ^^^^
      {
          RESULT = `program &quot;$FOUND&quot;`
      }    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="miscellaneous_recipes"  id="miscellaneous_recipes"></A>
               <h1>
               14.0 Miscellaneous recipes

               </h1>



  <a name="matching_valid_messageid_header" id="matching_valid_messageid_header"></a>
  <h2>
      14.1 Matching valid Message-Id header

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> wrote full RFC compliant matcher. Follow the link
        &lt;<a href="http://www.xray.mpe.mpg.de/mailing-lists/procmail/1998-03/msg00375.html" >http://www.xray.mpe.mpg.de/mailing-lists/procmail/1998-03/msg00375.html</A>&gt;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      dq = '&quot;'                                # (literal) double-quote
      bw = &quot;\\&quot;                               # (literal) backwhack
      ws         = &quot;[         ]*&quot;                     # whitespace
      atom       = &quot;[-!#-'*+/-9=?A-Z^-~]+&quot;
      word       = &quot;($atom|$dq([^$dq\]|$bw.)*$dq)'
      local_part = &quot;$word($ws\.$ws$word)*&quot;
      domain     = &quot;(\[$ws([^][\]|$bw.)*$ws\]|$atom($ws\.$ws$atom)*)&quot;

      :0
      * ! $ ^Message-Id:$ws&lt;EM&gt;<a href="mailto:$ws$local_part$ws@$ws$domain$ws" >$ws$local_part$ws@$ws$domain$ws</a>&lt;/EM&gt;
      thats-non-valid-message-id    </PRE></TD>
    </TR>
</TABLE>



  <a name="sending_two_files_in_a_message" id="sending_two_files_in_a_message"></a>
  <h2>
      14.2 Sending two files in a message

  </h2>




<p>
<p class="column8">
        If you plan to send multiple files in a message, be sure that every
        file has extra blank line at the end so that they can be <em class="word">cat</em>d
        together. Instead of doing

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (cat THIS; echo &quot; &quot;; cat THAT ) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You do

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (cat THIS THAT ) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But sometimes you don't have control over the files, then you can
        do this to make sure there is blank line. Notice, only two
        processes used compared to first choice.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (echo '' | cat THIS - THAT ) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[David]</span> And an sed expert would do it this way

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (sed -e '$ !b' -e '/./G' -e &quot;r THIS&quot; THAT ) | $SENDMAIL    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>$: the last line
<li>!: everywhere except the range (in this case, everywhere except
            the last line)
	</li>
<li>b: branch to a label. No label: branch to the end
	            (and, since -n is not in effect, print the pattern space)</li>
</ul>




<p class="column8">
        Now remember that everywhere except the last line, we've
        skipped ahead, so the rest of the code will be executed only for
        the last line of the input.

<ul>
	<li>/./: on lines that contain a character (but we get here only for
	            the last line, so on the last line if it contains a character)</li>
</ul>



<ul>
	<li>G: append a newline and the contents of the hold space to the
            pattern space (the hold space is empty, so basically, if the
            last line was already empty, do nothing, but if the last line
            was not empty, append a newline and thus add a blank line after
            it).
<li>r file: After finishing with this run through the sed
	            instructions, read the named file and copy it to the output.</li>
</ul>




<p class="column8">
        This side of sed comes out only after sed has had a few drinks...



  <a name="excessive_quoting_of_message" id="excessive_quoting_of_message"></a>
  <h2>
      14.3 Excessive quoting of message

  </h2>




<p>
<p class="column10"><em class="quote10">
          <span class="word-ref">[25 Nov 1997 buck A T Compact.COM]</span> I administer a LISTSERV mailing
          list and our host has asked us to reduce excess quoting of
          previously posted material. ...Subject: asking if this was
          excessive quoting. With the weights below, this extra copy will
          activate at 66% quoted lines of all body lines.</em>



<p class="column8">
        <span class="word-ref">[era]</span> I would definitely tolerate 75% quotes. And in the
        end, you will of course always have to face the kinds of people who
        would rather change their quoting style to evade such constraints
        than quote less. An idealized quote parser should perhaps realize
        that a non-blank prefix that recurs on a lot of lines is probably a
        customized quote string.


<p class="column8">
        This will preserve the correspondent's original subject (with a Re:
        added if it didn't already have one) and thus the template text
        should indicate the nature of the problem.


<p class="column8">
        I'm not sure what would be appropriate to generate behavior more
        like I suggest below, any takers? Perhaps no score at all for empty
        lines, neutralize .signatures (hope sender obeys &quot;-- &quot; convention)
        and add 10^0.5 for each quoted line and dish out -15^0.3 for
        non-quoted? (I haven't really explored this &ndash; could be completely
        up the creek.) [Also, perhaps long runs of quoted material should
        be penalized harder than quoted snippet &ndash; reply text &ndash; quoted
        snippet &ndash; reply text alternations?]

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      COPY_ADDRESS = &quot;listAdm@example.com&quot;

      :0
      * ^Sender: &lt;mailing list tag&gt;
      {
          # - quoted lines
          # - non-blank, non-quoted lines
          # - completely blank lines

          :0
          *$  10^1 B ?? ^$s*&gt;
          *$ -15^1 B ?? ^$s*[^&gt;$WSPC]
          *$ -15^1 B ?? ^$s*$
          {
              #   You don't need to repeat the original condition here
              #   You also don't really need to extract SENDER
              #   Generate a reply with appropriate headers and the
              #   body quoted

              :0 fhw
              | $FORMAIL -rtk -A &quot;Bcc: $COPY_ADDRESS&quot;

              # Now &quot;replace&quot; the body with template text + body (In
              # other words, add the template before the quoted body)

              :0 fbw
              | cat $HOME/template.txt -

              # Now send it off to recipients mentioned in generated
              # header

              ! -t
          }

          # Wasn't excessively quoted; save it
          :0 :
          $SOME_MBOX    </PRE></TD>
    </TR>
</TABLE>



  <a name="sending_message_to_pager_in_chunks" id="sending_message_to_pager_in_chunks"></a>
  <h2>
      14.4 Sending message to pager in chunks

  </h2>




<p>
<p class="column10"><em class="quote10">
          I have a 200 character limit on my pager. But I have wordy contacts
          who go over that limit. What I would like to do is have a recipe
          split up messages addressed to my pager into 200 character (max)
          messages (Procmail mailing list 1997-12).</em>



<p class="column8">
        <span class="word-ref">[era]</span> This stuff about forwarding to pagers is a recurring
        topic on this list. I've tried to find a good summary of all the
        issues but there always seems to be some tiny twist to what people
        would like to have implemented. As a general comment for future
        generations, the Procmail part is usually trivial and the problem
        reduces to writing a good program (shell script or otherwise) for
        formatting the text precisely the way you want it, and spitting it out
        in suitable chunks.


<p class="column8">
        Here's something to split up the body of the message into smaller
        chunks and do a shell script on each chunk. The -s option to fold says
        to only wrap lines on whitespace if possible

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Create a duplicate of the message to forward to the pager.
      #   This will be reformatted and have most headers stripped off.

      :0 c
      {
          # Construct header with only From: and Subject: retained

          HEADER = `$FORMAIL -XFrom: -XSubject:`

          #   Reformat body as 200-character lines and send each
          #   as a separate message with the preconstructed minimal
          #   header

          :0 bw
          |   tr '\012' ' ' | fold -s -w 200 | while read line; do
              echo -e &quot;$HEADER\n\n$line&quot; | \
              $SENDMAIL pageraddress@wherever.com ; done
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If your version of echo doesn't understand \n to mean newline
        (and/or the -e option to enable this escape processing), you need to
        tweak this. (You might need to anyway &ndash; this is mostly untested. In
        my limited testing, I found the messages would arrive in more or less
        random order. Inserting pauses in the script should help to some
        extent, but could lead to other problems and is not an ideal solution
        anyhow.)


<p class="column8">
        I don't know if the header trimming is required; some pager gateways
        appear to count the headers as part of the message, while others
        don't. Again, for future generations, details like this are relevant
        to include when you ask about how to do this.



  <a name="playing_particular_sound_when_message_arrives" id="playing_particular_sound_when_message_arrives"></a>
  <h2>
      14.5 Playing particular sound when message arrives

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Peter S Galbraith &lt;galbraith A T mixing.qc.dfo.ca&gt;]</span> Here is
        the command in shell to produce the sound:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % cat anyfile | /usr/X11R6/bin/auplay /usr/lib/exmh/drip.au    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        However, it won't work directly in the recipe

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      procmail: Executing &quot;/usr/X11R6/bin/auplay /usr/lib/exmh/drip.au&quot;
      Can't connect to audio server    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Strange. The command works from the shell if I <samp class="word">su</samp> to user <samp class="word">mail</samp>.
        Anyway, I got it to work by fully specifying the audio server (which
        is my workstation, where I receive mail)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      AU      = /usr/X11R6/bin/auplay
      TUNE    = /usr/lib/exmh/drip.au

      :0 hwic
      * ^From:.*foo@example.com
      | cat &gt; /dev/null; $AU -audio tcp/mixing:8000 $TUNE    </PRE></TD>
    </TR>
</TABLE>



  <a name="combining_multiple_originalcc_and_originalto_headers" id="combining_multiple_originalcc_and_originalto_headers"></a>
  <h2>
      14.6 Combining multiple Original-Cc and Original-To headers

  </h2>




<p>
<p class="column10"><em class="quote10">
          How can I use procmail/formail to combine the information in these
          headers into their <em class="word">CORRESPONDING</em> header MINUS the Original-*
          Note that I can have multiple Original-Cc: headers and I want all
          the recipients combined into one Cc: header.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   1998-01 by [david]
      #   initialize as unset

      ORIG_TO ORIG_CC

      #   The -c option to formail takes care of headers continued onto
      #   indented lines; the pipe to tr takes care of multiple
      #   Original-To: headers by linking their contents with commas.
      :0
      * ^Original-To:.*[^   ]
      {
          ORIG_TO = `$FORMAIL -zcxOriginal-To: | tr \\12 ,`
      }

      #   Drop trailing comma from tr:
      :0 A
      * ORIG_TO ?? ,^^
      * ORIG_TO ?? ^^\/.*[^,]
      {
          ORIG_TO = $MATCH
      }

      #   Likewise for Original-Cc: lines:

      :0
      * ^Original-Cc:.*[^   ]
      {
          ORIG_CC = `$FORMAIL -zcxOriginal-Cc: | tr \\12 ,`
      }

      :0 A
      * ORIG_CC ?? ,^^
      * ORIG_CC ?? ^^\/.*[^,]
      {
          ORIG_CC = $MATCH
      }

      #   Now, let's install the changes if needed:
      #   with -A instead of -I or -i it should
      #   not clobber existing To: or Cc: information.
      #   -A : Append a custom header field onto the header in any case.

      :0
      * ORIG_TO ?? ^^^^
      * ORIG_CC ?? ^^^^
      { }
      :0 E fhw
      | $FORMAIL                                                      \
        ${ORIG_TO:+-A &quot;To: $ORIG_TO&quot;}                                 \
        ${ORIG_CC:+-A &quot;Cc: $ORIG_CC&quot;}    </PRE></TD>
    </TR>
</TABLE>



  <a name="forwarding_sensitive_messages_in_encrypted_format" id="forwarding_sensitive_messages_in_encrypted_format"></a>
  <h2>
      14.7 Forwarding sensitive messages in encrypted format

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[&lt;Valdis.Kletnieks A T vt.edu&gt;]</span> Please note that the standard Unix
        <samp class="word">crypt(1)</samp> command is not secure, as it uses a modification of the
        Enigma engine, which was broken by the Benchley Park guys (Turing
        and the rest) back during WWII, using a mechanical relay based
        computer. As such, it is trivially easy to break using any computer
        more resent than a Radio Shack TRS-80. Poke around in any of the
        comp.sources.Unix archives, they had a &quot;Crypt Breaker's Workbench&quot;
        posted well over a decade ago. For similar reasons, I can't
        recommend single-pass 56-bit DES anymore either. Triple-DES (with
        an effective 112-bit key) looks safe, as do any of the encryptions
        provided with PGP.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   by [alan]
      #   See if addressed *directly* to me, and ..
      #   ..has not already been forwarded

      KEY             = &quot;TheMagic&quot;
      FORWARD_EMAIL   = &quot;foo@example.com&quot;

      :0
      *$   ^To:.*$LOGNAME(@|[^0-9a-z]|$)
      *$ ! ^$MYXLOOP
      {
          # now let's encrypt the body using mimencode

          :0 fbw
          |   echo &quot;MIME-Version: 1.0&quot; ;                              \
              echo &quot;Content-Type: application/crypt&quot; ;                \
              echo &quot;Content-transfer-encoding: base64&quot; ;              \
              echo &quot;&quot; ;                                               \
              crypt $KEY | mimencode -b

          #   Now let's prepare the headers for forwarding the mail,
          #   and mark it so we don't loop

          :0 fhw
          | $FORMAIL   -I&quot;Resent-To: $FORWARD_EMAIL&quot; -I&quot;$MYXLOOP&quot;

          :0
          ! $FORWARD_EMAIL

      }    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="procmail_and_pgp"  id="procmail_and_pgp"></A>
               <h1>
               15.0 Procmail and PGP

               </h1>



  <a name="decrypt_pgp_messages_automatically" id="decrypt_pgp_messages_automatically"></a>
  <h2>
      15.1 Decrypt pgp messages automatically

  </h2>




<p>
<p class="column8">
        <strong class="word">Warning</strong>: if you use remailers or anonymous services, you must use
        different passwords and different user id's to decrypt incoming
        messages. If you just receive messages encrypted with one key, then
        you this may be useful to you. However, it is generally considered a
        huge security risk to keep your password carved into your .procmailrc.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fbw
      * B ?? PGP ENCRYPTED MESSAGE
      | pgp -z &quot;your pass phrase&quot; -f +batch 2&gt;&amp;1    </PRE></TD>
    </TR>
</TABLE>



  <a name="getkeys_from_key_server" id="getkeys_from_key_server"></a>
  <h2>
      15.2 Getkeys from key server

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # by Adam Shostack &lt;adam A T bwh.harvard.edu&gt; 1996-02
      #
      # This first ruleset protects me from mailbombs from an automated
      # service that I often send incorrect commands to, generating 5mb
      # of reply. It also sorts based on success of the command.
      #
      # swissnet.ai.mit.edu is fast key server

      :0
      * From bal@swissnet.ai.mit.edu
      {
         :0 h
          * &gt;10000
          /dev/null

          :0 h
          *^Subject:.*no keys match
          /dev/null

         :0 E
         | pgp +batchmode -fka
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="auto_grab_incoming_pgp_keys" id="auto_grab_incoming_pgp_keys"></a>
  <h2>
      15.3 Auto grab incoming pgp keys

  </h2>



<p>
<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  [Opher Kahn &lt;kahn A T dg-rtp.dg.com&gt;] This first
      #  ruleset protects me from mailbombs from an automated
      #  service that I often send incorrect commands to,
      #  generating 5mb of reply. It also sorts based on success
      #  of the command.
      #
      #  swissnet.ai.mit.edu is PGP key server

      :0
      * From bal@swissnet.ai.mit.edu
      {
         :0 h
         * &gt;10000
         /dev/null

         :0 h
         *^Subject:.*no keys match
         /dev/null

         :0 E
         | pgp +batchmode -fka
      }

      #  auto key retrieval
      #
      #  I have an elm alias, pgp, points to a key server The log file
      #  gets unset briefly to keep the elm lines out of my log file.

      :0 W
      * B   ?? -----BEGIN PGP
      * H ! ?? ^FROM_DAEMON
      {
          KEYID = `/usr3/adam/bin/sender_unknown`
      }

      LOGFILE=

      #   #todo: We should get rid of the 'elm' dependency here.
      #   #todo: correct this sometime... [jari]
      #

      :0 ahc
      * ! ^X-Loop: Adams autokey retrieval
      | $FORMAIL -a&quot;X-Loop: Adams autokey retrieval&quot; | elm -s&quot;mget $KEYID&quot; pgp


      #!/bin/sh
      #
      #   Script: sender_unknown
      #
      #   unknown returns a keyid, exits 1 if the key is known. $output
      #  is to get the exit status. Otherwise, this would be a one
      #  liner.

      OUTPUT=`pgp -f +VERBOSE=0 +batchmode  -o /dev/null`
      echo $OUTPUT | egrep -s 'not found in file'
      EV=$?
      if [ $EV -eq 0 ]; then
              echo $OUTPUT | awk '{print $6}'
      fi
      exit $EV

      # end of sender_unknown    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="includerc_usage"  id="includerc_usage"></A>
               <h1>
               16.0 Includerc usage

               </h1>



  <a name="using_multiple_rc_files" id="using_multiple_rc_files"></a>
  <h2>
      16.1 Using: multiple rc files

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Do INCLUDERC statements function as a kind of &quot;call&quot; which
          returns control to the &quot;original&quot; rc file if processing falls off
          the end of the included rc file? Or if processing falls off the
          end, does mail then get delivered to $DEFAULT and processing
          stop? Suppose I have these commands</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      INCLUDERC = $PMSRC/pm-a.rc
      INCLUDERC = $PMSRC/pm-b.rc
      INCLUDERC = $PMSRC/pm-c.rc    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Yes, the control is returned to the original file where the
        includerc was called from. And No, mail does not get delivered in
        the $DEFAULT because the includerc just ends: processing continues
        until there is no more statements in the top level.


<p class="column8">
        Includerc is nothing more that a sliced top level recipe.



  <a name="using_call_rc_file_conditionally" id="using_call_rc_file_conditionally"></a>
  <h2>
      16.2 Using: call rc file conditionally

  </h2>




<p>
<p class="column8">
        One interesting way to prevent false hits when filtering UBE is to
        try to see if the message comes from some valid destination
        first. If it comes, then it shouldn't be run through UBE filter,
        because it may filter valid messages out. No ube filter is
        completely bullet proof.


<p class="column8">
        Here is an example where the UBE detection is put into use only when
        the message comes from somewhere that I don't know beforehand (or I
        have just forgot to tweak my .procmailrc)

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ME      = &quot;(me@here.example.com)&quot;
      LISTS   = &quot;(procmail|list-a|list-b)&quot;

      :0                      # Idea by Bill Moseley
      *$ ! ^TO_()$ME
      *$ ! $LISTS
      {
          # Could be UBE or I might be on a unknown distribution list.
          INCLUDERC = $PMSRC/pm-ubecheck.rc
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[dan]</span> That would work; common practice, however, is to put recipes
        for filing mail from lists (and, per Bill's preferences, anything
        mentioning procmail in the head gets treated the same as mail from
        this list) first; then the only remaining condition to consider
        there would be unexpected blind carbons: * ! ^TO_moseley. This
        method is good if you get much more spam than legitimate mail
        (including mail from list subscriptions as legitimate) and you want
        procmail to deal with spam right away. I belong to several very
        active mailing lists, so I actually receive more pieces of
        legitimate mail than pieces of spam.


<p class="column8">
        One way to get the best of both worlds is this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      *$ ! ()\/(^TO_$LOGNAME|procmail|list-(ABC|123|XYZ))    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        because then, if the regexp matches (and thus the negated condition
        fails and you don't detour into $PMSRC/checkspam.rc), MATCH is
        already set to the name of the mailing list, and you can do further
        tests by just examining MATCH (or a variable you copy it into)
        instead of a repeating a complete head search.  [I prefer to use
        the variable $LOGNAME rather than hard-coding my name because then
        others can use the code, and I can use it unchanged on sites where
        my logname is different, and if my logname is changed my
        procmailrc will keep up with it.]  For example (I've separated the<br>
        conditions into two lines so that, per Bill's preferences, a
        mention of procmail in the head will get the message into the
        Procmail List folder, even if a match to $^TO_$LOGNAME is also
        present and appears sooner):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ! ()\/(procmail|list-(ABC|123|XYZ))
      *$ ! ^TO_$LOGNAME
      {
          INCLUDERC=$PMSRC/pm-ubecheck.rc
      }

      #   The next recipe has an `E' flag, so it will be examined
      #   only if the preceding one didn't match; thus if $MATCH was
      #   set inside pm-ubecheck.rc, it won't hurt anything here, and a
      #   value for $MATCH set in pm-ubecheck.rc
      #   won't be mistaken for a list name:

      :0 E: # MATCH is non-null only if it matched a list name
      * MATCH ?? (.)
      $MATCH

      #   Remaining recipes will be read only for two types of mail:
      #   those that met $^TO_$LOGNAME but not any expected list
      #   name, and those that went through pm-ubecheck.rc but came out
      #   undelivered.    </PRE></TD>
    </TR>
</TABLE>



  <a name="using_autoloading_an_rc_file" id="using_autoloading_an_rc_file"></a>
  <h2>
      16.3 Using: autoloading an rc file

  </h2>




<p>
<p class="column8">
        Now when you know that includerc can be called conditionally, let's
        discuss about &quot;autoloading of a module&quot;. For example you may see
        following statement modules which import predefined variables:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * !  WSPC ?? ( )
      {
          INCLUDERC = $PMSRC/pm-javar.rc
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It says that &quot;If variable WSPC does not contain space, then load
        module&quot;. If the module has already been loaded by some other rc
        file, the WSPC would exist. If it does not exist yet, then the
        module is loaded. This is classical example of conditionally
        loading functions or variables into current module:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Check if feature is present, No? Then load module module.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Justin Lloyd &lt;jlloyd A T harris.com&gt; suggest a general way of
        caching the included rc files. Use top-level script that
        records every module that was included. The module is loaded
        only if it it not yet included:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   pm-xximport.rc

      :0
      * ! INCLUDE_CACHE ?? ()\&lt;$RC\&gt;
      {
         #    Module was not there yet, add it to the list
         INCLUDE_CACHE  = &quot;$INCLUDE_CACHE$RCFILE$NL&quot;
         INCLUDERC      = $RC
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This is different approach then the previous one. Instead of
        checking features, the presense of module is checked. Two sides of
        the coin which can be used for the same thing. You can pick either
        solution but here are some thoughts:

<ul>
	<li>Adding extra top level INCLUDE_CACHE is extra work. Procmail
	            must open a separate top-level rc file every time with call</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      RC=&quot;pm-xxscript.rc&quot;   INCLUDERC=pm-xximport.rc    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>If feature already existed, you would still have to open the
            pm-xximport.rc file for every call to find it out. E. g. here you
            pm-xximport.rc is called 3 times no matter if 1, 2, 3 were
	            already present</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      RC=&quot;pm-xxscript1.rc&quot;   INCLUDERC=pm-xximport.rc
      RC=&quot;pm-xxscript2.rc&quot;   INCLUDERC=pm-xximport.rc
      RC=&quot;pm-xxscript3.rc&quot;   INCLUDERC=pm-xximport.rc    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        With previous simple feature test, procmail can evaluate the
        condition in place without the need of opening separate file:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      if no feature present..
          then load

      if no feature present..
          then load    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Note however, that both suggestions accomplish the same thing; the
        implementation is only different. If the typical count of including
        RC files per module were big enough, I'd use justin's way. Usually
        it's around few, say one or two, whose purpose is to define
        variables of get date information.



  <a name="making_naming_of_the_rc_file" id="making_naming_of_the_rc_file"></a>
  <h2>
      16.4 Making: naming of the rc file

  </h2>




<p>
<p class="column8">
        When you write an rc file, think whether or not it could be
        generalized so that others could use it. You could adopt a style
        where all procmail files start with prefix <samp class="word">pm</samp>, so that they can
        be stacked with other files in the same directory. If you simply
        named them as <samp class="word">rc.*</samp>, look what happens:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % ls rc*        # fine, print rc files    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        but If you  would like to print all procmail relates files and backup
        them with one command, the starting prefix is better:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % ls pm-*

      --&gt; pm-mytest.rc
          pm-jaube.rc
          pm-tips.txt
          pm-art.txt
          pm-incoming.log
          pm-list.mbox        # the mailing list    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A name foramt could be <samp class="word">pm-xxSCRIPT-NAME.rc</samp> for a rc file where
        <samp class="word">xx</samp> is the initials of first name and surname, like (J)ohn (D)oe.
        These scripts are product versions, that can be distributed. There
        also is usually private scripts that handle other things, like
        mailing lists, work messages and so on. They vould have a prefix
        <samp class="word">my</samp>.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      pm-jdscript.rc
      pm-myscript.rc      &lt;&lt; private version    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When downloading someone else's script it would be good if it's name
        were unique according to person who made it:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      pm-ajscript.rc      # Average Joe's script.    </PRE></TD>
    </TR>
</TABLE>



  <a name="making_using_name_space_when_saving_procmail_variables" id="making_using_name_space_when_saving_procmail_variables"></a>
  <h2>
      16.5 Making: Using name space when saving procmail variables

  </h2>




<p>
<p class="column8">
        If you're going to write rc file that works like any other
        programming language subroutine, you must separate it from the
        world and make it well behaving. A subroutine is traditionally a
        black box: you call it with arguments and it responds with
        returned values. You don't need to know what happens in there. And
        you expect that the subroutine hasn't changed the existing
        environment, like procmail variables <samp class="word">DEFAULT</samp> <samp class="word">LOGFILE</samp> etc. when
        it ends.


<p class="column8">
        So the process diagram of a good RC subroutine is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
                          pm-xxscript1.rc
      call            --&gt; +------------+
      arguments           | black      | --&gt; it may call
                          | box        |     other subroutines
                          |            | &lt;-- pm-xxscript2.rc
      output values   &lt;-- +------------+    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail does not have local variables, so you must put the
        variables to global name space. Let's see an example where
        subroutine uses <samp class="word">MAILDIR</samp> for <samp class="word">chdir</samp> purposes.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      MAILDIR_xxscript1   = $MAILDIR              # save
      ...
      MAILDIR             = new location
      ...
      ...at the end of subroutine
      MAILDIR             = $MAILDIR_xxscript1    # restore    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here the original value is saved when subroutine started and the
        original value was restored when subroutine exited. The global
        namespace (xxscript1) used was unique and is guaranteed not to
        clash with anyone else's. If the <samp class="word">pm-xxscript2.rc</samp> would have also
        used <samp class="word">MAILDIR</samp> the saved value would have been in

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      PROCMAILVAR_xxscript2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        and the two wouldn't mix up with each others <samp class="word">MAILDIR</samp>. The general
        name for saved variable is therefore:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      PROCMAILVAR_scriptname    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        This follows the simple &quot;onion&quot; or &quot;stack&quot; model, where variable's
        value is saved before changing it and restored on exit point.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      save-x-1
      set--x-1

          save-x-2
          set--x-2
          ..
          restore-x-2

      restore-x-1    </PRE></TD>
    </TR>
</TABLE>



  <a name="making_public_and_private_variables_in_rc_file" id="making_public_and_private_variables_in_rc_file"></a>
  <h2>
      16.6 Making: Public and private variables in rc file

  </h2>




<p>
<p class="column8">
        As you learned above, the variables should be put to RC file's
        name space. The user interface variables (public) should be all caps
        and private variable should start with lowercase letter. Whether
        you use &quot;theVarStyle&quot; or &quot;the_var_style&quot; is up to you.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      [script pm-xxscript.rc]

      # ........................... public

      XX_SCRIPT_FLAG = ${XX_SCRIPT_FLAG:-&quot;default&quot;}
      XX_SCRIPT_VAR  = ${XX_SCRIPT_VAR:-&quot;default&quot;}

      # ........................... private

      charset = &quot;a-z1-2&quot;
      regexp  = &quot;something-that-matches&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Whether you need to stick prefix <samp class="word">xx_script</samp> to the private variables
        depends on whether you call another includerc which may happen to use
        same names as you:


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      [pm-xxscript.rc]
      charset = ...           # watch this
      ...
      INCLUDERC = ..          # call another subroutine

          charset = ..        # holy cow, it used same variable

      ..back in the pm-script.rc

      :0
      * $charset              # BOOM, not what you think.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        In this case it would be wise a) not to define <samp class="word">charset</samp> at the top
        of the file but to move the definition to just before the recipe
        where it is used or b) make the name unique, with
        <samp class="word">xxScriptCharset</samp>.



  <a name="the_rules_of_thumb_for_constructing_general_purpose_rc" id="the_rules_of_thumb_for_constructing_general_purpose_rc"></a>
  <h2>
      16.7 The rules of thumb for constructing general purpose rc file

  </h2>



<p>
<ul>
	<li>Write good documentation at the beginning of file: how to set up
            the includerc and explain what it does. If you don't include
            docs, people may skip your extraordinary useful script. Also,
            remember that the script lives in the Net and passes through many
	            hands long after you have been disconnected.</li>
</ul>



<ul>
	<li>Keep the layout like this: the user interface variables must all
            be in capital letters. Familiarize yourself with what(1) tags
            too. Notice the first and last lines: if you keep the format
            like this, then any universal tool can rip your code from any
            file (or mail), because it's delimited by &quot;pm-xxScript.rc &ndash; &quot;
            and &quot;end of pm-xxScript.rc&quot;. See Unix what(1) for first line's
	            syntax.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          # pm-xxScript.rc -- procmail script for ...
          # DOCS

          USER VARIABLES

          private variables

          CODE

          # end of pm-xxScript.rc    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Always include version number or last modification date somewhere.
            Prefer some version control tool, like RCS, VCS, ClearCase,
	            whatever you have at hand.</li>
</ul>



<ul>
	<li>Use a variable name like <samp class="word">dummy</samp> in appropriate places to tell
            what's happening in the code. Remember that the <em class="word">VERBOSE</em>
            setting isn't much help if you can't tell by looking at the
	            <em class="word">LOG</em> where on earth the code is executing.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          dummy = &quot;start of pm-xxScript.rc&quot;
          ...
          dummy = &quot;Now testing if we have control message XXX&quot;
          :0
          * condition
          {
              dummy = &quot;Now testing if the command is YYY&quot;
              :0
              * condition
              ...
          }
          ...
          dummy = &quot;end of pm-xxScript.rc&quot;    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>If you need the value of some common headers, don't just call
            formail like this because the value may already be available
            prior your includerc. For example the user may already have needed
	            the <em class="word">Subject</em> value and stored it in a variable</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          [in pm-xxScript.rc]

          XX_SCRIPT_SUBJECT = `$FORMAIL -xSubject:'

          [User may have already read the content to SUBJECT]

          SUBJECT   = `$FORMAIL -xSubject:'
          INCLUDERC = $PMSRC/pm-xxScript.rc

      Your pm-xxScript.rc launches an unnecessary formail call. Instead,
      use the existing SUBJECT.

          [user]
          :0
          * ^Subject:\/.*
          {
              SUBJECT = $MATCH
          }

          ...

          XX_SCRIPT_SUBJECT   = $SUBJECT            # Note this!
          INCLUDERC           = $PMSRC/pm-xxScript.rc

          [ in the pm-xxScript.rc variable definitions  ]

          #   User should initialize the variable
          #   XX_SCRIPT_SUBJECT if he already has read the
          #   subject.

          :0
          * XX_SCRIPT_SUBJECT ?? ^^^^
          * ^subject:\/.*
          {
             SUBJECT = $MATCH
          }
          ...the rest of the code    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li><strong class="word">Add</strong> header <samp class="word">X-Loop</samp> and test against it if you are sending an
            automated reply. The <samp class="word">X-loop</samp> prevents responding to already
	            responded message.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          :0
          *    condition
          *  ! ^FROM_DAEMON
          *$ ! ^$MYXLOOP
          {
              # Ok, now we're clear to send an automated reply
          }    </PRE></TD>
    </TR>
</TABLE>



  <a name="an_includerc_skeleton" id="an_includerc_skeleton"></a>
  <h2>
      16.8 An includerc skeleton

  </h2>




<p>
<p class="column8">
        Here is my includerc file skeleton that i use in all my modules. The
        funny looking &quot;.$&quot; are for the text2HTML Perl filter. The
        documentation section can be ripped and turned into HTML very easily
        is you just keep the standard 4 tab column positions and start the
        description with &quot;File id&quot; and end it with &quot;Change Log&quot;. The command
        to make the HTML is:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % ripdoc.pl pm-xxscript.rc | t2HTML.pl &gt; pm-xxscript.html    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        These two perl files are available from my ftp directory.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # pm-xxscript.rc -- one line description string here
      # &lt;EM&gt;&lt;STRONG&gt;$Id: pm-tips.html,v 1.13 2007/10/02 15:09:43 jaalto Exp $&lt;/STRONG&gt;&lt;/EM&gt;
      #
      #   File id
      #
      #       .Copyright (C)  1997-98 Foo Bar
      #       .$Created:      YYYY-MM $
      #       .$keywords:     procmail [subroutine|recipe] whatItDoes $
      #
      #       This code is free software in terms of GNU Gen. pub. Lic. v2 or later
      #       You can get newest version by sending mail to maintainer with
      #       subject &quot;send &lt;FILENAME&gt;&quot;
      #
      #   Description
      #
      #       This subroutine Parses &lt;what&gt; from variable INPUT
      #
      #   Required settings
      #
      #       PMSRC must point to source directory of procmail code.
      #       This subroutine will include
      #
      #       o   pm-xxScriptA.rc
      #       o   pm-xxScriptB.rc
      #
      #   Call arguments (variables to set before calling)
      #
      #       o   INPUT, the string from where to parse...
      #       o   VAR1, description, default is ...
      #       o   VAR2, description, default is ...
      #
      #   Returned values
      #
      #       ERROR will have value &quot;yes&quot; if couldn't parse INPUT
      #       OUTPUT will have result after successful parse
      #
      #   Example usage
      #
      #           :0
      #           * condition\/.*
      #           {
      #               INPUT     = $MATCH
      #               INCLUDERC = $PMSRC/pm-xxscript.rc
      #               #  OUTPUT has the result
      #           }
      #
      #   Change Log: (none)

      # ..................................................... &amp;init ...

      dummy       = &quot;init: pm-xxscript.rc start&quot;

      #  Read the standard variable definitions if they are not
      #  yet defined: that's &quot;if WSPC variable does not contains space,
      #  as it should, then global variables haven't been read yet&quot;

      :0
      * !  WSPC ?? ( )
      {
          INCLUDERC = $PMSRC/pm-javar.rc
      }

      # .................................................... &amp;input ...
      # - User configurable variables with reasonable defaults
      # - But parameters like &quot;INPUT&quot; that must be set beforehand
      #   are not mentioned here.

      VAR1    = $VAR1{VAR1:-&quot;default1&quot;}
      VAR2    = $VAR2{VAR2:-&quot;default2&quot;}

      # .................................................... &amp;do-it ...

      dummy       = &quot;subroutine: pm-xxscript.rc parses now that and that&quot;

      &lt;the code&gt;

      dummy       = &quot;subroutine: pm-xxscript.rc end.&quot;

      # end of pm-xxscript.rc    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="mailing_list_server"  id="mailing_list_server"></A>
               <h1>
               17.0 Mailing list server

               </h1>

<P>
<TABLE class="shade-note">
    <TR>
    <TD class="shade-note-attrib" valign="top">
    <b>      Note:</b>
 These examples are for ad-hoc lists. Procmail language is not
      suitable for handling complex mailing list administration
      although there is Procmail based MLM called <em class="word">Smartlist</em>. The de
      facto MLM software with web based interface is nowadays Python
      based GNU <em class="word">Mailman</em>.
    </TD>
    </TR>
</TABLE>


<p class="column8">
        Simple Mailing list server

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # by Lars Hecking &lt;lhecking A T nmrc.ucc.ie&gt;
      #

      MAJORDOM = &quot;majordomo-(users|docs|workers)&quot;

      :0 w
      *$ ^(Sender|To|Cc):.*\/$MAJORDOM
      *$  MAJORDOM ?? ()\/$\MATCH
      | $APPNMAIL $LISTS/$MATCH    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Here is another, by Brock Rozen &lt;brozen A T torah.org&gt; with ideas
        from <span class="word-ref">[dan]</span>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # get the date in RFC822 format for insertion into some messages;
      # the &quot;Resent-Date:&quot; field is copied from the &quot;Date:&quot; field on
      # some systems. RFC1123 says &quot;All mail software SHOULD use 4-digit
      # years in dates...&quot;

      LIST_NAME = &quot;myList&quot;
      LIST_ADDR = &quot;$LSIT_NAME foo@example.com&quot;
      LIST_DATE = `date '+%a, %d %h %Y %H:%M:%S %Z'`
      LIST_ERR  = &quot;$EMAIL&quot;        # my admin address

      #   Sendmail ignores &quot;To:&quot; in the presence of &quot;Resent-To:&quot;
      #

      :0 fhw
       *$ !^X-List: $LIST_NAME
       *$ ^TO()$LIST_NAME
       |  $FORMAIL
              -A &quot;X-List: $LIST_NAME&quot;                                 \
              -I &quot;Resent-To: $LIST_ADDR &quot;                             \
              -i &quot;Resent-Date: $LIST_DATE&quot;                            \
              -I &quot;Errors-To: $LIST_ERR&quot;                               \
              -A &quot;Precedence: bulk&quot;                                   \
              -A &quot;X-Loop: $COMSAT&quot;

      :0 a
      ! -oi `cat /var/tmp/src/power-users.list`    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="common_troubles"  id="common_troubles"></A>
               <h1>
               18.0 Common troubles

               </h1>



  <a name="procmail_modes_normal_delivery_and_mail_filter" id="procmail_modes_normal_delivery_and_mail_filter"></a>
  <h2>
      18.1 Procmail modes: normal, delivery, and mail filter.

  </h2>




<p>
<p class="column10"><em class="quote10">
          ... a) what recipes procmail goes through if there's no
          /etc/procmailrc on the system b) how it decides whether an
          address/local-part is valid or not c) how procmail selects the
          mailbox to drop the mail</em>



<p class="column8">
        <span class="word-ref">[philip]</span> <em class="word">Delivery</em> mode is invoked using the -d flag. All
        arguments are the -d are user names. It is usually used by the MTA
        to deliver mail to users, and indeed, procmail will return failure
        if it is given an invalid user name. In delivery mode, procmail
        reads /etc/procmailrc before the user's .procmailrc.


<p class="column8">
        <strong class="word">Note</strong>: Procmail will work in delivery mode only if it is
        setuid root, if it is invoked with the ruid of the recipient named
        in -d, or, under certain OSes where the build routines have
        determined that it is safe, if the euid is that of the recipient
        and the egid is the recipient's login group.


<p class="column8">
        <em class="word">Mailfilter</em> mode is invoked using the -m flag. It accepts
        only one rcfile as an argument &ndash; other arguments are either
        variable assignments or arguments that are made availible to the
        rcfile itself as $1, $2, etc. If the specified rcfile is located
        under /etc/procmailrcs/ then procmail will take on the uid of the
        owner of that file. Otherwise, it will run as the user who invoked
        it. /etc/procmailrc, that procmail -d reads, is ignored. In
        mail filter mode, procmail unsets <samp class="word">ORGMAIL</samp> and <samp class="word">DEFAULT</samp> to
        suppress normal delivery &ndash; reaching the end of the rcfile results
        in the mail bouncing. If the rcfile sets either of them then
        procmail will attempt delivery to that mailbox if it falls off the
        end of the rcfile; however, the mailbox will have to be writable by
        the uid/user that procmail is running as.


<p class="column8">
        <strong class="word">Note</strong>: Only one rcfile can be named on the command line, but names
        of other rcfiles can be passed in the positional parameters to be
        used later in INCLUDERC assignments.


<p class="column8">
        <em class="word">Normal</em> mode is invoked by not using the <samp class="word">-m</samp> or <samp class="word">-d</samp> flags. It
        accepts any number of rcfiles and variable assignments as
        arguments. Procmail runs as the invoking user in this mode.
        /etc/procmailrc is ignored.


<p class="column8">
        So, to answer your questions: if procmail reaches the end of the
        specified rcfile, it bounces the mail (/etc/procmailrc is ignored).
        Everything is up to the rcfile &ndash; how to determine whether the
        address is valid and where to put the message if it is.



  <a name="procmail_as_sendmail_mlocal_mail_filtering_device" id="procmail_as_sendmail_mlocal_mail_filtering_device"></a>
  <h2>
      18.2 Procmail as sendmail Mlocal mail filtering device

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I'm a new sys admin at my company, and I've been trying to set up
          Procmail as the mail filtering device (still using mail as the
          Mlocal) I've tried setting up the sendmail.cf to use Procmail as
          a filter (we want to use the current mailer as the local mailer)
          with one local procmail rc file. Procmail seems to work just fine
          if set up as the local mailer, but I'm still having problems
          setting it as the filter.</em>



<p class="column8">
        <span class="word-ref">[John M Vinopal &lt;banshee A T abattoir.com&gt; answers sendmail.cf]</span>

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      R$+ &lt; @ $=a . &gt; $*
          $#procmail $@ /etc/mail/procmailrc $: $1 &lt; @ procmail &gt; $3
      R$+ &lt;@ procmail &gt; $*                      $1 &lt; @ example.com .&gt; $2    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        so this sends anything of the form foo@resort.com through procmail
        and rewrites it as foo@procmail. the procmail script reinjects it
        and it bypasses the call to procmail and then is rewritten back to
        foo@example.com.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /etc/mail/procmailrc:
      :0
      ! -oi -f &quot;$@&quot;    </PRE></TD>
    </TR>
</TABLE>



  <a name="procmail_doesnt_pass_8bit_characters" id="procmail_doesnt_pass_8bit_characters"></a>
  <h2>
      18.3 Procmail doesn't pass 8bit characters

  </h2>




<p>
<p class="column8">
        You've mistaken. Procmail does not do that to your mail.
        Frank Gadegast &lt;phade A T powerweb.de&gt; tells you:

<ul>
	<li>procmail wasnt the problem, it was sendmail
<li>I uncommented this line in sendmail.cf
	            and now I get all nice German Umlauts.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
          # strip message body to 7 bits on input?
          # O SevenBitInput    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The problem was that some mails run through the local mailer
        procmail and arrived all right (local mail), all mail from external
        (that dropped into my most used mailbox where I use a
        procmail-filter), did not arrive all right. This made me think it
        procmail, but these mails came from external and it was sendmail to
        blame.



  <a name="my_isp_isnt_very_interested_in_installing_procmail" id="my_isp_isnt_very_interested_in_installing_procmail"></a>
  <h2>
      18.4 My ISP isn't very interested in installing procmail

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I recently requested my ISP to install procmail, and they
          responded by saying no. Their main reason was they did not wish to
          incur the traffic from any/ all of their subscribers setting up
          mailing lists.</em>



<p class="column8">
        <span class="word-ref">[Jon Lewis &lt;jlewis A T inorganic5.chem.ufl.edu&gt;]</span> Wouldn't you need
        write access to either /etc/aliases or /etc/procmailrc to setup
        mailing lists? Tell the ISP that procmail will greatly improve mail
        delivery and enable all users to filter out junkmail without ever
        seeing it. If they still refuse, find a better ISP.



  <a name="my_isp_has_systemwide_procmailrc_is_this_a_good" id="my_isp_has_systemwide_procmailrc_is_this_a_good"></a>
  <h2>
      18.5 My ISP has systemwide procmailrc; is this a good idea?

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[eli]</span> I, for one, do not like my ISPs to put stuff in
        /etc/procmailrc. There is precious little I will gain from that and
        plenty of opportunity for them to make mistakes I would not have. At
        one ISP I know people got upset at some sendmail level filtering of
        mail. One of those upset is a habitual complain-to-spammer-ISP
        person. He did not want problems seeming to go away if they were
        really there. Another guy just didn't trust the filtering.


<p class="column8">
        Writing a shell script that will give the user a .procmailrc which
        includercs a system wide shared procmailrc is the best way to do it.
        This forces the filtering to be &quot;opt-in&quot;.



  <a name="procmail_changes_mailbox_and_directory_permissions" id="procmail_changes_mailbox_and_directory_permissions"></a>
  <h2>
      18.6 Procmail changes mailbox and directory permissions

  </h2>




<p>
<p class="column8">
        By Ed McGuire &lt;emcguire A T i2.com&gt;. Before procmail was used:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; -rw-rw----   1 foo      mail  1127 Sep 11 07:33 foo    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        After:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; -rw-------   1 foo      mail  1517 Sep 11 07:34 foo    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        when the UMASK environment variable is more restrictive than the
        mode of the mailbox, procmail changes the mode of the mailbox. The
        default value of UMASK is 077.  If you want to preserve the group
        access to your mailbox, I think you can set UMASK to 007 in the
        rcfile:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      UMASK = 007    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          Further note: the above <samp class="word">UMASK</samp> suggestion in .procmailrc does not
          work. See comment by Gjermund S&oslash;rseth &lt;gjermund A T nextel.no&gt;</em>



<p class="column8">
        However the permissions on <samp class="word">DEFAULT</samp> are handled before procmail
        even opens the .procmailrc, so changing the umask there will have
        no effect on the mailspool.


<p class="column8">
        <span class="word-ref">[Scott J. Kramer &lt;sjk A T lux.com&gt;]</span> it's documented in the
        MISCELLANEOUS of the procmail(1) man page:


<p class="column10"><em class="quote10">
          If /var/mail/$LOGNAME already is a valid mailbox, but has got too
          loose permissions on it, procmail will correct this. To prevent
          procmail from doing this make sure the u+x bit is set.</em>



<p class="column8">
        Otherwise, you might notice a syslog message like:


<p class="column10"><em class="quote10">
          procmail: Enforcing stricter permissions on &quot;/var/mail/sjk&quot;</em>



<p class="column8">
        when it chmod's the file to 600. As you've discovered, this is
        inconsistent with the SYSV (Solaris 2 anyway) default mailbox
        protection of 660, gid=6 (mail). I think that's an OS-dependent bug,
        with the `chmod u+x ...' as the workaround.



  <a name="changing_mbox_permission_during_compilation_to_660" id="changing_mbox_permission_during_compilation_to_660"></a>
  <h2>
      18.7 Changing mbox permission during compilation to 660

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...it appears that mail that procmail delivers back into the
          spool it is writing out with owner.group user.mail and rights
          600. To me this is reasonable. Mail delivered to the spool by
          /bin/mail is written out owner user, group mail 660.</em>



<p class="column10"><em class="quote10">
          When procmail delivers mail 600 later attempts at delivery with
          procmail removed from the .forward file fail: /bin/mail doesn't
          have permissions (or refuses to uses its permissions).</em>



<p class="column10"><em class="quote10">
          Since we have fickle and unruly users who will be moving their
          forwards in and out of place this is a problem.</em>
<br>


<p class="column10"><em class="quote10">
          Is the correct solution to force procmail to write 660? If so, how
          is this done? I assume in the section of config.h just below the
          warning about only messing with a section if you think you know
          what you are doing. I don't like feel like I know well enough what
          I'm doing to walk into that territory without some guidance.</em>



<p class="column8">
        <span class="word-ref">[alan]</span> I used to be the manager of the system support in the
        College of Engineering, at the University of California, Santa
        Barbara.


<p class="column8">
        We supported about 1500 users from two HP 9000 G30's, using one of
        them as the centralized mailer. Mail was available via NFS exported
        /usr/spool/mail to over 200 workstations, of all kinds: SGI, HP,
        Sun, etc.


<p class="column8">
        We replaced /bin/mail with procmail as the local mailer (Mlocal)
        because procmail correctly avoided NFS-locking problems, and it
        supported user-configurable mail filtering, without compromising
        system security.


<p class="column8">
        In over two years subsequent to the change, we had no loss of mail
        due to procmail being used as the local mailer. If you wish further
        comment from the current system managers, send mail to
        &quot;postmaster A T eci.ucsb.edu&quot;.


<p class="column8">
        To answer your specific questions:


<p class="column8">
        * you can configure the permissions directly, by changing one of the
        following defines in config.h:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /* bit set on mailboxes when mail arrived */
      #define UPDATE_MASK     S_IXOTH
      /* if found set */
      #define OVERRIDE_MASK   (S_IXUSR|S_ISUID|S_ISGID|S_ISVTX)
      /* the permissions on the mailbox will be left untouched */
      #define INIT_UMASK      (S_IRWXG|S_IRWXO)       /* == 077 */
      #define GROUPW_UMASK    (INIT_UMASK&amp;~S_IRWXG)   /* == 007 */    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        We did not find it necessary, however:

<ul>
	<li>We did disable all locking except dot-locking, since the kernel
            locks were the source of the NFS-locking problems. There have
            continued to be occasional locking problems, but these are
            &quot;victim&quot;-induced problems caused by using non-supported and
            discouraged mailers, such as &quot;mailtool&quot; from older Suns. These
            locking problems have nothing to do with mail delivery, but from
            the mail client using kernel-advisory locks, and then orphaning
            them or, leaving them locked all day long.
<li>An alternative to having users use .forward files, is to create a
            file of users who would like to use procmail as their local
            delivery agent, and use this file to initialize a class
	            variable.</li>
</ul>




<p class="column8">
        Write a special rule in sendmail.cf which delivers mail using
        Mprocmail instead of Mlocal when the destination user is in the
        special procmail user class.


<p class="column8">
        This allows users who want procmail-direct delivery in spite of
        management worrying.


<p class="column8">
        I set this up to test procmail delivery on our system before
        changing Mlocal to use procmail. We placed some &quot;volunteer&quot; users in
        the procmail class file, and they never had any problems (I was one
        of them).



  <a name="the_forward_file_must_be_real_file" id="the_forward_file_must_be_real_file"></a>
  <h2>
      18.8 The .forward file must be real file

  </h2>




<p>
<p class="column8">
        <a href="http://www.math.fu-berlin.de/~guckes/mail/forwarding.html" >http://www.math.fu-berlin.de/~guckes/mail/forwarding.html</A>


<p class="column10"><em class="quote10">
          ...I tried to make a softlink to ~/.forward, but then my
          procmail wouldn't run. When I made a real ~/.forward file, then it
          worked again. My question is &ndash; why would procmail treat a link to a
          file any differently than the actual file itself?</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ln -s ~/.procmail/forward ~/.forward    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Werner Reisberger &lt;wr A T tribe.ping.de&gt;]</span> That's not a problem with
        procmail, this is an MTA issue. Due to security reasons sendmail will
        not deliver mail to files whicharesymlinks.


<p class="column8">
        <span class="word-ref">[david]</span> procmail has restrictions on what permissions it will tolerate
        on an rcfile. For example (I'm just guessing here) it can tell whether
        it can read the target file but it cannot tell who might be able to
        write to it. This prevents a major security hole


<p class="column8">
        You can make hard link to the file, since A hard link is completely
        indistinguishable from the original file. But note: a file hard-linked
        to two or more names is very distinguishable from a file with only one
        (hard) link, and procmail, for example, will not deliver to a plain
        folder that has two or more hard links.


<p class="column8">
        You can also put the real file at ~/.forward and let
        ~/.procmail/forward be a symlink to


<p class="column8">
        <span class="word-ref">[&lt;mikk0022 A T maroon.tc.umn.edu&gt;]</span> I suppose, the reasoning behind
        procmail's folder policy is that procmail locks the file by name, not
        inode. Hence it cannot guarantee mutual exclusion for access to a file
        which has multiple names.


<p class="column8">
        My understanding of the .forward policy is that a symlink need not
        share the permissions of its target. Therefore somebody's .forward
        symlink could have proper permissions, while its target could be
        writable by others. This would allow anybody with the write
        permissions to execute any program (potentially) from the user's
        forward file.<br>


<p class="column8">
        Two hard links share the same permission, so this argument doesn't
        hold.



  <a name="using_forward_if_procmail_already_is_lda" id="using_forward_if_procmail_already_is_lda"></a>
  <h2>
      18.9 Using .forward if procmail already is LDA

  </h2>




<p>
<p class="column10"><em class="quote10">
          <span class="word-ref">[Elie Rosenblum &lt;fnord A T jurai.net&gt;]</span> If you have a .forward, it is
          used by sendmail to replace a call to the LDA for the user in
          question. So if you have a .forward that doesn't call procmail,
          procmail is ...</em>



<p class="column8">
        <span class="word-ref">[david]</span> Elie sent the answer to me with a carbon to the list, but
        since reading my personal copy my inbox got trashed. As of this
        writing the list copy hasn't reached me, but the rest of that
        sentence (as I recall from reading it before it got hosed) was to
        the effect that procmail is then never invoked at all on your
        incoming mail; a .forward takes precedence over the LDA. That
        scenario never occurred to me. Thank you for explaining.


<p class="column10"><em class="quote10">
          <span class="word-ref">[Philip]</span> Scratch the bit about /etc/procmailrcs/$LOGNAME. You're
          mixing up procmail -d with procmail -m.</em>



<p class="column8">
        Ah, got it ... after rereading the man page. The part about
        /etc/procmailrcs really can apply only when procmail is setuid
        root, so again it's something I've no experience with and never
        quite followed or retained. So no file in /etc/procmailrcs is ever
        used implicitly, but /etc/procmailrc can be.


<p class="column10"><em class="quote10">
          <span class="word-ref">[Philip]</span> $HOME/.forward is handled by sendmail. If you have a
          forward, then sendmail rewrites attempts to deliver to you into<br>
          attempts to deliver to the addresses listed in the .forward file.</em>



<p class="column8">
        Or in other words, the .forward takes precedence over the LDA.
        Thank you both.



  <a name="mail_should_be_put_in_the_mailqueue_if_write" id="mail_should_be_put_in_the_mailqueue_if_write"></a>
  <h2>
      18.10 Mail should be put in the mailqueue if write fails

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...We want to deliver directly to a user's home
          directory. But this can of course be temporarily full. Then the
          mail should <strong class="word">not</strong> bounce, but instead be put back in the
          mailqueue and tried again until either it succeeds or sendmail
          bounces it after 5 days (as usual). The README file says this is
          my choice (to bounce or not), but I cannot find any place where
          I can set this. What is the correct place to set this behavior</em>



<p class="column8">
        <span class="word-ref">[1998-06-24 PM-L phil]</span> The -t flag causes procmail to
        return EX_TEMPFAIL where it normally would have returned
        EX_CANTCREAT. If you've made procmail the local delivery agent then
        you should add -t to the A= define, <strong class="word">before</strong> the -d flag.



  <a name="qmail_how_to_make_it_work_with_procmail" id="qmail_how_to_make_it_work_with_procmail"></a>
  <h2>
      18.11 Qmail: how to make it work with procmail

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[1998-11-10 PM-L John Conover &lt;conover A T inow.com&gt;]</span> All you
        do is install fastforward and dot-forward, (they are optional, and
        are not required.) Then cp /var/qmail/boot/proc or
        /var/qmail/boot/proc+df, to /var/qmail/rc.


<p class="column8">
        <span class="word-ref">[1998-11-10 PM-L Greg Boes &lt;gboes A T ashfordtech.com&gt;]</span> From the qmail
        FAQ (4.4 How do I use procmail with qmail?) Put

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      | preline procmail    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        into ~/.qmail. You'll have to use a full path for procmail unless
        procmail in in the system's startup PATH. Note that procmail will
        try to deliver to /var/spool/mail/$USER by default; to change this,
        see INSTALL.mbox.



  <a name="qmail_procmail_looks_file_from_varspoolmail_only" id="qmail_procmail_looks_file_from_varspoolmail_only"></a>
  <h2>
      18.12 Qmail: Procmail looks file from /var/spool/mail only

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Procmail seems to want to do something in /var/spool/mail. But
          since I use qmail, I don't have a /var/spool/mail. Is there a way
          to have procmail not to create temp stuff there?</em>



<p class="column8">
        <span class="word-ref">[philip]</span> Get procmail 3.11pre7 and uncomment and and correct for your
        local setup the MAILSPOOLHOME=&quot;/.mail&quot; define in src/authenticate.c.
        Compile and install. t's relative to the user's home directory.
        Thus the name <samp class="word">MAILSPOOLHOME</samp>.


<p class="column8">
        <span class="word-ref">[Ekkehard Knopp &lt;knopp A T rz-online.de]</span> at the qmail-home-page
        you can find a patch for procmail-3.11.pre7 called
        procmail-maildir-patch. When you can't find it, I can send you a
        netmail. Have no problems with procmail and qmail. Works good.



  <a name="qmail_patch_to_procmail_3_11pre7_to_work_with" id="qmail_patch_to_procmail_3_11pre7_to_work_with"></a>
  <h2>
      18.13 Qmail: patch to procmail 3.11pre7 to work with Maildirs

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Jaye Mathisen &lt;mrcpu A T cdsnet.net&gt;]</span> On the www.qmail.org page is a
        patch that lets procmail 3.11pre7 work with Maildir's, (qmail's NFS
        safe delivery format), and not must Mailbox's.


<p class="column8">
        Very useful. Really slows down delivery though. On my test box,
        just adding procmail to the delivery where all it did was deliver
        to the default mailbox, and no other rules whacked my speed test
        from something like 600,000 messages/day to about 180,000.


<p class="column8">
        Killer. I suspect Procmail's locking of the Maildir 8 ways from
        Sunday is probably partially to blame.



  <a name="afs_how_to_use_procmail_when_home_is_in" id="afs_how_to_use_procmail_when_home_is_in"></a>
  <h2>
      18.14 AFS: How to use Procmail when HOME is in AFS cell

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I've viewed some of the archived posts concerning AFS and
          procmail, but each seems to have a different perspective on the
          subject. Besides the fact that AFS isn't the greatest product in
          the world, does everyone agree that it is not possible to use
          procmail when your $HOME lies in an AFS cell? Mail sent locally
          seems to work with procmail, but mail from users w/o a token or
          AFS id just gets delivered to /var/spool/mail/someone.</em>



<p class="column8">
        <span class="word-ref">[Christopher Lindsey &lt;lindsey A T ncsa.uiuc.edu&gt; 1998-03-09 PM-L]</span> AFS
        is awesome! You just have to treat it nicely. :) The only viable
        solution that we've been able to come up with involves patching the
        procmail-3.11pre7 sources to &quot;fake&quot; user home directories out of
        another directory.


<p class="column8">
        For example, my home directory in AFS is

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /afs/ncsa.uiuc.edu/.u1/lindsey/    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It is kept as such on the mail server in /etc/passwd as well.
        However, we have some space set up via NFS in /var/forward with
        space for each individual user (so /var/forward/lindsey in my
        case).


<p class="column8">
        The procmail patch intercepts requests for the user's home
        directory and replaces it with the &quot;fake&quot; directory (the
        /var/forward one). So for all practical purposes, procmail things
        that my home directory is /var/forward/lindsey, and everything
        works fine.



  <a name="help_some_idiot_sent_my_address_to_30_mailing" id="help_some_idiot_sent_my_address_to_30_mailing"></a>
  <h2>
      18.15 Help, some idiot sent my address to 30 mailing lists

  </h2>




<p>
<p class="column8">
        You can make a procmail recipe to junk incoming mail from the
        lists until you get the unsubscribe messages delivered to cancel
        your participation. You should complain to the list's maintainer
        that such things was even possible: The mailing list should have
        sent you a confirmation message with unique &quot;participate ID number&quot;
        that you need to send back in order for the subscription to take in effect.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      KILL_FILE = $PMSRC/.kill-immediately

      :0
      *$ ? $IS_READABLE $KILL_FILE
      {
          KILL = `cat $KILL_FILE`
      }

      # 1) Make sure KILL has value
      # 2) if match is found from header.
      # 3) /dev/null does not need lockfile

      :0
      *  KILL ?? [a-z]
      *$ $KILL
      /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[sean]</span> ...In the long haul, your best bet with dealing with this
        problem is to stamp out the offender - bring this harassment to
        the attention of their ISP and get their account closed. Repeat as
        necessary. Most of the mailing lists should have some record of the
        submission request. Even if forged, the abuser probably has their
        IP address in the headers somewhere (and if the person is actively
        subscribing your friend to so many lists and actually WORKING at
        covering their tracks, apparently you've REALLY crossed them). Most
        people who stoop to these immature harassment tactics aren't
        bright enough to fully cover their tracks.


<p class="column8">
        Another alternative to having to manually deal with unsubs on
        certain lists is once you've identified filterable characteristics
        of the lists, BOUNCE them. Most semi-intelligent listserv
        implementations will unsub you if they get repeated bounces. Yea,
        not nice to the listserv maintainer - but then, if perhaps they'd
        implement a subscription verification system, it wouldn't have been
        a problem to begin with.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * condition
      {
          # may expose your .forward - but if you're bouncing lists,
          # it probably doesn't matter much.
          EXITCODE = 67

          # save header for examination.
          :0 h:
          bounce.log
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You've got a sticky situation. You can't simply ditch all
        unrecognized mail - you need to be able to review potential refuse
        first, and take action on anything which doesn't belong (because
        you certainly don't want to continue getting the non-wanted lists
        till the end of eternity - you should want to unsubscribe from them
        to simplify your mail).



  <a name="help_procmail_beeps_and_prints_to_my_console" id="help_procmail_beeps_and_prints_to_my_console"></a>
  <h2>
      18.16 Help, Procmail beeps and prints to my console

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...when messages get filtered through procmail I get a beep and
          then first 10 lines or so are also sent to the console. I get a
          lot of messages so the beeps, and stuff on my screen is getting
          very annoying.</em>



<p class="column8">
        <span class="word-ref">[sean]</span> One or the other should do the trick (or both even): Go to
        your login file (what it is named depends on the shell you're
        using), and add:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      biff -n    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or/also, in your .procmailrc add:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      COMSAT = &quot;no&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[manual]</span> has information on the COMSAT variable. It also states
        (contrary to reasoning I gave in above) that COMSAT defaults to
        'no' if you specify an rc file on the commandline (otherwise, it is
        on by default).


<p class="column8">
        Doing this latter one should keep procmail from generating
        COMSAT/BIFF notifications, but would still leave your shell capable
        of receiving them, say, if you only processed certain mail in
        procmail manually or some such. Personally, I turn biff off AND set
        the COMSAT off. I read my mail when I read my mail, and I check it
        often enough (with a POP client at that).



  <a name="help_procmail_dumps_mail_to_console" id="help_procmail_dumps_mail_to_console"></a>
  <h2>
      18.17 Help, procmail dumps mail to console

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I have installed sendmail and procmail on my linux machine
          (latest version of slackware) it works ok, but procmail if run
          with -d $u dumps all mail after receiving immediately on the
          console with ---- more ---- I don't like it, a beep is ok, but I
          do not want all the garbage on my screen. Is there a way to tell
          procmail that I just want the mail in my mailbox
          (/var/spool/mail/$u) ? Thanks for the help!</em>



<p class="column8">
        <span class="word-ref">[Xavier Beaudouin &lt;kiwi A T oav.net&gt;]</span> Check your /etc/inetd.conf for a
        in.comstat, add a '#' at the beginning of the line, save the file
        and killall -HUP inetd. This should stop this ;-)



  <a name="help_corrupted_from_line_in_mailbox" id="help_corrupted_from_line_in_mailbox"></a>
  <h2>
      18.18 Help, corrupted From_ line in mailbox

  </h2>




<p>
<p class="column9"><strong>
         [Jeffrey S. Gilton &lt;jeffg A T castlec.com&gt;
         1998-02-11 in procmail mailing list &quot; Solved the FFrom problem&quot;]</strong>



<p class="column8">
        Thanks to everyone who responded to my questions about a problem where
        the From line was getting corrupted. Here I tell what was the real
        problem.


<p class="column8">
        To recap, when our Caldera OpenLinux 1.1 system received multiple
        mail messages very quickly, some messages would get multiple F's on
        the from line and then subsequent messages would be missing the F's.


<p class="column8">
        Most responses said that it sounded like a file locking problem.
        Suggested solutions were to get the latest version of procmail or
        recompile our version so that it would look at the file locking
        mechanisms.


<p class="column8">
        The funny thing was that three systems with new installs didn't
        exhibit the problem.


<p class="column8">
        The file locking recommendation eventually led to the real problem. On
        a good system I would run our spam script (we spammed ourselves to
        trigger the problem) and everything would work. Using top I would see
        multiple instances of procmail running. Looking at the directory where
        the spool files were, I would see a spool_file.lock file get created
        and then go away.


<p class="column8">
        Finally, I did the exact same thing on the system that wouldn't work.
        There I would see the multiple instances of procmail running but no
        lock file being created. I said to myself &quot;Now that I know what is
        happening, the question is why.&quot;


<p class="column8">
        It turned out to be a permission problem on the spool directory. On
        the system that worked, the permissions were rwxrwxr-x with the owner
        being root and the group being mail. On the system that didn't work,
        the permissions were rwxr-xr-x with the owner and group being root.
        This meant that procmail, which is run as mail couldn't write the
        directory file. We changed the broken system to rwxrwxr-x with owner
        root and group mail. The problem disappeared.


<p class="column8">
        As I said, the suggestions about lock files were key. It guided our
        investigation until we found the real problem. I thank everyone who
        responded.


<p class="column8">
        I've seen other posting about corruption of the From line. Perhaps you
        have the same problem.


<p class="column8">
        <span class="word-ref">[Christopher B. Smith &lt;cbsmith A T envise.com&gt;]</span> I had the exact same
        problem with my upgraded OpenLinux system. For the record, if you are
        running the imapd that comes with it, you should really set your
        permissions for the directory is as follows:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      chmod 1777 /var/mail/spool    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        I got that feedback from the guy who wrote imapd, and it works very
        well.



  <a name="directing_users_mail_to_home_instead_of_varspool" id="directing_users_mail_to_home_instead_of_varspool"></a>
  <h2>
      18.19 Directing user's mail to HOME instead of /var/spool/

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I have a need to direct all a single user's mail to a mailbox in
          his home directory, to $HOME/mailbox,</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # One possible solution, not perfect

      UHOME       = /tmp_mnt/users
      UHOME_LIST  = &quot;(login1|login2|login3)&quot;

      *$ ^TO\/$UHOME_LIST@
      *   MATCH ?? ()\/[^@]+
      $UHOME/$MATCH    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[era]</span> Perhaps preferably use ^TO_ if you have Procmail 3.11pre7
        or newer. This is the classical case of using Procmail where you
        really need the envelope recipient information. The headers are
        <span class="word-big">not</span> enough to determine who a message is for. If Procmail is your
        MDA, you can have this, but I'd still think something involving
        Sendmail would be more appropriate. For one thing, what if this
        user would suddenly really want to use Procmail? You can set
        <samp class="word">DEFAULT</samp> and <samp class="word">ORGMAIL</samp> for this one user in <samp class="word">/etc/procmailrc</samp> to come
        around that, but the bottom line, as so many times before, is that
        Procmail might not be the right tool for this.



  <a name="nfs_mounting_varmail_is_a_good_way_to_get" id="nfs_mounting_varmail_is_a_good_way_to_get"></a>
  <h2>
      18.20 NFS mounting /var/mail is a good way to get bad performance

  </h2>




<p>
<p class="column8">
        Procmail mailing list 1998-06

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; /var/mail stays at a Solaris 2.5 machine. Cucipop is working
      &gt; at the same machine. It's fine there. But, I want to have
      &gt; more than one machine with cucipop and when I put cucipop at
      &gt; another machines, NFS clients, it is delaying more 30 or 40
      &gt; seconds to close the session.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[1998-06-23 PM-L Brad Knowles &lt;brad A T colltech.com&gt;]</span> NFS mounting
        /var/mail is a good way to get bad performance, especially when
        you're doing any NFS writes. Even if you're not doing any NFS
        writes, just having to deal with local file locking and trying to
        translate that into NFS file locking is a nightmare (in general,
        file locking is one of the single biggest problems left with NFS).

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; Procmail is working good on NFS, it finishes quickly. But when
      &gt; cucipop is put on a NFS client, procmails starts to delay too.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail probably isn't writing to NFS, or if it is, it's probably
        not using the same locking mechanism as cucipop. Unfortunately,
        each vendor and each program have their own ideas on how to best do
        that.


<p class="column10"><em class="quote10">
          <span class="word-ref">[philip]</span> cucipop was written by the author of procmail. Ideally,
          when you compile cucipop you edit its config.h to use the locking
          techniques that procmail's autoconf process determined for your
          system(s). However, even if you didn't do that, cucipop uses the
          same dotlocking algorithm as procmail.</em>



<p class="column8">
        Also, keep in mind that any POP3 server will have to copy the
        mailbox in order to work on it, and many of them copy the mailbox
        to /var/mail/.username (you got it &ndash; creating lots of NFS writes).
        When they're done, they copy the mailbox back to /var/mail/username
        (after they copy any new mail messages that have come in to the end
        of /var/mail/.username and locked then truncated the original
        /var/mail/username file).


<p class="column10"><em class="quote10">
          <span class="word-ref">[philip]</span> cucipop doesn't use a temporary file: it keeps it all in
          memory. On deletes it updates the mailspool in place which should
          never <strong class="word">lose</strong> data, though if the server crashes in the middle of
          this you can end up with one or more bogus messages.</em>



<p class="column8">
        This is a <em class="word">real</em> nightmare when you start talking about users who
        select &quot;Leave mail on server&quot; and have multi-megabyte mailboxes.


<p class="column10"><em class="quote10">
          <span class="word-ref">[philip]</span> Assuming you have enough memory, cucipop should be pretty
          fast.</em>



<p class="column8">
        I think maybe now you're starting to understand why POP3 really
        doesn't scale well at all in multi-machine environments (unless
        you've cooked up a custom mail store that uses a real database
        back-end, like Oracle Parallel Server), with /bin/mail (or
        procmail) as a writable interface to this message store and POP3
        and/or IMAP as a readable (and writable) interface to this same
        message store. Then you can let the database vendors deal with the
        hard data replication and distribution problems.


<p class="column8">
        Otherwise, it's a pain-in-the-ass.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; Is there another good pop server?    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Have you tried QPopper from Qualcomm? It's the single best POP3
        server I've ever run across, although I wouldn't put even it in an
        NFS write environment.


<p class="column8">
        BTW, I used to be the Mail Systems Administrator for GNN (Global
        Network Navigator), the web site/National ISP co-operative between
        O'Reilly &amp; Assoc. and AOL. At our peak, we had hundreds of
        thousands of registered users, of which up to five to six thousand
        were logged in at any one time, with their MUA set to check their
        mail every minute.


<p class="column8">
        We had a single primary Mail/POP3 server machine (Dec Alpha 2100 w/
        four 250Mhz processors, 4GB RAM, 28GB hardware mirrored/striped
        mail spool), and one warm spare (same CPU/RAM configuration,
        physically hooked up to the same disks, but through DECsafe ASE not
        mounting them unless the primary died).



  <a name="i_cant_see_the_sendmails_response_in_logfile" id="i_cant_see_the_sendmails_response_in_logfile"></a>
  <h2>
      18.21 I can't see the sendmail's response in LOGFILE

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...As the man page says, this should've written to my LOGFILE. It
          didn't. But it DID activate the pipe in the recipe. So what's up
          here?</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hc
      *$ ? $IS_EXIST $HOME/.vacation
      | LOG=| ($FORMAIL -r; echo $IM_NOT_HERE) | $SENDMAIL -t    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> The man page says that a variable capture recipe assigns the
        standard output of the command to the variable. Since you are repiping
        the output of formail and echo to sendmail, sendmail sucks up the
        standard output of formail and sendmail. Sendmail itself does not
        write to standard output, so the stdout of ( $FORMAIL -r ; echo
        $IM_NOT_HERE ) | $SENDMAIL -t is nothing.


<p class="column8">
        Thus you're assigning a null string to $LOG, and when procmail writes
        $LOG to the logfile you can't see a difference.



  <a name="compiling_procmail_and_choosing_locking_scheme" id="compiling_procmail_and_choosing_locking_scheme"></a>
  <h2>
      18.22 Compiling procmail and choosing locking scheme

  </h2>




<p>
<p class="column8">
        General advice: Everything except dot locking is usually broken.


<p class="column8">
        <span class="word-ref">[stephen, &lt;199607292139.XAA12433@hera.cuci.nl&gt;]</span>. Remove fcntl() and
        lockf(), only allow flock() (or omit it completely) Kernel locks
        don't work. But that's all some programs use. Across a networked
        filesystem, lockf() doesn't work, fcntl() and flock() should, but
        they don't either because the lockd is buggy. Mailtool uses fcntl()
        but does it wrong, so that's another problem. The only thing that
        works on all platforms, all networks, all the time are .lock files.


<p class="column8">
        Makefile refers to:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Uncomment (and change) if you think you know
      #LOCKINGTEST=100
      #        it better than the autoconf lockingtests.
      #        This will cause the lockingtests to be hotwired.
      #        100     to enable fcntl()
      #        010     to enable lockf()
      #        001     to enable flock()
      #        Or them together to get the desired combination.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        config.h refers to:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /*#define NO_fcntl_LOCK uncomment any of these three if you */
      /*#define NO_lockf_LOCK definitely do not want procmail to make */
      /*#define NO_flock_LOCK use of those kernel-locking methods */    </PRE></TD>
    </TR>
</TABLE>



  <a name="forwarding_lot_of_mail_causes_heavy_load" id="forwarding_lot_of_mail_causes_heavy_load"></a>
  <h2>
      18.23 Forwarding lot of mail causes heavy load

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...There are several forward (e.g. ! walter@localhost) recipes
          For every forwarded mail, a distinct sendmail process is created.
          This leads to a heavy (IMHO unbearable) system load. How can I
          stop procmail from running a sendmail process for every mail
          forwarded?</em>



<p class="column8">
        SUMMARY: Look at qmail, it's better than sendmail.


<p class="column8">
        <span class="word-ref">[era 1998-08-15 PM-L]</span> (Blows dust off old underutilized Bat
        Book/ORA sendmail book) Yeah, setting QueueFactor (q) and QueueLA
        (x) to suitable values should do what you want. You need to have
        load-balancing support compiled in, though; according to the Bat
        Book, sendmail -d3.1 tells whether you have it or not. (Mine just
        says getla:0 which I would imagine means I have the support but the
        load average was below the cutoff level.


<p class="column10"><em class="quote10">
          AFAIK using load averaging would have the first messages
          delivered and the rest queued. However, also not being a sendmail
          guru, I do not know how to empty a sendmail queue for incoming
          mail only. Moreover, even if I knew how to do this, it would have
          to be done after procmail finishes.</em>



<p class="column8">
        <span class="word-ref">[Liviu Daia &lt;daia A T stoilow.imar.ro&gt;]</span> Instruct sendmail to queue
        messages when called from procmail:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SENDMAILFLAGS=&quot;-oi -od d&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        then disable the normal sendmail daemon from your system init
        scripts, and run it in flush queue mode only, that is, replace

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /usr/sbin/sendmail -bd -q 15m    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        in your init scripts with

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /usr/sbin/sendmail -q 15m    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        (&quot;15m&quot; is how often the queue will be run (15 minutes).
        Change it to whatever is appropriate
        for your purposes). Also make sure to disable forking in your
        sendmail.cf.


<p class="column8">
        The downside of this approach is that it will also delay the
        delivery of local messages.
        Different approach: pipe messages to sendmail instead of using
        '!' and use the wait flag. Something along the lines of:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 w
      * conditions
      | $SENDMAIL $SENDMAILFLAGS &lt;recipients&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Well, I'm actually not sure you can use the 'w' flag without 'f'
        (the manual doesn't say it, and I'm not too familiar with procmail
        internals), so if that doesn't work you might also try Sendmail
        will rewrite the <samp class="word">From_</samp> header (which you can probably safely
        ignore), and it will (optionally) add a <samp class="word">From:</samp> if one doesn't
        exist, but it won't touch an <strong class="word">existing</strong> <samp class="word">From:</samp>. Well, actually it
        will encode or decode any 8-bit characters in the <samp class="word">From:</samp> according
        to the options in sendmail.cf, but it won't change the <strong class="word">meaning</strong> of
        the &quot;From:&quot;. In fact, that's exactly what procmail does too in the
        '!' recipes.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 fw
      * conditions
      | $SENDMAIL $SENDMAILFLAGS &lt;recipients&gt;

      # dummy recipe to stop procmail from delivering an empty message
      :0
      a /dev/null    </PRE></TD>
    </TR>
</TABLE>



  <a name="what_happens_to_mail_if_mda_procmail_fails" id="what_happens_to_mail_if_mda_procmail_fails"></a>
  <h2>
      18.24 What happens to mail if MDA Procmail fails

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...When procmail is the local mailing agent distributing
          e-mail to a user's $HOME and the target machine is 'down', where
          does the e-mail go? I was given the impression that the mail
          would be collected on the 'mailhub' in /usr/mail/BOGUS.xxx
          (Solaris system). It is not happening and we have the potential
          of losing mail.</em>



<p class="column8">
        <span class="word-ref">[philip]</span> I assume that by &quot;target machine&quot; you mean the NFS
        server for the given user's account. Procmail's attempt to read
        ~/.procmailrc will timeout, then when it tries to write to $DEFAULT
        (which you say is in their home directory) it'll time out (again)
        and return EX_CANTCREAT to sendmail. Sendmail will then presumably
        bounce the message.


<p class="column8">
        Now, if sendmail is looking for .forward files in user home
        directories, then procmail will never be called, as sendmail will
        try to open the .forward file and consider it a transient error
        when it times out, causing the message to be queued for a later
        delivery attempt.


<p class="column8">
        (Note: invoking procmail with the -t flag causes it to return
        EX_TEMPFAIL instead of EX_CANTCREAT. This would cause the message
        to be requeued. However, this is not generally recommended.)



  <a name="procmail_reads_entire_90mb_message_into_memory" id="procmail_reads_entire_90mb_message_into_memory"></a>
  <h2>
      18.25 Procmail reads entire 90Mb message into memory

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...last week my workstation ground to a halt when procmail received a
          90Mb Email message (ran out of memory). The point is, such
          message sizes are fine by me, as long as the system can handle
          it. Is there any way I could make procmail only read the headers
          of that message before scanning /etc/procmailrc/ ~/.procmailrc and
          acting on it? That way it wouldn't need to read the entire
          message into memory.</em>



<p class="column10"><em class="quote10">
          ...Recently, I modified the sendmail.cf file to pipe messages
          through procmail before sending them to deliver, so that I can
          use system-wide procmail recipes for spam filtering. However,
          yesterday we had a client send a 22 megabyte e-mail message (on
          purpose, no less) and the system just came to its knees trying to
          deliver it to the user's mailbox.</em>



<p class="column8">
        <span class="word-ref">[philip]</span> Btw, All the versions of /bin/mail (or mail.local) that
        I've seen the source for either read the entire message into memory
        first or use a temp file. Depending on where temp files are
        located, a 90MB temp file may be just as bad as holding it in
        memory.


<p class="column8">
        And, No, there isn't. Hacking it in would not be non-trivial, mainly
        because the current code runs with the assumption that the entire
        message is there, and determining when it actually needs to see the
        entire body (to do demand loading) would not be easy. Remember
        that a condition on the size of the message, ala

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * &gt; 10000000
      /dev/null    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        would require the body to be read...  It really is just better to
        simply have sendmail enforce the limit. You should be doing it
        there anyway to cut down on the totally trivial denial-of-service
        attacks and because it's more efficient.


<p class="column10"><em class="quote10">
          ...I am running procmail ver 3.11pre7 and I keep getting
          &quot;out of memory as i tried to allocate 8xxxxxx bytes.&quot;. I
          have over 100 meg available swap space so i have a difficult
          time understanding this. Is this a known error?</em>



<p class="column8">
        Procmail's memory allocation technique appears to non-optimal for
        some OS/libc combos, namely implementation of the libc system
        function realloc() (FreeBSD has been reported). It's conceivable
        that the configuration process could be enhanced to detect this
        system limitation to use a strategy more efficient on them. Don't
        hold your breath.



  <a name="procmail_signaled_out_of_memory_in_my_verbose_log" id="procmail_signaled_out_of_memory_in_my_verbose_log"></a>
  <h2>
      18.26 Procmail signaled out of memory in my verbose log

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I notice in my procmail verbose log the following
          'transaction':</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      procmail: [10239] Sat Jan  9 08:49:02 1999
      procmail: Out of memory
      buffer 0: &quot;formail&quot;
      buffer 1: &quot; formail -A &quot;X-Check: List&quot;&quot;
        Folder: **Bounced** 5744
      procmail: Notified comsat: &quot;bhoule@:**Bounced**&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          If I act quick enough when this happens, I can look in
          spool/mqueue and find a message with a gazillion addresses in the
          To: line. So it seems that formail is having trouble adding my
          X-Check header to an already large set of headers.</em>



<p class="column8">
        <span class="word-ref">[philip]</span> No, it's procmail that's unable to allocate enough memory.
        The buffer dumps indicate that procmail was unable to get enough
        memory somewhere between parsing the action line and reaching the
        next recipe &ndash; buffer 0 would not contain the string &quot;formail&quot; if
        procmail had gotten to another recipe or variable assignment.
        What's weird is that the message is so small (only 5744 bytes
        according to procmail). Do you only see this error on this recipe,
        or at random places in your .procmailrc? If the later, then I would
        guess that your mailserver is running out of memory for some other
        reason and that procmail happens to be an innocent bystander. If
        the former, then, well, I'm not sure.


<p class="column10"><em class="quote10">
          The message is never delivered to me. Is there anything I can do
          so that procmail/formail will act as if it was never there so the
          incoming dumps into my inbox rather than returning an error to
          the mailer? This &quot;*<em class="word">Bounced</em>*&quot; business is not a very helpful
          action.</em>



<p class="column8">
        Giving procmail the -t flag will cause fatal internal errors that
        are normally returned as permanent errors to be returned as
        temporary failures instead. Otherwise there's no way to control
        that. (Setting EXITCODE won't work because procmail needs to malloc
        memory to handle TRAP and EXITCODE, and it'll refuse to try that
        when it was malloc that caused the exit.)



  <a name="variables_default_and_orgmail" id="variables_default_and_orgmail"></a>
  <h2>
      18.27 Variables DEFAULT and ORGMAIL

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...According to the man pages, <samp class="word">DEFAULT</samp> is defined as <samp class="word">ORGMAIL</samp>
          ...so if I redefine ORGMAIL, then <samp class="word">DEFAULT</samp> should change as
          well, which doesn't help me. Any help on this would be
          appreciated</em>



<p class="column8">
        <span class="word-ref">[david]</span> <samp class="word">DEFAULT</samp> is initially defined as equal to <samp class="word">ORGMAIL</samp>. Once
        procmail has started reading /etc/procmailrc (if it is the MDA) or
        your .procmailrc, you can change the value of either without affecting
        the other.


<p class="column8">
        In fact, you can even set DEFAULT on the command line when you invoke
        procmail (I'm not sure about doing that with <samp class="word">ORGMAIL</samp>, though), and
        that value will override its normal initial value equal to <samp class="word">ORGMAIL</samp>.


<p class="column8">
        What if it is possible that dropping to DEFAULT fails due to disk full?
        Then you would better have another drop place in another file system.
        Peek at bdf(1) or df(1) to find out the different mounted file systems.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Place this to the end of your .procmailrc and define
      # DEFAULT_SECONDARY

      :0 :
      $DEFAULT

      :0 E
      $DEFAULT_SECONDARY    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you deliver explicitly to $DEFAULT, procmail treats it like any
        other save-to-folder recipe, and if the write fails, it continues
        reading recipes.


<p class="column10"><em class="quote10">
          ...If I had set the &quot;deliver&quot; destination as <samp class="word">ORGMAIL</samp> rather than
          <samp class="word">DEFAULT,</samp> would it have made any difference?</em>



<p class="column8">
        Nope. If you write a recipe for it, procmail just expands the variable
        and doesn't give a heck if it happens to be the same destination as
        <samp class="word">DEFAULT</samp> or <samp class="word">ORGMAIL</samp>. <samp class="word">DEFAULT</samp> is special to procmail only when it
        uses it on its own after falling off the end of the rcfile; <samp class="word">ORGMAIL</samp>
        is special only at startup (without -m) and when procmail falls off
        the end of the rcfile and finds that it cannot save the message to
        <samp class="word">DEFAULT</samp>.


<p class="column10"><em class="quote10">
          In general, if procmail falls off the end of the rcfile,
          fails to save to <samp class="word">DEFAULT</samp>, and then fails to save to <samp class="word">ORGMAIL</samp>,
          does it revert to the compiled-in value of <samp class="word">ORGMAIL</samp> ?</em>



<p class="column8">
        <span class="word-ref">[philip]</span> Procmail has no fallback beyond the current value of
        <samp class="word">ORGMAIL</samp>. If delivery to both <samp class="word">DEFAULT</samp> and <samp class="word">ORGMAIL</samp> fail, then
        procmail gives up and exits with error code 73 (EX_CANTCREAT) or 75
        (EX_TEMPFAIL), depending on whether the -t flag was given. Setting
        <samp class="word">EXITCODE</samp> would probably override those. The message is logged
        as &quot;*Bounced*&quot;.



  <a name="when_default_cannot_be_mailed_to" id="when_default_cannot_be_mailed_to"></a>
  <h2>
      18.28 When DEFAULT cannot be mailed to

  </h2>




<p>
<p class="column8">
        If procmail gets to the end of the rcfile without delivery (or without
        being directed to another rcfile by an INCLUDERC or HOST assignment),
        it assumes these:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0:
      $DEFAULT

      :0 e:
      $ORGMAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        That is, it tries to deliver to $DEFAULT and if it can't, it tries
        $ORGMAIL. If that fails too (&quot;deep, deep trouble&quot; as Stephen says in
        the man page), it exits without delivery and reports failure to the
        MTA, which, depending on other factors, will either requeue the letter
        and try delivering later or will bounce it to the sender.



  <a name="variable_dropprivs" id="variable_dropprivs"></a>
  <h2>
      18.29 Variable DROPPRIVS

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I have procmail invoked from a mailtable for a virtual domain.
          Presently that runs as root, inherited from sendmail. I'd like to
          have it run less privileged. I tried chown'ing the rc file to the
          user I want used and setting &quot;DROPPRIVS=yes&quot;. That didn't do it.
          So I added &quot;LOGNAME=user&quot; and &quot;USER=$LOGNAME&quot; before the
          DROPPRIVS assignment and that didn't work.</em>




<p class="column8">
        <span class="word-ref">[philip]</span> DROPPRIVS only has an effect inside the /etc/procmailrc used
        when procmail is running in delivery mode (-d), not when it's
        running in mail filter mode (-m). USER and LOGNAME have no effect on
        the working of DROPPRIVS, as procmail is just going to change to
        the uid/gid of the user specified on the command line after the -d.
        Your mailtable entry should be specifying the procmail mailer,
        which runs procmail in mail filter mode.


<p class="column8">
        If the following are true:

<ul>
	<li>procmail is running in mail filter mode
<li>no assignments were given on the command line
	</li>
<li>the -p flag was not specified
	</li>
<li>the rcfile specified is located under /etc/procmailrcs/ without
            backwards references (&quot;/../&quot;s)
	<li>the rcfile is not a directory (duh!)</li>
</ul>




<p class="column8">
        then procmail will assume the uid and gid of the owner of the
        rcfile. If the rcfile is actually a symlink, the procmail will
        assume the uid and gid of the link itself, not the underlying file.
        If your OS allows anyone to give away ownership of files with
        chown, the procmail adds the following restriction to those above:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /etc/procmailrcs must be owned by root and mode 700.    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_home" id="variable_home"></a>
  <h2>
      18.30 Variable HOME

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Since procmail doesn't understand tilde, you have to use
        variable HOME instead.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      CONTENT   = `cat ~/file.txt`        # Won't work
      CONTENT   = `cat $HOME/file.txt`    # ok    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        But accessing other user's home is another story. You could change
        the SHELL temporarily to get procmail understand the reference,
        like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SHELL   = /bin/csh
      CONTENT = `cat ~user/file.txt`
      SHELL   = /bin/sh                   # restore original setting    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Because the tilde is in $SHELLMETAS, when procmail sees a tilde,
        it will invoke a shell. It's better to skip the extra process of a
        shell and use the $HOME variable: put a symlink somewhere under
        your own home directory that points to the other user's file so
        that you can use the $HOME variable in your .procmailrc and avoid
        the shell invocation.


<p class="column8">
        However, there are dangers on this too, because sysadm may move
        home directories and your symlinks may be out of date. If you
        expect such changes and broken links, then you could cache the
        needed home directories at time you need them:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HOME_PHIL   = `ksh -c &quot;echo ~phil&quot;`
      HOME_ED     = `ksh -c &quot;echo ~ed&quot;`    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_host" id="variable_host"></a>
  <h2>
      18.31 Variable HOST

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> If a assignment to the &quot;HOST&quot; variable occurs where the
        assigned value doesn't equal the hostname of the machine on which
        procmail is running, procmail will stop reading the procmailrc, and
        if there are other procmailrcs specified on the command line, it
        will start reading them.


<p class="column8">
        <span class="word-ref">[david]</span> It goes back to the early days of procmail, before Stephen
        thought of INCLUDERC or the &quot;var ?? condition&quot; syntax. When people
        had to use different code based on which local host machine was
        processing a particular message, the method was to list a number of
        rcfiles on procmail's command line. The first one would start out
        with general code for all messages and all hosts and then have a

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HOST = some.specific.machine    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        assignment, followed by code for mail delivered on that machine.
        If the first nine characters of &quot;some.specific.machine&quot; matched the
        real value of $HOST, procmail would stay in that rcfile; on a
        mismatch, it would jump to the second rcfile named on the command
        line.


<p class="column8">
        The second rcfile would probably be for another particular machine,
        so (unless it first had some universal code for all machines except
        the first one, or unless there were only two machines where
        procmail might run) right at the top it would have

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HOST = this.specific.machine    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Again, a match for the first nine characters would keep procmail
        reading this rcfile, but a mismatch would make it jump to the next
        rcfile.


<p class="column8">
        And so it went. An incorrect HOST assignment (note that &quot;HOST&quot;
        alone attempts to unset the variable, so it is <em class="word">always</em> an
        incorrect assignment) in the last rcfile on the command line made
        procmail drop the message and exit. Since we almost never name
        more than one rcfile on the command line now, attempting to unset
        HOST in .procmailrc will have that effect.


<p class="column8">
        I would guess that the only use of this original setup still around
        is in SmartList, where flist invokes procmail with a number of
        rcfiles on the command line and uses things like
        HOST=go.to.the.next.rcfile.now to move from one to the next. Also,
        procmail's -m facility (which didn't exist back then) is
        incompatible with using HOST to jump among rcfiles, because it
        requires naming exactly one rcfile on the command line.


<p class="column8">
        Nowadays we can do something like this to use different rcfiles on
        different hosts:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * HOST ?? ^^\/[^.]+
      {
          INCLUDERC = $HOME/.$MATCH.rc
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_linebuf" id="variable_linebuf"></a>
  <h2>
      18.32 Variable LINEBUF

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...[manual] Length of the internal line buffers, cannot be set
          smaller than 128. All lines read from the rcfile should not
          exceed $LINEBUF characters before and after expansion. If not
          specified, it defaults to 2048. This limit, of course, does not
          apply to the mail itself...</em>



<p class="column8">
        <strong class="word">Note:</strong> Beware of simply setting LINEBUF to a huge value: such an
        assignment causes procmail to immediately allocate twice that much
        memory (procmail has two buffer internally of size $LINEBUF).


<p class="column8">
        <span class="word-ref">[philip]</span> Those 160 lines of condition are almost certainly
        overflowing LINEBUF. You should either a) use one of the
        innumerable recipes sent to the list demonstrating the use of
        fgrep; b) break it into multiple recipes; or c) increase LINEBUF.
        If you modify this list of domains regularly, then you should
        strongly consider (a), as (b) and (c) just put off it happening
        again.


<p class="column8">
        <samp class="word">LINEBUF</samp> only applies to lines from procmailrcs. You generally only
        have to worry about <samp class="word">LINEBUF</samp> when you have a variable expansion or
        command expansion (back quotes) that doesn't have an obvious and
        reasonable bound on its size. procmail will avoid over running its
        <samp class="word">LINEBUF</samp> length buffer when doing command expansions by ignoring the
        extra output, so you're safe there, as long as data truncation is
        fine. Variable expansion isn't checked like that, so you can cause
        procmail to core dump by doing something like:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject: \/.*
      |some-program $MATCH    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        then feeding procmail a message with a huge Subject: header field:
        since no shell meta characters appear in the action, the action
        line will be expanded and exec()ed by procmail directly instead of
        by the shell. On the other hand, the following is fine:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject: \/.*
      |some-program $MATCH ; ;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The semicolon forces a shell invocation, and the shell should be
        safe. If your /bin/sh can buffer overrun on variable expansion, then
        you're in more trouble than you know.


<p class="column8">
        Action lines aren't the only place to watch your variable
        expansions. Variable assignments and condition lines that have a
        leading dollar sign also undergo expansion. For example, this isn't
        safe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      SUBJECT = `$FORMAIL -x Subject:`
      NEWSUBJ = &quot;Subject: $SUBJECT&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        procmail won't buffer overrun in the first line, but a really long
        subject could cause the second to do so. The following should be
        safe:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      NEWSUBJ = &quot;Subject: `$FORMAIL -x Subject:`&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        but even then only if you're sure the shell is doing the expansion
        of NEWSUBJ.


<p class="column8">
        Note that matching against the value of a variable (using the &quot;var
        ??&quot; condition special) is safe no matter what the size of the
        contents of the variable. The problem is when you interpolate the
        variable into something else.


<p class="column10"><em class="quote10">
          Is there any easy way to know default LINEBUF value for
          specific procmail? I'm sure there's a much easier way, but this
          will work:</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #   Mitsuru Furukawa
      #
      $OUT    = $HOME/tmp/linebuf.lst

      :0 wc:  $OUT$LOCKEXT
      *$ ! ?  $IS_EXIST $OUT
      | echo &quot;$LINEBUF&quot; &gt; $OUT    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> If you examine the procmailrc manpage, you'll note that it
        lists fourteen variables (among them DEFAULT but not LINEBUF) whose
        values are reset in the environment by procmail, plus some
        additional ones like IFS, ENV, PWD, and PATH which come out of the
        top of config.h. Following this is a list of all of procmail's
        magic variables, including those fourteen. The idea is that while
        procmail has thirty magic variables, only fourteen of them are put
        into the environment by procmail.



<p class="column8">
        The others may have default values, but they're 'input only': if
        what you're doing depends on one of the others having a certain
        value, then you should just go ahead and set it to that value. I
        know of only two ways to find out what value procmail is using by
        default: a) check the manpage (the manual pages should show the correct
        default for the machine), or b) fire up your favorite debugger and
        hope that no one stripped the procmail binary.


<p class="column8">
        There will be no error message when Procmail dumps core, even
        though the reason is apparently precisely that <samp class="word">LINEBUF</samp> is being
        exceeded too much.


<p class="column10"><em class="quote10">
          Is there a limit on the length of a single line</em>



<p class="column8">
        <span class="word-ref">[david]</span> Yes, both before and after variable expansion and
        command substitution, it must be shorter than <samp class="word">LINEBUF</samp> characters.
        The exceptions are (1) comments and (2) commands that are run by a
        shell rather than directly by procmail. The entire condition must
        be under <samp class="word">LINEBUF</samp> characters


<p class="column8">
        Unfortunately, LINEBUF seems to be a write-only variable; you can
        change its value but you can't find out its current setting.



  <a name="variable_log_and_logfile" id="variable_log_and_logfile"></a>
  <h2>
      18.33 Variable LOG and LOGFILE

  </h2>




<p>
<p class="column8">
        If you want to print something to the <samp class="word">LOGFILE</samp>, you could do it
        like this

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      LOG = &quot;  This message goes to LOGFILE&quot;
      LOG = &quot; $NL$NL  And this has linefeeds around $NL$NL&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or like this, which proves to have some nice feature in respect to
        <samp class="word">VERBOSE</samp> setting:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      dummy = &quot;  This message goes to LOGFILE&quot;
      dummy = &quot; $NL$NL  And this has linefeeds around $NL$NL&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You see, if you set <samp class="word">VERBOSE=&quot;off&quot;</samp> Then the <samp class="word">dummy</samp> lines are not
        printed and recorded to the <samp class="word">LOGFILE</samp>. <samp class="word">LOG</samp> messages are aways
        printed, and that's not very nice if you're trying to suppress
        messages while you call some subroutine:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      saved   = $VERBOSE
      VERBOSE = &quot;off&quot;

      #   Hope this subroutine does not use LOG
      #   Eg. $PMSRC/pm-jaaddr.rc

      INCLUDERC = $RC_ADDR

      VERBOSE = $saved            # restore original value    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_trap" id="variable_trap"></a>
  <h2>
      18.34 Variable TRAP

  </h2>




<p>
<p class="column8">
        Here is one example how to write to the log file, Be sure that you
        have preset all the variables, this just demonstrated the usage of
        <samp class="word">TRAP</samp>. Pay attention to right use of single and double quotes if
        you pass the values to the shell. Like in this example where the
        <samp class="word">/dev/</samp> is removed from the <samp class="word">FOLDER</samp> variable's value.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      TRAP = 'echo &quot;
      FROM    $FROM
      TO/CC   $TO / $CC
      SUBJECT $SUBJECT
      FOLDER  $LASTFOLDER
      &quot; | sed -e &quot;s#FOLDER   /dev/#FOLDER   #g&quot;'    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And if your MUA expects the file to be touched before it sees new
        incoming mail, here is recipe by <span class="word-ref">[david]</span>:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      TRAP = 'touch -m $HOME/Mail/$LASTFOLDER' # with strong quotes    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Place it early in your rcfile; then each recipe that saves to a
        directory can look simply like this, and the trap will take care of
        the touching:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 flags # no local lockfile needed for save to directory
      * conditions
      directoryname/.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> Procmail terminates when it exits ... after final delivery
        of the message. It doesn't terminate (nor execute TRAP) after
        delivering a copy to a <samp class="word">c</samp> recipe [however, a clone does execute
        TRAP when it terminates, unless you unset TRAP for it]. It doesn't
        execute the trap after a variable assignment, a variable capture
        recipe, a filtering recipe, nor any other non-delivering action.


<p class="column8">
        On the other hand, it <em class="word">does</em> execute the trap if you do a quick
        bail-out by unsetting or missetting $HOST.



<p class="column9"><strong>
         <span class="word-ref">[Recipe to record Subject lines on exit]</span></strong>



<p class="column8">
        <Some Message had doubled Subject lines> <span class="word-ref">[david]</span> ...this will
        list all subject lines in the log file upon exit if there are two
        or more. The earliest would appear twice: once in the trap output
        and once in the logabstract.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^Subject:.*$(.+$)*Subject:
      {
          #  If there is already `TRAP' set, combine the
          #  old trap recipe with this

          TRAP = &quot;${TRAP:+$TRAP ; }$FORMAIL -XSubject:&quot;
      }    </PRE></TD>
    </TR>
</TABLE>



  <a name="variable_umask" id="variable_umask"></a>
  <h2>
      18.35 Variable UMASK

  </h2>




<p>
<p class="column8">
        There is a better way to find out which folders contain new
        mails if you are using procmail to filter the mails. (This was a
        hack by one of my friends) procmail allows you to set UMASK on the
        folders. So before doing anything, set UMASK to 076, which means the
        perms will be -rwx-----x to any folder which receives mails. now
        using <samp class="word">find</samp> -perm -001, you can print the folders which have new
        mails. the shell script which does this will also have to chmod o-x
        on all these folders.


<p class="column10"><em class="quote10">
          ...How does this work? AFAIK umask only applies to new files created
          and not to appending to existing files which is what procmail
          essentially does, right?</em>



<p class="column8">
        <span class="word-ref">[era]</span> Procmail does interpret UMASK this way, so this works,
        but I don't think it's a particularly good solution. It's actually
        hinted at in the documentation for UMASK in procmailrc(5). <samp class="word">find</samp> is
        a rather heavy program to start up every time you want to look for
        mail. (Haven't done any timings, though.)

<ul>
	<li>I just grep -c '^From ' on my mail folders to see how many
            messages there are in them. (This is only an approximation, in
            the case where one or more messages contain unescaped From_
            lines.)
<li>For a really pedestrian solution, keep all your spool files in
            their own directory (I think this is a good idea for other
            reasons as well) and do an ls -lrt on that directory, possibly
            piped into a sed script to trim off files with time stamps older
            than, say, 24 hours.
	</li>
<li>If your mail reader will reset permissions on spool files when
            it gets mail from them, the UMASK trick is a good base for a
            mail checking script, but I would then only ls -l the spool
	            files and look for files with an x01 permission.</li>
</ul>





  <a name="umask_and_permissions" id="umask_and_permissions"></a>
  <h2>
      18.36 UMASK and permissions

  </h2>




<p>
<p class="column10"><em class="quote10">
          My mail folder says -rw-r--r-x, Is there a bug in Procmail's
          umask handling? (see last x bit)</em>



<p class="column8">
        <span class="word-ref">[philip]</span> That's a feature, not a bug! To quote the procmailrc(5)
        manpage:


<p class="column8">
        <strong class="word">UMASK</strong>: The name says it all (if it doesn't, then forget about
        this one :-). Anything assigned to UMASK is taken as an octal
        number. If not specified, the umask defaults to 077. If the umask
        permits o+x, all the mailboxes procmail delivers to directly will
        receive an o+x mode change. This can be used to check if new mail
        arrived.


<p class="column10"><em class="quote10">
          Anyhow, normally, under Unix, the create system call will set
          default permissions of 666 and the umask can only be used to mask
          off the bits you don't want (and not to e.g. add x bits).
          Shouldn't Procmail work this way, too, just to be consistent with
          the rest of the system?</em>



<p class="column8">
        creat() will set the permissions to whatever you want it to,
        modulus the umask. If the umask is zero, you can set the
        permissions to 7777, though that would be kind of stupid (and
        actually, most versions of UNIX won't let you set both the sticky
        bit and an executable bit unless you're root, for historical
        reasons). Most programs that call creat() or open(..,O_CREAT,...)
        give a mode argument of 0666, as they generally don't write out
        executables. Procmail just happens to call open() with a mode
        argument of 0667, to be modified by your umask.



  <a name="performance_difference_between_back_tick_and_recipe" id="performance_difference_between_back_tick_and_recipe"></a>
  <h2>
      18.37 Performance difference between back tick and &quot;|&quot; recipe

  </h2>




<p>
<p class="column8">
        Procmail sends the whole message to stdin whenever
        it sees back ticks used. And if you use recipe, you can add
        the <samp class="word">h</samp> flag to feed only the header to the program, and not the
        whole message. Let's ask academic question: Which one
        of the choices below is efficient?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      # Side effect: Do something with shell
      dummy = `echo hi there &gt; some-file.txt`

      :0 hwic
      | echo &quot;hi there&quot; &gt; some-file.txt    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail sends whole message to first line and only headers
        to second recipe. Answer: It doesn't matter. Either way procmail
        will make one write system call which will return 0 <span class="word-ref">[bytes written]</span>
        and off it goes. You should use the first one, because the latter
        affects the <samp class="word">A</samp> and <samp class="word">E</samp> flags later, first one is more clear overall.


<p class="column8">
        While someone suggested following, it was rejected because it
        hurts performance more <span class="word-ref">[stephen]</span>. The cat process is useless and
        directing to dev null does not buy anything.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 hwic
      | cat - /dev/null; echo &quot;hi there&quot; &gt; some-file.txt    </PRE></TD>
    </TR>
</TABLE>



  <a name="procmails_temporary_file_names_while_writing_file_out" id="procmails_temporary_file_names_while_writing_file_out"></a>
  <h2>
      18.38 Procmail's temporary file names while writing file out

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Any ideas what might make those .nfs* files? They contain
          messages which seem to have been successfully processed by
          procmail in the later parts of the .procmailrc . However, I doubt
          they'd ever get cleaned up if I didn't discover them.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /disk3/home/foobar/Mail 119) ls -la backup
      total 22
      drwx------  2 stanr         512 Nov 11 21:00 .
      drwx------  3 stanr        2560 Nov 11 21:11 ..
      -rw-------  1 stanr        3063 Nov  4 03:31 .nfsA0c724.4
      -rw-------  1 stanr        1780 Nov  3 23:00 .nfsA47da4.4
      -rw-------  1 stanr         849 Nov  3 23:22 .nfsA481f4.4
      -rw-------  1 stanr        2293 Nov 11 11:28 .nfsA737d4.4
      -rw-------  1 stanr        2598 Nov 11 20:39 msg.HCJB
      -rw-------  1 stanr        3127 Nov 11 21:00 msg.ICJB
      -rw-------  1 stanr        1884 Nov 11 20:45 msg.KCJB
      /disk3/home/stanr/Mail 120)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> procmail uses temporary name while it is trying to
        write a file out, which it renames if things go well. I noticed
        that they all came from a 4h 31 span overnight; perhaps there was
        some systems work being done on your machine that screwed things
        up?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 ic
      | cd backup &amp;&amp; rm -f dummy `ls -t msg.* .nfs* | sed -e 1,3d`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[aaron]</span> When a file that is being used by a program on an NFS
        client gets unlinked the NFS server renames it to something like
        that. It should then actually get unlinked when the file is closed,
        but it looks like the NFS server never got the close message for
        those.


<p class="column8">
        <span class="word-ref">[Keith Pyle &lt;keith A T ibmoto.com&gt;]</span> It is a result of using NFS, but
        the fault lies with the operating system on the NFS client. Keep in
        mind that NFS is stateless from the perspective of the NFS server.
        It keeps no information on how any file is being used. So, if a
        client tells the server to delete the file, the server deletes the
        file. This is not normally a problem, but many programs use a
        &quot;trick&quot; of Unix where the program opens a file, unlinks (deletes)
        it, and then continues to use the file. For all local files, the
        Unix kernel will not actually delete the file until all processes
        which have the file open exit. This works very well for temporary
        files.


<p class="column8">
        If a client tells an NFS server to delete a file, it will delete
        the file immediately because of the stateless nature of NFS. The
        server has no way of knowing if any client still has the file open.
        To avoid this problem, if a client unlinks an open file on an NFS
        filesystem, the file is renamed to .nfs* where * is a unique value.
        The NFS client system is supposed to delete the .nfs* file when the
        process exits. However, there are some versions of Unix which do
        not do this well (e.g., AIX). If one of these OS's is used, it is
        common to find .nfs* files in various places. Therefore, it is a
        good idea for system administrators to periodically purge any .nfs*
        files over a certain age to eliminate the unsightly buildup in the
        filesystems.



  <a name="parameter" id="parameter"></a>
  <h2>
      18.39 Parameter $@

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> Of version 3.11pre7 procmail does not grok &quot;$*&quot;, nor does
        it grok &quot;$@&quot; outside a pipe or forward action. The only way to get
        the positional parameters all quoted together into &quot;$*&quot; is
        something like this:


<p class="column8">
        This doesn't work after all

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ARGS = `echo &quot;$@&quot;`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail substitutes null for &quot;$@&quot; there.  <em class="word">This</em> works, though:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 ir
      ARGS=|echo &quot;$@&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        After that you use &quot;$ARGS&quot; instead of &quot;$*&quot;.


<p class="column8">
        If you try to set ARGS with ARGS=&quot;$@&quot;, procmail doesn't substitute
        for &quot;$@&quot; and makes $ARGS null. If you try ARGS=&quot;$*&quot; you get the
        literal text '$*'.


<p class="column8">
        <span class="word-ref">[philip]</span> Of course, $ARGS differs greatly from $@ in that $ARGS will
        either be split on whitespace (if unquoted) or one argument (if
        double-quoted).  $@ has the cool property that if double quoted
        it'll still be split into multiple arguments on the original
        argument boundaries. Since full-blown mail addresses often have
        spaces, this distinction should not be casually dismissed. Note
        that while you might not type in such an addresses, your MUA's
        reply builder may.



  <a name="procmail_variables_are_null_terminated_detecting_null_string" id="procmail_variables_are_null_terminated_detecting_null_string"></a>
  <h2>
      18.40 Procmail variables are null terminated (detecting null string)

  </h2>




<p>
<p class="column8">
        You can't catch null in the message. Eg if you try like this

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      NUL=`/usr/bin/echo &quot;\000&quot;`

      :0
      *$ HB ?? $\NUL
      {
          LOG = &quot;Caught NUL&quot;
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[philip]</span> It won't work as expected. The problem is that environment
        variables (and therefore procmail variables) are null-terminated,
        and therefore cannot contain a null. The above line creates an
        empty variable. The solution is to use an inverted character class:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      NUL = `/usr/5bin/echo '[^\001-\377]'`    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Note that procmail handles 8-bit characters except for null in
        procmailrcs, so you can use a literal control-A and octal-377 in
        your .procmailrc and save an echo and shell invocation right there.



  <a name="from_daemon_to_and_to_and_casesensitiveness" id="from_daemon_to_and_to_and_casesensitiveness"></a>
  <h2>
      18.41 FROM_DAEMON TO and TO_ and case-sensitiveness

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> ^TO is case-insensitive by default. Stephen once told me
        something to the effect that tokens like ^TO, ^TO_, ^FROM_DAEMON,
        and ^FROM_MAILER are <em class="word">always</em> case-insensitive, even if the recipe
        has the <samp class="word">D</samp> flag, but I'm not positive that that was what he was
        saying, and we never pursued it. Certainly they are insensitive to
        case if there is no <samp class="word">D</samp>.


<p class="column8">
        <span class="word-ref">[philip]</span> If a regexp contains the ^FROM_DAEMON token, then that entire
        regexp is treated as case-insensitive. Other conditions in the
        recipe are not affected by this. The other tokens have no effect on
        the case-sensitivity. (This is with procmail 3.11pre4)



  <a name="to_macro_deciphered" id="to_macro_deciphered"></a>
  <h2>
      18.42 TO_ macro deciphered

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...What is the essential difference between TO and TO_ ?</em>



<p class="column8">
        <span class="word-ref">[phil 1996-03-21]</span> The difference is that ^TOalias1@site may match
        something like bobs-alias1@site while ^TO_ won't.


<p class="column8">
        <span class="word-ref">[elijah 1997-09-16]</span> Let's rewrite that in perl /x format. See
        below. The definition of the word boundary in block (E). See below.
        The ^TO_ expansion was added in v3.11pre4. You'll probably have to
        just ^TO (no '_'), which should work almost as well.



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /                       # [begin regexp]
       (                      # [Block (A)]
        ^                     # Anchor to start of line
         (                    # [Block (B)]
           (Original-)?       # Optionally proceed (C) with &quot;Original-&quot;
            (Resent-)?        # Optionally proceed (C) with &quot;Resent-&quot;
                    (         # [Block (C)]
                     To       # &quot;To&quot;
                    |Cc       # or &quot;Cc&quot;
                    |Bcc      # or &quot;Bcc&quot; {very rare in practice}
                    )         # [end (C)]
           | (                # [Block (D)]
              X-Envelope      # Proceed line 17 with &quot;X-Envelope&quot;
             |Apparently      # or &quot;Apparently&quot;
                 (-Resent)?   #    with optional &quot;-Resent&quot; appended
             )                # [end (D)]
                -To           # &quot;-To&quot; [line 14]
          )                   # [end (B)]
             :                # &quot;:&quot;
             (                # [Block (E)]
              .*              # any text
                # any single char other than letters, numbers,
                [^-a-zA-Z0-9_.]
                              # hyphen (-), underscore (_), or period (.)
             )                # [end (E)]
              ?               # Block (E) is optional
       )                      # [end (A)]
      /x                      # [end regexp]    </PRE></TD>
    </TR>
</TABLE>



  <a name="to_macro_and_rfc_822" id="to_macro_and_rfc_822"></a>
  <h2>
      18.43 TO_ macro and RFC 822

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...According to RFC822 the From address can contains almost anything
          and the valid mail address can be extracted from the line as
          long as it is enclosed between &lt;...&gt;. Like foo@example.com.</em>



<p class="column8">
        <span class="word-ref">[by Vikas Agnihotri &lt;vikas A T insight.att.com&gt;]</span> Block (E){see
        TO_ macro explanation} is there to slurp up that part. The
        &lt;encapsulation&gt; is not needed, and a case such as:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From: &quot;jester@fun.house.example.com&quot; fool@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Will confuse a test for &quot;^TO_jester@&quot;. Yes, I have seen people do
        that stuff, apparently not even maliciously. And although valid
        following is also valid

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From: someone@somewhere.example.com another@one.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Elijah continues]</span> it will also confuse the regexp. I don't like
        the ^TO and ^TO_ macros for most things and typically use stuff
        like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^(Resent-)?(To|CC):.*[&lt; ]{address}([ &gt;]|$)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It still can be confused, but the things that will cause problems
        are fairly rare in practice. You might prefer something like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ^(Resent-)?(To|CC):([^(]+([(].*[)])?)*[, &lt;]{address}([, &gt;]|$)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Which can correctly deal with

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      To: (hatter@tea.party) {address}
      To: (fake {address}) bill.the.lizard@the.jury.box
      To: Alice &lt;EM&gt;<a href="mailto:alice@the.croquet.game" >alice@the.croquet.game</a>&lt;/EM&gt;, &quot;W. Rabbit (late)&quot;
              &lt;EM&gt;<a href="mailto:hare@small.hole" >hare@small.hole</a>&lt;/EM&gt;, Gentle Reader &lt;{address}&gt;
      To: jabberwocky@vorpal.swords.example.com,
              duchess@the.croquet.game,
              chesire@no.where, {address}, dinah@meow.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It will still fail for

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      To: (fake &lt;{address}&gt;) mockturtle@tortoise.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If someone is malicious enough to send you such mail.



  <a name="from_daemon_deciphered" id="from_daemon_deciphered"></a>
  <h2>
      18.44 FROM_DAEMON deciphered

  </h2>




<p>
<p class="column8">
        Here is the exploded FROM_DAEMON regexp as of 3.11pre7

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (^(Precedence:.*(junk|bulk|list)
        |To: Multiple recipients of
        |(
          ((Resent-)?(From|Sender)|X-Envelope-From):|&gt;?From )
          ([^&gt;]*[^(.%@a-z0-9])?
          (
              Post(ma?(st(e?r)?|n)|office)
              |(send)?Mail(er)?
              |daemon
              |m(mdf|ajordomo)
              |n?uucp
              |LIST(SERV|proc)
              |NETSERV
              |o(wner|ps)
              |r(e(quest|sponse)|oot)
              |b(ounce|bs\.smtp)
              |echo
              |mirror
              |s(erv(ices?|er)
              |mtp(error)?|ystem)
              |A(
                 dmin(istrator)?
                 |MMGR
                 |utoanswer
                )
          )
          (  ([^).!:a-z0-9][-_a-z0-9]*)?
             [%@&gt;         ][^&lt;)]*(\(.*\).*)?
          )?
          $
          ([^&gt;]|$)
        )
      )    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[era]</span> explains the last regexps as follows:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (([^).!:a-z0-9]   End of e-mail address token
        [-_a-z0-9]      Another alpha token
        )?              ... or maybe not;
       [%@&gt;\t ]         Address separator -- either &lt;EM&gt;<a href="mailto:address@..." >address@...</a>&lt;/EM&gt; or
                          &lt;address&gt; or a bare address with whitespace
                          around it
       [^&lt;)]*           Skip as long as we don't run into another
                          bracketed address or end of comment
                          (presumably to prevent this from matching
                          inside parenthesized comments in the first
                          place)
       (\(.*\).*)?      Skip optional parenthesized comments and
                          anything after them if found
      )?                ... or maybe not; maybe we just see an ...
      $                  ... end of line instead
      ([^&gt;]|$)           Uh, I should know what this is supposed to do,
                          but I can't quite remember what it's for. I
                          think it had something to do with continued
                          header lines ... Anyone?    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          Does ^FROM_MAILER match on the Return-Path: line?</em>



<p class="column8">
        <span class="word-ref">[david 1998-04-29]</span> Apparently not, but it does match on the UNIX
        From_ line, which usually contains the same address as the
        Return-Path: header.


<p class="column10"><em class="quote10">
          Does anyone have an idea how I can use this macro but tell it to
          ignore the Return-Path line in the header?</em>




<p class="column8">
        There's probably some way within procmail without the extra fork of
        formail, but this is easy to think of and easy to write:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0h
      HEAD_WITHOUT_FROM_=| formail -IReturn-Path: -I'From '

      :0
      * HEAD_WITHOUT_FROM_ ?? ^FROM_MAILER
      action    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you want to consider only the From: header, try this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0
      * ^\/From:.*
      * MATCH ?? ^FROM_MAILER
      action    </PRE></TD>
    </TR>
</TABLE>

<hr>
               <A name="technical_matters"  id="technical_matters"></A>
               <h1>
               19.0 Technical matters

               </h1>



  <a name="list_of_exit_codes" id="list_of_exit_codes"></a>
  <h2>
      19.1 List of exit codes

  </h2>




<p>
<p class="column8">
        The right place to look is /usr/include/sysexits.h, but the codes
        should be pretty much standard. These ones are from HP-UX 10 and
        the code that are mostly used are EX_NOUSER or EX_NOPERM. It tells
        to the sender of UBE to &quot;piss off and delete me from your list; I'm
        not here&quot;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      EX_OK          0        successful termination
      EX__BASE       64       base value for error messages

      EX_USAGE       64       command line usage error
      EX_DATAERR     65       data format error
      EX_NOINPUT     66       cannot open input
      EX_NOUSER      67       addressee unknown
      EX_NOHOST      68       host name unknown
      EX_UNAVAILABLE 69       service unavailable
      EX_SOFTWARE    70       internal software error
      EX_OSERR       71       system error (e.g., can't fork)
      EX_OSFILE      72       critical OS file missing
      EX_CANTCREAT   73       can't create (user) output file
      EX_IOERR       74       input/output error
      EX_TEMPFAIL    75       temp failure; user is invited to retry
      EX_PROTOCOL    76       remote error in protocol
      EX_NOPERM      77       permission denied    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          I thought that by using the EXITCODE, I would be assured that the
          mail would be <em class="word">rejected</em> but in fact Sendmail 8.8.7 attempts to
          deliver the &quot;user unknown&quot; to netcom.com, which is obviously
          wrong?</em>



<p class="column8">
        <span class="word-ref">[sean]</span> Sendmail accepts the message, then passes it on to
        Procmail, either as the local delivery agent, or via a .forward
        file (depending on your system's configuration). Procmail says &quot;gee,
        gotta lie about not being here&quot; and rejects the message, when is
        sent back into the spool, and delivered according to who it
        appeared to come from.


<p class="column8">
        Had SENDMAIL determined the user didn't exist (password file /
        aliases / virtusertable.txt), then it would have rejected the
        message right when the remote was doing SMTP RCPT. But the user WAS
        valid, and so it accepted it.


<p class="column8">
        Another scenario is when you have a mail secondary, and your
        primary (where the user account and procmail are) is down. Some
        system goes to deliver mail to you, and resolves to your secondary
        &ndash; which simply holds mail for your primary &ndash; it hasn't a clue
        which user is valid and which isn't. Well, the (E)HELO (the system
        sending your primary the message) takes place during the SMTP
        session, the message is coming from your secondary - not from the
        original sender. At THAT point, if the user didn't exist, I believe
        sendmail would be issuing an unknown user error to the secondary,
        which in turn should mail that message back to who it thinks is the
        sender (I can't check my Bat book from where I'm at - any sendmail
        pros are welcome to elaborate).


<p class="column10"><em class="quote10">
          is there any way at all to get around this (force the rejection
          at delivery time)? Better yet, is there some sort of check to
          make sure that the Received domain reasonably matches the From:
          domain?</em>



<p class="column8">
        You'd need to have a ruleset in your SMTP Daemon (generally
        Sendmail) to check domains (which WILL fail on many valid messages,
        BTW) and reject it WHILE the SMTP delivery session (actually, the
        negotiation) is in progress. By the time Procmail has the message,
        you've completely accepted the message, and any rejection you might
        hope to do is bouncing the mail - to the apparent sender.


<p class="column8">
        Such is the problem with forged mail.


<p class="column8">
        I wouldn't suggest this tactic for fighting spam anyway - so much
        of it is forged, and any bounce you send out simply uses up system
        resources on your machine and those on the system that was spoofed.
        Spammers don't REMOVE addresses from their lists (they want the
        lists to look as big as possible when they go to sell it to someone
        else) &ndash; some have even taken to GENERATING addresses at domains
        and sending messages to them with the assumption that somebody will
        probably have an account by that name (&quot;bill@ joe@ dave@ ...&quot;).


<p class="column8">
        Use procmail to trashbin (or otherwise file) all the junk and then
        manually take action on those which get through.



  <a name="list_of_precedence_codes" id="list_of_precedence_codes"></a>
  <h2>
      19.2 List of precedence codes

  </h2>




<p>
<p class="column8">
        The priorities most sendmails recognize are following. The lower
        the priority, the later the message gets dealt with. A smart
        vacation program will ignore anything with a list, bulk, or junk
        priority. --Adam Shostack &lt;adam A T bwh.harvard.edu&gt;

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      0   first-class
      30  list
      60  bulk
      100 junk
      100 special-delivery    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[dan]</span> You should use <samp class="word">bulk</samp> when you distribute files via File
        Server. The value in the Precedence: header says absolutely NOTHING
        about the contents of the message itself, it merely suggests a
        priority level to the mail system. From pp. 668 of the O'Reilly's
        <em class="word">sendmail</em> book, bulk typically has a value of -200 while <samp class="word">junk</samp>
        -100; thus a message with <samp class="word">junk</samp> will get <em class="word">higher</em> priority than
        that of <samp class="word">bulk</samp> (although this can be changed in the <samp class="word">sendmail.cf</samp>
        file).


<p class="column8">
        Other than on heavily loaded machines, this value won't matter
        anyway, since all mail will be quickly processed.


<p class="column8">
        <span class="word-ref">[Stephen]</span> ...Mail sent by a person is usually considered to be more
        important than autoreplies generated by some daemon. One way to
        express the lower priority of autoreplies is by adding a
        &quot;Precedence: junk&quot; field. This allows mail transport agents to
        make educated decisions about which mail to forward first (in case
        the mailqueue gets clogged).


<p class="column8">
        Another point is: other autoreply services, like <samp class="word">vacation</samp>. They
        try to make an effort not to accidentally reply to a message
        generated by another daemon (e.g. yours). One way they detect this
        is by looking at the Precedence field. If it contains <samp class="word">junk</samp>, they
        know, this is not something we should respond to.



  <a name="sendmail_and_t" id="sendmail_and_t"></a>
  <h2>
      19.3 Sendmail and -t

  </h2>




<p>
<p class="column10"><em class="quote10">
          sendmail -t tag reads To, Cc, Bcc, etc, for the recipient of
          the auto response?</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0h
      * condition
      * !^X-Loop: foo@site\.com
      | ($FORMAIL -rA &quot;X-Loop: foo@example.com&quot; ) | sendmail -oi -t    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[david]</span> That's not a problem, because formail -r will not generate
        any Cc: or Bcc: headers unless you tell formail to add them. The
        only line where sendmail -t will look for recipients will be the
        To: line.



  <a name="rfc822_replyto_and_formail_problem_with_multiple_recipients" id="rfc822_replyto_and_formail_problem_with_multiple_recipients"></a>
  <h2>
      19.4 RFC822 Reply-To and formail problem with multiple recipients

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[david]</span> formail -r extracts only one return address, even when the
        Resent-Reply-To: or Reply-To: header contains more than one (and
        Stephen has told me he plans to leave it that way).

<ul>
	<li>Looking for the best address to reply to is a completely different
            algorithm than looking for the best group of addresses to reply
            to. Finding a group of addresses involves actually determining
            that you even are searching for a group and not only for one
            address. Then finding out the best address for each. It's already
            a tricky business doing this just for one address.
<li>It makes thousands of autoreply recipes vulnerable to mail-storm
            attacks. Formail tries its best to control the damage even if
            operated by someone who doesn't know what he is doing. If it were
            to reply to multiple addresses at times, this damage control is
	            severely undermined.</li>
</ul>




<p class="column8">
        [dan]I understand these concerns; however RFC822 specifically
        allows for multiple recipients in a Reply-To: header. Given that, it
        seems that there should be a straight-forward way to deal with this in
        formail; even worse is that &quot;formail&quot; silently ignores multiple
        Reply-To: addresses.


<p class="column8">
        For (a), wouldn't the Reply-To: (or Resent-Reply-To:) header supersede
        all other addresses and thus greatly simplify the searching? For (b),
        how about only using multiple (Resent-)Reply-To: addresses if
        formail's &quot;-t&quot; option is also specified? Or if you are really worried
        about mail-storms and existing recipes, a new formail option.



  <a name="procmail_and_imap_server" id="procmail_and_imap_server"></a>
  <h2>
      19.5 Procmail and IMAP server

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[ed]</span> See also <a href="ftp://ftp.cac.washington.edu/mail/imap.vs.pop" >ftp://ftp.cac.washington.edu/mail/imap.vs.pop</A> ...This
        paper is an elaboration on a short note entitled &quot;Comparing Two
        Approaches to Remote Mailbox Access: IMAP vs. POP&quot;, which was written
        in 1993 and recently updated. The purpose of this paper is to provide
        more extensive background on message access paradigms and protocols,
        and then to specifically compare the Internet's Post Office Protocol
        (POP) and the Internet Message Access Protocol (IMAP) in the context
        of &quot;online&quot; operation.


<p class="column10"><em class="quote10">
          ...I log in to a set of NFS-ed servers (or more precisely AFS-ed),
          and my mail comes into another server (not a part of this set)
          which is running IMAP. So sendmail never delivers mail into
          /var/mail/$LOGNAME on my login machines, and instead delivers to
          the IMAP server. Since sendmail never reads my .forward file in
          the home directory, I figure procmail never gets invoked.</em>



<p class="column8">
        You need a program which will fetch your e-mail from the IMAP
        server and then feed it to procmail. One such program that can do
        this is fetchmail. Check out <a href="http://packages.debian.org/fetchmail" >http://packages.debian.org/fetchmail</A>
        The bad news is that once you do this, you probably won't be able
        to use an IMAP client to read your e-mail anymore. But that might
        be good news if you prefer an MUA that reads mbox files but doesn't
        grok IMAP.



  <a name="machine_which_processes_mail" id="machine_which_processes_mail"></a>
  <h2>
      19.6 Machine which processes mail

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...The just-installed procmail does not work and I am assuming
          that sendmail is trying to run procmail on another machine. Is
          there anyway I could find out the appropriate ARCHITECTURE for
          that machine</em>



<p class="column8">
        <span class="word-ref">[era]</span> The following should tell you the name of the machine which
        processes mail for the machine you're asking about. You can then
        try to log in to that machine if you have shell access there, which
        is something you need to have in order to compile Procmail on it.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      nslookup -q=mx machine      # alternatively use host(1) command    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you don't have nslookup (doh) or don't understand what it says,
        try adding this to your .forward

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &quot;|uname -a &gt;/full/path/to/home/.uname.out&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        i.e. this should be there in <span class="word-big">addition</span> to what else you do.
        Otherwise this will lose your mail thoroughly, since it reads the
        mail but doesn't save it anywhere. You might want to save a copy of
        all incoming mail to a safety mailbox, too, just in case. Like so:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      /full/path/to/home/safetymailbox
      |&quot;uname -a &gt;/full/path/to/home/.uname.out&quot;
      |&quot;IFS=' '&amp;&amp; exec /usr/local/bin/procmail -Yf- || exit 75&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you try this, it is very important that the file safetymailbox
        exists and is writable. (<samp class="word">man</samp> <samp class="word">5</samp> <samp class="word">forward</samp> if you have that &ndash; I
        don't seem to have this manual page on systems with newish versions
        of sendmail, is that correct?)


<p class="column8">
        Try the <samp class="word">uname</samp> command (and/or read the manual) to see what you
        should expect to find in the file .uname.out



  <a name="compiling_procmail_and_mailspoolhome" id="compiling_procmail_and_mailspoolhome"></a>
  <h2>
      19.7 Compiling procmail and MAILSPOOLHOME

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I am compiling 3.11pre7 on a new system and have a couple of
          questions. I edited the makefile to be the home directory
          &quot;/home/a/abc&quot; for example. I defined MAILSPOOLHOME as &quot;/mail&quot;.
          The incoming mail is actually stored in &quot;/usr/mail/abc&quot;.  When I
          pipe test messages through procmail (using
          &quot;procmail&lt;/usr/mail/abc&quot;), rather than them ending up in my
          inbox, they end up in a mailbox called &quot;msg.gs.KB&quot;.  What on
          earth did I goof up? As I sit here and think about this, should
          MAILSPOOLHASH be set to 1 instead of 0?</em>



<p class="column8">
        <span class="word-ref">[philip]</span> If incoming mail is supposed to be stored in
        /usr/mail/loginnamehere, then you should not define MAILSPOOLHOME
        at all, but rather define MAILSPOOLDIR to &quot;/usr/mail/&quot; and leave
        MAILSPOOLHASH as 0. Defining MAILSPOOLHOME causes mail to be
        delivered to insides each user's home directory, which does not
        appear to be what you want. MAILSPOOLHASH causes addition levels of
        hierarchy in the spool directory to be created, thus avoiding the
        'fat slow directory' problem.

<hr>
               <A name="procmail_software_for_emacs"  id="procmail_software_for_emacs"></A>
               <h1>
               20.0 Procmail software for Emacs

               </h1>



  <a name="what_is_emacs" id="what_is_emacs"></a>
  <h2>
      20.1 What is Emacs

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...first thing I learned on a Unix machine was that <samp class="word">vi</samp> is a text
          editor and <samp class="word">Emacs</samp> is a way of life.
          --David W. Tamkin &lt;dattier A T wwa.com&gt;</em>



<p class="column8">
        <strong class="word">Emacs</strong> refers to a programming platform (it's not only a text
        editor, or a programming editor, but it does almost everything you
        tell it to do except make your coffee) which can be found almost in
        any Unix platform. Nowadays Emacs is also available for the PC
        platform too. There are two flavors to choose from: Emacs,
        maintained by the FSF (Free Software Foundation), and XEmacs,
        sometimes called &quot;Emacs the next generation&quot;, because it has a
        better graphical user interface (gui) and internally advanced OO
        design (it can highlight on tty, whereas Emacs can't). XEmacs is
        being maintained by group of programming wizards. Emacs add-in
        packages are lisp and the lisp file extension is <em class="word">.el</em>. Inside each
        package one finds instructions how to use and how to install the
        package into Emacs.



  <a name="emacs_procmailmode_and_procmail_code_checking_lint" id="emacs_procmailmode_and_procmail_code_checking_lint"></a>
  <h2>
      20.2 Emacs procmail-mode and Procmail code checking (Lint)

  </h2>




<p>
<p class="column8">
        Procmail mode for Emacs (which can also lint procmail recipes) is
        available. People familiar with C-coding know lint, which is a
        rigorous code syntax checker. You can read about this Emacs mode
        from <a href="http://tiny-tools.sourceforge.net/" >http://tiny-tools.sourceforge.net/</A>



  <a name="why_use_procmail_with_gnus" id="why_use_procmail_with_gnus"></a>
  <h2>
      20.3 Why use procmail with Gnus

  </h2>




<p>
<p class="column8">
        Gnus &lt;<a href="http://www.gnus.org" >http://www.gnus.org</A>&gt; includes very powerful mail split
        methods and one normal reaction against the need of procmail is:
        &quot;Hey, Gnus does my mail splitting, I don't need procmail&quot;. The
        difference between Gnus and procmail splitting is quite easily
        explained: you want procmail to preprocess the mail before gnus
        ever sees it and then postprocess the mail with Gnus (read, move
        mail from the inbox to another)


<p class="column8">
        <strong class="word">Case1</strong>: Gnus and regular mailbox, no procmail. Gnus reads directly
        one huge mailbox where all incoming messages are. When the user
        starts Gnus, it slurps in the whole mailbox and starts splitting the
        mail according to the its split rules.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      mail -&gt; $MAIL --&gt; fire up Gnus  --&gt; split1.mbx split2.mbx ....    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <strong class="word">Case2</strong>: procmail and Gnus. The mail is always delivered to
        procmail first. Procmail is free to put the mail anywhere or just
        let it drop to the user's default inbox, usually pointed by
        environment variable $MAIL.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      mail -&gt; procmail                --&gt; Post processing with Gnus
              [the  ~/Mail/spool]
              --&gt; split1.mbx
              --&gt; split2.mbx
              [The default procmail rule drops to inbox]
              --&gt; $MAIL    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        You can let gnus to process the messages further: like moving
        messages from one inbox to another.


<p class="column8">
        Summary

<ul>
	<li>If you use procmail, the incoming messages are immediately
            categorized. The incoming mail is put in the folder of your
            choice. The mailboxes are there waiting for you all the time. You
            can use <samp class="word">less</samp> or <samp class="word">more</samp> to view them in a hurry.
<li>If you don't use procmail and let Gnus to do all the splitting,
            you always see one huge inbox, $MAIL. It will not be split
            until you fire up Emacs and Gnus. If you're in a hurry, you
            may not have time to start Emacs &amp; Gnus, before reading the
            important messages. Your only option is to read all  messages
	            in $MAIL and try to find the ones that consider e.g you work.</li>
</ul>




<p class="column8">
        So, let procmail drop messages to their inboxes and Gnus to
        possibly &quot;fine process&quot; these inboxes.



  <a name="setting_up_gnus_for_procmail_basics" id="setting_up_gnus_for_procmail_basics"></a>
  <h2>
      20.4 Setting up Gnus for procmail - Basics

  </h2>




<p>
<p class="column8">
        Procmail and Gnus communicate with each other very nicely when you
        use the mail backends like: <samp class="word">nnml</samp>, <samp class="word">nnmh</samp> and <samp class="word">nnfolder</samp>. See
        Emacs info Gnus::Node: <samp class="word">Select</samp> <samp class="word">Methods</samp> for more.


<p class="column8">
        Here are step by step instructions for reading the mail with <samp class="word">nnml</samp>
        mail backend. We suppose that you have the following definition in your
        procmailrc so that the incoming mail is delivered to the right<br>
        directory.


<p class="column10"><em class="quote10">
          The important point here is that the name of the gnus <samp class="word">nnml</samp> group
          is identical; except the <samp class="word">.spool</samp> suffix, to the spool file where
          procmail writes. So if you write to <samp class="word">list.procmail.spool</samp>, the
          group name in gnus is named <samp class="word">nnml:list.procmail</samp></em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      #  .procmailrc excerpt

      PMSRC       = $HOME/pm
      MAILDIR     = $HOME/Mail
      SPOOL       = $MAILDIR/spool
      RC_LIST     = $PMSRC/pm-jalist.rc

      #  The file name must be list.xxxxx.spool in order to
      #  `nnml' to work in Gnus.Define procmail mailing list

      PROCMAIL_SPOOL = $SPOOL/list.procmail.spool

      #  GNUS must have unique message headers, generate one
      #  if it isn't there. By Joe Hildebrand &lt;EM&gt;<a href="mailto:hildjj@fuentez.com" >hildjj@fuentez.com</a>&lt;/EM&gt;

      :0 fhw
      | $FORMAIL -a Message-Id: -a &quot;Subject: (None)&quot;

      #   detect mailing lists and store messages to spool directory

      INCLUDERC = $RC_LIST

      :0 :
      * ! LIST ?? ^^^^
      $SPOOL/list.$LIST.spool    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Copy the Lisp code below to your ~/.gnus
<li>Start Gnus with <samp class="word">M-x</samp> <samp class="word">gnus-no-server</samp> (M-x means ESC
            followed by x). You will see <em class="word">Group</em> buffer to appear.
	</li>
<li>Make the new group with <samp class="word">G</samp> <samp class="word">m</samp> <samp class="word">list.procmail</samp> RET <samp class="word">nnml</samp> RET.
            You can read the group as usual and query new mail with <samp class="word">g</samp>
	            command.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq
       gnus-secondary-select-methods '((nnml &quot;&quot;))
       ;; See also nnmail-procmail-suffix which is .spool by
       ;; default
       ;;
       nnmail-use-procmail        t
       nnmail-spool-file          'procmail
       nnmail-procmail-directory  &quot;~/Mail/spool/&quot;
       nnmail-delete-incoming     t)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And then I have procmail always deliver to ~/Mail/spool/. If you
        add more inboxes, create them inside gnus <em class="word">Group</em> buffer with
        <samp class="word">G</samp> <samp class="word">m</samp>.



  <a name="gnus_for_procmail_more_about_it" id="gnus_for_procmail_more_about_it"></a>
  <h2>
      20.5 Gnus for procmail - More about it

  </h2>




<p>
<p class="column8">
        Okay, let's continue our journey in Emacs. What you read previously
        was the minimum you needed to get your Gnus to read procmail
        delivered files. However, if you're new to Gnus, here are some more
        tips and basic instructions. The best advice I can give is that you
        go to each buffer: In group, you press <samp class="word">G</samp> <samp class="word">C-h</samp> and in Summary
        <samp class="word">C-h</samp> <samp class="word">m</samp> and print the commands to printer that you see listed.


<p class="column8">
        In Group buffer

<ul>
	<li>When you press <samp class="word">g</samp> to get new mail to these groups, the
            group <strong class="word">disappears</strong> if there is no mail. If you want the
	            group to be permanently visible, then set</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq gnus-permanently-visible-groups  &quot;^nnml\\|^nnfolder&quot;)

      In emergency, press `L' to list all groups.    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>If you made a mistake and wrote <samp class="word">list.procmaill</samp> with an
            extra <samp class="word">l</samp> accidentally in the group name, use <samp class="word">G</samp> <samp class="word">r</samp> to
	            rename group.</li>
</ul>



<ul>
	<li>Raise or lower the priority of your procmail mail groups
            with <samp class="word">S</samp> <samp class="word">l</samp>. Values 1 or 2 or 3 are good. Consider reserving
	            1 for your primary mail and 2 and 3 for mailing lists.</li>
</ul>



<ul>
	<li>When you exit a group and have read some articles, they won't show
            up next time you go there. But by giving prefix argument before
            entering the group with <samp class="word">SPC</samp>, Gnus will list all read articles.
            You give the command like <samp class="word">C-u</samp> <samp class="word">SPC</samp>, where <samp class="word">C-u</samp> is the
	            prefix argument.</li>
</ul>




<p class="column8">
        Settings


<p class="column8">
	<ul>
	<li>You want gnus to tell you everything it does</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq gnus-verbose 10)  ;; 0..10    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>You expire articles (get permanently rid of them) with the 'E'
            command in the <em class="word">Summary</em> buffer. The default expiry time is 7
	            days. You can define the expiry time in days with</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq nnmail-expiry-wait 7)    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>If you read mailing lists, you want automatic expiry when you
            have read the article. Use the following to set up groups that use
	            this automatic expiration.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq gnus-auto-expirable-newsgroups
          (concat
           &quot;procmail&quot;
           &quot;\\|other-list&quot;
           &quot;\\|and-some-other-list&quot;))    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
	<ul>
	<li><samp class="word">B</samp> <samp class="word">e</samp> in the <em class="word">Summary</em> buffer expires current expirable articles.</li>
</ul>



<ul>
	<li>If you want to kill an article; permanently remove it from disk,
	            use <samp class="word">B</samp> <samp class="word">delete</samp>.</li>
</ul>



<ul>
	<li>If you want to mark an article as <em class="word">persistent</em> (never expires),
	            use <samp class="word">*</samp></li>
</ul>



<ul>
	<li>You don't want these mail groups cached because mail is
            already in &quot;cache&quot; format. The cache is needed only when you
	            read newsgroups and want to store messages locally.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq gnus-uncacheable-groups &quot;^nn\\(virtual\\|m[hlk]\\|db\\)&quot;)    </PRE></TD>
    </TR>
</TABLE>



  <a name="emacs_and_gnus_fiddling_with_spool_files" id="emacs_and_gnus_fiddling_with_spool_files"></a>
  <h2>
      20.6 Emacs and Gnus &ndash; Fiddling with spool files

  </h2>




<p>
<p class="column8">
        Well, to tell you the truth, managing Gnus is scary at first: You
        can make a lot of mistakes along the way or otherwise change your mind
        about group names and so on. It's a tricky task to move mail from one
        directory to another if you decide to rename the spool file name
        where procmail is putting the filtered mail.


<p class="column8">
        Let's take an example: Say you decide to change the spool file name
        list.procmail.spool to mail.procmail.spool, because you come to
        think that all your mail groups should have the same prefix &quot;mail.&quot;
        in your Gnus group buffer. You already changed procmail to
        output to that file, so now you have two files sitting in your
        spool directory.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ~/Mail/spool/list.procmail.spool
      ~/Mail/spool/mail.procmail.spool    # make sure this exists    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Let Gnus read the old file as usual. Press <samp class="word">g</samp> read new mail to
            <samp class="word">list.procmail</samp>. list.procmail.spool will now be empty and
            merged to <samp class="word">nnml</samp> backend file nnml:list.procmail.
<li>Make a new group with <samp class="word">G</samp> <samp class="word">m</samp> nnmail <samp class="word">mail.procmail</samp> in <em class="word">Group</em>
            buffer.
	</li>
<li>Go to the old <samp class="word">list.procmail</samp> group and select all articles with <samp class="word">M</samp>
            <samp class="word">P</samp> <samp class="word">a</samp>. Move the messages with <samp class="word">B</samp> <samp class="word">m</samp> to <samp class="word">mail.procmail</samp>.
            You will see <samp class="word">G</samp> marks appear to the beginning of moved articles.
	</li>
<li>Exit the <em class="word">Summary</em> buffer and hit <samp class="word">g</samp> to see that the
            messages hat were transferred to your new <samp class="word">mail.procmail</samp>
	</li>
<li>Kill the old group <samp class="word">list.procmail</samp> with <samp class="word">G</samp> <samp class="word">DEL</samp>
	</li>
<li>One more thing, remove that empty spool file. It is no longer used
	            for anything.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      % rm ~/Mail/spool/list.procmail.spool    </PRE></TD>
    </TR>
</TABLE>



  <a name="gnus_article_snippets" id="gnus_article_snippets"></a>
  <h2>
      20.7 Gnus article snippets

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[These articles have been collected from the GNUS hypertext archive]</span>

<hr class="special">
	 <strong><em>  </em></strong><br>



<p class="column10"><em class="quote10">
          I'm also a bit confused with the proposed solution of having
          procmail filter incoming mail in a <samp class="word">nnmail-procmail-directory</samp>
          instead.</em>



<p class="column8">
        You have Procmail stuff mail in spool files, pre-sorted and
        filtered. Gnus then picks these up and stuff the messages in the
        appropriate groups. Gnus uses movemail to actually move the mail
        out of the spool, and movemail uses locking that Procmail
        understands, so there is no danger of mail loss.


<p class="column10"><em class="quote10">
          Why are <samp class="word">nnfolder-directory</samp> and <samp class="word">nnmail-procmail-directory</samp> two
          different directories if <samp class="word">nnmail-procmail-directory</samp> will contain
          the mail boxes that procmail appends to and <samp class="word">nnfolder-directory</samp> is
          supposed to be &quot;All the nnfolder mail boxes will be stored under
          this directory&quot;?</em>



<p class="column8">
        Because Procmail should stuff its mail in different folders, <strong class="word">not</strong>
        in the ones that your regular mail is stored in.


<p class="column10"><em class="quote10">
          Is the idea to have Gnus use <samp class="word">nnmail-procmail-directory</samp> as a
          temporary directory that it draws from to process and then
          deposit nnfolder mailboxes in the <samp class="word">nnfolder-directory</samp> ?</em>



<p class="column8">
        Yep &ndash; Jason L Tibbitts III &lt;tibbs A T hpc.uh.edu&gt;


<p class="column4">

<hr class="special">
	 <strong><em>  Procmail settings </em></strong><br>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq nnmail-use-procmail t)
      (setq nnfolder-directory &quot;~/gMail/&quot;)
      (setq nnmail-spool-file 'procmail)
      (setq nnmail-procmail-directory &quot;~/incoming/lists/&quot;)
      (setq gnus-secondary-select-methods '((nnfolder &quot;&quot;)))
      (setq nnmail-procmail-suffix &quot;&quot;)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Procmail is adding incoming mail to ~/incoming/lists/listname. The
        nnfolder groups I subscribed to are named &quot;nnfolder:lists.listname&quot;
        Gnus does create the ~/gMail/lists directory with a zero length file
        in this directory for each list, but doesn't move any mail over and
        so it thinks I have &quot;No more unread newsgroups&quot;.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (nnmail-get-spool-files)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        After much experimentation, I finally got movemail to work. I
        changed <samp class="word">nnfolder-directory</samp> to &quot;~/gMail/lists/&quot; and Gnus now moves
        mail from &quot;~/incoming/lists/&quot; to corresponding groups in
        &quot;~/gMail/&quot;. My problem seems to be solved, but still these workings
        seem counter-intuitive to me. By what the manual has to say about
        <samp class="word">nnfolder-directory</samp> I would think Gnus should build the nnfolder
        groups in &quot;~/gMail/lists/&quot; instead given my definitions.



<p class="column8">
        I think nnmail expects the spool files to be called
        &quot;~/incoming/lists.whatever&quot;, not &quot;~/incoming/lists/whatever&quot;.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      (setq nnmail-procmail-directory &quot;~/incoming/lists/&quot;)    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        I thought you said the groups were called &quot;lists.whatever&quot;? So the
        spool files were called ~/incoming/lists/lists.whatever.spool,
        then?

<hr>
               <A name="rfc_request_for_comments"  id="rfc_request_for_comments"></A>
               <h1>
               21.0 RFC, Request for comments

               </h1>



  <a name="rfcs_and_their_jurisdiction_munged_addresses" id="rfcs_and_their_jurisdiction_munged_addresses"></a>
  <h2>
      21.1 RFCs and their jurisdiction (munged Addresses)

  </h2>




<p>
<p class="column8">
        Groups: gnu.emacs.gnus
        Search: RFC


<p class="column10"><em class="quote10">
          The real implementation of news software doesn't care if the from
          field is munged or not</em>



<p class="column8">
        <span class="word-ref">[1998-03-25 gnus.emacs.gnus, Marty Fouts &lt;fouts A T null.net&gt;]</span>
        The point of the argument is: The RFCs don't demand what those
        who would quote them to suppress munging claim they do. In
        particular, RFC 1036 is advisory, an <strong class="word">attempt</strong> to describe how
        netnews works with NNTP. In the case of header munging, RFC
        1036 does <strong class="word">not</strong> describe the way the software works in the
        field. There is no reason to cite an advisory RFC that in many
        ways is incorrect to support an untenable position.


<p class="column10"><em class="quote10">
          <strong class="word">Note:</strong> Marty is an IETF USEFOR and has a good understanding how
          the RFCs should be interpreted. See gnu.emacs.gnus 1999-02-08
          and theread / Re: &quot;Sender&quot; field/.</em>



<p class="column8">
        <span class="word-ref">[1997-11-05 gnus.emacs.gnus, Marty Fouts]</span> No RFC forces the address
        of the poster to be a <em class="word">reachable</em> address (indeed, Sender: is
        sometimes user@host without the domain part) &ndash; it only requires
        such addresses to be syntactically correct. The RFCs do <strong class="word">not</strong>
        require anything. The RFCs related to Usenet are <em class="word">advisory</em>. RFCs
        describe various things and define a small number of standard
        protocols, netnews is <strong class="word">not</strong> an internet standard protocol.)

<ul>
	<li>Not all RFCs are standards
<li>RFC 1036 <strong class="word">specifically</strong> states that it is not an internet
            standard.
	</li>
<li>The wording of RFC 1036 and 822 WRT to the RFC 1036 header is
            ambiguous. RFC 822 <strong class="word">specifically</strong> describes the format of a
            mail message. It does not describe the complete format of an
            electronic mail address.
	</li>
<li>Nowhere in 1036 is there language requiring that the address be
            deliverable to. Further, 822 provides language that would allow
            for a valid but not deliverable address to be acceptable. [822
            doesn't describe addresses, it describes <strong class="word">mailboxes</strong>, which are
	            something similar but not identical.]</li>
</ul>




<p class="column8">
        The bottom line WRT RFCs that are informational is that when there
        is an ambiguity, or a difference between the RFC and the
        implementation, the implementation (which is what the RFC was
        trying to describe in the first place) has precedent.


<p class="column8">
        As much as y'all want it to be otherwise, the <strong class="word">implementation</strong> of
        netnews, (I. E. INND, NNTP) doesn't care about whether or not an
        address can be replied to. It is rumoured that some news posting
        software checks the validity of an address. Such software is in a
        <strong class="word">tiny</strong> minority.


<p class="column10"><em class="quote10">
          [counter argument 1998-03-25 gnu.emacs.gnus, Jan
          Vroonhof &lt;vroonhof A T frege.math.ethz.ch&gt;] Now although INND and
          friends are important parts of the Usenet software bundle the
          news READERS are even more important. Now I'll bet 99% readers,
          like f.i. Gnus, assume the address in the header is the address to
          be replyed to when the user requests to go into a private
          discussion with the author (i.e. reply instead of followup).</em>



<p class="column8">
        <span class="word-ref">[marty]</span> netnews is a <em class="word">public</em> forum. mail is a <em class="word">private</em>
        communication medium. Posting in a <strong class="word">public</strong> forum does <strong class="word">not</strong>
        require that I give you access to my private address, just as
        speaking at a public meeting does not require that I give you my
        unlisted phone number.


<p class="column8">
        One thing is for certain: putting the burden on anyone wishing to
        send an mail to you, by requiring them to decipher the address.
        Someone may never &quot;reply by mail&quot; to persons using those phony
        addresses. Anyone who wishes to send a personal mail cannot just hit
        'reply'. People who do this accept this, which is they will watch
        the newsgroups for followups regularly. If someone eagerly wants
        to get personal, he can spend the extra minute to decipher
        the correct address for the person. --Marty


<p class="column10"><em class="quote10">
          <span class="word-ref">[counter argument, vroonhof]</span> However if you don't want to give me
          your phone number, why give me a false one? If people with this
          desire at least put only their name and had no &quot;&lt;adress&gt;&quot; part
          then one could have the news reader say &quot;Reply impossible, no
          address given&quot;.</em>



<p class="column10"><em class="quote10">
          <span class="word-ref">[Counter argument, unknown]</span> When I was using Pegasus Mail (Win95),
          it took me about 10 minutes to set up filters that removed over
          75% of the spam I received. 10 minutes is too great a burden to
          you? MY, what a busy person you are.</em>



<p class="column8">
        <span class="word-ref">[timothy]</span> What about the accounts from which I do not control
        (network at work) where I do not have say over what software is
        installed? I can say to the sysadmin ``Hey I'd like Pegasus mail
        installed'' and he nods and mumbles something. He's got 2 years
        worth of backlog from there not being a real sysadmin around


<p class="column10"><em class="quote10">
          <span class="word-ref">[Counter argument, unknown]</span> Furthermore, there are a number of
          procmail recipes available on the net, that can be used with
          minor adjustments to filter your mail. No heavy-duty Unix skills
          are required. Just the initiative to take responsibility for your
          own problems.</em>



<p class="column8">
        I know procmail very well, and spammers are still getting through.
        You know why? They refuse to follow all the conventions we depend
        on. And they spam mailing lists, so I have to filter for that as
        well. I have spent untold hours trying to develop better and better
        filters with lower numbers of mis-hits. Nothing works as well as
        not giving more spammers my address.


<p class="column10"><em class="quote10">
          ...You simply prefer to put the problem off on somebody else, rather
          than take the time to deal with it yourself. Well, that kind of
          laziness does seem to predominate in the &quot;world of the Internet&quot;
          these days.</em>



<p class="column8">
        I have spent the time, learning from what others have done and
        seeking to improve them. You are certain you are right and refuse
        to think about it anymore.... and that kind of laziness is all over
        the Internet.


<p class="column8">
        The only one it wrongly inconveniences are those who need to mail
        me and have lost my mail address. If you want to followup a Usenet
        post, do it in Usenet. I'll be back here for followups. I get
        enough mail, and don't need mail for Usenet threads.


<p class="column8">
        If you would like me to use a real address, please set me up an
        account with procmail where I can get all my Usenet related
        messages sent. --Timothy



  <a name="comments_about_addresses_munging" id="comments_about_addresses_munging"></a>
  <h2>
      21.2 Comments about addresses munging

  </h2>




<p>
<p class="column7"><em><strong>
       <span class="word-ref">[1998-03-24 gnu.emacs.gnus &lt;drwho A T No-Spam-see-sig.xnet.com&gt;]</span></strong></em>



<p class="column8">
        ...I am well aware that it is bad behavior, as I am well aware
        that it breaks standards. However, I'm <em class="word">also</em> well aware of the
        fact that I do not need to have a mail-box filled with spam every
        time I look at it. Things have quieted down considerably since I
        started altering my From: line. There's still the occasional that
        gets me, though. It's not really such a big deal right now, but
        after following the net-abuse newsgroups for a while, it has become
        apparent to me that spammers are trying new tactics to grab mail
        addresses (msg id's, sender: lines, etc...).


<p class="column8">
        Since I have to download most of my mail from a POP3 account, it
        takes time that I don't have to wait for all that spam to download.
        If breaking my headers means getting a few moments peace and
        freedom from spam, then so be it.


<p class="column7"><em><strong>
       <span class="word-ref">[M. Maxwell &lt;drwho A T No-Spam-see.sig&gt; 1998-03-26 gnus.emacs.gnus]</span></strong></em>



<p class="column8">
        ...Believe me, I <em class="word">don't</em> like having to do this <header munging>
        at all. But it saves me <em class="word">considerable</em> aggravation. I also don't
        have to download my mail from a POP3 server (my ISP has a shell
        account), but I prefer to read mail offline simply because I get so
        much of it with all those mail lists,


<p class="column8">
        And since that's the case, I end up downloading plenty of junk
        along with the legit mail, after which, my local procmail puts it
        where it belongs. In other words, not in my inbox. And so I'll do
        what I have to to foil the spammers (until we get some sort of
        legislation passed on junk mail). And those that <em class="word">do</em> get past the
        fouled headers are dealt with accordingly.



  <a name="rfc_and_valid_mail_address_characters" id="rfc_and_valid_mail_address_characters"></a>
  <h2>
      21.3 RFC and valid mail address characters

  </h2>




<p>
<p class="column10"><em class="quote10">
          What characters are legal in e-mail addresses? So far, I have
          uppercase, lowercase, digits, _ - + . @</em>



<p class="column8">
        <span class="word-ref">[elijah]</span> Most any 7bit character. For all practical purposes
        whitespace (space, tab, newline) are really inadvisable. This post
        is from a valid address. I also have ones with control characters &ndash;
        eg &lt;@qz.to&gt; (may not show up right in your newsreader). See RFC822
        for the full rules on generating an address, but the quick and dirty
        thing is any of the &quot;specials&quot; must be quoted to be used.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      See definition of `specials' in RFC
      specials    =  ()&lt;&gt;,;:\.[] and a double quote    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        If you don't believe me, there are mail toys to prove this. Best one
        I know of right now is Tom Phoenix's &quot;fred&amp;barney&quot;@example.com
        address. You can replace the &quot;&amp;&quot; with just about any string I
        believe. I've tried it with stuff like &quot;fred($)barney&quot;@example.com
        and it seems pretty stable.



  <a name="rfc_and_loginname" id="rfc_and_loginname"></a>
  <h2>
      21.4 RFC and login-name@fdqn

  </h2>




<p>
<p class="column8">
        [1998-06-08 Message-ID: <EM><a href="mailto:wkd8cjekay.fsf@mjf.vip.best.com" >wkd8cjekay.fsf@mjf.vip.best.com</A></EM>
        Marty Fouts &lt;Usenet-user A T usa.net&gt; in gnu.emacs.help. Refer also
        to summary of the whole thread in 1998-06-11 Message-ID:
        <EM><a href="mailto:wk4sxs62ll.fsf@mjf.vip.best.com" >wk4sxs62ll.fsf@mjf.vip.best.com</A></EM> by Marty Fouts.]

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt;&gt;&gt;&gt;&gt; In article &lt;EM&gt;<a href="mailto:x7g1hfu2sf.fsf@gkar.prescienttech.com" >x7g1hfu2sf.fsf@gkar.prescienttech.com</a>&lt;/EM&gt;,
      &gt;&gt;&gt;&gt;&gt; Rich Pieri &lt;EM&gt;<a href="mailto:rich.pieri@prescienttech.com" >rich.pieri@prescienttech.com</a>&lt;/EM&gt; enscribed:

      &gt; -----BEGIN PGP SIGNED MESSAGE-----

      &gt; Marty Fouts writes:

      &gt;&gt; Sort of: system-name is not a hook into gethostbyname. The
      &gt;&gt; /variable/ system-name is set by a builtin defvar to
      &gt;&gt; gethostbyname. system-name returns the value of the /variable/
      &gt;&gt; system-name, and the emacs lisp manual advises setting it if it
      &gt;&gt; is not correct.

      &gt; It still uses gethostbyname() to set the initial value.
      &gt; gethostbyname() is supposed to return an fqdn on a networked
      &gt; host.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        So? That the initial value is an FQDN is no indication that the
        value returned at any time thereafter will be. This is why emacs
        doesn't use system-name to create mail addresses, but has a
        separate function. If emacs itself doesn't rely on system-name to
        generate any mail addresses, why should gnus?

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt;&gt;&gt; user@fqdn is the agent responsible for submission of a
      &gt;&gt;&gt; message to the network. user@fqdn is the RFC sender of the
      &gt;&gt;&gt; message. user@fqdn therefore must be made to be a valid
      &gt;&gt;&gt; mailbox.

      &gt;&gt; This is just flat out wrong. There is no such requirement in
      &gt;&gt; any RFC or implied by any combination of RFCs.

      &gt; Premise: Gnus is used interactively. Premise: &quot;user&quot;
      &gt; (user-login-name) is the login name of the person using Gnus.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And that's where you fail first. There is no requirement anywhere
        in any RFC or combination of RFCs that a login name even exist.
        Although your premise is true, it is irrelevant to your conclusion,
        as explained below.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &gt; Premise: &quot;fqdn&quot; (system-name, self-referential gethostbyname) is
      &gt; the canonical network host name of the machine &quot;user&quot; is using at
      &gt; the time.    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        And that's where you fail second. There is no requirement anywhere
        in any RFC or combination of RFCs that the machine &quot;user&quot; is using
        be exposed as a part of a mailbox. I am /allowed/ to do that, and
        if I do that I am required to support that mailbox as valid. I am
        <em class="word">not</em> /required/ to do that.


<p class="column8">
        I've already cited, and will repeat, that a TIP is a good example
        of such a machine. So is a POP3 client. You are missing some more
        premises, most notably that user@fqdn is the <strong class="word">sender</strong> of the
        message in the sense of any RFC or combination of RFCs.


<p class="column8">
        Most importantly, you are missing some steps in your logic.

<ul>
	<li>You have not established that the /sender/ field's mailbox has
            to be the one you would construct from
            user-login-name@system-name, even on a system where such a
            combination formed a valid mailbox.
<li>You have not established that user-login-name@system-name be
            required to form a valid mailbox, even if the system has the
            concept of a login-name and both user-login-name and
	            system-name return what you expect them to.</li>
</ul>




<p class="column8">
        Nor will you be able to, because there are no such requirements.

<ul>
	<li>There is /no/ requirement /anywhere/ in any combination of RFCs
            that it be possible to construct a mailbox from the combination
            of a &quot;login-name&quot; of any sort and an FQDN.
<li>There is /no/ requirement /anywhere/ in any combination of RFCs
            that a &quot;login-name&quot; even exist.
	</li>
<li>There is /no/ definition /anywhere/ in any combination of RFCs
	            for the concept of a &quot;login-name&quot;.</li>
</ul>




<p class="column8">
        To put this as simply as possible:


<p class="column10"><em class="quote10">
          You are incorrect to assert that there is any requirement that a
          system support the mapping from (login-name,FQDN) to a mailbox of
          the form login-name@FQDN.</em>



<p class="column8">
        Once you understand that this assertion is incorrect, it should be
        easy to see that all assertions derived from it are incorrect.



  <a name="rfcs_and_messages_signature" id="rfcs_and_messages_signature"></a>
  <h2>
      21.5 RFCs and messages signature

  </h2>




<p>
<p class="column8">
        <a href="http://www.chemie.fu-berlin.de/outerspace/netnews/son-of-1036.html" >http://www.chemie.fu-berlin.de/outerspace/netnews/son-of-1036.html</A>


<p class="column8">
        According to universal defacto Net convention, there must
        be &quot;\n-- \n&quot; before signature. The extra space in signature
        delimiter tells that it is user's messages and not the Message
        Digest that uses delimiter &quot;\n--\n&quot;. There is no RFC that would
        address this though.


<p class="column8">
        And by the way: it's rude to have a longer sig than 1-3 lines.
        Better yet, move the repetitive information to the X-headers
        if your MUA supports modifying the headers.


<p class="column8">
        <strong class="word">NOTE</strong>: The choice of delimiter is somewhat unfortunate, since it
        relies on preservation of trailing white space, but it is too
        well-established to change.


<p class="column8">
        <span class="word-ref">[Paul O. Bartlett &lt;pobart A T access.digex.net&gt;]</span> Eg. When one is writing
        text, the preferred Un*x editor routinely truncates trailing blanks
        when writing a file, so that even if there were &quot;-- &quot; in the
        signature, Pine includes it automatically as part of the editable<br>
        text, and the editor would simply truncate the blank. The signature
        delimiter may be &quot;too well-established to change,&quot; but it collides
        with the reality of the tools people use.



  <a name="rfc_and_using_mime_in_usenet_newsgroups" id="rfc_and_using_mime_in_usenet_newsgroups"></a>
  <h2>
      21.6 RFC and using MIME in Usenet newsgroups

  </h2>




<p>
<p class="column9"><strong>
         [1999-02-12 Marty Fouts &lt;gnus A T fogey.com&gt; in gnu.emacs.gnus
         Message-id: <EM><a href="mailto:wklni3b3gl.fsf@Usenet.nospam.fogey.com" >wklni3b3gl.fsf@Usenet.nospam.fogey.com</A></EM>]</strong>



<p class="column8">
        The use of MIME is debatable. The use of MIME in a USENET posting
        is inexcusable, except for the case covered in draft by:


<p class="column10"><em class="quote10">
          Insofar as there exist authorities empowered (by common consent
          or otherwise) to define what is and is not proper in various
          hierarchies or newsgroups or cooperating subnets, those
          authorities ought to establish, by means of rules, guidelines,
          charters or whatever else, the practices considered acceptable
          within their domains. In particular they ought to establish which
          of the more exotic content types are likely to be inappropriate.
          In the absence of such specific guidance, the following default
          recommendations are offered as an indication of best practice at
          the present time.</em>



<p class="column8">
        Note that the comment &quot;is inexcusable&quot; is my opinion. The draft,
        contrary to your apparent understanding, merely gives -guidelines-
        for how to use mime headers.


<p class="column8">
        If you, or anyone else, feels that the draft replacement for RFC
        1036 needs to be worded differently, you are welcome to join the
        task force and attempt to persuade the members of this. However, a
        warning is in order: the process has been ongoing for several
        years, deadlines approach, and this particular issue has been
        argued in a great deal of detail.



  <a name="some_rfc_pointers" id="some_rfc_pointers"></a>
  <h2>
      21.7 Some RFC Pointers

  </h2>




<p>
<p class="column8">
        <a href="http://www.ietf.org/rfc.html" >http://www.ietf.org/rfc.html</A>

<ul>
	<li>rfc821 SMTP protocol, see also rfc959 FTP protocol standard
<li>rfc822  Format of internet messages (formerly called as Arpanet)
            A new draft that is likely to replace 822 is at:
            <a href="http://tools.ietf.org/html/draft-ietf-drums-msg-fmt-04" >http://tools.ietf.org/html/draft-ietf-drums-msg-fmt-04</A>
	</li>
<li>rfc1036 (the mail message format standard: From, to, date ...)
            Check also <samp class="word">son-of-1036.html</samp> mentioned earlier.
	</li>
<li>rfc1153 Digest message format, 1990, Status: EXPERIMENTAL)
	</li>
<li>rfc1738 URL specification, mailto, http, &lt;URL:address&gt; consult
            rfc2396 which supersedes rfc1738. the &lt;URL:...&gt; wrapping has been
            de-recommended by popular demand. &quot;define a single, generic
            syntax for all URI&quot;. See also rfc2369 &quot;The Use of URLs as
            Meta-Syntax for Core Mail List Commands&quot;
	</li>
<li>rfc1855 Netiquette Guidelines 1995
	</li>
<li>rfc1991 PGP Message Exchange Formats
	</li>
<li>rfc2076 Common Internet Message Headers
	</li>
<li>rfc2045,6,7  MIME
	</li>
<li>rfc2111 Content-ID and Message-ID Uniform Resource Locators
                    Also rfc1341
	<li>rfc2142 Mailbox names for common services, roles and functions</li>
</ul>



<hr>
               <A name="introduction_to_email_headers"  id="introduction_to_email_headers"></A>
               <h1>
               22.0 Introduction to E-mail Headers

               </h1>



  <a name="to_find_out_more_about_mail" id="to_find_out_more_about_mail"></a>
  <h2>
      22.1 To find out more about mail

  </h2>




<p>
<p class="column8">
<span class="quote7">All about Email headers</span><BR>
        <a href="http://www.stopspam.org/email/headers/headers.html" >http://www.stopspam.org/email/headers/headers.html</A>
        ...This document is intended to provide a comprehensive introduction
        to the behavior of mail headers. It is primarily intended to help
        victims of unsolicited mail (&quot;mail spam&quot;) attempting to determine
        the real source of the (generally forged) mail that plagues them;
        it should also help in attempts to understand any other forged
        mail. It may also be beneficial to readers interested in a
        general-purpose introduction to mail transfer on the Internet.


<p class="column8">
        <span class="word-ref">[See also RFC pointers in the RFC section]</span>


<p class="column8">
<span class="quote7">IMC &ndash; Internet Mail Standards</span><BR>
        <a href="http://www.imc.org/mail-standards.html" >http://www.imc.org/mail-standards.html</A>


<p class="column8">
<span class="quote7">FAQ archive</span><BR>
        <a href="http://www.faqs.org/faqs/" >http://www.faqs.org/faqs/</A>


<p class="column8">
<span class="quote7">UNIX EMail Software</span><BR>
        <a href="http://www.faqs.org/faqs/mail/setup/unix/part1/index.html" >http://www.faqs.org/faqs/mail/setup/unix/part1/index.html</A>
        ...This document is intended for system administrators who need to
        know how to set up their UNIX systems for mail communication with
        the outside world...UUCP, Addresses, Domain Addresses, FQDN, NIC,
        MX record, Bang-Paths, Gateways, Routers, Smarthost, MIME,
        X.400, &quot;The maps&quot;, Aliases


<p class="column8">
<span class="quote7">Plus addressing</span><BR>
        <a href="http://www.faqs.org/faqs/mail/addressing/" >http://www.faqs.org/faqs/mail/addressing/</A>


<p class="column8">
<span class="quote7">The Unix MBOX, Berkeley, format</span><BR>
        <a href="http://www.qmail.org/qmail-manual-html/man5/mbox.html" >http://www.qmail.org/qmail-manual-html/man5/mbox.html</A> ...This
        format comes to us from the ancient UNIX mail program, V7
        /bin/mail...Each message ends with two blank lines


<p class="column8">
        <span class="word-ref">[1998-09-06 PM-L Dallman Ross &lt;dman A T netcom.com&gt;]</span> I would have
        thought the connection to Berkeley was /usr/ucb/mail (a.k.a.
        &quot;Mail,&quot; with a capital &quot;M&quot;); not /usr/bin/mail (a.k.a.
        &quot;/bin/mail&quot;). (&quot;UCB&quot; stands for &quot;University of California,
        Berkeley.&quot;) The two are close, though different enough that I get
        messed up if I try to use /bin/mail for much. But &quot;ancient UNIX
        mail program&quot;? I use and prefer /usr/ucb/mail whenever I'm in a
        UNIX shell. Many others do, too. &lt;Yeesh.&gt; (I don't like pine. It
        feels too GUI.)


<p class="column8">
        Okay, sorry for the digression, but you all <em class="word">were</em> talking about
        the RFCs and From_ lines. If it's called &quot;Berkeley Mail Format,&quot;
        then I'd infer it comes from Berkeley Mail.



<p class="column8">
<span class="quote7">Literature</span><BR>
        Dr. Bob's Painless Guide to the Internet : &amp; Amazing Things You
        Can Do With E-Mail
        by Bob Rankin
        No Starch Press
        ISBN: 1886411093
        List Price: $12.95


<p class="column8">
        Netiquette
        by Virginia Shea
        Paperback 1 Ed edition (May 1994)
        Albion Books
        ISBN: 0963702513
        Amazon.com Price: $19.95


<p class="column8">
        The Elements of E-Mail Style : Communicate Effectively
      Via Electronic Mail
        by David Angell, Brent D. Heslop
        Addison-Wesley Pub Co (C)
        ISBN: 0201627094
        Paperback - 157 pages (April 1994)
        List Price: $12.95


<p class="column8">
        All About Internet Mail (Internet Workshop Series, No. 7)
        by Lee David Jaffe
        Library Solutions Inst &amp; Pr
        ISBN: 188220820X
        Amazon.com Price: $34.00


<p class="column8">
        3 Rs of E-Mail : Risks, Rights and Responsibilities
        by Diane B. Hartman, Karen S. Nantz
        Crisp Publications Inc.
        ISBN: 1560523786
        Paperback - 153 pages (June 1996)
        List Price: $12.95


<p class="column8">
        E-mail Companion; Communicating Effectively Via the
      Internet and Other Global Networks
        by John S. Quarterman, Smoot Carl-Mitchell
        Addison Wesley Pub Co
        ISBN: 0201406586
        Paperback - 318 pages (November 1994)
        List Price: $19.95


<p class="column8">
        The Internet Message : Closing the Book With Electronic Mail
          (out of print)
        by Marshall T. Rose
        Prentice Hall (Sd)
        ISBN: 0130929417


<p class="column8">
        Managing Mailing Lists: Majordomo, LISTSERV, Listproc,
      and SmartList
        By Alan Schwartz
        O'Reilly &amp; Assoc.
        1st Edition March 1998
        ISBN: 1-56592-259-X
        298 pages, $29.95
        <a href="http://www.oreilly.com/catalog/mailing/" >http://www.oreilly.com/catalog/mailing/</A>


<p class="column8">
        sendmail, 2nd Edition
        By Bryan Costales &amp; Eric Allman
        O'Reilly &amp; Assoc.
        2nd Edition January 1997
        ISBN: 1-56592-222-0
        1050 pages, $39.95
        &lt;<a href="http://www.oreilly.com/" >http://www.oreilly.com/</A>&gt;



  <a name="lecture_by_alan_stebbens" id="lecture_by_alan_stebbens"></a>
  <h2>
      22.2 Lecture by Alan Stebbens

  </h2>




<p>
<p class="column8">
        Procmail mailing list 1996-08.


<p class="column8">
        There are two general classes of headers: those generated
        automatically by the MTA, and those configured and inserted by the
        MUA, on the user's behalf.


<p class="column8">
        The former, the ones generated by the MTAs, are used mostly for
        tracking the e-mail, and generally have nothing to do with the
        content of the mail, much like those bar-code labels FedEx uses to
        track packages.


<p class="column8">
        The latter, the ones inserted by the MUA or by the user, are just
        like the shipping label the FedEx customer fills out, ie: they
        determine the source, the destination, and describe the content of
        the mail.


<p class="column8">
        It would be overburdensome for the user to generate all of these MUA
        headers themselves, so the user's mailer generates many or most of
        them automatically, typically under configuration control. Of course,
        the user can always override or replace the automatic MUA headers.


<p class="column8">
        The MTA headers, on the other hand, are almost completely automatic
        and the user almost never can change them. Only under special
        circumstances should the MTA headers be inserted or modified by the
        user.


<p class="column8">
        &gt;From the user's perspective, however, the e-mail process seems
        atomic, so that the distinction of these header classes is lost.
        Even some systems managers or postmasters fail to appreciate that it
        is during different stages of the e-mail process, that different
        sets of headers get inserted.


<p class="column8">
        To help clarify this distinction, here's a diagram of the e-mail
        process and its several stages:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      sender -&gt; MUA -&gt; MTA -&gt;..-&gt; MTA -&gt; MDA -&gt;{maildrop}-&gt; MUA -&gt; reader
      [1]       [2]    [3]        [4]    [5]                [6]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Headers typically provided by &quot;template&quot; by the MUA to the sender,
        usually during stage [1] (when composing e-mail):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From:               # who I am
      To:                 # the target
      Cc:                 # people to keep informed, but need not respond
      Bcc:                # secret admirers
      Subject:            # what's the mail about
      Reply-To:           # highest priority return address
      Priority:
      Precedence:
      Resent-To:          # used for redirecting e-mail
      Resent-Cc:
      X-BlahBlah:         # personalized headers    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When the sender is done composing, and says &quot;send it&quot; to his/her
        mailer, some additional headers may get inserted by the MUA at this
        stage [2]:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Date:
      Resent-Date:        # if being redirected
      From:               # If not already present
      Sender:             # if a From: is already present
      X-Mailer:           # what MUA composed this message
      Mime-Version:
      Content-Type:       # what kind of stuff is in here
      Content-Transfer-Encoding:
      Content-Length:    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        When the MTA receives the e-mail from the MUA at stage [3], it may
        insert additional headers showing the origination of the e-mail:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      From                # if local e-mail, automatic or by -f option
      Date                # If not already present
      Message-Id:         # unique ID for the e-mail; the first MTA
                          # creates this
      Received:           # shows inter-system e-mail tracking info
      Return-Path:        # shows how to get back to the sender    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        As each MTA hands off the e-mail, additional headers may get added,
        all as part of the MTA to MTA handoff in stage [3]:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Received:           # inserted by each MTA    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        As the final MTA hands the e-mail to a delivery agent (MDA), in
        stage [4], there are still some more header insertions which may
        occur:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Apparently-To:      # added if no To: header exists
      From                # may get added if local e-mail    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Some sites insert special rewrite rules and filtering to occur to
        support virtual domains, and these header changes will occur at
        stage [5], just before the incoming mail is dropped. Generally,
        though, no new headers are added, except possibly one to avoid
        loops:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      X-Loop: $USER@$HOST # inserted to avoid filtering loops    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Finally, at stage [6] when the reader views his/her e-mail, most
        MUAs will apply a filter to the stored mail causing selected headers
        to be omitted from the display. In a sense, then, this filtering
        &quot;removes&quot; the headers from the user's view (although no headers are
        actually removed by the MUA).


<p class="column8">
        The headers typically omitted are those inserted by the MTAs, and
        those having to do with the transport process and less with the
        contents.



  <a name="applied_to_received_messages" id="applied_to_received_messages"></a>
  <h2>
      22.3 Applied to received messages

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[alan]</span> So, now that we have a common understanding...


<p class="column8">
        The first &quot;From&quot; is a Unix-mail <samp class="word">From_</samp> header (note the space).
        This is inserted automatically by MTAs, unless one is already
        present and only then if it seems valid.


<p class="column8">
        The second <samp class="word">From:</samp> is generated by the MUA (your personal mailer),
        either by configuration, or by the user. The rewrite rules in
        sendmail and most filtering programs concern themselves with the
        <samp class="word">From:</samp>, <samp class="word">To:</samp>, <samp class="word">Cc:</samp>, <samp class="word">Reply-To:</samp> headers.


<p class="column8">
        I'll assume that if &quot;From smmi&quot; is not &quot;correct&quot;, then you must be
        trying to hide the delivery process, and implementing something of a
        virtual domain.


<p class="column8">
        In general, it is a bad idea to &quot;correct&quot; the automatic mail headers
        inserted by the MTAs. This is a different matter than changing
        addresses to show virtual domains. The <samp class="word">From_</samp> header is part of the
        history of the message, showing how the mail was originated.
        Similarly, the &quot;Received:&quot; headers should not be messed with.
        Changing the history of an e-mail message will make it very
        difficult to diagnose e-mail delivery errors.


<p class="column8">
        That being said, and, since I also believe in the freedom of choice,
        I will now supply you with &quot;enough rope to hang yourself&quot; :^)


<p class="column8">
        There are two places where you can have the <samp class="word">From_</samp> header
        corrected: just before it gets dropped into the mailbox (for
        incoming e-mail), or as it gets submitted to the MTA (for outgoing
        e-mail).


<p class="column8">
        Changing the <samp class="word">From_</samp> before it gets dropped is easy. Just use a
        recipe like this:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      FROM    = `$FORMAIL -zxFrom:`
      DATE    = ...construct the RFC date format

      :0 fhw
      | $FORMAIL -I &quot;From  $FROM $DATE&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The <samp class="word">From_</samp> header is created automatically by the MTA (sendmail)
        when it receives a piece of mail. If the mail is sent through
        sendmail without using the '-f' option, then sendmail sets the
        default <samp class="word">From_</samp> to that of the current user. If you are not root, or
        a &quot;trusted user&quot; (see the sendmail man page), then sendmail will
        ignore the <samp class="word">From_</samp>  header and either remove it altogether or replace
        it. Even if you are root, sendmail will replace the <samp class="word">From_</samp>, if the
        e-mail is being received locally (as opposed to from the network).


<p class="column8">
        If you wish to change the <samp class="word">From_</samp>, you must invoke sendmail, as root
        or a &quot;trusted user&quot;, and use the &quot;-f&quot; option. EG: to set the <samp class="word">From_</samp>
        to match the <samp class="word">From:</samp> header, use the following recipe, as root:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0 h
      FROM=|$FORMAIL -zxFrom:

      :0
      ! -oi -t -f&quot;$FROM&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Please read the man page on sendmail, noting the use of '-f'.



  <a name="bcc_lecture_by_alan_stebbens" id="bcc_lecture_by_alan_stebbens"></a>
  <h2>
      22.4 Bcc lecture by Alan Stebbens

  </h2>




<p>
<p class="column8">
        Procmail mailing list 1996-11


<p class="column8">
        Procmail most typically processes incoming mail at a destination
        site; the BCC formatting (or lack of it) is done on outgoing mail,
        at the originating site.


<p class="column8">
        For this discussion, let's make distinctions as to the kinds of mail
        there are: (a) incoming mail, and (b) outgoing mail. Bcc's are
        inserted into outgoing mail by the user, and the message is then
        handed to a MUA. The MUA may then handle the BCC's or defer that to
        the Mail Transport Agent (MTA), such as sendmail. Whichever agent
        performs the Bcc function, that function is performed in at least
        three different ways:

<ul>
	<li>Many MUAs format outgoing mail without the Bcc: headers, so that
            the same message header can be sent to all recipients. The Bcc:
            recipients receive an extra line in the message body, indicating
            the nature of the mail. The text of the message varies from MUA
            to MUA; The Rand Mailer, MH, for example inserts the lines
	            around the original text:</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      ------- Blind-Carbon-Copy
      ...
      ------- End of Blind-Carbon-Copy    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Some MUAs will send the message, separately, to each Bcc:
            recipient, with the recipient address on the Bcc: header. Each
            Bcc recipient thus knows that they received the message by way
            of the Bcc, but do not know whom else was a Bcc recipient. All
            Bcc recipients are private, even to other Bcc recipients. (It
	            would be nice if all MUAs behaved this way).</li>
</ul>



<ul>
	<li>A few MUAs deliver the message without the Bcc:, but also without
	            any special indication; you must guess that it was a Bcc.</li>
</ul>




<p class="column8">
        The original mail standard RFC822 says this about Bcc:


<p class="column10"><em class="quote10">
          4.5.3. BCC / RESENT-BCC</em>



<p class="column10"><em class="quote10">
          This field contains the identity of additional recipients of the
          message. The contents of this field are not included in copies of
          the message sent to the primary and secondary recipients. Some
          systems may choose to include the text of the &quot;Bcc&quot; field only in
          the author(s)'s copy, while others may also include it in the text
          sent to all those indicated in the &quot;Bcc&quot; list.</em>



<p class="column8">
        So, procmail <em class="word">would</em> handle Bcc's correctly if the sender's MUA
        included the Bcc in the header in the first place. But, since
        procmail is most typically used on <em class="word">incoming</em> mail, it will never
        have a chance to deal with Bcc: headers.



  <a name="bcc_lecture_by_philip_guenther" id="bcc_lecture_by_philip_guenther"></a>
  <h2>
      22.5 Bcc lecture by Philip Guenther

  </h2>




<p>
<p class="column8">
        Procmail mailing list 1996-11


<p class="column8">
        The Bcc: header should in general not appear in an incoming message
        (if procmail is used for processing outgoing mail it may occur
        there). Most (?) Mail User Agents will send a bcc by just removing
        the header entirely and putting the address in the envelope
        recipient list with the other recipients from the To: and Cc:
        headers. Done this way, the address to which the message was bcc'ed
        *does not occur in the headers at all*, and you are SOL.


<p class="column8">
        By the time procmail is run (in the standard installation), the
        envelope is lost, which is the only way you would be able to process
        Bcc's with any possible regularity, and even that's suspect as if an
        alias at another site that contains your address is bcc'ed, then the
        envelope, by the time it reaches you site, will only contain your
        (local) address.


<p class="column8">
        Furthermore, the whole point of the Bcc: header is that the people
        who receive the message do not know the entire list of address to
        which the message was sent. If an alias is bcc'ed, it is not clear
        whether the members of the alias should know that it was the alias
        that was bcc'ed and not just the individual in question alone.


<p class="column10"><em class="quote10">
          There MUST be some trace of the BCC destination that travels with
          the e-mail. Otherwise, how does it know its destination? If I'm
          right, then couldn't procmail use this to properly handle the
          message?</em>



<p class="column9"><strong>
         [alan]</strong>



<p class="column8">
        Procmail mailing list 1996-11


<p class="column8">
        Only the MTA knows the destination address because it is part of
        the &quot;envelope&quot;, the information which is passed on the &quot;RCPT To:
        some-user&quot; SMTP line. This information is how the MTA knows to
        deliver the mail, and not by the contents of the headers.


<p class="column8">
        Of course, when invoked properly, many MTAs can read the headers to
        obtain the addresses needed on subsequent &quot;RCPT&quot; commands in the
        ensuing SMTP connections. In fact, the Bcc: header can be read along
        with the rest of the destination headers to obtain the recipient
        addresses, but the Bcc: will also be removed from the headers.


<p class="column8">
        The address by which an MTA receives a mail is known as the
        &quot;envelope address&quot;, which may be distinct from any headers in the
        message itself, or, the same as one of them, for directly addressed
        mail.


<p class="column8">
        With mailing lists, for example, the addressee will never see
        his/her own address, but will see the mailing list in the To: or Cc:
        header fields. Even here, when mail is addressed to more than one
        mailing list, there is a lack of standard for determining <em class="word">the</em>
        address by which a message is received. There are lots of
        conventions followed, and heuristics, but no clearly defined
        standard to indicate the cause of delivery.


<p class="column8">
        You may be able to configure your MTA to pass along the envelope in
        a new header, or pass it by argument to the local delivery program
        (which can be procmail). It is then up to the local delivery program
        to use (or not) the envelope address information.


<p class="column8">
        If you wish to understand the limits of your mail system, you should
        read RFC822 (mail formatting standards) and RFC821, which describes
        the original language of SMTP. There are several extensions in
        progress, but the basic commands of &quot;MAIL&quot;, &quot;RCPT&quot;, and &quot;DATA&quot;
        should suffice.

<hr>
               <A name="message_headers"  id="message_headers"></A>
               <h1>
               23.0 Message headers

               </h1>



  <a name="what_is_correct_from_address_syntax" id="what_is_correct_from_address_syntax"></a>
  <h2>
      23.1 What is correct From address syntax

  </h2>




<p>
<p class="column10"><em class="quote10">
          Case 1 is what is in RFC 822, as I recall. I regard Case 2 as
          &quot;screen syntax&quot; for inclusion in plain-text message-body
          contexts. It could be used for the interactive presentation of
          headers, but I would be inclined to think any tool that doesn't
          accept the original RFC-822 form is broken.</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      1. login@path.to.host (Personal Name)
      2. Personal Name &lt;EM&gt;<a href="mailto:login@path.to.host" >login@path.to.host</a>&lt;/EM&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[1998-05-31 FAQ-L Simon Lyall &lt;simon A T darkmere.gen.nz&gt;]</span> Both
        forms are legit but the way news and standards documents are going
        is for the first form to be discouraged. This efectively means
        that software should accept both forms but only generate the second
        (this is when the article is first created not by someone half way
        around the world).


<p class="column8">
        The problem with the first form is that stuff in brackets is
        actually a &quot;comment&quot; rather than the name of the poster. This means
        that there is no way using the first form to actually say what your
        name is, it is just that most people say their name in the comment
        field. They could just as easily say something else. This means
        that software that displays the comment field as th name is just
        taking a guess.


<p class="column8">
        The 2nd format puts the name of the posted in a definite place that
        software can work with and allows you to leave the use of brackets
        for comments. The current internet draft that on this that will
        most likely replace RFC 822 on this point is at:
        <a href="http://tools.ietf.org/html/draft-ietf-drums-msg-fmt-04" >http://tools.ietf.org/html/draft-ietf-drums-msg-fmt-04</A>


<p class="column8">
        The bit is section 3.4 which says:


<p class="column10"><em class="quote10">
          Note: Some legacy implementations used the simple form where the
          addr-spec appears without the angle brackets, but included the
          name of the recipient in parentheses as a comment following the
          addr-spec. Since the meaning of the information in a comment is
          unspecified, implementations SHOULD use the full name-addr form
          of the mailbox if a name of the recipient is being used instead
          of the legacy form. Also, because some legacy implementations
          interpret the comment, comments SHOULD NOT generally be used in
          address fields to avoid confusion.</em>




  <a name="whats_that_xuidl_header" id="whats_that_xuidl_header"></a>
  <h2>
      23.2 What's that X-UIDL header?

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span>

<ul>
	<li>It's not standardized, and will never be standardized by an RFC.
            (No X- header can be)
<li>Some servers use this to store information for the UIDL command.
	</li>
<li>Some clients apparently store UIDL information in this header in
            the locally downloaded copy. (Note: the POP3 protocol doesn't
            let the client modify the message(s) stored on the server.)
	</li>
<li>Some spamming software packages include this header in messages
            they send to make some POP3 clients that support client side
            filtering think that they've already filtered the message.
	</li>
<li>Filtering out incoming messages (pre-retrieval via POP3) seems
            'fairly' safe, though some legitimate mail may include this
            header. Using it as a heavy weight (but not enough on its
            own) in a procmail scoring recipe that detects spam appears to
	            be reasonable.</li>
</ul>



<ul>
	<li><span class="word-ref">[philip]</span> If a message comes into your mailbox that has the X-UIDL:
            header, and doesn't have your address in the header, then I
            would have strong doubts about its legitimacy.
<li><span class="word-ref">[ed]</span> comments: E-mails with X-UIDL: headers are almost
            definitely spam unless they've been Resent-To: me by someone.
	            Also, valid X-UIDL: headers have 32 hexadecimal digits exactly.</li>
</ul>




<p class="column8">
        <span class="word-ref">[David]</span> The advisability of trashing all mail with X-UIDL: headers
        has been discussed on procmail list recently; apparently it's
        possible for one to appear in legitimate mail.


<p class="column8">
        <span class="word-ref">[Elijah]</span> Yup. Very true. Mostly likely case would probably be for
        certain types of forwarded mail, including some moderated mailing
        lists. Fluffy's mod.* list had these until I pointed out the
        wide-spread file-to-/dev/null problem to Fluffy.



  <a name="what_is_that_first_from_header" id="what_is_that_first_from_header"></a>
  <h2>
      23.3 What is that first From_ header?

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[philip]</span> the address on the <samp class="word">From_</samp> line is the envelope
        sender. If the message has a Return-Path: header, then it would
        probably be easier to use that instead, as then you don't have to
        deal with the date as found at the end of the <samp class="word">From_</samp> header.


<p class="column8">
        DON'T CONFUSE THE ENVELOPE WITH THE MESSAGE. The headers in the
        message are allowed to contain a list of address in the To: and Cc:
        headers that are totally irrelevant to where the message it going. For
        example, a message from a mailing list may simply say &quot;To:
        procmail@Informatik.RWTH-Aachen.DE&quot;, with no visible sign that
        &quot;guenther A T gac.edu&quot; is an address to which the message is being
        delivered. That information, where the message is currently in the
        process of being delivered to, is found ONLY in the envelope.


<p class="column8">
        Okay, where is this precious envelope? In SMTP the envelope consists
        of the MAIL FROM: and RCPT TO: SMTP commands. However, when a message
        is given to the local mailer, this information is typically lost.
        Well, the envelope sender is usually saved now days in the
        Return-Path: header, but the envelope recipient usually only appears
        in the form of the login name that the local mailer was passed on the
        command line. This can be used, for example, by /etc/procmailrc
        scripts that check $LOGNAME to see where the message is set to go.


<p class="column8">
        A problem arises however when people start creating virtual domains.
        When sendmail does the aliasing (usually by mailertable I believe?),
        it totally loses the original envelope recipient address in the
        rewriting. All the addresses get rewritten to the same thing, and
        sendmail thus has no reason to differentiate them. Having lost their
        independent identities, the now-same multiple recipients are merged to
        form one call to the local mailer.


<p class="column8">
        The key point here is that once the envelope recipient is lost by the
        virtual domain alias, THERE IS NO WAY TO GET IT BACK! You can wave
        your hands and try faking it, but no one in the virtual domain can
        ever get onto a mailing list or otherwise receive a piece of mail for
        which the header doesn't explicitly contain his/her mail address. And
        furthermore, even doing that faking is extremely difficult to do
        right. What I show below does NOT correctly handle messages with
        Resent-* headers. This can result in messages being received by people
        who shouldn't receive them, possibly violating someone's privacy.
        Please keep all that in mind if you decide to use it. It handles a
        goodly percentage of the cases, but it'll bite you badly at some point
        in the future.


<p class="column8">
        So you may ask, does this mean that virtual domains are
        hopeless? The answer is no, you just have to be very careful in the
        sendmail.cf to keep the envelope recipient stashed somewhere long
        enough that it can be passed as an argument to the local mailer,
        usually by putting it in the 'host' part of the mailer triple, though
        with sendmail 8.7.x, putting it into the local part with a '+' would
        probably be incredibly clean. In the end, it ends up being passed to
        procmail (standard /bin/mail has no way of handling this, but we
        already knew that) as another argument (i.e., -a orig-envelope-recip),
        though with some work it might be possible to do it via a new header,
        but that's uglier and no more efficient. I don't have the sendmail.cf
        (or m4 .mc) mods necessary to do this, but if you post to
        comp.mail.sendmail (after checking the FAQ, I think it might be there)
        someone may be able to give you further pointers on saving envelope
        recipients in virtual domain situations.



  <a name="messageid_header" id="messageid_header"></a>
  <h2>
      23.4 Message-Id header

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Are there known problems with &quot;valid&quot; mails with illegal
          MessageIDs? For some strange reason, some people are sending out
          mail with bad message id's. That wouldn't be much of a problem,
          except that our MITS department won't even consider fixing the
          bad-message-id unless it causes a problem somewhere else.</em>



<p class="column8">
        Why would they not consider fixing it? Their e-mail software/gateway
        is broken, and needs fixing. That's that. Direct them to RFC 822, sec
        4.6.1. <a href="http://www.ietf.org/rfc/rfc0822.txt?number=822" >http://www.ietf.org/rfc/rfc0822.txt?number=822</A>


<p class="column8">
        <span class="word-ref">[Gerald Oskoboiny &lt;gerald A T impressive.net&gt;]</span> There are problems with
        Some of the problems with mail containing a bad message id


<p class="column8">
        Some people (myself included) run filters to automatically delete
        incoming e-mail if its message-ID has been seen recently, or if it
        looks bogus.


<p class="column8">
        Some mailing list software (including Smartlist) does not accept
        e-mail with a message-ID that has been seen recently. Each message
        must have a unique message-ID. The best way to ensure that msgids are
        unique in a global context is to include a fully-qualified domain name
        after the '@'. In particular, a message-ID like
        &lt;3.0.5.32.19971208192547.007db100@mailhub &gt; is unacceptable for this
        reason (even if it didn't have a space at the end.)


<p class="column8">
        Some mail archive software (including some that I wrote) uses
        message-IDs as a unique identifier for that message in the archive. It
        may reject messages that appear to be duplicates because they have a
        message-ID used by other messages. (as my software does.)


<p class="column8">
        <span class="word-ref">[generating message id]</span>


<p class="column8">
        [Stainless Steel Rat &lt;ratinox A T peorth.gweep.net&gt; 1998-03-13
        in Emacs Gnus mailing list] ...it is strongly recommended that
        <samp class="word">Message-Id</samp> strings be generated by the MUA, rather than the
        MTA. The reason being that a mail hub could be processing
        several messages at the same time (multiple CPUs), and so
        could accidentally generate duplicate <samp class="word">Message-Id</samp> strings.
        The MTA should generate <samp class="word">Message-Id</samp> headers only when the MUA
        is stupid and fails to do it.


<p class="column8">
        <span class="word-ref">[phil 1998-03-19 PM-L]</span> ... let's do a quick work-up of a 'more complete'
        regexp to match <samp class="word">Message-Id</samp>s. I'll take syntax lines from rfc822
        with regexps that should match them. For ease of presentation, I'm
        going to work from the bottom up. Note: any brackets that only
        contain whitespace should really contain a space and a tab.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      dq         = '&quot;'                        # (literal) double-quote
      bw         = &quot;\\&quot;                       # (literal) backwhack
      ws         = &quot;[         ]*&quot;             # whitespace
      atom       = &quot;[-!#-'*+/-9=?A-Z^-~]+&quot;
      word       = &quot;($atom|$dq([^$dq\]|$bw.)*$dq)'
      local_part = &quot;$word($ws\.$ws$word)*&quot;
      domain     = &quot;(\[$ws([^][\]|$bw.)*$ws\]|$atom($ws\.$ws$atom)*)&quot;

      :0
      *$ ! ^Message-Id:$ws&lt;EM&gt;<a href="mailto:$ws$local_part$ws@$ws$domain$ws" >$ws$local_part$ws@$ws$domain$ws</a>&lt;/EM&gt;
      {
          ...Catched illegal message id
      }    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          ...I did start logging ids that match that condition. It matched
          two messages so far. One message-id was clearly bogus, but here's
          the other one (mailing list with 1 msg/week, no spam):</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Message-Id: &lt;199803251729.LAA10847@wuarchive.wustl.edu.&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column10"><em class="quote10">
          Is your regexp incomplete wrt trailing dot in the domain part, or
          is the MUA/MTA broken?</em>



<p class="column8">
        <span class="word-ref">[philip]</span> rfc822 doesn't allow a trailing dot. I just looked
        at the draft of the new Internet Message Header Standard (the
        eventual replacement for rfc822) and it doesn't either. Rather, it
        further restricts the syntax of generated <samp class="word">Message-Id</samp> headers to
        disallow comments or folding whitespace from occuring in the
        message-id itself.


<p class="column8">
        <em class="word">however</em>: before you go tightening that regexp, note that the
        standard <em class="word">requires</em> that programs that process messages <em class="word">must</em>
        accept and parse messages that fit the obsolete syntax. This is
        because old mail messages can hang around for long periods of time
        in a way that most other internet data formats don't see. The new
        requirements are on the <strong class="word">generation</strong> of new messages, not on old
        messages.


<p class="column7"><em><strong>
       <span class="word-ref">[1998-10-22 comp.emacs Toby Speight &lt;Toby.Speight A T digitivity.com&gt;]</span></strong></em>



<p class="column8">
        It's more usual (and useful) to refer to news articles by
        Message-ID (that's what Message-IDs are for!). In this case

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      &lt;<a href="news://uhfwwk9ae.fsf_-_@delivery.ansa.co.uk" >news://uhfwwk9ae.fsf_-_@delivery.ansa.co.uk</a>&gt;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        (though for some reason this returns text/plain for something which
        is clearly a message/rfc822). Either of which is an unambiguous
        URL, not subject to the same time-dependent changes. URLs were
        designed exactly to remove the need for such descriptions.



  <a name="received_header" id="received_header"></a>
  <h2>
      23.5 Received header

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...Found another interesting pattern, Received header that are all
          on one line. Normally a Received: header spans two lines, at
          least on <em class="word">all</em> the mail I get. This filter locates the single
          line Received: headers and traps on that:</em>


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0:
      *Received:\/( ?[^       ])*$
      mail/Spam    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        <span class="word-ref">[Christopher Lindsey &lt;lindsey A T ncsa.uiuc.edu&gt;]</span> No guarantees here. I
        just tried it out on some test mailboxes (all known to have valid
        mail), and it matched like mad. As far as I can tell, there's no
        requirement in RFC 822 for multiple lines in a <samp class="word">Received</samp> header.


<p class="column8">
        <span class="word-ref">[Reto Lichtensteiger &lt;rali A T meitca.com&gt;]</span> The one line header vs.
        multi-line header is config'ed in sendmail: An older cf file
        (V8.7):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HReceived: $?sfrom $s $.$?_($?s$|from $.$_) \
          $.by $j ($v/$Z)$?r with $r$. id $i$?u for $u$.; $b    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A later (V8.8) one:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      HReceived: $?sfrom $s $.$?_($?s$|from $.$_)
              $.by $j ($v/$Z)$?r with $r$. id $i$?u
              for $u; $|;
              $.$b    </PRE></TD>
    </TR>
</TABLE>



  <a name="returnpath" id="returnpath"></a>
  <h2>
      23.6 Return-Path

  </h2>




<p>
<p class="column10"><em class="quote10">
          ...I've created a user (lo_mailer) with a .forward and a
          procmailrc file to transport incoming mail to the right user.<br>
          That is working fine, but the Return-Path: Line is set to the
          local procmail user (lo_mailer) and does not contain the original
          Return-Path! What can I do to win back the original-line? Please
          help me :)</em>



<p class="column8">
        <span class="word-ref">[david]</span> Normally when you forward mail you should NOT keep the
        original return path. If the forwarding destination is invalid or
        unreachable, mail has to be returned to the forwarder, who can fix
        the forwarding routine, not to the original sender, who can't do
        anything about it and probably never even heard of the final
        destination address.


<p class="column8">
        But, though you should change the return path, you do not have to
        lose the information that the original return path contained. You
        can safely put that into the body or into another header line. Try
        this in lo_mailer's .procmailrc:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      :0fwh # if there's a return path, save it as Old-Return-Path:
      * ^Return-Path:.*&lt;.+&gt;
      | formail -iReturn-Path: # lower-case i

      :0Efwh # if there's no return path but there is a From_, use that
      * ^^From[      ]+\/[^  ]+
      | formail -A &quot;Old-Return-Path: $MATCH&quot;

      :0Efwh # if there was neither a Return-Path: nor a From_
      | formail -A &quot;Old-Return-Path: unknown&quot;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The first set of brackets in the condition line of the second
        recipe enclose a space and a tab; the second set enclose caret,
        space, tab.


<p class="column8">
        On the forwarding leg from lo_mailer to the final recipient, the
        return path will be to lo_mailer, as it should, but if the final
        recipient wants to know where it originated, he or she can look at
        the <samp class="word">Old-Return-Path</samp> header.


<p class="column8">
        There is one caution here. If lo_mailer is taking mail to a general
        response address and distributing it to specific people based on
        subject or body content or just by rotation to balance the
        workload, fine. But if you have a personal domain and your ISP is
        routing all mail for any address in your domain to your account on
        the ISP, and you're depending on procmail to deliver it to the
        right address in your own domain by reading To: or Cc: headers,
        that is the wrong approach. The correct recipient will be on the
        envelope, which is removed from incoming mail before procmail can
        see it. Your ISP has to do something that lets you know the true
        envelope recipient or recipients of a message, and others here know
        a lot more about that than I do (and way, way more than I could
        tell you without making mistakes).


<p class="column8">
        <span class="word-ref">[1998-11-11 Gnus-L Karl Kleinpaste]</span> With regard to
        the standards for Return-Path, RFC822 observes that it should be a
        <strong class="word">route</strong> back to the originator, i.e., it should show relay hops;
        RFC1123 in turn says that failure notifications should be sent back
        to the originator with the route information deleted, that is, &quot;If
        the address is an explicit source route, it SHOULD be stripped down
        to its final hop.&quot; ??? Then what's the point of providing the
        source route in the first place?


<p class="column8">
        It seems to me that Return-Path's value has become very limited in
        an environment where source-routed mail is vastly deprecated, and
        just plain not supported by many. I know that, when I did serious
        sendmail work years ago, I shot all source routes on sight.


<p class="column8">
        You could very well substitute the use of user-login-name for the
        &quot;-f&quot; argument in sendmail with the value user-mail-address; the
        result should give the effect you need, and not create any
        interoperability problems &ndash; mail will still show a proper way to
        return to you.


<p class="column8">
        That said, this mailing list's requirement of matching Return-Path
        is indeed pretty peculiar.



  <a name="errorsto" id="errorsto"></a>
  <h2>
      23.7 Errors-To

  </h2>




<p>
<p class="column10"><em class="quote10">
          1) Can somebody confirm that Errors-To: is deprecated?
          2) Is there an RFC for this?</em>



<p class="column8">
        <span class="word-ref">[1998-09-15 Liviu Daia &lt;daia A T stoilow.imar.ro&gt;]</span> 1) It is an UUCP
        thing, and it's indeed deprecated. Here's the relevant quote from
        sendmail's manual. 2) Probably not, since UUCP-related RFCs haven't
        been updated in a while.


<p class="column10"><em class="quote10">
          If errors occur anywhere during processing, this header will
          cause error messages to go to the listed addresses. This is
          intended for mailing lists. The Errors-To: header is officially
          deprecated and will go away in a future release.</em>




  <a name="xsubscriptioninfo" id="xsubscriptioninfo"></a>
  <h2>
      23.8 X-Subscription-Info

  </h2>




<p>
<p class="column8">
        This is a header that is used by some mailing lists: it contains an
        mail address for un/subscribe, or a URL with said info. Imagine
        the reduction in bozo messages asking how to unsubscribe from
        mailing lists. If your mailing list doesn't have it already, make
        a suggestion to the list's maintainer.



  <a name="replyto_header" id="replyto_header"></a>
  <h2>
      23.9 Reply-To header

  </h2>




<p>
<p class="column8">
        The existence of a Reply-To: means, &quot;IF you reply to me, send it to
        this address instead of the one in the From: header.&quot;


<p class="column8">
        In the case of a mailing list, the list usually is that default
        mailbox. In that case, a Reply-To header says, &quot;don't send it to the
        list, send it here instead.&quot; Again, it is more a matter of &quot;do what I
        mean&quot;.


<p class="column8">
<span class="quote7">ListAdmin: Don't play with Reply-To</span><BR>
        <a href="http://www.unicom.com/pw/reply-to-harmful.html" >http://www.unicom.com/pw/reply-to-harmful.html</A>
        ... RFC-822 on reply-to is just almost hopeless. The reason people
        do what they do is more likely because they saw someone else doing
        that, and imagined it was correct, and copied - perhaps slightly
        varying things along the way. ...If you use a reasonable mailer,
        Reply-To munging does not provide any new functionality. It, in
        fact, decreases functionality. Reply-To munging destroys the
        reply-to-author. capability.


<p class="column8">
<span class="quote7">Mail-Followup-To</span><BR>


<p class="column9"><strong>
         <span class="word-ref">[Mail-Followup-To problems]</span> Keith Moore &lt;moore A T
         cs.utk.edu&gt; Wed, 11 Feb 1998 14:20:25 -0500 commented on the
         nmh list. Keith is the IETF applications area director, and
         used to chair the DRUMS working group.</strong>



<p class="column8">
        Please don't implement support for Mail-Reply-To and Mail-Followup-To
        in nmh. Not only are they nonstandard, they're a poor fix for the
        problem.


<p class="column8">
        Reply-To is widely misinterpreted as the replacement for the From
        field in replies, in such a way that &quot;reply all&quot; goes to Reply-To + To
        + Cc if Reply-To is present and From + To + CC if no Reply-to field is
        present.


<p class="column8">
        RFC 822 has language that appears to support this view. But a careful
        reading of RFC 822 reveals that this prose does not apply to Reply-To
        with respect to a &quot;reply all&quot; function, but only with the use of
        Reply-To in a &quot;reply to author&quot; function.


<p class="column8">
        This leaves us with the situation where the author of a message is
        unable to specify the complete destination for replies. Even if the
        author specifies a Reply-To field, if the recipient uses &quot;reply all&quot;,
        addresses from the To and CC field are still included. This is the
        behavior implemented by almost every UA in existence, but it's almost
        always the wrong thing to do.


<p class="column8">
        And RFC 822's examples make it clear that Reply-To is intended as the
        <em class="word">complete</em> destination for replies, not merely a replacement for the
        From field.


<p class="column8">
        The right way to fix this is to correctly interpret Reply-To - not as
        simply the replacement for the From field in replies, but as the reply
        destination preferred by the author of the subject message. Adding new
        headers doesn't fix the problem. It only makes the situation more
        complex.


<p class="column8">
        Dan's proposal is intrinsically flawed. It incorrectly assumes that
        the sender can reasonably anticipate the recipient's needs in replying
        to the message, and that such needs can reasonably be lumped into
        either &quot;reply&quot; or &quot;followup&quot;. It doesn't solve the real problem, which
        is that responders need to think about where their replies go.
        Mail-Followup-To won't decrease the number of messages that go to the
        wrong place.


<p class="column8">
        If I sent out a message inviting people to a meeting, and want
        &quot;normal&quot; replies (presumably accepting or declining the invitation) to
        go to my secretary. Should I put my secretary's address in
        &quot;Mail-Reply-To&quot; or &quot;Mail-Followup-To&quot;?


<p class="column8">
        Say I put it in Mail-Reply-To and a responder wants to send a personal
        reply to me, perhaps because it's sensitive in nature. So he hits
        &quot;reply to author&quot; thinking that the message will go to me. Instead,
        the message goes to my secretary. This is Bad.


<p class="column8">
        Say I put my secretary's address in Mail-Followup-To and a responder
        wants to send a message to the list of recipients of the original
        message &ndash; maybe that responder wants to let everyone know about cheap
        airfares to the meeting. So the responder hits &quot;reply to everyone&quot;
        thinking that the message will go to everyone. Instead, the message
        goes to my secretary. This is not as bad as the other case, but it's
        still not desirable.


<p class="column8">
        So if some responses are neither &quot;personal&quot; nor &quot;group&quot; replies, why
        not define an extensible reply header that would include not only the
        address but the category of reply? Something like:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Labelled-Reply-To: secretary; jeeves@cs.utk.example.com
      Labelled-Reply-To: mailing-list; listname@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        It turns out that we already have most of this in RFC 822:

<ul>
	<li>The 'phrase' before an address, or a comment, can identify a
            person by name and/or role. The responder can use this information
            to decide whether it's reasonable to send a reply to that person.
	            e.g.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Reply-To: (my secretary) jeeves@cs.utk.example.com    </PRE></TD>
    </TR>
</TABLE>

<ul>
	<li>Similarly, the 'phrase' after a group name can identify a group
	            of recipients, which can also be used by the responder. e.g.</li>
</ul>



<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Reply-To: Secretary: jeeves@cs.utk.example.com ;,
           The Gang: a@foo, b@bar, c@zot ;    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        (Unfortunately, phrases are so widely botched, that they probably
        aren't usable for this.)


<p class="column8">
        Summary:

<ul>
	<li>The way to solve most reply problems is to encourage the responder
            to actually think about where the message needs to go, and make it
            easy for him to get the behavior he wants. (It also helps if
            people use the RFC 822 'phrase' to label their header addresses.)
<li>We can build interfaces that help the responder do this without
            defining any new header fields.
	</li>
<li>Except for a very few cases, Mail-{Reply,Followup}-To doesn't
	            help. It only provides more opportunities for surprising behavior.</li>
</ul>





<p class="column9"><strong>
         Stainless Steel Rat &lt;ratinox A T peorth.gweep.net&gt;  1998-02-12
         commented in Emacs ding mailing list</strong>



<p class="column8">
        Every mail client is not doing supporting this. Only the badly written
        ones fail to distinguish between replies and followups.


<p class="column8">
        When you get right down to it, this proposed standard has two goals:

<ul>
	<li>To make broken MUAs act less brokenly. Well, broken MUAs are not
            going to implement this standard, anyway; good MUAs do not need it
            as they already make the distinction between replies and
            followups.
<li>To make broken mailing lists act less brokenly. Administrators of
            broken mailing lists have decided that they like it that way. They
            claim that it makes it easier for their lists' subscribers to
            reply to the list. The subscribers that &quot;need&quot; list-bound Reply-To
	            headers are using broken MUAs. See #1.</li>
</ul>




<p class="column8">
        This proposed standard will not solve any of the problems it attempts
        to address. It creates headers that are ignored by bad MUAs and are
        redundant for good MUAs.


<p class="column8">
        To summarise Keith's statement: From is the originator's mailbox. It
        is not an 'account'. RFC 822 states that the originator header should
        contain the correct default reply address.


<p class="column8">
        This is the scenario that the proponents of these headers have
        proposed, and the flaw the IETF has found with it.


<p class="column8">
        Joe is subscribed to a mailing list that he reads from his &quot;private&quot;
        mail account. For whatever reason, Joe posts a message to that list
        from work, so his work mailbox is in the From header. Joe does not
        want to override where responses go with a Reply-To header, but he
        wants personal replies to go to his private mail account instead of
        his work account.


<p class="column8">
        The flaw the IETF found is that Joe is equating his two mailboxes with
        his private and work accounts. There is no such correspondence as far
        as RFC 822 is concerned. If Joe is acting in a &quot;private&quot; fashion, the
        system he is using is irrelevant; his private mailbox belongs in the
        From header and he should put that mailbox there when he originates
        the message, regardless of where he physically is when he does so.



  <a name="mailcopiesto_header" id="mailcopiesto_header"></a>
  <h2>
      23.10 Mail-Copies-To header

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[Suggested by Lars Magne Ingebrigtsen, the Author of Emacs Gnus]</span>


<p class="column8">
        ...Mail-Copies-To: is a header line used in messages on
        Usenet to direct copies by mail of followups to posts.
        <a href="http://www.newsreaders.com/misc/mail-copies-to.html" >http://www.newsreaders.com/misc/mail-copies-to.html</A>


<p class="column8">
        <span class="word-ref">[SL Baur &lt;steve A T xemacs.org&gt;]</span> The <samp class="word">Mail-Copies-To:</samp> header should
        control how your mail (and Usenet) client prepares a followup
        message. It gives control to the sender of a message whether
        <samp class="word">courtesy</samp> duplicate copies of messages should be sent.
        There are two forms:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Mail-Copies-To: never    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Do not automatically include the sender of the message being
        responded to. There are two canonical examples.

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Usenet:
      From: foo@example.com
      Newsgroups: comp.emacs.xemacs
      Mail-Copies-To: never    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A followup in a conforming client should generate in the response
        message headers:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Newsgroups: comp.emacs.xemacs

      Email:
      From: foo@example.com
      To: mailing-list@somewhere.example.com
      Cc: luser@somewhereelse.example.com
      Mail-Copies-To: never    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A followup in a conforming client should generate in the response
        message headers:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      To: mailing-list@somewhere.example.com
      Cc: luser@somewhereelse.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The second form includes a properly formed RFC822 mail address as
        the parameter:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Mail-Copies-To: someaddress@somewhere.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        In this case, the sender of the message is specifically requesting
        that responses to the message not only go to the main forum (either
        mailing list or Usenet newsgroup), but a duplicate copy should also
        be sent to <samp class="word">someaddress@somewhere.example.com</samp>. There are (again) two
        canonical examples.


<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Usenet:
      From: foo@example.com
      Newsgroups: comp.emacs.xemacs
      Mail-Copies-To: foo@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A followup in a conforming client should generate in the response
        message headers:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      Newsgroups: comp.emacs.xemacs
      Cc: foo@example.com[1]

      Email:
      From: foo@example.com
      To: mailing-list@somewhere.example.com
      Cc: luser@somewhereelse.example.com
      Mail-Copies-To: foo@example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        A followup in a conforming client should generate in the response
        message headers:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      To: mailing-list@somewhere.example.com
      Cc: luser@somewhereelse.example.com, foo@example.com[2]    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        There is no requirement that the address in <samp class="word">Mail-Copies-To</samp>
        match the <samp class="word">From</samp> address. Footnotes: [1] Or `To:
        foo@example.com' [2] It is also acceptable to put
        <samp class="word">foo@example.com</samp> in the To: line.



  <a name="mailfollowupto_and_replytopersonal_headers" id="mailfollowupto_and_replytopersonal_headers"></a>
  <h2>
      23.11 Mail-Followup-To and Reply-To-Personal headers

  </h2>




<p>
<p class="column8">
        <span class="word-ref">[21 Nov 1997,  Mutt Development List &lt;mutt-dev A T cs.hmc.edu]</span>


<p class="column8">
        Jacob Palme just today submitted an Internet-Draft
        describing Mail-Followup-To. Jacob, the Working Group chair Chris
        Newman and I all regard this as complementary to my own
        Reply-To-Personal proposal, an early version of which I posted here
        and which was also submitted as an Internet-Draft just today. In
        fact had me week been a bit less harried Jacob and I would have
        issued a joint draft. Within a few days you should be able to view
        these drafts in the IETF drafts directory on ds.internic.net under
        the names


<p class="column8">
        draft-ietf-drums-mail-followup-to-00.txt Jacob Palme's draft on the
        proposed Mail-Followup-To header.


<p class="column8">
        draft-ietf-drums-replyto-personal-00.txt My draft on
        Personal-Reply-To



  <a name="contentlength_header_and_from_specification" id="contentlength_header_and_from_specification"></a>
  <h2>
      23.12 Content-Length header and From_ specification

  </h2>




<p>
<p class="column9"><strong>
         [1996-05-17 From: Jamie Zawinski &lt;jwz A T netscape.com&gt;
         comp.mail.headers]</strong>



<p class="column8">
        ...I'm not saying that the BSD Mailbox format is good. Just that
        the Content-Length variant of that format is worse.


<p class="column8">
        Ok, so someone took the From_ format, and extended it to not
        require mangling by adding a length indicator to the format. At
        first glance, this may sound simple and elegant, but it breaks the
        world, and one shouldn't encourage its use to spread.


<p class="column8">
        The thing that breaks is taking an existing, widely-implemented
        format, and adding a requirement that it have a length
        indicator. This means that any existing software that already
        thinks it knows how to manipulate that format is going to damage
        the file (any change to the data will cause the length indicator to
        be wrong with respect to the new specification but not with respect
        to the old specification.)


<p class="column8">
        If the content-length-based format was not otherwise-
        indistinguishable from the ``From '' format, there wouldn't be a
        problem; the old software would simply fail to work with this new
        file format, instead of <samp class="word">`corrupting</samp>' the documents (in quotes,
        because it's really just a matter of which spec you're following.)


<p class="column8">
        Also, mailboxes are by their nature a textual format; but, the
        content-length header measures in bytes rather than lines. This
        means that if you move the file to a system which has a different
        end-of-line representation (Windows &lt;=&gt; Mac, or Windows &lt;=&gt; Unix)
        then the content-lengths will suddenly be wrong, because the
        linebreaks now take two bytes instead of one, or vice versa.


<p class="column8">
        It's impossible for a mail client to look at a file, and tell which
        of the two formats (From_ or Content-Length) it is in; they are
        programmatically indistinguishable. The presence of a Content-Length
        header is not enough, because suppose you were on a system which
        knew nothing at all about that header, and some incoming message
        just happened to have that header in it. Then that header would
        end up in your mailbox (because nobody would have known to remove
        or recalculate it), and it would possibly be incorrect.  (Presume
        further that the header was not just incorrect, but intentionally
        malicious...)


<p class="column8">
        Stricter parsing of the ``From '' separator line doesn't help
        either, because there are many, many variations on what goes in
        that line (since it was never standardized either); and also, some
        mail readers include that line verbatim when forwarding messages
        (Sun's MailTool, for example) so a stricter parser wouldn't help
        that case at all, because message bodies tend to contain valid
        matches.


<p class="column8">
        Some mail readers attempt to cope with this by recognizing the case
        where the Content-Length is not obviously spot-on-target, and then
        searching forward and backward for the nearest message delimiter;
        but this is obviously not foolproof, and makes one's parser much
        more inefficient (requiring arbitrary lookahead and backtracking.)


<p class="column8">
        Conventional wisdom is, ``if you believe the Content-Length header,
        I've got a bridge to sell you.''



  <a name="moral_about_cc_copies_in_usenet" id="moral_about_cc_copies_in_usenet"></a>
  <h2>
      23.13 Moral about CC copies in Usenet

  </h2>




<p>
<p class="column9"><strong>
         Sending CC</strong>



<p class="column8">
        There has been very heated discussion in the gnu.emacs.gnus (e.g
        around 1999-03-20) newsgroup where many people argue for sending CC
        replies to the person thet posted the question to the newsgroup.
        The benefit of sending CC has been seen as:

<ul>
	<li>The person gets fast answer.
<li>The person may not read the newsgroup regularly and appreciates
            the private answer
	</li>
<li>The newfeed for him may not be very reliable, so the answer may not
            appear fast in the group (but we don't know this for sure)
	</li>
<li>The newgroup expiry period may be too fast for him to catch the reply
	            (but we don't know this for sure).</li>
</ul>




<p class="column8">
        In recent years the netnews has changed a lot and many people have
        started using non-existing mail address in order to prevent
        getting UBE mail. This has made the &quot;CC&quot; senders annoyed, because
        they get bounced mail from these non-existing addresses.


<p class="column9"><strong>
         Not sending CC</strong>



<p class="column8">
        Usenet is considered a public forum, which does not force anyone
        to reveal their &quot;real&quot; address if they don't want to. It's the same
        as lock in their doors. Some people don't want to see non-invited
        people in their doors and that's why they don't like CC messages too:

<ul>
	<li>The CC is superfluous: The answer has already posted to newsgroup
<li>a CC won't help following a thread. Person has to visit the
            newsgroup to see the whole discussion anyway.
	</li>
<li>A CC is subjected to mail delivery problems: Person has moved,
            mail delivery problem (keep trying for N days), transient failure..
	</li>
<li>He always wants to read the newsgroup and doesn't like CC copies
	            to fill in his mailbox in expensive ISP account.</li>
</ul>




<p class="column9"><strong>
         A Clear munged address</strong>



<p class="column8">
        An clear non-existing mail address that indicates that it is not the
        real destination is usually considered good manners:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      john.doe@nowhere.example.com
      b.gates@vatikan.example.com
      dummy@no-replies.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        Or partially modified, that a human mind can &quot;decode&quot; if a direct
        contact is wanted (but somewhat hard to programs, because there are
        more creative choices that what program can ever expect to see):

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      johnx.you-know-what-todo@not-here.skynet.example.com
      door.lock.mike@chevanix.example.com
      nospam.xavier@ube-stop.aol.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column9"><strong>
         A valid looking address</strong>



<p class="column8">
        But an address that looks like a &quot;real&quot;, but is bogus, is not a
        polite way to participate in Usenet. This address wold give an
        impression that persn is really there:

<P>
<TABLE class="shade-normal">
    <TR>
    <TD class="shade-normal-attrib" valign="top">
    <PRE>
      mike@future-domain.example.com    </PRE></TD>
    </TR>
</TABLE>


<p class="column8">
        The MORAL learned about automatic CC copies is:


<p class="column10"><em class="quote10">
          An automatic CC is a bad thing. Don't guess people's minds. An
          open mail (real mail addresss) is not an invitation to visit
          his door. It is only a hint where the message comes from (valid
          or not). The only thing we can be sure of is that a A clear
          anti-UBE address is a stop sign, not to send any CC copies.</em>



<p class="column10"><em class="quote10">
          When people want CC, they indicate it by saying it in mail or
          adding some header that can hopefully be understood by
          newsreaders, like <samp class="word">Mail-Copies-To</samp> or <samp class="word">Followup</samp>.</em>





</body>
</html>
